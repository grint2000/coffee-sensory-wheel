<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mollis SCA 커피 관능 평가</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    html,body { font-family: 'Noto Sans KR', sans-serif; background: #fcfaf7;}
    .flavor-badge { font-size: 13px; border-radius: 9999px; padding: 2px 10px; margin: 2px; display:inline-block;}
    .export-btn { background:#8B5A2B; color:white;} .export-btn:hover { background: #654321;}
    .tab-btn-active { background: #8B5A2B!important; color:#fff !important;}
    .tab-btn-inactive { background: #f3efe8!important; color: #675444;}
    .visual-section-flex { display: flex; flex-direction: row; gap: 18px; flex-wrap: wrap; }
    @media (max-width:900px){ .visual-section-flex{ flex-direction:column; } }
    @media (max-width:640px){
      .visual-section-flex { flex-direction: column; gap: 12px;}
      .grid-cols-sample { grid-template-columns:1fr!important;}
      .md\:grid-cols-2 { grid-template-columns: 1fr !important;}
      .score-input-wrap input[type=number], .score-slider { width: 90px; }
      .defect-block { min-width:110px!important;}
    }
    .flavor-scroll{ max-height: 400px; overflow-y: auto;}
    @media (max-width: 640px) { .flavor-scroll {max-height: 250px;} }
    .no-scrollbar::-webkit-scrollbar {display: none;} .no-scrollbar {-ms-overflow-style: none; scrollbar-width: none;}
    .html2canvas-container { box-shadow: 0 0 0 3px #eee; }
    .score-slider { width: 100%; }
    .sample-list-scroll {max-height: 190px; overflow-y: auto;}
    .compare-table th, .compare-table td {border:1px solid #e2e2e2; padding:6px 8px; font-size:14px;}
    .compare-table th {background: #f9f3ea;}
    .compare-table tr:nth-child(even) td {background: #f8f6f4;}
    .tooltip { position: relative; cursor: help;}
    .tooltip .tooltip-text { visibility: hidden; background: #333; color: #fff; position: absolute; z-index: 10; padding: 7px 15px; border-radius: 8px; left: 50%; top:110%; min-width:160px; font-size:13px; opacity:0; transform:translateX(-50%); pointer-events: none; transition: opacity 0.2s; box-shadow: 0 1px 6px rgba(0,0,0,0.13); word-break: keep-all; }
    .tooltip:hover .tooltip-text {opacity:1;visibility:visible;}
    .toast { position: fixed; bottom: 28px; right: 28px; min-width: 240px; background: #8B5A2B; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 3px 20px rgba(0,0,0,.18); z-index: 9999; font-size: 15px; opacity: 0; pointer-events:none; transition: opacity 0.3s; text-align: center; }
    .toast.show{opacity:1;pointer-events:auto;}
    .defect-badge { border-radius:9999px; font-size:12px!important; padding:2px 11px;margin: 0 4px 4px 0; display:inline-block; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .defect-headline { font-size: 15px; font-weight:600; margin-bottom:.5rem }
    .defect-desc { font-size: 11px; color: #666; margin-bottom: .2rem; }
    .defect-block { display:flex; flex-direction: column; min-width:120px; margin-right:9px; margin-bottom:7px;}
    @media print { .flavor-scroll, .sample-list-scroll { max-height: none !important; overflow: visible !important; } body { background: #fff; } .toast { display:none; } }
    @media (max-width:400px) {
      .defect-block { min-width:70px!important;font-size:11px;}
      .defect-badge { font-size:11px!important;padding:1px 6px;}
      .defect-headline { font-size:12.5px;}
    }
    
    /* 향미 선택 개선 */
    .flavor-checkbox-label {
      position: relative;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      margin: 3px;
      font-size: 13px;
      cursor: pointer;
      line-height: 1.2;
      transition: all 0.2s;
    }
    .flavor-checkbox-label:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .flavor-checkbox-label input {
      position: absolute;
      opacity: 0;
    }
    
    /* 샘플 리스트 드래그 앤 드롭 */
    .sample-item {
      cursor: grab;
      transition: background-color 0.2s;
      user-select: none;
      touch-action: none; /* 모바일에서 드래그 사용 가능 */
    }
    .sample-item:active {
      cursor: grabbing;
    }
    .sample-item.sortable-ghost {
      opacity: 0.4;
      background-color: #f0ebdd !important;
    }
    .sample-item.sortable-chosen {
      background-color: #fef9c3 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .sample-drag-handle {
      cursor: grab;
      color: #9ca3af;
      padding: 0 6px;
    }
    
    /* 향미 프로필 레이더 차트 */
    .flavor-profile-chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }
    
    /* 분할 화면 비교 */
    .split-view {
      display: flex;
      flex-direction: row;
      width: 100%;
      gap: 10px;
      margin-top: 20px;
      overflow: auto;
    }
    .split-view-container {
      flex: 1;
      min-width: 200px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
      .split-view {
        flex-direction: column;
      }
    }
    
    /* 터치 최적화 - 모바일 */
    @media (max-width: 768px) {
      .flavor-checkbox-label {
        padding: 8px 14px; /* 더 큰 터치 영역 */
        margin: 4px;
        font-size: 14px;
      }
      .mobile-touch-friendly {
        min-height: 44px; /* 최소 터치 영역 크기 */
      }
      .tab-btn-inactive, .tab-btn-active {
        padding: 8px 16px;
        margin-bottom: 8px;
      }
      input[type="radio"] + span {
        padding: 4px 0;
        margin-left: 4px;
        display: inline-block;
      }
      .score-slider {
        height: 20px; /* 슬라이더 높이 증가 */
      }
      .flavor-badge {
        padding: 4px 12px;
        margin: 3px;
      }
    }
    
    /* 고급 비교 테이블 */
    .advanced-compare-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    .advanced-compare-table th {
      background: #8B5A2B;
      color: white;
      font-weight: 600;
      text-align: left;
      padding: 10px 12px;
      font-size: 13px;
    }
    .advanced-compare-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .advanced-compare-table tr:nth-child(even) {
      background-color: #f9f7f5;
    }
    .advanced-compare-table tr:last-child td {
      border-bottom: none;
    }
    .advanced-compare-table .category-row {
      background-color: #f4eee6;
      font-weight: bold;
    }
    .advanced-compare-category {
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: bold;
      padding: 6px 8px;
      background-color: #f4eee6;
      border-radius: 4px;
    }
    
    /* 모달 스타일 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      display: none; /* 모달은 처음에 보이지 않음 */
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.show {
      display: flex; /* 모달이 보이도록 함 */
    }
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      max-width: 90%;
      max-height: 90vh;
      overflow: auto;
      width: 1200px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-body {
      padding: 1rem;
    }
    
    /* 검색 기능 추가 */
    .search-box {
      position: sticky;
      top: 0;
      background: #f8f8f8;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    /* 차트 컨테이너 높이 지정 - 수정된 부분 */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* 네비게이션 버튼 스타일 */
    .nav-btn {
      padding: 6px 12px;
      background-color: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .nav-btn:hover:not(:disabled) {
      background-color: #e5e7eb;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="min-h-screen bg-[#fcfaf7]">
<div class="max-w-5xl mx-auto p-1 md:p-4 bg-[#fcfaf7]">
  <!-- Header -->
  <header class="flex flex-col md:flex-row items-center justify-between py-4 mb-2 border-b border-tan-300 bg-white rounded-lg shadow-sm">
    <div class="flex items-center">
      <svg width="48" height="48" viewBox="0 0 200 200" class="mr-2"><rect width="200" height="200" fill="black"/><path d="M100,40 L120,60 L110,60 L110,80 L115,90 L105,100 C105,100 120,110 130,120 C140,130 120,150 120,150 L80,150 C80,150 60,130 70,120 C80,110 95,100 95,100 L85,90 L90,80 L90,60 L80,60 Z" fill="#D2B48C"/><circle cx="95" cy="60" r="2" fill="#D2B48C"/><circle cx="105" cy="70" r="2" fill="#D2B48C"/><circle cx="115" cy="65" r="2" fill="#D2B48C"/></svg>
      <span class="text-2xl md:text-3xl font-bold text-tan-900 select-none">mollis</span>
    </div>
    <div class="mt-3 md:mt-0 text-center md:text-right">
      <h2 class="text-lg md:text-2xl font-semibold">SCA 커피 관능 평가</h2>
      <div class="text-xs text-gray-500 mt-1">PC/모바일 대응 · PDF 저장 최적</div>
    </div>
  </header>
  <!-- Sample/Data/Compare Section -->
  <section class="bg-white shadow rounded-lg p-3 md:p-6 mb-3 flex flex-col md:flex-row gap-3">
    <!-- 샘플 관리 -->
    <div class="flex-1 min-w-[260px] mb-3 md:mb-0">
      <div class="mb-3 bg-yellow-50 border border-yellow-200 rounded px-2 py-2 flex items-center text-xs text-yellow-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">샘플 관리 방법 안내:</span><br>
          - <b>샘플 추가</b>로 새로운 커피 평가를 기록/관리할 수 있습니다.<br>
          - <b>샘플 선택</b>시 해당 샘플 내용을 상세 편집/저장하며, 자동저장이 지원됩니다.<br>
          - <b>웹에 전체 저장</b> 또는 <b>웹에서 불러오기</b> 버튼을 통해 LocalStorage에 전체 평가 내역을 관리할 수 있습니다.<br>
          - <b>JSON 내보내기</b> 및 <b>불러오기</b> 기능을 통해 데이터를 파일로 보관/복원할 수 있습니다.
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-database mr-2"></i>샘플 관리/불러오기</h3>
      <div class="flex items-center gap-1 mb-2 flex-wrap">
        <button class="px-2 py-1 export-btn rounded text-xs flex items-center mobile-touch-friendly" id="addSampleBtn"><i class="fa fa-plus mr-2"></i>샘플 추가</button>
        <button class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs flex items-center mobile-touch-friendly" id="removeSampleBtn"><i class="fa fa-trash mr-2"></i>샘플 삭제</button>
        <button class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs flex items-center mobile-touch-friendly" id="cloneSampleBtn"><i class="fa fa-copy mr-2"></i>복제</button>
      </div>
      <div class="sample-list-scroll bg-gray-50 rounded-lg border p-1.5 no-scrollbar">
        <div id="sampleList" class="sample-sortable-list"></div>
        <div class="text-xs text-gray-500 mt-2 px-2">
          <i class="fas fa-arrows-alt"></i> 샘플 순서를 드래그하여 변경할 수 있습니다.
        </div>
      </div>
      <div class="flex flex-wrap gap-1 mt-2">
        <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-xs flex items-center mobile-touch-friendly" id="saveSamplesBtn"><i class="fa fa-save mr-1"></i>웹에 전체 저장</button>
        <button class="px-3 py-1 bg-blue-200 hover:bg-blue-300 text-blue-900 rounded text-xs flex items-center mobile-touch-friendly" id="loadSamplesWebBtn"><i class="fa fa-cloud-download-alt mr-1"></i>웹에서 불러오기</button>
        <button class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-xs flex items-center mobile-touch-friendly" id="exportSamplesBtn"><i class="fa fa-download mr-1"></i>JSON 내보내기</button>
        <label class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-xs flex items-center cursor-pointer mb-0 mobile-touch-friendly"><i class="fa fa-upload mr-1"></i>불러오기<input type="file" id="importSamplesInput" accept=".json" class="hidden"></label>
      </div>
    </div>
    <!-- 커핑 비교 -->
    <div class="flex-1 min-w-[260px]">
      <div class="mb-3 bg-blue-50 border border-blue-200 rounded px-2 py-2 flex items-center text-xs text-blue-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">커핑 기록 비교 안내:</span><br>
          - <b>아래 평가 목록에서 2개 이상 선택</b> 후 <b>비교차트 표시</b>를 클릭하면 SCA 점수/향미/결점 비교차트와 표가 생성됩니다.<br>
          - 다양한 샘플을 추가한 후, 손쉽게 차트로 비교・분석이 가능합니다.<br>
          - 샘플을 새로고침하거나 불러온 후에도 비교기능 사용 가능.<br>
          <span class="text-gray-400">※ 비교 표와 차트는 PDF, 이미지 등으로 저장시 함께 출력됨.</span>
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-code-compare mr-2"></i>커핑 기록 비교</h3>
      <div id="compareListBox" class="mb-2"></div>
      <div class="flex gap-2 flex-wrap">
        <button class="export-btn text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="compareBtn">
          <i class="fa fa-chart-radar mr-1"></i>기본 비교
        </button>
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="advancedCompareBtn">
          <i class="fa fa-chart-line mr-1"></i>고급 비교
        </button>
        <button class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="splitViewBtn">
          <i class="fa fa-columns mr-1"></i>분할 화면
        </button>
      </div>
      <div id="compareArea"><div class="text-xs text-gray-400 my-2">2개 이상 샘플을 선택 후 비교 버튼을 눌러주세요.</div></div>
    </div>
  </section>
  
  <!-- 샘플 네비게이션 (추가된 부분) -->
  <div class="mb-3 bg-white shadow rounded-lg p-3 flex items-center justify-between">
    <button id="prevSampleBtn" class="nav-btn mobile-touch-friendly">
      <i class="fas fa-chevron-left mr-1"></i>이전
    </button>
    <div id="currentSampleIndicator" class="font-bold text-center flex-1 truncate mx-2">현재 샘플: <span class="text-amber-700"></span></div>
    <button id="nextSampleBtn" class="nav-btn mobile-touch-friendly">
      다음<i class="fas fa-chevron-right ml-1"></i>
    </button>
  </div>
  
  <!-- 평가 폼 -->
  <form id="cuppingForm" class="bg-white shadow rounded-lg p-3 md:p-6 mb-4 sample-info">
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <div class="font-bold text-lg mr-2 mb-1">현재 샘플명:</div>
      <input id="sampleTitleInput" type="text" maxlength="60" class="p-1.5 border rounded min-w-[140px] text-base font-semibold" placeholder="샘플명">
      <span id="sampleSavedState" class="ml-2 text-green-700 font-bold text-xs hidden">저장됨</span>
    </div>
    <!-- 커피 정보 -->
    <section>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-mug-hot mr-2"></i>커피 정보</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 grid-cols-sample">
        <div>
          <label class="block text-sm font-semibold mb-1">커피명</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="coffeeName" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">원산지</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="origin" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">품종(Variety)</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="variety" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">가공방식(Process)</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="process" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 날짜</label>
          <input type="date" class="coffee-input w-full border border-tan-300 rounded p-2" id="roastDate">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 레벨</label>
          <select class="coffee-input w-full border border-tan-300 rounded p-2" id="roastLevel">
            <option value="">선택</option>
            <option value="light">Light</option>
            <option value="medium-light">Medium-Light</option>
            <option value="medium">Medium</option>
            <option value="medium-dark">Medium-Dark</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>
    </section>
    <!-- SCA 향미 선택 -->
    <section class="mt-8">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-circle-half-stroke mr-2"></i>SCA 향미 선택</h3>
      <div class="text-xs mb-3 text-gray-600">[프래그런스] [아로마] [플레이버] [에프터테이스트] 각 그룹별로 10개까지 선택</div>
      <button type="button" class="mb-4 px-2 py-1 rounded bg-gray-100 text-xs mobile-touch-friendly" onclick="window.open('https://sca.coffee/research/coffee-tasters-flavor-wheel', '_blank');"> 플레이버 휠 공식자료 <i class="fas fa-external-link-alt ml-1 text-xs"></i> </button>
      <div id="flavorTabs" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="flavorWheelMultiSelectArea" class="flavor-scroll border border-gray-50 rounded-lg p-2 bg-gray-50 no-scrollbar mb-1"></div>
    </section>
    <!-- 단계 속성 -->
    <section class="mt-8">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block mb-1 font-medium tooltip">
            Acidity <span class="text-xs text-gray-500">(산미)</span>
            <span class="tooltip-text">커피의 밝고 상쾌한 특성으로 입에서 느껴지는 신맛의 정도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="acidity_level">
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Sweetness <span class="text-xs text-gray-500">(단맛)</span>
            <span class="tooltip-text">커피에서 느껴지는 달콤함의 정도와 깊이</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="sweetness_level">
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Body <span class="text-xs text-gray-500">(바디감)</span>
            <span class="tooltip-text">커피의 질감과 무게감, 입안에서 느껴지는 밀도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="body_level">
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
      </div>
    </section>
    <!-- 로스팅 디펙트 -->
    <section class="mt-10" id="section-defect">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-fire mr-2"></i>로스팅 디펙트(결점) 선택</h3>
      <div class="text-xs mb-2 text-gray-600"> 각 항목별로 결점의 정도(매우 약함, 약함, 보통, 강함, 매우 강함)를 선택하세요. <span class="text-gray-400 ml-1">* 왜곡되지 않은 평가를 위해 결점이 없으면 "미선택"으로 둡니다.</span> </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div>
          <label class="font-semibold mb-1 flex items-center"> 언더디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                로스팅을 통해 산미, 단맛, 플레이버가 불충분하게 발현.<br>
                공격적인 산미, 피니시/애프터테이스트 부족,<br>
                구개 앞쪽에서 플레이버가 느껴짐.<br>
                <span class="font-semibold">SCA 플레이버휠 'Green/Vegetative'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_underdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 오버디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과도한 로스팅으로 플레이버가 파괴.<br>모든 산미와 플레이버가 사라진 맛.<br>
                <span class="font-semibold">SCA 플레이버휠 'Roasted'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_overdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 베이킹(베이크드)
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                캐러멜 반응 지속시 생기는 결점.<br>팝콘, 딱딱한 시리얼, 귀리맛 등.<br>
                <span class="font-semibold">SCA 플레이버휠 '곡물류'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_baked">
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 스코칭
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과하게 높은 열에 노출된 결점.<br>SCA 플레이버휠의 '재' 또는 '탄 맛' 노트.<br>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_scorching">
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
      </div>
    </section>
    <!-- SCA 점수 (슬라이더별 점수입력) -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-star mr-2"></i>SCA 점수 (0~10점, 0.25단위)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 score-input-wrap">
        <div>
          <label class="block text-sm mb-1 tooltip">프래그런스<span class="tooltip-text">분쇄한 분말 시 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFragrance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFragrance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">아로마<span class="tooltip-text">물 부은 후 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAroma_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAroma" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">플레이버<span class="tooltip-text">혀로 느껴지는 커피의 전반적 맛 특성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFlavor_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFlavor" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">에프터테이스트<span class="tooltip-text">삼킨 후 입안에 남는 좋은 맛의 지속성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAftertaste_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAftertaste" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">액시디티<span class="tooltip-text">밝은 산미, 긍정적이면 높게</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAcidity_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAcidity" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">바디<span class="tooltip-text">입안에서 느껴지는 무게감, 질감</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBody_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBody" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">밸런스<span class="tooltip-text">각 항목의 조화</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBalance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBalance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">오버럴<span class="tooltip-text">총평, 인상</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreOverall_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreOverall" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-end gap-3">
        <div>
          <label class="text-sm block mb-1">총점 (기본 30점+합계)</label>
          <span id="totalScore" class="font-bold inline-block text-lg bg-gray-100 px-4 py-2 rounded border">86.00</span>
        </div>
        <button type="button" id="calcScoreBtn" class="ml-1 mt-2 px-4 py-2 rounded export-btn flex items-center mobile-touch-friendly"><i class="fas fa-equals mr-2"></i>점수 계산</button>
      </div>
    </section>
    <!-- 테이스팅 노트 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-pen-nib mr-2"></i>테이스팅 노트/비고</h3>
      <textarea id="tastingNotes" class="coffee-input w-full min-h-[80px] p-2 border rounded" placeholder="특이사항, 시간, 온도, 커핑 총평 등 메모"></textarea>
    </section>
    <!-- 결과 시각화 및 내보내기 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-chart-radar mr-2"></i>결과 시각화 및 내보내기</h3>
      <div class="visual-section-flex w-full mt-2">
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0 mb-2">
          <h4 class="font-semibold mb-2">향미 특성/속성</h4>
          <div id="selectedFlavorsArea"></div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0">
          <h4 class="font-semibold mb-2">SCA 평가 레이더 차트</h4>
          <canvas id="cuppingRadar" class="w-full max-w-full" height="200"></canvas>
        </div>
      </div>
      <div id="selectedDefectsArea" class="w-full mt-6"></div>
      <div class="flex flex-wrap mt-6 gap-2">
        <button id="exportImgBtn" type="button" class="export-btn px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-image mr-2"></i>이미지로 내보내기</button>
        <button id="exportCsvBtn" type="button" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-file-csv mr-2"></i>CSV로 내보내기</button>
        <button id="exportXlsxBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-file-excel mr-2"></i>엑셀로 내보내기</button>
      </div>
      <div class="text-xs text-gray-400 mt-8 md:mt-12 text-center"> 평가일: <span id="evalDate"></span> | mollis SCA 커피 관능 평가</div>
    </section>
  </form>
</div>

<!-- 분할 화면 비교 모달 -->
<div id="splitViewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="font-bold text-lg">분할 화면 비교</h3>
      <button id="closeSplitViewBtn" class="text-gray-500 hover:text-gray-700 mobile-touch-friendly">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="flex gap-2 mb-4 flex-wrap">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">왼쪽 샘플</label>
          <select id="leftSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">오른쪽 샘플</label>
          <select id="rightSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
      </div>
      <div class="split-view" id="splitViewContainer">
        <div class="split-view-container" id="leftSampleView">
          <div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>
        </div>
        <div class="split-view-container" id="rightSampleView">
          <div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* --- 원본 데이터 및 각종 전역변수 --- */
// 향미 데이터 확장 및 조정
const FLAVOR_DATA = [
  // Fruity - Citrus Fruit
  ["Fruity","Citrus Fruit","Lemon","#FFEB88"],
  ["Fruity","Citrus Fruit","Orange","#FFC300"],
  ["Fruity","Citrus Fruit","Grapefruit","#FF9970"],
  ["Fruity","Citrus Fruit","Lime","#C0E57B"],
  ["Fruity","Citrus Fruit","Tangerine","#FFA54F"],
  ["Fruity","Citrus Fruit","Bergamot","#F9D949"],
  ["Fruity","Citrus Fruit","Yuzu","#EFDF48"],
  
  // Fruity - Other Fruit
  ["Fruity","Other Fruit","Apple","#C4E8A2"],
  ["Fruity","Other Fruit","Pear","#D6ECC2"],
  ["Fruity","Other Fruit","Grape","#A288E3"],
  ["Fruity","Other Fruit","Kiwi","#8FBC8F"],
  ["Fruity","Other Fruit","Watermelon","#E8B4B8"],
  
  // Fruity - Berry
  ["Fruity","Berry","Raspberry","#FF8BA0"],
  ["Fruity","Berry","Strawberry","#FF97A1"],
  ["Fruity","Berry","Blackberry","#D7263D"],
  ["Fruity","Berry","Blueberry","#7099DA"],
  ["Fruity","Berry","Cranberry","#E30B5C"],
  ["Fruity","Berry","Acai","#71466F"],
  
  // Fruity - Stone Fruit
  ["Fruity","Stone Fruit","Peach","#FFCBA4"],
  ["Fruity","Stone Fruit","Apricot","#FBCEB1"],
  ["Fruity","Stone Fruit","Cherry","#DE3163"],
  ["Fruity","Stone Fruit","Plum","#B27AA4"],
  ["Fruity","Stone Fruit","Nectarine","#FFB8A0"],
  
  // Fruity - Tropical Fruit  
  ["Fruity","Tropical Fruit","Pineapple","#FEDF00"],
  ["Fruity","Tropical Fruit","Mango","#FFB300"],
  ["Fruity","Tropical Fruit","Coconut","#F2E8D7"],
  ["Fruity","Tropical Fruit","Passion Fruit","#DDA0DD"],
  ["Fruity","Tropical Fruit","Guava","#F88379"],
  ["Fruity","Tropical Fruit","Banana","#FFEB99"],
  ["Fruity","Tropical Fruit","Lychee","#FFE4E1"],
  ["Fruity","Tropical Fruit","Star Fruit","#FADA5E"],
  ["Fruity","Tropical Fruit","Papaya","#FFDAB9"],
  
  // Fruity - Dried Fruit
  ["Fruity","Dried Fruit","Raisin","#BB9055"],
  ["Fruity","Dried Fruit","Prune","#925E3A"],
  ["Fruity","Dried Fruit","Fig","#8A4117"],
  ["Fruity","Dried Fruit","Date","#A57164"],
  ["Fruity","Dried Fruit","Dried Apple","#D5BA98"],
  ["Fruity","Dried Fruit","Dried Cherry","#A85751"],
  
  // Sweet
  ["Sweet","","Brown Sugar","#B38B57"],
  ["Sweet","","Caramel","#FFB15E"],
  ["Sweet","","Honey","#FDE994"],
  ["Sweet","","Vanilla","#F0D7BC"],
  ["Sweet","Caramelized","Toffee","#D2691E"],
  ["Sweet","Caramelized","Butterscotch","#E09540"],
  ["Sweet","Vanilla","Custard","#F0E68C"],
  ["Sweet","Vanilla","Cream","#FFFDD0"],
  ["Sweet","","Maple Syrup","#C97C5D"],
  ["Sweet","","Molasses","#774936"],
  
  // Floral
  ["Floral","","Jasmine","#DEC2CB"],
  ["Floral","","Rose","#FD5D8B"],
  ["Floral","","Chamomile","#F5E5C0"],
  ["Floral","","Hibiscus","#F53E6A"],
  ["Floral","","Lavender","#B57EDC"],
  ["Floral","","Orange Blossom","#FFCC99"],
  ["Floral","","Elderflower","#F0FFF0"],
  ["Floral","","Honeysuckle","#FFF0DB"],
  ["Floral","","Violet","#C9A0DC"],
  
  // Nutty/Cocoa
  ["Nutty/Cocoa","Nutty","Hazelnut","#D7C2A8"],
  ["Nutty/Cocoa","Nutty","Almond","#DBD3C9"],
  ["Nutty/Cocoa","Nutty","Peanut","#D28C78"],
  ["Nutty/Cocoa","Nutty","Walnut","#C19A6B"],
  ["Nutty/Cocoa","Nutty","Cashew","#F5DEB3"],
  ["Nutty/Cocoa","Cocoa","Dark Chocolate","#6C4F3D"],
  ["Nutty/Cocoa","Cocoa","Cocoa","#926F34"],
  ["Nutty/Cocoa","Cocoa","Milk Chocolate","#7B3F00"],
  ["Nutty/Cocoa","Cocoa","Bittersweet Chocolate","#332421"],
  ["Nutty/Cocoa","Cocoa","Mocha","#785135"],
  
  // Spices
  ["Spices","","Cinnamon","#E5B39B"],
  ["Spices","","Clove","#C17855"],
  ["Spices","","Pepper","#818286"],
  ["Spices","","Nutmeg","#BD9C7F"],
  ["Spices","Warming Spices","Cardamom","#BDA55D"],
  ["Spices","Warming Spices","Allspice","#9C5903"],
  ["Spices","Pungent Spices","Licorice","#2A2926"],
  ["Spices","Pungent Spices","Anise","#50404D"],
  ["Spices","","Ginger","#EFCC9C"],
  ["Spices","","Vanilla Bean","#F3E5AB"],
  
  // Cereal/Grain
  ["Cereal/Grain","Cereal","Malt","#F0E68C"],
  ["Cereal/Grain","Cereal","Toast","#D2B48C"],
  ["Cereal/Grain","Cereal","Barley","#DBD0AE"],
  ["Cereal/Grain","Grain-like","Granola","#C8A951"],
  ["Cereal/Grain","Grain-like","Oats","#E4CBB1"],
  ["Cereal/Grain","Grain-like","Rice","#F9FBE7"],
  ["Cereal/Grain","Grain-like","Wheat","#EAD9A7"],
  ["Cereal/Grain","Grain-like","Corn","#FFF380"],
  
  // Roasted
  ["Roasted","","Brown Roast","#5C4033"],
  ["Roasted","","Smoky","#463F3A"],
  ["Roasted","Light Roast","Tea-like","#967969"],
  ["Roasted","Light Roast","Herbal","#BDCB96"],
  ["Roasted","Medium Roast","Toasty","#C19A6B"],
  ["Roasted","Medium Roast","Caramelized","#C68E17"],
  ["Roasted","Dark Roast","Burnt","#373536"],
  ["Roasted","Dark Roast","Charred","#2C1608"],
  ["Roasted","Dark Roast","Ashy","#5D5D5D"],
  
  // Green/Vegetative
  ["Green/Vegetative","","Under-ripe","#A4C09C"],
  ["Green/Vegetative","","Peapod","#B2DAC0"],
  ["Green/Vegetative","","Fresh","#C2E99E"],
  ["Green/Vegetative","Fresh Green","Grass","#7EC850"],
  ["Green/Vegetative","Fresh Green","Cucumber","#8FBC8F"],
  ["Green/Vegetative","Fresh Green","Green Bell Pepper","#4F7942"],
  ["Green/Vegetative","Herbaceous","Mint","#98FB98"],
  ["Green/Vegetative","Herbaceous","Sage","#BCB88A"],
  ["Green/Vegetative","Herbaceous","Basil","#579229"],
  ["Green/Vegetative","Vegetal","Olive","#708238"],
  ["Green/Vegetative","Vegetal","Spinach","#175732"],
  
  // Sour/Fermented
  ["Sour/Fermented","Sour","Citric Acid","#CEE6CB"],
  ["Sour/Fermented","Sour","Malic Acid","#C9E265"],
  ["Sour/Fermented","Sour","Acetic Acid","#D9C1B4"],  ["Sour/Fermented","Clean Acidity","Tartaric Acid","#D7E8CB"],
  ["Sour/Fermented","Clean Acidity","Phosphoric Acid","#E8F3D9"],
  ["Sour/Fermented","Fermented","Winey","#AC436E"],
  ["Sour/Fermented","Fermented","Overripe","#625958"],
  ["Sour/Fermented","Fermented","Yogurt","#F5F5F5"],
  ["Sour/Fermented","Fermented","Sourdough","#E8D0A7"],
  ["Sour/Fermented","Fermented","Vinegar","#ECEDE6"],
  ["Sour/Fermented","Fermented","Kombucha","#DEC19B"],
  ["Sour/Fermented","Aged/Funky","Musty","#8B7D6B"],
  ["Sour/Fermented","Aged/Funky","Earthy","#79553D"],
  
  // Other
  ["Other","","Chemical","#FCF6B1"],
  ["Other","","Medicinal","#E2D784"],
  ["Other","Chemical","Rubber","#454545"],
  ["Other","Chemical","Petroleum","#2E2E2E"],
  ["Other","Chemical","Plastic","#BEBEBE"],
  ["Other","Chemical","Tar","#1C1C1C"],
  ["Other","Earthy","Soil","#6F4E37"],
  ["Other","Earthy","Mushroom","#D7CEC7"],
  ["Other","Earthy","Forest Floor","#5E4B3B"],
  ["Other","Earthy","Wet Earth","#622F22"],
  ["Other","Woody","Oak","#A46B2B"],
  ["Other","Woody","Cedar","#A67B5B"],
  ["Other","Woody","Pine","#8A9A5B"],
  ["Other","Woody","Sandalwood","#B87333"]
];

const FLAVOR_PHASES=[{id:"fragrance",label:"프래그런스"},{id:"aroma",label:"아로마"},{id:"flavor",label:"플레이버"},{id:"aftertaste",label:"에프터테이스트"}];
const ATTR_TO_BADGE={acidityLevel:{label:"산미",color:"#FF6B6B"},sweetnessLevel:{label:"단맛",color:"#51CF66"},bodyLevel:{label:"바디감",color:"#339AF0"}};
const ATTR_VALUE_LABELS={"Low":"Low","Med-Low":"Med-Low","Medium":"Medium","Med-High":"Med-High","High":"High"};
const DEFECT_LABELS={none:{label:"미선택",color:"#bbb" },very_weak:{label:"매우 약함",color:"#9ad0c2"},weak:{label:"약함",color:"#95a7f2"},moderate:{label:"보통",color:"#f6c177"},strong:{label:"강함",color:"#f59f4c"},very_strong:{label:"매우 강함",color:"#fc4747"} };
const DEFECT_PROPS=[{key:"defectUnderdevelopment",label:"언더디벨롭먼트",desc:"로스팅 불충분, 강한 산미, 피니시/애프터 부족",wheel:"Green/Vegetative"},{key:"defectOverdevelopment",label:"오버디벨롭먼트",desc:"과도한 로스팅으로 산미, 플레이버 소멸",wheel:"Roasted"},{key:"defectBaked",label:"베이킹(베이크드)",desc:"팝콘/귀리/시리얼류 결점, 캐러멜화 과잉",wheel:"곡물(Cereal/Grain)"},{key:"defectScorching",label:"스코칭",desc:"탄맛, 과다열 노출, 재/탄 노트",wheel:"Roasted"}];

// 향미 카테고리별 그룹핑
const FLAVOR_CATEGORIES = [
  { name: "과일류", categories: ["Fruity"], color: "#FFB8A0" },
  { name: "달콤함", categories: ["Sweet"], color: "#FDE994" },
  { name: "꽃향", categories: ["Floral"], color: "#F5E5C0" },
  { name: "견과/초콜릿", categories: ["Nutty/Cocoa"], color: "#D7C2A8" },
  { name: "향신료", categories: ["Spices"], color: "#BDA55D" },
  { name: "곡물/시리얼", categories: ["Cereal/Grain"], color: "#E4CBB1" },
  { name: "로스팅", categories: ["Roasted"], color: "#967969" },
  { name: "풀/채소류", categories: ["Green/Vegetative"], color: "#A4C09C" },
  { name: "산미/발효", categories: ["Sour/Fermented"], color: "#CEE6CB" },
  { name: "기타", categories: ["Other"], color: "#D7CEC7" }
];

let samples = [];
let currentSampleId = null;
let sampleSaveTimeout = null;
let flavorProfileChart = null; // 향미 프로필 차트 객체
let sortableInstance = null; // Sortable 인스턴스를 저장할 변수

function getEmptySampleData(){
  let flavorSelections = {}; FLAVOR_PHASES.forEach(phase=> flavorSelections[phase.id] = [] );
  return {
    title: "", coffeeName: "", origin: "", variety: "", process: "", roastDate: "", roastLevel: "",
    flavorSelections, acidityLevel: "", sweetnessLevel: "", bodyLevel: "",
    defectUnderdevelopment: "none", defectOverdevelopment: "none", defectBaked: "none", defectScorching: "none",
    scoreFragrance: 7, scoreAroma: 7, scoreFlavor: 7, scoreAftertaste: 7, scoreAcidity: 7, scoreBody:7, scoreBalance:7, scoreOverall:7,
    tastingNotes: "", lastEdit: +(new Date())
  };
}

function createNewSampleObj(title){
  let id = "sample_"+Date.now()+"_"+Math.floor(Math.random()*10000);
  return {id, title:title||"새 샘플", sampleData: getEmptySampleData(), lastEdit: +(new Date())};
}

// 현재 샘플 표시 업데이트 함수
function updateCurrentSampleIndicator() {
  const indicator = document.getElementById('currentSampleIndicator');
  if (!indicator) return;
  
  const currentSample = getCurrentSampleObj();
  if (currentSample) {
    indicator.querySelector('span').textContent = currentSample.title || "샘플";
    
    // 현재 위치 표시 (예: 2/5)
    const currentIndex = samples.findIndex(s => s.id === currentSampleId);
    if (currentIndex > -1) {
      indicator.querySelector('span').textContent += ` (${currentIndex + 1}/${samples.length})`;
    }
  } else {
    indicator.querySelector('span').textContent = "샘플 없음";
  }
}

// 네비게이션 버튼 상태 업데이트
function updateNavigationButtons() {
  const prevBtn = document.getElementById('prevSampleBtn');
  const nextBtn = document.getElementById('nextSampleBtn');
  
  if (!prevBtn || !nextBtn || !samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  
  prevBtn.disabled = currentIndex <= 0;
  prevBtn.classList.toggle('opacity-50', currentIndex <= 0);
  prevBtn.classList.toggle('cursor-not-allowed', currentIndex <= 0);
  
  nextBtn.disabled = currentIndex >= samples.length - 1;
  nextBtn.classList.toggle('opacity-50', currentIndex >= samples.length - 1);
  nextBtn.classList.toggle('cursor-not-allowed', currentIndex >= samples.length - 1);
}

// 이전 샘플로 이동
function goToPrevSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex > 0) {
    loadSample(samples[currentIndex - 1].id);
  }
}

// 다음 샘플로 이동
function goToNextSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex < samples.length - 1) {
    loadSample(samples[currentIndex + 1].id);
  }
}

function renderSampleList(){
  let listDiv = document.getElementById('sampleList');
  if(!samples.length){
    listDiv.innerHTML = `<div class="text-gray-500 text-xs my-3 text-center">샘플 없음<br>새로 추가하세요.</div>`;
    updateNavigationButtons();
    updateCurrentSampleIndicator();
    return;
  }
  
  // 드래그 앤 드롭 가능한 샘플 리스트로 변경
  let html = '';
  samples.forEach(sm => {
    html += `
      <div class="flex justify-between items-center border rounded-lg px-2 py-1 mb-1 sample-item ${sm.id === currentSampleId ? "bg-yellow-100 border-yellow-700" : "bg-white border-gray-200"}" data-id="${sm.id}">
        <div class="sample-drag-handle"><i class="fas fa-grip-lines"></i></div>
        <span class="truncate text-sm flex-1 ${sm.id === currentSampleId ? "font-bold" : ""}">${sm.title || "샘플"}</span>
        <span class="text-xs ml-2 text-gray-400">${sm.sampleData && sm.sampleData.roastDate ? sm.sampleData.roastDate : ""}</span>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
  
  // 샘플 클릭 이벤트
  Array.from(listDiv.querySelectorAll('.sample-item')).forEach(el => {
    el.addEventListener('click', (e) => {
      // 드래그 핸들을 클릭했을 때는 로드하지 않음
      if (!e.target.closest('.sample-drag-handle')) {
        let id = el.getAttribute('data-id');
        if (id !== currentSampleId) {
          loadSample(id);
        }
      }
    });
    
    // 샘플 복제를 위한 컨텍스트 메뉴(우클릭) 이벤트
    el.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const sampleId = el.getAttribute('data-id');
      if (confirm("이 샘플을 복제하시겠습니까?")) {
        cloneSample(sampleId);
      }
    });
    
    // 모바일에서 길게 누르기로 샘플 복제
    el.addEventListener('touchstart', function(e) {
      if (e.target.closest('.sample-drag-handle')) return; // 드래그 핸들 터치 시 무시
      
      const longPressTimer = setTimeout(() => {
        const sampleId = el.getAttribute('data-id');
        if (confirm("이 샘플을 복제하시겠습니까?")) {
          cloneSample(sampleId);
        }
      }, 800); // 800ms 이상 누르면 복제 다이얼로그 표시
      
      // 터치 종료 시 타이머 제거
      const clearTimer = () => clearTimeout(longPressTimer);
      el.addEventListener('touchend', clearTimer, { once: true });
      el.addEventListener('touchcancel', clearTimer, { once: true });
    });
  });
  
  // Sortable.js 초기화 - 드래그 앤 드롭
  // 기존 인스턴스가 있으면 파괴
  if (sortableInstance) {
    sortableInstance.destroy();
  }
  
  if (samples.length > 1) {
    sortableInstance = new Sortable(listDiv, {
      animation: 150,
      handle: '.sample-drag-handle',
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      onEnd: function (evt) {
        // 드래그 앤 드롭 후 배열 재정렬
        const oldIndex = evt.oldIndex;
        const newIndex = evt.newIndex;
        
        if (oldIndex !== newIndex) {
          const item = samples[oldIndex];
          samples.splice(oldIndex, 1);
          samples.splice(newIndex, 0, item);
          saveSamplesToStorage();
          updateNavigationButtons();
          updateCurrentSampleIndicator();
        }
      }
    });
  }
  
  updateNavigationButtons();
  updateCurrentSampleIndicator();
  renderCompareList(); // 샘플 변경시 항상 compare UI 새로 그리기
  
  // 분할 화면 비교 셀렉트박스 업데이트
  updateSplitViewSelects();
}

// 샘플 복제 기능
function cloneSample(sampleId) {
  const originalSample = samples.find(s => s.id === sampleId);
  if (!originalSample) return;
  
  // 깊은 복사를 통해 완전한 복제본 생성
  const clonedData = JSON.parse(JSON.stringify(originalSample.sampleData));
  const newId = "sample_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
  const clonedSample = {
    id: newId,
    title: originalSample.title + " (복사본)",
    sampleData: clonedData,
    lastEdit: +(new Date())
  };
  
  samples.unshift(clonedSample); // 배열 맨 앞에 추가
  currentSampleId = newId;
  renderSampleList();
  setUIFromSample(clonedSample.sampleData);
  saveSamplesToStorage();
  showToast("샘플을 복제했습니다.");
}

function loadSamplesFromStorage(){
  try{
    let raw = localStorage.getItem("mollis_sca_samples2");
    if(raw){ samples = JSON.parse(raw); if(!Array.isArray(samples)){samples=[];} }
  }catch(e){samples=[];}
  if(samples.length===0){
    let defaultSample = createNewSampleObj("샘플 #1");
    samples.push(defaultSample);
    currentSampleId = defaultSample.id;
    saveSamplesToStorage();
  }
  if(!currentSampleId || !samples.find(s=>s.id===currentSampleId)){ currentSampleId = samples[0].id; }
  renderSampleList();
}

function saveSamplesToStorage(){
  localStorage.setItem("mollis_sca_samples2", JSON.stringify(samples));
  document.getElementById('sampleSavedState').classList.remove("hidden");
  setTimeout(()=>document.getElementById('sampleSavedState').classList.add("hidden"), 900);
}

function showToast(msg) {
  try {
    let toast = document.getElementById('toast');
    toast.innerHTML = msg;
    toast.classList.add('show');
    setTimeout(()=>{toast.classList.remove('show');},1800);
  } catch(e) {}
}

function saveCurrentSample(applyInput=true){
  let sampleIdx = samples.findIndex(s=>s.id===currentSampleId);
  if(sampleIdx!==-1){
    if(applyInput){
      saveUIToSample(samples[sampleIdx].sampleData);
    }
    let titleVal = document.getElementById('sampleTitleInput').value.trim();
    samples[sampleIdx].title = titleVal || "샘플";
    samples[sampleIdx].sampleData.title = samples[sampleIdx].title;
    samples[sampleIdx].lastEdit = +(new Date());
    renderSampleList();
    saveSamplesToStorage();
  }
}

function loadSample(sampleId){
  // 현재 샘플 저장
  if(currentSampleId) {
    saveCurrentSample();
  }
  
  let sampleObj = samples.find(s=>s.id===sampleId);
  if(sampleObj){
    currentSampleId = sampleId;
    setUIFromSample(sampleObj.sampleData);
    renderSampleList();
  }
}

function setUIFromSample(sampleData){
  document.getElementById('sampleTitleInput').value = sampleData.title||'';
  document.getElementById('coffeeName').value = sampleData.coffeeName||'';
  document.getElementById('origin').value = sampleData.origin||'';
  document.getElementById('variety').value = sampleData.variety||'';
  document.getElementById('process').value = sampleData.process||'';
  document.getElementById('roastDate').value = sampleData.roastDate||'';
  document.getElementById('roastLevel').value = sampleData.roastLevel||'';
  ["acidity","sweetness","body"].forEach(group=>{
    let v = sampleData[group+"Level"]||"";
    let groupRadio = 'input[name="'+group+'Level"]';
    if(v){
      let radio = document.querySelector(groupRadio+'[value="'+v+'"]');
      if(radio) radio.checked = true;
    } else{
      let radios = document.querySelectorAll(groupRadio); radios.forEach(r=>r.checked = false);
    }
  });
  DEFECT_PROPS.forEach(d=>{
    const val = sampleData[d.key] || "none";
    let radioNode = document.querySelector('input[name="'+d.key+'"][value="'+val+'"]');
    if(radioNode) radioNode.checked = true;
  });
  [
    ["scoreFragrance","scoreFragrance"],["scoreAroma","scoreAroma"],["scoreFlavor","scoreFlavor"],["scoreAftertaste","scoreAftertaste"],
    ["scoreAcidity","scoreAcidity"],["scoreBody","scoreBody"],["scoreBalance","scoreBalance"],["scoreOverall","scoreOverall"]
  ].forEach(([key,id])=>{
    document.getElementById(id).value = sampleData[key]||7;
    document.getElementById(id+"_slider").value = sampleData[key]||7;
  });
  document.getElementById('tastingNotes').value = sampleData.tastingNotes||'';
  renderSelectedFlavorsArea(sampleData);
  renderSelectedDefectsArea(sampleData);
  updateRadar(sampleData);
  updateTotalScore(sampleData);
  renderFlavorTabs();
  renderFlavorPhase();
}

function saveUIToSample(targetDataObj){
  let sampleData = targetDataObj||getCurrentSampleObj().sampleData;
  sampleData.title = document.getElementById('sampleTitleInput').value||"";
  sampleData.coffeeName = document.getElementById('coffeeName').value;
  sampleData.origin = document.getElementById('origin').value;
  sampleData.variety = document.getElementById('variety').value;
  sampleData.process = document.getElementById('process').value;
  sampleData.roastDate = document.getElementById('roastDate').value;
  sampleData.roastLevel = document.getElementById('roastLevel').value;
  sampleData.acidityLevel = getCheckedRadio('acidityLevel');
  sampleData.sweetnessLevel = getCheckedRadio('sweetnessLevel');
  sampleData.bodyLevel = getCheckedRadio('bodyLevel');
  DEFECT_PROPS.forEach(d=>{
    sampleData[d.key] = getCheckedRadio(d.key)||"none";
  });
  sampleData.scoreFragrance = parseFloat(document.getElementById('scoreFragrance').value) || 0;
  sampleData.scoreAroma = parseFloat(document.getElementById('scoreAroma').value) || 0;
  sampleData.scoreFlavor = parseFloat(document.getElementById('scoreFlavor').value) || 0;
  sampleData.scoreAftertaste = parseFloat(document.getElementById('scoreAftertaste').value) || 0;
  sampleData.scoreAcidity = parseFloat(document.getElementById('scoreAcidity').value) || 0;
  sampleData.scoreBody = parseFloat(document.getElementById('scoreBody').value) || 0;
  sampleData.scoreBalance = parseFloat(document.getElementById('scoreBalance').value) || 0;
  sampleData.scoreOverall = parseFloat(document.getElementById('scoreOverall').value) || 0;
  sampleData.tastingNotes = document.getElementById('tastingNotes').value;
  sampleData.lastEdit = +(new Date());
}

function getCurrentSampleObj(){ return samples.find(s=>s.id===currentSampleId); }

// FlavorTabs/Phase
let currentFlavorPhase = "fragrance";

function renderFlavorTabs(){
  const tabs = document.getElementById('flavorTabs');
  tabs.innerHTML = '';
  FLAVOR_PHASES.forEach(phase=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'flavor-phase-btn font-bold rounded px-4 py-1 mr-1 mb-1 mobile-touch-friendly ' + (currentFlavorPhase === phase.id ? 'tab-btn-active' : 'tab-btn-inactive');
    btn.textContent = phase.label;
    btn.dataset.flavorphase = phase.id;
    btn.onclick = () => {
      currentFlavorPhase = phase.id;
      renderFlavorTabs();
      renderFlavorPhase();
    };
    tabs.appendChild(btn);
  });
}

function renderFlavorPhase(){
  let curSel = getCurrentSampleObj().sampleData.flavorSelections[currentFlavorPhase]||[];
  let outer = document.getElementById('flavorWheelMultiSelectArea');
  let catMap = {};
  FLAVOR_DATA.forEach(([cat, sub, desc, color])=>{
    if(!catMap[cat])catMap[cat] = [];
    catMap[cat].push({sub,desc,color});
  });
  
  // 검색 기능 추가
  let html = `
    <div class="search-box mb-3">
      <input type="text" id="flavorSearchInput" class="search-input" 
        placeholder="향미 검색 (예: berry, chocolate, floral...)">
    </div>
  `;
  
  for(let cat in catMap){
    html += `<div class="flavor-category mb-3 mt-2"><div class="font-bold mb-1">${cat}</div>`;
    let subMap = {};
    catMap[cat].forEach(f=>{
      let k = f.sub||'특징없음';
      if(!subMap[k])subMap[k]=[];
      subMap[k].push(f);
    });
    for(let sub in subMap){
      html += `<div class="flavor-subcategory mb-2 ml-2"><span class="font-semibold text-sm">${sub!=='특징없음'?sub:""}</span>&nbsp;`;
      subMap[sub].forEach(f=>{
        let id = cat+'|'+sub+'|'+f.desc;
        let checked = curSel.includes(id) ? ' checked ':'';
        let textColor = getContrastColor(f.color);
        
        html+=`<label class="flavor-checkbox-label" style="background:${f.color};color:${textColor};box-shadow:${checked?'0 0 0 1px #000, inset 0 0 0 1px rgba(255,255,255,0.4)':'none'}" data-category="${cat}" data-subcategory="${sub}" data-flavor="${f.desc.toLowerCase()}">
          <input type="checkbox" class="flavorSelectBox" data-key="${id}" ${checked}> ${f.desc}
        </label>`;
      });
      html += '</div>';
    } html+='</div>';
  }
  outer.innerHTML = html;
  
  // 검색 기능 추가
  const searchInput = document.getElementById('flavorSearchInput');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim().toLowerCase();
      if (searchTerm === '') {
        // 모든 항목 표시
        document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
          label.style.display = '';
        });
        document.querySelectorAll('.flavor-category, .flavor-subcategory').forEach(item => {
          item.style.display = '';
        });
      } else {
        // 검색어에 맞는 항목만 표시
        document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
          const category = label.dataset.category.toLowerCase();
          const subcategory = label.dataset.subcategory.toLowerCase();
          const flavor = label.dataset.flavor;
          
          if (category.includes(searchTerm) || subcategory.includes(searchTerm) || flavor.includes(searchTerm)) {
            label.style.display = '';
          } else {
            label.style.display = 'none';
          }
        });
        
        // 빈 서브카테고리 및 카테고리 숨기기
        document.querySelectorAll('.flavor-subcategory').forEach(subcat => {
          const hasVisibleItems = Array.from(subcat.querySelectorAll('.flavor-checkbox-label')).some(
            label => label.style.display !== 'none'
          );
          subcat.style.display = hasVisibleItems ? '' : 'none';
        });
        
        document.querySelectorAll('.flavor-category').forEach(cat => {
          const hasVisibleItems = Array.from(cat.querySelectorAll('.flavor-subcategory')).some(
            subcat => subcat.style.display !== 'none'
          );
          cat.style.display = hasVisibleItems ? '' : 'none';
        });
      }
    });
  }
  
  outer.querySelectorAll('.flavorSelectBox').forEach(cb=>{
    cb.onchange = function(){
      let sel = getCurrentSampleObj().sampleData.flavorSelections[currentFlavorPhase];
      let key = this.getAttribute('data-key');
      if(this.checked){
        if(sel.length<10) sel.push(key);
        else {
          this.checked = false;
          showToast("각 항목당 최대 10개까지만 선택 가능합니다.");
          return;
        }
        this.parentNode.style.boxShadow = '0 0 0 1px #000, inset 0 0 0 1px rgba(255,255,255,0.4)';
      } else{
        let idx = sel.indexOf(key); if(idx>-1) sel.splice(idx,1);
        this.parentNode.style.boxShadow = 'none';
      }
      renderSelectedFlavorsArea();
      scheduleAutoSave();
    }
  });
}

// 향미 특성/속성 실시간 반영
function renderSelectedFlavorsArea(_data){
  let sampleData = _data||getCurrentSampleObj().sampleData;
  let html = '';
  FLAVOR_PHASES.forEach(phase=>{
    let phaseSel = (sampleData.flavorSelections[phase.id]||[]).map(key=>{
      let [cat,sub,desc] = key.split('|');
      let rec = FLAVOR_DATA.find(f=>f[0]===cat&&f[1]===sub&&f[2]===desc);
      let color = rec?rec[3]:'#B8B2A5';
      // 색상 대비 계산하여 텍스트 색상 결정
      let textColor = getContrastColor(color);
      return `<span class="flavor-badge" style="background:${color};color:${textColor};">${desc}</span>`;
    });
    html+=`<div class="mb-1"><span class="font-bold">${phase.label}:</span> ${phaseSel.join(' ')||'<span class="text-xs text-gray-400">없음</span>'}</div>`;
  });
  
  // 속성 표시 - 실시간 반영되도록 getCurrentSampleObj() 적용
  html += `<div class="mt-2 mb-1 flex flex-wrap items-center">`;
  let currentSample = getCurrentSampleObj();
  if (currentSample) {
    Object.keys(ATTR_TO_BADGE).forEach(attrKey=>{
      let attrMeta = ATTR_TO_BADGE[attrKey];
      let val = currentSample.sampleData[attrKey];
      if(val){
        html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;">${attrMeta.label}: ${ATTR_VALUE_LABELS[val]}</span>`;
      } else {
        html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;opacity:0.5;">${attrMeta.label}: 미선택</span>`;
      }
    });
  }
  html += `</div>`;
  
  // 로스팅 디펙트 표시 - 실시간 반영되도록 getCurrentSampleObj() 적용
  html += `<div class="mt-2"><span class="font-bold">로스팅 디펙트:</span> <div class="flex flex-wrap gap-1 mt-1">`;
  let hasDefect = false;
  if (currentSample) {
    DEFECT_PROPS.forEach(d=>{
      const val = currentSample.sampleData[d.key]||"none";
      if(val !== "none") {
        const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
        html += `<span class="flavor-badge" style="background:${dColor};color:#fff;">${d.label}: ${DEFECT_LABELS[val].label}</span>`;
        hasDefect = true;
      }
    });
  }
  
  // 선택된 디펙트가 없는 경우
  if(!hasDefect) {
    html += `<span class="text-xs text-gray-400">선택된 디펙트 없음</span>`;
  }
  
  html += `</div></div>`;
  document.getElementById('selectedFlavorsArea').innerHTML = html;
}

// 디펙트 영역은 비워둠
function renderSelectedDefectsArea(){
  document.getElementById('selectedDefectsArea').innerHTML = '';
}

// 배경색에 따라 대비되는 텍스트 색상 반환 (가독성 향상)
function getContrastColor(hexColor) {
  // 색상이 어두운지 밝은지 판단
  if (!hexColor) return '#000000';
  
  // 16진수 색상값 파싱
  let r, g, b;
  if (hexColor.startsWith('#')) {
    hexColor = hexColor.substring(1);
  }
  
  // 3자리 헥스코드 처리 (#RGB)
  if (hexColor.length === 3) {
    r = parseInt(hexColor.charAt(0) + hexColor.charAt(0), 16);
    g = parseInt(hexColor.charAt(1) + hexColor.charAt(1), 16);
    b = parseInt(hexColor.charAt(2) + hexColor.charAt(2), 16);
  } 
  // 6자리 헥스코드 처리 (#RRGGBB)
  else if (hexColor.length === 6) {
    r = parseInt(hexColor.substring(0, 2), 16);
    g = parseInt(hexColor.substring(2, 4), 16);
    b = parseInt(hexColor.substring(4, 6), 16);
  } else {
    return '#000000'; // 기본값
  }
  
  // 밝기 계산 (YIQ 공식)
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  
  // 밝은 색상이면 검정, 어두운 색상이면 흰색 반환
  return brightness > 128 ? '#000000' : '#FFFFFF';
}

function getCheckedRadio(name){ let r = document.querySelector('input[name="'+name+'"]:checked'); return r?r.value:""; }

function updateTotalScore(_data){
  let s = _data||getCurrentSampleObj().sampleData;
  let sum = 30 + s.scoreFragrance + s.scoreAroma + s.scoreFlavor + s.scoreAftertaste + s.scoreAcidity + s.scoreBody + s.scoreBalance + s.scoreOverall;
  document.getElementById('totalScore').textContent = sum.toFixed(2);
}

// SCA Radar Chart
let radarChartObj = null;
function updateRadar(_data){
  let s = _data||getCurrentSampleObj().sampleData;
  if(!radarChartObj){
    radarChartObj = new Chart(document.getElementById('cuppingRadar').getContext('2d'), {
      type: "radar",
      data: {
        labels:["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"],
        datasets:[{label:"점수",data:[7,7,7,7,7,7,7,7], backgroundColor:"rgba(139,90,43,0.15)",borderColor:"#8B5A2B",pointBackgroundColor:"#8B5A2B"}]
      },
      options: { responsive:true, plugins:{legend:{display:false}}, scales:{r:{ min:0,max:10,ticks:{stepSize:2, font:{family:"Noto Sans KR", size:13}}, pointLabels:{font:{family:"Noto Sans KR", weight:"bold", size:13}} }} }
    });
  }
  let chart = radarChartObj;
  chart.data.datasets[0].data = [
    s.scoreFragrance, s.scoreAroma, s.scoreFlavor, s.scoreAftertaste,
    s.scoreAcidity, s.scoreBody, s.scoreBalance, s.scoreOverall
  ];
  chart.update();
}

// 자동 저장 스케줄링
function scheduleAutoSave() {
  if (sampleSaveTimeout) clearTimeout(sampleSaveTimeout);
  sampleSaveTimeout = setTimeout(() => {
    saveCurrentSample();
  }, 3000); // 3초 후 저장
}

// 수치입력, 슬라이더/인풋 동기화
(()=>{
  let scoreFieldList = ["Fragrance","Aroma","Flavor","Aftertaste","Acidity","Body","Balance","Overall"];
  scoreFieldList.forEach(field=>{
    let numId = "score"+field, sliderId = "score"+field+"_slider";
    let numInput = document.getElementById(numId);
    let sliderInput= document.getElementById(sliderId);
    numInput.oninput = numInput.onchange = ()=>{
      sliderInput.value = numInput.value;
      updateTotalScore();
      updateRadar();
      scheduleAutoSave();
    };
    sliderInput.oninput = sliderInput.onchange = ()=>{
      numInput.value = sliderInput.value;
      updateTotalScore();
      updateRadar();
      scheduleAutoSave();
    }
  });
})();

// 속성 변경 이벤트 설정 (산미, 단맛, 바디)
["acidityLevel","sweetnessLevel","bodyLevel"].forEach(gr=>{
  document.querySelectorAll('input[name="'+gr+'"]').forEach(r=>{
    r.onchange = ()=>{
      renderSelectedFlavorsArea(); // 속성 변경시 실시간 반영
      scheduleAutoSave();
    }
  });
});

// 기본 필드 변경 이벤트
["coffeeName","origin","variety","process","roastDate","roastLevel","tastingNotes"].forEach(id=>{
  document.getElementById(id).onblur = ()=>{ scheduleAutoSave(); };
});

// 디펙트: radio 이벤트
DEFECT_PROPS.forEach(d=>{
  document.querySelectorAll('input[name="'+d.key+'"]').forEach(radio=>{
    radio.onchange = ()=>{
      renderSelectedFlavorsArea(); // 디펙트 변경시 실시간 반영
      scheduleAutoSave();
    }
  });
});

document.getElementById('calcScoreBtn').onclick = ()=>{
  saveCurrentSample();
  updateTotalScore();
  updateRadar();
};

// 이미지로 내보내기 - 향미 프로필 차트 제거
document.getElementById('exportImgBtn').onclick = ()=>{
  saveCurrentSample();
  let s = getCurrentSampleObj().sampleData;
  const tempRoot = document.createElement('div');
  tempRoot.style.backgroundColor = "#fcfaf7";
  tempRoot.style.padding = "32px 40px";
  tempRoot.style.maxWidth = "800px";
  tempRoot.style.fontFamily = "'Noto Sans KR', sans-serif";
  tempRoot.style.position = "absolute";
  tempRoot.style.left = "-9999px";
  tempRoot.style.top = "0";
  
  tempRoot.innerHTML = `
  <h2 style="text-align:center;margin-bottom:22px;font-size:24px;font-weight:bold;color:#8B5A2B;border-bottom:2px solid #8B5A2B;padding-bottom:8px;">커피 관능 평가 결과</h2>
  
  <div style="margin-bottom:25px;">
    <table style="width:100%;border-spacing:0;border-collapse:separate;font-size:14px;">
      <tr>
        <td style="padding:4px 5px 8px 0;font-weight:bold;width:120px;">커피명</td>
        <td style="padding:4px 15px 8px 0;">${s.coffeeName||"<span style='color:#BBB;'>미입력</span>"}</td>
        <td style="padding:4px 5px 8px 0;font-weight:bold;width:100px;">원산지</td>
        <td style="padding:4px 0 8px 0;">${s.origin||"<span style='color:#BBB;'>미입력</span>"}</td>
      </tr>
      <tr>
        <td style="padding:4px 5px 8px 0;font-weight:bold;">품종(Variety)</td>
        <td style="padding:4px 15px 8px 0;">${s.variety||"<span style='color:#BBB;'>미입력</span>"}</td>
        <td style="padding:4px 5px 8px 0;font-weight:bold;">가공방식</td>
        <td style="padding:4px 0 8px 0;">${s.process||"<span style='color:#BBB;'>미입력</span>"}</td>
      </tr>
      <tr>
        <td style="padding:4px 5px 8px 0;font-weight:bold;">로스팅 날짜</td>
        <td style="padding:4px 15px 8px 0;">${s.roastDate||"<span style='color:#BBB;'>미입력</span>"}</td>
        <td style="padding:4px 5px 8px 0;font-weight:bold;">로스팅 레벨</td>
        <td style="padding:4px 0 8px 0;">${s.roastLevel||"<span style='color:#BBB;'>미입력</span>"}</td>
      </tr>
    </table>
  </div>
  
  <div style="display:flex;flex-direction:row;gap:20px;flex-wrap:wrap;margin-bottom:25px;">
    <div style="background:white;flex:1;min-width:250px;border-radius:10px;padding:18px 15px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      <h4 style="font-weight:600;font-size:16px;margin:0 0 12px 0;color:#333;">향미 특성 및 속성</h4>
      <div style="margin-bottom:15px;">
        ${FLAVOR_PHASES.map(phase => {
          const phaseSel = (s.flavorSelections[phase.id]||[]).map(key => {
            const [cat, sub, desc] = key.split('|');
            const rec = FLAVOR_DATA.find(f => f[0]===cat && f[1]===sub && f[2]===desc);
            const color = rec ? rec[3] : '#B8B2A5';
            const textColor = getContrastColor(color);
            return `<span style="display:inline-block;padding:4px 12px;border-radius:20px;margin:3px;font-size:13px;color:${textColor};background:${color};">${desc}</span>`;
          }).join('');
          
          return `<div style="margin-bottom:10px;">
            <span style="font-weight:600;margin-right:5px;">${phase.label}:</span> 
            ${phaseSel || '<span style="font-size:13px;color:#999;">없음</span>'}
          </div>`;
        }).join('')}
      </div>
      
      <div style="margin-bottom:12px;">
        ${Object.keys(ATTR_TO_BADGE).map(attrKey => {
          const attrMeta = ATTR_TO_BADGE[attrKey];
          const val = s[attrKey];
          if(val) {
            return `<span style="display:inline-block;padding:4px 12px;border-radius:20px;margin:3px 6px 3px 0;font-size:13px;color:#fff;background:${attrMeta.color};">${attrMeta.label}: ${ATTR_VALUE_LABELS[val]}</span>`;
          } else {
            return `<span style="display:inline-block;padding:4px 12px;border-radius:20px;margin:3px 6px 3px 0;font-size:13px;color:#fff;background:${attrMeta.color};opacity:0.5;">${attrMeta.label}: 미선택</span>`;
          }
        }).join('')}
      </div>
      
      <div>
        <span style="font-weight:600;margin-right:5px;">로스팅 디펙트:</span>
        <div style="margin-top:4px;">
          ${(() => {
            let defectHtml = '';
            let hasDefect = false;
            
            DEFECT_PROPS.forEach(d => {
              const val = s[d.key] || "none";
              if(val !== "none") {
                const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
                defectHtml += `<span style="display:inline-block;padding:4px 12px;border-radius:20px;margin:3px 6px 3px 0;font-size:13px;color:#fff;background:${dColor};">${d.label}: ${DEFECT_LABELS[val].label}</span>`;
                hasDefect = true;
              }
            });
            
            if(!hasDefect) {
              return '<span style="font-size:13px;color:#999;">선택된 디펙트 없음</span>';
            }
            
            return defectHtml;
          })()}
        </div>
      </div>
    </div>
    
    <div style="background:white;flex:1;min-width:250px;border-radius:10px;padding:18px 15px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      <h4 style="font-weight:600;font-size:16px;margin:0 0 12px 0;color:#333;">SCA 평가 점수 차트</h4>
      <canvas id="imgExportRadar" width="320" height="250"></canvas>
      <div style="text-align:center;margin-top:15px;">
        <span style="font-weight:600;">총점:</span> <span style="font-size:20px;font-weight:bold;color:#8B5A2B;">${document.getElementById('totalScore').textContent}</span>
      </div>
    </div>
  </div>
  
  ${s.tastingNotes ? `
  <div style="background:#F6F1E9;border-radius:10px;padding:15px 18px;margin-top:12px;">
    <div style="font-weight:600;font-size:16px;margin-bottom:8px;color:#76582B;">테이스팅 노트</div>
    <div style="white-space:pre-line;font-size:14px;line-height:1.7;color:#333;">${s.tastingNotes.replace(/</g,"&lt;")}</div>
  </div>
  ` : ''}
  
  <div style="margin-top:30px;font-size:12px;color:#888;text-align:center;border-top:1px solid #ece1cf;padding:8px 0 0 0;"> 
    평가일: ${(new Date()).toISOString().slice(0,10)} | mollis SCA 커피 관능 평가 
  </div>
  `;
  
  document.body.appendChild(tempRoot);
  
  // Draw radar chart for export
  const exportRadar = tempRoot.querySelector('#imgExportRadar');
  if(exportRadar){
    new Chart(exportRadar.getContext('2d'), {
      type: "radar",
      data: { 
        labels:["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"], 
        datasets:[{ 
          label:"점수", 
          data:[ s.scoreFragrance, s.scoreAroma, s.scoreFlavor, s.scoreAftertaste, s.scoreAcidity, s.scoreBody, s.scoreBalance, s.scoreOverall ], 
          backgroundColor:"rgba(139,90,43,0.13)", 
          borderColor:"#8B5A2B", 
          pointBackgroundColor:"#8B5A2B",
          borderWidth: 2,
          pointRadius: 4
        }] 
      },
      options: { 
        plugins:{legend:{display:false}}, 
        scales:{r:{
          min:0,
          max:10,
          ticks:{
            stepSize:2,
            font:{size:12}
          },
          pointLabels:{
            font:{size:13,weight:'bold'}
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          },
          angleLines: {
            color: 'rgba(0,0,0,0.1)'
          }
        }}
      }
    });
  }
  
  setTimeout(()=>{
    html2canvas(tempRoot, {backgroundColor:"#fcfaf7", scale: 2, logging:false})
    .then(canvas=>{
      const a = document.createElement('a');
      a.href = canvas.toDataURL("image/png");
      const fname = (s.coffeeName||'coffee_sample')+'_cupping.png';
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      document.body.removeChild(tempRoot);
    });
  }, 800); // 차트 렌더링 시간을 위해 시간 증가
};

// export csv/xlsx 등 기타 기능
document.getElementById('exportCsvBtn').onclick = ()=>{
  saveCurrentSample();
  let s = getCurrentSampleObj().sampleData;
  let fields = [
    "coffeeName","origin","variety","process","roastDate","roastLevel",
    "acidityLevel","sweetnessLevel","bodyLevel",
    ...FLAVOR_PHASES.map(phase => "flavorSelections." + phase.id), ...DEFECT_PROPS.map(d=>d.key),
    "scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall",
    "tastingNotes"
  ];
  let row = fields.map(f=>{
    if(f.startsWith('flavorSelections.')){
      let phase = f.split('.')[1];
      return (s.flavorSelections[phase]||[]).map(key=>key.split('|')[2]).join('; ');
    }
    if(DEFECT_PROPS.find(d=>d.key===f)){
      let v = s[f]||"none";
      return DEFECT_LABELS[v]?DEFECT_LABELS[v].label:"";
    }
    return s[f]!==undefined?s[f]:"";
  });
  let header = ["커피명","원산지","품종","가공법","로스팅일","로스팅레벨","산미단계","단맛단계","바디단계","프래그런스","아로마","플레이버","에프터테이스트", ...DEFECT_PROPS.map(d=>d.label), "Fragrance점수","Aroma점수","Flavor점수","Aftertaste점수","Acidity점수","Body점수","Balance점수","Overall점수","비고/노트"];
  let csv = header.join(',')+'\n'+row.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',');
  let blob = new Blob([csv],{type:"text/csv"});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (s.title?s.title+"_":"cupping_")+"data.csv";
  a.click();
};

document.getElementById('exportXlsxBtn').onclick = ()=>{
  saveCurrentSample();
  let s = getCurrentSampleObj().sampleData;
  let fields = [
    "coffeeName","origin","variety","process","roastDate","roastLevel",
    "acidityLevel","sweetnessLevel","bodyLevel",
    ...FLAVOR_PHASES.map(phase => "flavorSelections." + phase.id), ...DEFECT_PROPS.map(d=>d.key),
    "scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall",
    "tastingNotes"
  ];
  let row = fields.map(f=>{
    if(f.startsWith('flavorSelections.')){
      let phase = f.split('.')[1];
      return (s.flavorSelections[phase]||[]).map(key=>key.split('|')[2]).join('; ');
    }
    if(DEFECT_PROPS.find(d=>d.key===f)){
      let v = s[f]||"none";
      return DEFECT_LABELS[v]?DEFECT_LABELS[v].label:"";
    }
    return s[f]!==undefined?s[f]:"";
  });
  let header = ["커피명","원산지","품종","가공법","로스팅일","로스팅레벨","산미단계","단맛단계","바디단계","프래그런스","아로마","플레이버","에프터테이스트", ...DEFECT_PROPS.map(d=>d.label), "Fragrance점수","Aroma점수","Flavor점수","Aftertaste점수","Acidity점수","Body점수","Balance점수","Overall점수","비고/노트"];
  let ws = XLSX.utils.aoa_to_sheet([header,row]);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "cupping");
  XLSX.writeFile(wb,(s.title?s.title+"_":"cupping_")+"data.xlsx");
};

document.getElementById('saveSamplesBtn').onclick = ()=>{
  saveCurrentSample();
  saveSamplesToStorage();
  showToast("모든 샘플을 웹 브라우저(LocalStorage)에 저장했습니다.");
};

document.getElementById('exportSamplesBtn').onclick = ()=>{
  saveCurrentSample();
  let blob = new Blob([JSON.stringify(samples,null,2)],{type:'application/json'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sca_cupping_samples.json';
  a.click();
};

document.getElementById('importSamplesInput').onchange = function(e){
  let file = e.target.files[0];
  if(!file)return;
  let reader = new FileReader();
  reader.onload = function(){
    try{
      let arr = JSON.parse(this.result);
      if(Array.isArray(arr)){
        samples = arr;
        if(samples.length>0){
          currentSampleId = samples[0].id;
          renderSampleList();
          setUIFromSample(samples[0].sampleData);
          saveSamplesToStorage();
          showToast("샘플 데이터를 성공적으로 불러왔습니다.");
        }
      }
    }catch(err){ alert("파일을 읽을 수 없습니다."); }
  };
  reader.readAsText(file,"utf-8");
};

// 웹에서 불러오기 버튼(내부 localStorage → 앱에 적용)
document.getElementById('loadSamplesWebBtn').onclick = ()=>{
  let raw = localStorage.getItem("mollis_sca_samples2");
  if(raw){
    try{
      let arr = JSON.parse(raw);
      if(Array.isArray(arr)&&arr.length>0){
        if(confirm("웹 저장소에서 이전 샘플 데이터를 불러올까요? (현재 작업은 즉시 덮어쓰기됨)")){
          samples = arr;
          currentSampleId = samples[0].id;
          setUIFromSample(samples[0].sampleData);
          renderSampleList();
          showToast("웹 저장소의 기록을 불러왔습니다.");
        }
      }else{ showToast("저장된 기록이 없습니다."); }
    }catch(e){ alert("불러올 수 없습니다."); }
  }else{ showToast("저장된 기록이 없습니다."); }
};

// --- 커핑 비교 기능 개선
function renderCompareList(){
  let cmpBox = document.getElementById('compareListBox');
  if(!samples.length){
    cmpBox.innerHTML =`<div class="text-xs text-gray-400">기록 없음</div>`;return;
  }
  let html = samples.map(sm=>
    `<label class="inline-flex items-center mr-2 mb-1 text-xs mobile-touch-friendly">
      <input type="checkbox" class="compareCheck" value="${sm.id}">
      <span class="ml-1">${sm.title}</span>
    </label>`
  ).join("");
  cmpBox.innerHTML = html;
}

// 기본 비교 차트 생성
document.getElementById('compareBtn').onclick = function(){
  let checked = Array.from(document.querySelectorAll('.compareCheck:checked')).map(cb=>cb.value);
  if(checked.length<2){
    document.getElementById('compareArea').innerHTML = '<div class="text-red-600 text-xs my-2">2개 이상 샘플을 반드시 선택해야 비교가 가능합니다.</div>';
    return;
  }
  let cmpSamples = samples.filter(s=>checked.includes(s.id));
  let scaFields = ["scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall"];
  let scaNames = ["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"];
  let colorList=["#7f5539","#9c6644","#e5989b","#a7c957","#2196f3","#f9c846","#c70039","#607466"];
  let cmpDiv = document.getElementById('compareArea');
  cmpDiv.innerHTML = '<div class="chart-container"><canvas id="compareRadarChart"></canvas></div>';
  setTimeout(()=>{
    let ctx = document.getElementById('compareRadarChart').getContext('2d');
    let cmpChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels: scaNames,
        datasets: cmpSamples.map((smp,i)=>({
          label: smp.title,
          data: scaFields.map(f=>smp.sampleData[f]||0),
          borderColor: colorList[i%colorList.length],
          backgroundColor: colorList[i%colorList.length]+'25',
          pointBackgroundColor:colorList[i%colorList.length]
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {legend:{position:"top"}},
        scales: { r:{min:0,max:10,ticks:{stepSize:2}} }
      }
    });
  },120);
  let th = ['항목'].concat(cmpSamples.map(s=>s.title));
  let trs = scaFields.map((fld,i)=>
    `<tr><th>${scaNames[i]}</th>`+cmpSamples.map(s=>`<td>${s.sampleData[fld]}</td>`).join("")+"</tr>"
  ).join("");
  let flavorRow = FLAVOR_PHASES.map(phase=>
    `<tr><th>${phase.label}</th>`+
    cmpSamples.map(smp=>{
      let flavorTxt=(smp.sampleData.flavorSelections[phase.id]||[]).map(key=>key.split('|')[2]).join(", ");
      return `<td>${flavorTxt||"-"}</td>`;
    }).join("")+"</tr>"
  ).join("");
  let defectRow = DEFECT_PROPS.map(d=>
    `<tr><th>${d.label}</th>`+
    cmpSamples.map(smp=>{
      let val = smp.sampleData[d.key]||"none";
      return `<td>${DEFECT_LABELS[val]?DEFECT_LABELS[val].label:"미선택"}</td>`;
    }).join("")+"</tr>"
  ).join("");
  cmpDiv.innerHTML += `
    <div class="overflow-x-auto mt-3">
      <table class="compare-table min-w-[360px] w-full border-collapse text-xs">
        <thead><tr>${th.map(h=>"<th>"+h+"</th>").join("")}</tr></thead>
        <tbody>
          ${trs}
          ${flavorRow}
          ${defectRow}
        </tbody>
      </table>
    </div>`;
};

// 고급 비교 테이블 및 차트 생성
document.getElementById('advancedCompareBtn').onclick = function() {
  let checked = Array.from(document.querySelectorAll('.compareCheck:checked')).map(cb=>cb.value);
  if(checked.length<2){
    document.getElementById('compareArea').innerHTML = '<div class="text-red-600 text-xs my-2">2개 이상 샘플을 반드시 선택해야 비교가 가능합니다.</div>';
    return;
  }
  
  let cmpSamples = samples.filter(s=>checked.includes(s.id));
  let cmpDiv = document.getElementById('compareArea');
  
  // SCA 점수 관련 상수
  const scaFields = ["scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall"];
  const scaNames = ["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"];
  const colorList = ["#7f5539","#9c6644","#e5989b","#a7c957","#2196f3","#f9c846","#c70039","#607466"];
  
  // 카테고리별로 데이터 구성
  const categories = [
    { name: "SCA 점수", fields: scaFields, labels: scaNames },
    { name: "맛 속성", fields: ["acidityLevel", "sweetnessLevel", "bodyLevel"], 
      labels: ["산미", "단맛", "바디감"],
      valueMap: { 
        "acidityLevel": ATTR_VALUE_LABELS, 
        "sweetnessLevel": ATTR_VALUE_LABELS,
        "bodyLevel": ATTR_VALUE_LABELS
      }
    },
    { name: "로스팅 결점", fields: DEFECT_PROPS.map(d => d.key), 
      labels: DEFECT_PROPS.map(d => d.label),
      valueMap: DEFECT_PROPS.reduce((obj, d) => {
        obj[d.key] = DEFECT_LABELS;
        return obj;
      }, {})
    }
  ];
  
  // SCA 점수 레이더 차트 생성
  cmpDiv.innerHTML = '<div class="chart-container"><canvas id="advancedCompareRadarChart"></canvas></div>';
  
  // 카테고리별 HTML 생성
  let html = '';
  categories.forEach(category => {
    html += `<div class="advanced-compare-category">${category.name}</div>`;
    html += `
      <div class="overflow-x-auto">
        <table class="advanced-compare-table min-w-[360px] w-full">
          <thead>
            <tr>
              <th>항목</th>
              ${cmpSamples.map(s => `<th>${s.title}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
    `;
    
    category.fields.forEach((field, idx) => {
      html += `<tr>
        <td>${category.labels[idx]}</td>
        ${cmpSamples.map(s => {
          let val = s.sampleData[field];
          
          // 숫자값(점수)인 경우 그대로 표시
          if (typeof val === 'number') {
            return `<td>${val}</td>`;
          }
          
          // 레벨이나 결점의 경우 레이블로 표시
          if (category.valueMap && category.valueMap[field]) {
            const valueObj = category.valueMap[field][val || 'none'];
            return `<td>${valueObj ? valueObj.label : '미선택'}</td>`;
          }
          
          return `<td>${val || '-'}</td>`;
        }).join("")}
      </tr>`;
    });
    
    html += `</tbody></table></div>`;
  });
  
  // 향미 프로필 비교를 위한 향미 카테고리별 집계 테이블
  html += `<div class="advanced-compare-category">향미 프로필 비교</div>`;
  html += `<div class="overflow-x-auto"><table class="advanced-compare-table min-w-[360px] w-full">
    <thead><tr><th>향미 카테고리</th>${cmpSamples.map(s => `<th>${s.title}</th>`).join("")}</tr></thead>
    <tbody>`;
  
  // 각 샘플별 카테고리 집계
  FLAVOR_CATEGORIES.forEach(category => {
    html += `<tr><td>${category.name}</td>`;
    
    cmpSamples.forEach(s => {
      let count = 0;
      FLAVOR_PHASES.forEach(phase => {
        (s.sampleData.flavorSelections[phase.id] || []).forEach(key => {
          const [cat, sub, desc] = key.split('|');
          if (category.categories.includes(cat)) {
            count++;
          }
        });
      });
      
      html += `<td>${count}</td>`;
    });
    
    html += `</tr>`;
  });
  
  html += `</tbody></table></div>`;
  
  // 향미 특성 상세 비교
  html += `<div class="advanced-compare-category">향미 특성 상세 비교</div>`;
  
  FLAVOR_PHASES.forEach(phase => {
    html += `<div class="mb-4">
      <h4 class="font-semibold mb-2">${phase.label}</h4>
      <div class="overflow-x-auto">
        <table class="advanced-compare-table min-w-[360px] w-full">
          <thead><tr><th>샘플</th><th>선택된 향미</th></tr></thead>
          <tbody>`;
          
    cmpSamples.forEach(s => {
      const flavors = (s.sampleData.flavorSelections[phase.id] || [])
        .map(key => {
          const [cat, sub, desc] = key.split('|');
          const rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
          const color = rec ? rec[3] : '#B8B2A5';
          const textColor = getContrastColor(color);
          
          return `<span style="display:inline-block;padding:2px 8px;border-radius:15px;margin:2px;font-size:12px;color:${textColor};background:${color};">${desc}</span>`;
        })
        .join(' ');
        
      html += `<tr><td>${s.title}</td><td>${flavors || '-'}</td></tr>`;
    });
    
    html += `</tbody></table></div></div>`;
  });
  
  // 향미 프로필 레이더 차트
  html += `<div class="mt-5 mb-3 chart-container"><canvas id="flavorProfileCompareChart"></canvas></div>`;
  
  cmpDiv.innerHTML += html;
  
  // SCA 점수 레이더 차트 생성
  setTimeout(() => {
    const ctx = document.getElementById('advancedCompareRadarChart').getContext('2d');
    new Chart(ctx, {
      type: "radar",
      data: {
        labels: scaNames,
        datasets: cmpSamples.map((smp, i) => ({
          label: smp.title,
          data: scaFields.map(f => smp.sampleData[f] || 0),
          borderColor: colorList[i % colorList.length],
          backgroundColor: colorList[i % colorList.length] + '25',
          pointBackgroundColor: colorList[i % colorList.length],
          borderWidth: 2
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: "top" } },
        scales: { r: { min: 0, max: 10, ticks: { stepSize: 2 } } }
      }
    });
    
    // 향미 프로필 레이더 차트 생성
    const flavCtx = document.getElementById('flavorProfileCompareChart').getContext('2d');
    
    // 각 샘플별 향미 카테고리 집계
    const flavorProfileDatasets = cmpSamples.map((smp, i) => {
      const categoryData = FLAVOR_CATEGORIES.map(category => {
        let count = 0;
        FLAVOR_PHASES.forEach(phase => {
          (smp.sampleData.flavorSelections[phase.id] || []).forEach(key => {
            const [cat, sub, desc] = key.split('|');
            if (category.categories.includes(cat)) {
              count++;
            }
          });
        });
        return count;
      });
      
      return {
        label: smp.title,
        data: categoryData,
        borderColor: colorList[i % colorList.length],
        backgroundColor: colorList[i % colorList.length] + '25',
        borderWidth: 2
      };
    });
    
    new Chart(flavCtx, {
      type: "radar",
      data: {
        labels: FLAVOR_CATEGORIES.map(c => c.name),
        datasets: flavorProfileDatasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: "top" } },
        scales: { 
          r: { 
            min: 0,
            ticks: {
              stepSize: 1,
              callback: function(value) {
                if (value % 1 === 0) return value;
              }
            }
          } 
        }
      }
    });
  }, 150);
};

// 분할 화면 비교 관련 함수
function updateSplitViewSelects() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  
  if (!leftSelect || !rightSelect) return;
  
  leftSelect.innerHTML = '';
  rightSelect.innerHTML = '';
  
  // 기본 옵션 추가
  leftSelect.innerHTML = '<option value="">샘플 선택...</option>';
  rightSelect.innerHTML = '<option value="">샘플 선택...</option>';
  
  // 샘플 목록 옵션 추가
  samples.forEach(sample => {
    const leftOption = document.createElement('option');
    leftOption.value = sample.id;
    leftOption.textContent = sample.title;
    
    const rightOption = document.createElement('option');
    rightOption.value = sample.id;
    rightOption.textContent = sample.title;
    
    leftSelect.appendChild(leftOption);
    rightSelect.appendChild(rightOption);
  });
  
  // 기본값 선택 (첫 번째, 두 번째 샘플)
  if (samples.length >= 2) {
    leftSelect.value = samples[0].id;
    rightSelect.value = samples[1].id;
    updateSplitView();
  } else if (samples.length === 1) {
    leftSelect.value = samples[0].id;
    updateSplitView();
  }
}

// 분할 화면에 샘플 정보 표시
function updateSplitView() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  const leftView = document.getElementById('leftSampleView');
  const rightView = document.getElementById('rightSampleView');
  
  if (!leftSelect || !rightSelect || !leftView || !rightView) return;
  
  // 왼쪽 샘플 정보 표시
  const leftSampleId = leftSelect.value;
  const leftSample = leftSampleId ? samples.find(s => s.id === leftSampleId) : null;
  
  if (leftSample) {
    leftView.innerHTML = renderSampleSummaryForSplitView(leftSample);
  } else {
    leftView.innerHTML = '<div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>';
  }
  
  // 오른쪽 샘플 정보 표시
  const rightSampleId = rightSelect.value;
  const rightSample = rightSampleId ? samples.find(s => s.id === rightSampleId) : null;
  
  if (rightSample) {
    rightView.innerHTML = renderSampleSummaryForSplitView(rightSample);
  } else {
    rightView.innerHTML = '<div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>';
  }
}

// 분할 화면용 샘플 요약 HTML 생성
function renderSampleSummaryForSplitView(sample) {
  const s = sample.sampleData;
  let html = `
    <div class="mb-3 border-b pb-2">
      <h3 class="font-bold text-lg">${sample.title}</h3>
    </div>
    
    <div class="mb-4">
      <table class="w-full text-sm">
        <tr>
          <td class="font-semibold pr-2">커피명:</td>
          <td>${s.coffeeName || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
        <tr>
          <td class="font-semibold pr-2">원산지:</td>
          <td>${s.origin || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
        <tr>
          <td class="font-semibold pr-2">품종:</td>
          <td>${s.variety || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
        <tr>
          <td class="font-semibold pr-2">가공법:</td>
          <td>${s.process || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
        <tr>
          <td class="font-semibold pr-2">로스팅날짜:</td>
          <td>${s.roastDate || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
        <tr>
          <td class="font-semibold pr-2">로스팅레벨:</td>
          <td>${s.roastLevel || "<span class='text-gray-400'>미입력</span>"}</td>
        </tr>
      </table>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold border-b pb-1 mb-2">SCA 점수</h4>
      <div class="grid grid-cols-2 gap-1 text-sm">
        <div>프래그런스: <span class="font-medium">${s.scoreFragrance}</span></div>
        <div>아로마: <span class="font-medium">${s.scoreAroma}</span></div>
        <div>플레이버: <span class="font-medium">${s.scoreFlavor}</span></div>
        <div>에프터테이스트: <span class="font-medium">${s.scoreAftertaste}</span></div>
        <div>액시디티: <span class="font-medium">${s.scoreAcidity}</span></div>
        <div>바디: <span class="font-medium">${s.scoreBody}</span></div>
        <div>밸런스: <span class="font-medium">${s.scoreBalance}</span></div>
        <div>오버럴: <span class="font-medium">${s.scoreOverall}</span></div>
      </div>
      <div class="text-right font-bold mt-2">총점: ${(30 + s.scoreFragrance + s.scoreAroma + s.scoreFlavor + s.scoreAftertaste + s.scoreAcidity + s.scoreBody + s.scoreBalance + s.scoreOverall).toFixed(2)}</div>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold border-b pb-1 mb-2">속성</h4>
      <div class="grid grid-cols-3 gap-2 text-sm">
        <div>산미: <span class="font-medium">${s.acidityLevel || "미선택"}</span></div>
        <div>단맛: <span class="font-medium">${s.sweetnessLevel || "미선택"}</span></div>
        <div>바디감: <span class="font-medium">${s.bodyLevel || "미선택"}</span></div>
      </div>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold border-b pb-1 mb-2">향미</h4>
  `;
  
  FLAVOR_PHASES.forEach(phase => {
    const flavors = (s.flavorSelections[phase.id] || []).map(key => {
      const [cat, sub, desc] = key.split('|');
      const rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
      const color = rec ? rec[3] : '#B8B2A5';
      const textColor = getContrastColor(color);
      
      return `<span class="inline-block rounded-full px-2 py-0.5 text-xs mr-1 mb-1" style="background:${color};color:${textColor};">${desc}</span>`;
    }).join('');
    
    html += `
      <div class="mb-2">
        <div class="text-sm font-medium">${phase.label}:</div>
        <div class="flex flex-wrap mt-1">${flavors || "<span class='text-gray-400 text-xs'>없음</span>"}</div>
      </div>
    `;
  });
  
  html += `
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold border-b pb-1 mb-2">로스팅 디펙트</h4>
      <div class="text-sm">
  `;
  
  let hasDefect = false;
  DEFECT_PROPS.forEach(d => {
    const val = s[d.key] || "none";
    if (val !== "none") {
      const defectLabel = DEFECT_LABELS[val] ? DEFECT_LABELS[val].label : "미선택";
      html += `<div>${d.label}: <span class="font-medium">${defectLabel}</span></div>`;
      hasDefect = true;
    }
  });
  
  if (!hasDefect) {
    html += `<span class="text-gray-400 text-xs">선택된 디펙트 없음</span>`;
  }
  
  html += `
      </div>
    </div>
    
    ${s.tastingNotes ? `
    <div>
      <h4 class="font-semibold border-b pb-1 mb-2">테이스팅 노트</h4>
      <div class="text-sm whitespace-pre-line">${s.tastingNotes}</div>
    </div>
    ` : ''}
  `;
  
  return html;
}

// 분할 화면 비교 모달 컨트롤
document.getElementById('splitViewBtn').onclick = function() {
  const modal = document.getElementById('splitViewModal');
  modal.classList.add('show'); // 클래스를 추가하여 표시
  
  updateSplitViewSelects();
  updateSplitView();
};

document.getElementById('closeSplitViewBtn').onclick = function() {
  const modal = document.getElementById('splitViewModal');
  modal.classList.remove('show'); // 클래스를 제거하여 숨김
};

// 분할 화면 셀렉트박스 변경 이벤트
document.getElementById('leftSampleSelect').onchange = updateSplitView;
document.getElementById('rightSampleSelect').onchange = updateSplitView;

// 샘플 추가 버튼 (수정된 부분)
document.getElementById('addSampleBtn').onclick = function() {
  // 현재 샘플 저장
  if (currentSampleId) {
    saveCurrentSample();
  }
  
  // 새 샘플 생성
  const newSample = createNewSampleObj("새 샘플 #" + (samples.length + 1));
  samples.unshift(newSample); // 배열 맨 앞에 추가
  currentSampleId = newSample.id;
  
  renderSampleList();
  setUIFromSample(newSample.sampleData);
  saveSamplesToStorage();
  showToast("새 샘플을 추가했습니다.");
};

// 샘플 삭제 버튼 (수정된 부분)
document.getElementById('removeSampleBtn').onclick = function() {
  if (!currentSampleId) {
    showToast("삭제할 샘플이 선택되지 않았습니다.");
    return;
  }
  
  if (samples.length <= 1) {
    showToast("최소 한 개의 샘플은 유지해야 합니다.");
    return;
  }
  
  if (confirm("현재 샘플을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
    const idx = samples.findIndex(s => s.id === currentSampleId);
    if (idx > -1) {
      samples.splice(idx, 1);
      currentSampleId = samples[0].id; // 첫 번째 샘플로 이동
      renderSampleList();
      setUIFromSample(samples[0].sampleData);
      saveSamplesToStorage();
      showToast("샘플이 삭제되었습니다.");
    }
  }
};

// 샘플 복제 버튼
document.getElementById('cloneSampleBtn').onclick = function() {
  if (!currentSampleId) {
    showToast("복제할 샘플이 선택되지 않았습니다.");
    return;
  }
  
  cloneSample(currentSampleId);
};

// 모달 외부 클릭 시 닫기 기능
document.addEventListener('click', function(e) {
  const modal = document.getElementById('splitViewModal');
  
  // 모달이 표시 중이고, 모달 외부를 클릭했을 때만 닫기
  if (modal.classList.contains('show') && !e.target.closest('.modal-content') && e.target === modal) {
    modal.classList.remove('show');
  }
});

// 초기화 함수
document.addEventListener('DOMContentLoaded', function() {
  // 기본 초기화
  loadSamplesFromStorage();
  
  if (samples.length > 0) {
    // 샘플이 있을 경우 첫 번째 샘플 로드
    const sampleObj = samples.find(s => s.id === currentSampleId);
    if (sampleObj) {
      setUIFromSample(sampleObj.sampleData);
    }
  }
  
  renderCompareList();
  document.getElementById('evalDate').textContent = (new Date()).toISOString().slice(0,10);
  
  // 샘플 네비게이션 초기화
  updateCurrentSampleIndicator();
  updateNavigationButtons();
  
  // 이전/다음 버튼 이벤트 설정
  document.getElementById('prevSampleBtn').addEventListener('click', goToPrevSample);
  document.getElementById('nextSampleBtn').addEventListener('click', goToNextSample);
  
  // 스와이프 제스처 지원 (모바일)
  const formEl = document.getElementById('cuppingForm');
  const hammer = new Hammer(formEl);
  
  hammer.on('swipeleft', function() {
    goToNextSample();
  });
  
  hammer.on('swiperight', function() {
    goToPrevSample();
  });
  
  // 키보드 좌우 화살표 키 지원 (PC)
  document.addEventListener('keydown', function(e) {
    // 포커스가 input/textarea에 있으면 무시
    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
      return;
    }
    
    if (e.key === 'ArrowLeft') {
      goToPrevSample();
    } else if (e.key === 'ArrowRight') {
      goToNextSample();
    }
  });
});

// 모바일에서 폰트 사이즈 조정
window.addEventListener('resize', function(){
  // 모바일일 때 손가락 확대 버그 방지 (tailwind가 커버 대부분 함)
  document.body.style.fontSize = window.innerWidth < 760 ? '14.5px' : '16px';
}, false);
</script>
</body>
</html>
