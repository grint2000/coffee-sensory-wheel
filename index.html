<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mollis SCA 커피 관능 평가 (개선버전)</title>
  <link rel="manifest" href="manifest.json">
 <link rel="매니페스트" href="manifest.json">
  <meta name="theme-color" content="#8B5A2B">
 <meta name = "테마 색상"콘텐츠 = "#8B5A2B">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    html,body { font-family: 'Noto Sans KR', sans-serif; background: #fcfaf7;}
    .flavor-badge { font-size: 13px; border-radius: 9999px; padding: 2px 10px; margin: 2px; display:inline-block;}
    .export-btn { background:#8B5A2B; color:white;} .export-btn:hover { background: #654321;}
    .tab-btn-active { background: #8B5A2B!important; color:#fff !important;}
    .tab-btn-inactive { background: #f3efe8!important; color: #675444;}
    .visual-section-flex { display: flex; flex-direction: row; gap: 18px; flex-wrap: wrap; }
    @media (max-width:900px){ .visual-section-flex{ flex-direction:column; } }
    @media (max-width:640px){
      .visual-section-flex { flex-direction: column; gap: 12px;}
      .grid-cols-sample { grid-template-columns:1fr!important;}
      .md\:grid-cols-2 { grid-template-columns: 1fr !important;}
      .score-input-wrap input[type=number], .score-slider { width: 90px; }
      .defect-block { min-width:110px!important;}
    }
    
    /* 향미 선택 영역 스크롤 제거 및 전체 표시 */
    .flavor-section {
      max-height: none !important; 
      overflow: visible !important;
      padding: 15px;
      background: #f9f7f5;
      border-radius: 12px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    
    /* 바디감 항목 스타일 개선 - 향미 선택과 유사하게 */
    .body-descriptor-section {
      background: #f4f1ee;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #e5ddd4;
    }
    
    .body-descriptor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    
    /* 바디감 디스크립터 항목 - 향미 체크박스와 유사한 스타일 */
    .body-descriptor-item {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 6px 12px 6px 32px;
      border-radius: 20px;
      margin: 3px;
      font-size: 13px;
      cursor: pointer;
      line-height: 1.3;
      transition: all 0.2s;
      user-select: none;
      border: 1px solid #ddd;
      background: white;
      min-height: 36px;
    }
    
    .body-descriptor-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .body-descriptor-item.selected {
      box-shadow: 0 0 0 2px rgba(139, 90, 43, 0.8);
      transform: translateY(-1px);
      border-color: #8B5A2B;
      background: #8B5A2B;
      color: white;
    }
    
    .body-descriptor-item input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      left: 8px;
      width: 16px;
      height: 16px;
      margin: 0;
      cursor: pointer;
    }
    
    .body-descriptor-item .checkbox-custom {
      position: absolute;
      left: 8px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .body-descriptor-item input:checked + .checkbox-custom:after {
      content: "\f00c";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      font-size: 10px;
      color: #8B5A2B;
    }
    
    .body-descriptor-item.selected input:checked + .checkbox-custom:after {
      color: #fff;
    }
    
    .body-descriptor-item.selected .checkbox-custom {
      background: #8B5A2B;
      border-color: #8B5A2B;
    }
    
    /* SNS 형 이미지 내보내기 버튼 스타일 */
    .sns-export-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transition: all 0.3s;
    }
    
    .sns-export-btn:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* 샘플 알림 토스트 */
    .sample-toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .sample-toast.show {
      opacity: 1;
      visibility: visible;
    }
    
    .no-scrollbar::-webkit-scrollbar {display: none;} 
    .no-scrollbar {-ms-overflow-style: none; scrollbar-width: none;}
    .html2canvas-container { box-shadow: 0 0 0 3px #eee; }
    .score-slider { width: 100%; }
    .sample-list-scroll {max-height: 190px; overflow-y: auto;}
    .compare-table th, .compare-table td {border:1px solid #e2e2e2; padding:6px 8px; font-size:14px;}
    .compare-table th {background: #f9f3ea;}
    .compare-table tr:nth-child(even) td {background: #f8f6f4;}
    .tooltip { position: relative; cursor: help;}
    .tooltip .tooltip-text { visibility: hidden; background: #333; color: #fff; position: absolute; z-index: 10; padding: 7px 15px; border-radius: 8px; left: 50%; top:110%; min-width:160px; font-size:13px; opacity:0; transform:translateX(-50%); pointer-events: none; transition: opacity 0.2s; box-shadow: 0 1px 6px rgba(0,0,0,0.13); word-break: keep-all; }
    .tooltip:hover .tooltip-text {opacity:1;visibility:visible;}
    .toast { position: fixed; bottom: 28px; right: 28px; min-width: 240px; background: #8B5A2B; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 3px 20px rgba(0,0,0,.18); z-index: 9999; font-size: 15px; opacity: 0; pointer-events:none; transition: opacity 0.3s; text-align: center; }
    .toast.show{opacity:1;pointer-events:auto;}
    .defect-badge { border-radius:9999px; font-size:12px!important; padding:2px 11px;margin: 0 4px 4px 0; display:inline-block; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .defect-headline { font-size: 15px; font-weight:600; margin-bottom:.5rem }
    .defect-desc { font-size: 11px; color: #666; margin-bottom: .2rem; }
    .defect-block { display:flex; flex-direction: column; min-width:120px; margin-right:9px; margin-bottom:7px;}
    @media print { .flavor-section { max-height: none !important; overflow: visible !important; } body { background: #fff; } .toast, .sample-toast { display:none; } }
    @media (max-width:400px) {
      .defect-block { min-width:70px!important;font-size:11px;}
      .defect-badge { font-size:11px!important;padding:1px 6px;}
      .defect-headline { font-size:12.5px;}
      .body-descriptor-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
      .body-descriptor-item { font-size: 12px; padding: 5px 8px; }
    }
    
    /* 향미 선택 개선 */
    .flavor-checkbox-label {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 4px 12px 4px 30px;
      border-radius: 20px;
      margin: 3px;
      font-size: 13px;
      cursor: pointer;
      line-height: 1.3;
      transition: all 0.2s;
    }
    .flavor-checkbox-label:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .flavor-checkbox-label input {
      position: absolute;
      opacity: 0;
      left: 8px;
    }
    .flavor-checkbox-label .checkbox-custom {
      position: absolute;
      left: 8px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .flavor-checkbox-label input:checked + .checkbox-custom:after {
      content: "\f00c";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      font-size: 10px;
      color: #fff;
    }
    .flavor-checkbox-label input:checked + .checkbox-custom {
      background: #8B5A2B;
      border-color: #8B5A2B;
    }
    .flavor-checkbox-label .flavor-kr {
      font-size: 12px;
      opacity: 0.85;
      display: block;
    }
    
    .flavor-category-title {
      background: #8B5A2B;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      margin: 12px 0 8px 0;
      font-weight: 600;
    }
    
    .flavor-subcategory-title {
      font-weight: 600;
      background: #f1e7db;
      padding: 4px 10px;
      border-radius: 4px;
      margin: 8px 0 6px 0;
      display: inline-block;
    }
    
    /* 샘플 리스트 드래그 앤 드롭 */
    .sample-item {
      cursor: grab;
      transition: background-color 0.2s;
      user-select: none;
      touch-action: none;
    }
    .sample-item:active {
      cursor: grabbing;
    }
    .sample-item.sortable-ghost {
      opacity: 0.4;
      background-color: #f0ebdd !important;
    }
    .sample-item.sortable-chosen {
      background-color: #fef9c3 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .sample-drag-handle {
      cursor: grab;
      color: #9ca3af;
      padding: 0 6px;
      touch-action: none;
    }
    .sample-drag-handle:active {
      cursor: grabbing;
    }
    
    /* 향미 프로필 레이더 차트 */
    .flavor-profile-chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }
    
    /* 분할 화면 비교 */
    .split-view {
      display: flex;
      flex-direction: row;
      width: 100%;
      gap: 10px;
      margin-top: 20px;
      overflow: auto;
    }
    .split-view-container {
      flex: 1;
      min-width: 200px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
      .split-view {
        flex-direction: column;
      }
    }
    
    /* 터치 최적화 - 모바일 */
    @media (max-width: 768px) {
      .flavor-checkbox-label {
        padding: 8px 14px 8px 34px;
        margin: 4px;
        font-size: 14px;
      }
      .flavor-checkbox-label .checkbox-custom {
        width: 20px;
        height: 20px;
        left: 8px;
      }
      .flavor-checkbox-label input:checked + .checkbox-custom:after {
        font-size: 12px;
      }
      .mobile-touch-friendly {
        min-height: 44px;
      }
      .tab-btn-inactive, .tab-btn-active {
        padding: 8px 16px;
        margin-bottom: 8px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      input[type="radio"] + span {
        padding: 4px 0;
        margin-left: 4px;
        display: inline-block;
      }
      .score-slider {
        height: 20px;
      }
      .flavor-badge {
        padding: 4px 12px;
        margin: 3px;
      }
      .mobile-touch-friendly {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* 바디감 디스크립터 모바일 최적화 */
      .body-descriptor-item {
        padding: 8px 14px 8px 34px;
        margin: 4px;
        font-size: 14px;
        min-height: 44px;
      }
      .body-descriptor-item .checkbox-custom {
        width: 20px;
        height: 20px;
        left: 8px;
      }
      .body-descriptor-item input:checked + .checkbox-custom:after {
        font-size: 12px;
      }
    }
       
    /* 모달 스타일 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      max-width: 90%;
      max-height: 90vh;
      overflow: auto;
      width: 1200px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-body {
      padding: 1rem;
    }
    
    /* 검색 기능 추가 */
    .search-box {
      position: sticky;
      top: 0;
      background: #f8f8f8;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    /* 차트 컨테이너 높이 지정 */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* 네비게이션 버튼 스타일 */
    .nav-btn {
      padding: 6px 12px;
      background-color: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-btn:hover:not(:disabled) {
      background-color: #e5e7eb;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* 언어 토글 버튼 */
    .lang-toggle {
      position: absolute;
      right: 10px;
      top: 8px;
      z-index: 5;
      display: inline-flex;
      background: #f4eee6;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lang-toggle button {
      padding: 4px 8px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      min-height: 32px;
      transition: all 0.2s;
    }
    .lang-toggle button.active {
      background: #8B5A2B;
      color: white;
    }
    .lang-toggle button:hover:not(.active) {
      background: #e5d9c7;
    }
    
    /* 향미 카테고리 탭 네비게이션 */
    .flavor-category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .flavor-category-tab {
      padding: 6px 12px;
      background: #f1e7db;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .flavor-category-tab:hover {
      background: #e5d9c7;
    }
    
    .flavor-category-tab.active {
      background: #8B5A2B;
      color: white;
    }
    
    /* 향미 아코디언 패널 */
    .flavor-category-wrapper {
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .flavor-category-header {
      padding: 10px 15px;
      background: #f1e7db;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
    }
    
    .flavor-category-header h4 {
      margin: 0;
      font-weight: 600;
    }
    
    .flavor-category-content {
      padding: 15px;
      display: none;
      background: white;
    }
    
    .flavor-category-content.show {
      display: block;
    }
    
    /* 자주 사용하는 향미 섹션 */
    .frequently-used-flavors {
      background: #f9f4ea;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
    }
    
    .frequently-used-flavors h4 {
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    /* 검색 결과 강조 */
    .flavor-checkbox-label.search-highlight {
      box-shadow: 0 0 0 2px #8B5A2B;
    }
    
    /* 향미 카테고리 필터 버튼 */
    .flavor-filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .flavor-filter-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 15px;
      background-color: #f3efe8;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .flavor-filter-btn.active {
      background-color: #8B5A2B;
      color: white;
      border-color: #8B5A2B;
    }
    
    /* 향미 데이터 그리드 레이아웃 */
    .flavor-items {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    /* 향미 휠 패치 스타일 */
    .flavor-fix-hidden {
      display: none !important;
    }
    
    /* 선택된 향미 스타일 강화 */
    .flavor-checkbox-label.selected-flavor {
      box-shadow: 0 0 0 2px rgba(139, 90, 43, 0.8);
      transform: translateY(-1px);
    }
    
    /* 자동 백업 알림 */
    .backup-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(25, 135, 84, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .backup-notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* 언어 변경 애니메이션 */
    .language-transition {
      transition: opacity 0.2s ease-in-out;
    }
    
    .language-transition.fade-out {
      opacity: 0.5;
    }
    
    /* 바디감 카테고리 헤더 스타일 */
    .body-category-header {
      font-weight: 600;
      color: #8B5A2B;
      margin: 12px 0 8px 0;
      padding: 4px 8px;
      background: #f9f7f5;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body class="min-h-screen bg-[#fcfaf7]">
<div class="max-w-5xl mx-auto p-1 md:p-4 bg-[#fcfaf7]">
  <!-- Header -->
  <header class="flex flex-col md:flex-row items-center justify-between py-4 mb-2 border-b border-tan-300 bg-white rounded-lg shadow-sm">
    <div class="flex items-center">
      <svg width="48" height="48" viewBox="0 0 200 200" class="mr-2"><rect width="200" height="200" fill="black"/><path d="M100,40 L120,60 L110,60 L110,80 L115,90 L105,100 C105,100 120,110 130,120 C140,130 120,150 120,150 L80,150 C80,150 60,130 70,120 C80,110 95,100 95,100 L85,90 L90,80 L90,60 L80,60 Z" fill="#D2B48C"/><circle cx="95" cy="60" r="2" fill="#D2B48C"/><circle cx="105" cy="70" r="2" fill="#D2B48C"/><circle cx="115" cy="65" r="2" fill="#D2B48C"/></svg>
      <span class="text-2xl md:text-3xl font-bold text-tan-900 select-none">mollis</span>
    </div>
    <div class="mt-3 md:mt-0 text-center md:text-right">
      <h2 class="text-lg md:text-2xl font-semibold">SCA 커피 관능 평가 (개선버전)</h2>
      <div class="text-xs text-gray-500 mt-1">PC/모바일 대응 · PDF 저장 최적 · 확장형 바디감/향미 추가 · 개선된 UI/UX</div>
    </div>
    <div class="mt-3 md:mt-0 flex items-center">
      <button id="loginBtn" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">로그인</button>
      <span id="currentUserDisplay" class="ml-2 text-sm text-gray-600"></span>
    </div>
  </header>
  
  <!-- Sample/Data/Compare Section -->
  <section class="bg-white shadow rounded-lg p-3 md:p-6 mb-3 flex flex-col md:flex-row gap-3">
    <!-- 샘플 관리 -->
    <div class="flex-1 min-w-[260px] mb-3 md:mb-0">
      <div class="mb-3 bg-yellow-50 border border-yellow-200 rounded px-2 py-2 flex items-center text-xs text-yellow-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">샘플 관리 방법 안내:</span><br>
          - <b>샘플 추가</b>로 새로운 커피 평가를 기록/관리할 수 있습니다.<br>
          - <b>샘플 선택</b>시 해당 샘플 내용을 상세 편집/저장하며, 자동저장이 지원됩니다.<br>
          - <b>웹에 전체 저장</b> 또는 <b>웹에서 불러오기</b> 버튼을 통해 LocalStorage에 전체 평가 내역을 관리할 수 있습니다.<br>
          - <b>JSON 내보내기</b> 및 <b>불러오기</b> 기능을 통해 데이터를 파일로 보관/복원할 수 있습니다.
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-database mr-2"></i>샘플 관리/불러오기</h3>
      <div class="flex items-center gap-1 mb-2">
        <button class="px-2 py-1 export-btn rounded text-xs flex items-center mobile-touch-friendly" id="addSampleBtn"><i class="fa fa-plus mr-2"></i>샘플 추가</button>
        <button class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs flex items-center mobile-touch-friendly" id="removeSampleBtn"><i class="fa fa-trash mr-2"></i>샘플 삭제</button>
        <button class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs flex items-center mobile-touch-friendly" id="cloneSampleBtn"><i class="fa fa-copy mr-2"></i>복제</button>
        <button class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs flex items-center mobile-touch-friendly" id="undoBtn"><i class="fa fa-undo mr-2"></i>실행취소</button>
      </div>
      <div class="sample-list-scroll bg-gray-50 rounded-lg border p-1.5 no-scrollbar">
        <div id="sampleList" class="sample-sortable-list"></div>
        <div class="text-xs text-gray-500 mt-2 px-2">
          <i class="fas fa-arrows-alt"></i> 샘플 순서를 드래그하여 변경할 수 있습니다.
        </div>
      </div>
      <div class="flex flex-wrap gap-1 mt-2">
        <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-xs flex items-center mobile-touch-friendly" id="saveSamplesBtn"><i class="fa fa-save mr-1"></i>웹에 전체 저장</button>
        <button class="px-3 py-1 bg-blue-200 hover:bg-blue-300 text-blue-900 rounded text-xs flex items-center mobile-touch-friendly" id="loadSamplesWebBtn"><i class="fa fa-cloud-download-alt mr-1"></i>웹에서 불러오기</button>
        <button class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-xs flex items-center mobile-touch-friendly" id="exportSamplesBtn"><i class="fa fa-download mr-1"></i>JSON 내보내기</button>
        <label class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-xs flex items-center cursor-pointer mb-0 mobile-touch-friendly"><i class="fa fa-upload mr-1"></i>불러오기<input type="file" id="importSamplesInput" accept=".json" class="hidden"></label>
        <button class="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded text-xs flex items-center mobile-touch-friendly" id="backupManageBtn"><i class="fa fa-history mr-1"></i>백업 복원</button>
      </div>
    </div>
    
    <!-- 커핑 비교 -->
    <div class="flex-1 min-w-[260px]">
      <div class="mb-3 bg-blue-50 border border-blue-200 rounded px-2 py-2 flex items-center text-xs text-blue-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">커핑 기록 비교 안내:</span><br>
          - <b>아래 평가 목록에서 2개 이상 선택</b> 후 <b>비교차트 표시</b>를 클릭하면 SCA 점수/향미/결점 비교차트와 표가 생성됩니다.<br>
          - 다양한 샘플을 추가한 후, 손쉽게 차트로 비교・분석이 가능합니다.<br>
          - 샘플을 새로고침하거나 불러온 후에도 비교기능 사용 가능.<br>
          <span class="text-gray-400">※ 비교 표와 차트는 PDF, 이미지 등으로 저장시 함께 출력됨.</span>
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-code-compare mr-2"></i>커핑 기록 비교</h3>
      <div id="compareListBox" class="mb-2"></div>
      <div class="flex gap-2 flex-wrap"> 
        <button class="export-btn text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="compareBtn">
          <i class="fa fa-chart-radar mr-1"></i>기본 비교
        </button>
        <button class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="splitViewBtn">
          <i class="fa fa-columns mr-1"></i>분할 화면
        </button>
      </div>
      <div id="compareArea"><div class="text-xs text-gray-400 my-2">2개 이상 샘플을 선택 후 비교 버튼을 눌러주세요.</div></div>
    </div>
  </section>
  
  <!-- 샘플 네비게이션 -->
  <div class="mb-3 bg-white shadow rounded-lg p-3 flex items-center justify-between">
    <button id="prevSampleBtn" class="nav-btn mobile-touch-friendly">
      <i class="fas fa-chevron-left mr-1"></i>이전
    </button>
    <div id="currentSampleIndicator" class="font-bold text-center flex-1 truncate mx-2">현재 샘플: <span class="text-amber-700"></span></div>
    <button id="nextSampleBtn" class="nav-btn mobile-touch-friendly">
      다음<i class="fas fa-chevron-right ml-1"></i>
    </button>
  </div>
  
  <!-- 평가 폼 -->
  <form id="cuppingForm" class="bg-white shadow rounded-lg p-3 md:p-6 mb-4 sample-info">
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <div class="font-bold text-lg mr-2 mb-1">현재 샘플명:</div>
      <input id="sampleTitleInput" type="text" maxlength="60" class="p-1.5 border rounded min-w-[140px] text-base font-semibold" placeholder="샘플명">
      <span id="sampleSavedState" class="ml-2 text-green-700 font-bold text-xs hidden">저장됨</span>
    </div>
    
    <!-- 커피 정보 -->
    <section>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-mug-hot mr-2"></i>커피 정보</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 grid-cols-sample">
        <div>
          <label class="block text-sm font-semibold mb-1">커피명</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="coffeeName" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">원산지</label>
          <select class="coffee-input w-full border border-tan-300 rounded p-2" id="origin">
            <option value="">선택</option>
            <option value="Ethiopia">Ethiopia</option>
            <option value="Kenya">Kenya</option>
            <option value="Tanzania">Tanzania</option>
            <option value="Rwanda">Rwanda</option>
            <option value="Burundi">Burundi</option>
            <option value="Uganda">Uganda</option>
            <option value="DR Congo">DR Congo</option>
            <option value="Guatemala">Guatemala</option>
            <option value="Honduras">Honduras</option>
            <option value="El Salvador">El Salvador</option>
            <option value="Nicaragua">Nicaragua</option>
            <option value="Costa Rica">Costa Rica</option>
            <option value="Panama">Panama</option>
            <option value="Colombia">Colombia</option>
            <option value="Brazil">Brazil</option>
            <option value="Peru">Peru</option>
            <option value="Bolivia">Bolivia</option>
            <option value="Mexico">Mexico</option>
            <option value="Yemen">Yemen</option>
            <option value="India">India</option>
            <option value="Vietnam">Vietnam</option>
            <option value="Indonesia">Indonesia</option>
            <option value="Papua New Guinea">Papua New Guinea</option>
            <option value="China">China</option>
            <option value="Laos">Laos</option>
            <option value="Myanmar">Myanmar</option>
            <option value="Thailand">Thailand</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">품종(Variety)</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="variety" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">가공방식(Process)</label>
          <select class="coffee-input w-full border border-tan-300 rounded p-2" id="process">
            <option value="">선택</option>
            <option value="Washed">Washed</option>
            <option value="Natural">Natural</option>
            <option value="Honey">Honey</option>
            <option value="Anaerobic Natural">Anaerobic Natural</option>
            <option value="Anaerobic Washed">Anaerobic Washed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 날짜</label>
          <input type="date" class="coffee-input w-full border border-tan-300 rounded p-2" id="roastDate">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 레벨</label>
          <select class="coffee-input w-full border border-tan-300 rounded p-2" id="roastLevel">
            <option value="">선택</option>
            <option value="light">Light</option>
            <option value="medium-light">Medium-Light</option>
            <option value="medium">Medium</option>
            <option value="medium-dark">Medium-Dark</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>
    </section>
    
    <!-- SCA 향미 선택 -->
    <section class="mt-8">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-circle-half-stroke mr-2"></i>SCA 향미 선택</h3>
      <div class="text-xs mb-3 text-gray-600">[프래그런스] [아로마] [플레이버] [에프터테이스트] 각 그룹별 향미 선택</div>
      <div class="mb-4 flex flex-wrap items-center">
        <button type="button" class="px-2 py-1 rounded bg-gray-100 text-xs mobile-touch-friendly mr-2" onclick="window.open('https://sca.coffee/research/coffee-tasters-flavor-wheel', '_blank');">
          플레이버 휠 공식자료 <i class="fas fa-external-link-alt ml-1 text-xs"></i>
        </button>
        <div class="lang-toggle">
          <button type="button" id="langEn">영어</button>
          <button type="button" id="langKo" class="active">한글</button>
        </div>
      </div>
      <div id="flavorTabs" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="flavorWheelMultiSelectArea" class="flavor-section border border-gray-50 rounded-lg p-2 bg-gray-50 mb-1"></div>
    </section>
    
    <!-- 단계 속성 -->
    <section class="mt-8">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block mb-1 font-medium tooltip">
            Acidity <span class="text-xs text-gray-500">(산미)</span>
            <span class="tooltip-text">커피의 밝고 상쾌한 특성으로 입에서 느껴지는 신맛의 정도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="acidity_level">
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Sweetness <span class="text-xs text-gray-500">(단맛)</span>
            <span class="tooltip-text">커피에서 느껴지는 달콤함의 정도와 깊이</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="sweetness_level">
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Body <span class="text-xs text-gray-500">(바디감)</span>
            <span class="tooltip-text">커피의 질감과 무게감, 입안에서 느껴지는 밀도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="body_level">
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 바디감 디스크립터 섹션 개선 -->
    <section class="mt-8">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-hand-paper mr-2"></i><span data-i18n="body-descriptor-title">바디감 디스크립터</span></h3>
      <div class="text-xs mb-3 text-gray-600">
        <span data-i18n="body-descriptor-desc">커피의 질감, 밀도, 무게감을 표현하는 세부 특성을 선택하세요 (복수 선택 가능)</span>
      </div>
      <div class="body-descriptor-section">
        <div id="bodyDescriptorArea" class="body-descriptor-grid">
          <!-- 바디감 디스크립터들이 JavaScript로 동적 생성됩니다 -->
        </div>
        <div class="text-xs text-gray-500 mt-3">
          <i class="fas fa-info-circle mr-1"></i>
          <span data-i18n="body-descriptor-help">선택된 항목은 하이라이트 표시됩니다. 클릭하여 선택/해제할 수 있습니다.</span>
        </div>
      </div>
    </section>
    
    <!-- 로스팅 디펙트 -->
    <section class="mt-10" id="section-defect">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-fire mr-2"></i>로스팅 디펙트(결점) 선택</h3>
      <div class="text-xs mb-2 text-gray-600"> 각 항목별로 결점의 정도(매우 약함, 약함, 보통, 강함, 매우 강함)를 선택하세요. <span class="text-gray-400 ml-1">* 왜곡되지 않은 평가를 위해 결점이 없으면 "미선택"으로 둡니다.</span> </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div>
          <label class="font-semibold mb-1 flex items-center"> 언더디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                로스팅을 통해 산미, 단맛, 플레이버가 불충분하게 발현.<br>
                공격적인 산미, 피니시/애프터테이스트 부족,<br>
                구개 앞쪽에서 플레이버가 느껴짐.<br>
                <span class="font-semibold">SCA 플레이버휠 'Green/Vegetative'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_underdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 오버디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과도한 로스팅으로 플레이버가 파괴.<br>모든 산미와 플레이버가 사라진 맛.<br>
                <span class="font-semibold">SCA 플레이버휠 'Roasted'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_overdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 베이킹(베이크드)
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                캐러멜 반응 지속시 생기는 결점.<br>팝콘, 딱딱한 시리얼, 귀리맛 등.<br>
                <span class="font-semibold">SCA 플레이버휠 '곡물류'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_baked">
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 스코칭
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과하게 높은 열에 노출된 결점.<br>SCA 플레이버휠의 '재' 또는 '탄 맛' 노트.<br>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_scorching">
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
      </div>
    </section>
    
    <!-- SCA 점수 (슬라이더별 점수입력) -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-star mr-2"></i>SCA 점수 (0~10점, 0.25단위)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 score-input-wrap">
        <div>
          <label class="block text-sm mb-1 tooltip">프래그런스<span class="tooltip-text">분쇄한 분말 시 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFragrance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFragrance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">아로마<span class="tooltip-text">물 부은 후 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAroma_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAroma" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">플레이버<span class="tooltip-text">혀로 느껴지는 커피의 전반적 맛 특성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFlavor_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFlavor" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">에프터테이스트<span class="tooltip-text">삼킨 후 입안에 남는 좋은 맛의 지속성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAftertaste_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAftertaste" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">액시디티<span class="tooltip-text">밝은 산미, 긍정적이면 높게</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAcidity_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAcidity" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">바디<span class="tooltip-text">입안에서 느껴지는 무게감, 질감</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBody_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBody" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">밸런스<span class="tooltip-text">각 항목의 조화</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBalance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBalance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">오버럴<span class="tooltip-text">총평, 인상</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreOverall_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreOverall" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-end gap-3">
        <div>
          <label class="text-sm block mb-1">총점 (기본 30점+합계)</label>
          <span id="totalScore" class="font-bold inline-block text-lg bg-gray-100 px-4 py-2 rounded border">86.00</span>
        </div>
        <button type="button" id="calcScoreBtn" class="ml-1 mt-2 px-4 py-2 rounded export-btn flex items-center mobile-touch-friendly"><i class="fas fa-equals mr-2"></i>점수 계산</button>
      </div>
    </section>
    
    <!-- 테이스팅 노트 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-pen-nib mr-2"></i>테이스팅 노트/비고</h3>
      <textarea id="tastingNotes" class="coffee-input w-full min-h-[80px] p-2 border rounded" placeholder="특이사항, 시간, 온도, 커핑 총평 등 메모"></textarea>
    </section>
    
    <!-- 결과 시각화 및 내보내기 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-chart-radar mr-2"></i>결과 시각화 및 내보내기</h3>
      <div class="visual-section-flex w-full mt-2">
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0 mb-2">
          <h4 class="font-semibold mb-2">향미 특성/속성</h4>
          <div id="selectedFlavorsArea"></div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0">
          <h4 class="font-semibold mb-2">SCA 평가 레이더 차트</h4>
          <canvas id="cuppingRadar" class="w-full max-w-full" height="200"></canvas>
        </div>
      </div>
      <div class="flex flex-wrap mt-6 gap-2">
        <button id="exportImgBtn" type="button" class="export-btn px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-image mr-2"></i>이미지로 내보내기</button>
        <button id="exportSnsImgBtn" type="button" class="sns-export-btn px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-share-alt mr-2"></i>SNS형 이미지</button>
        <button id="exportXlsxBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-file-excel mr-2"></i>엑셀로 내보내기</button>
      </div>
      <div class="text-xs text-gray-400 mt-8 md:mt-12 text-center"> 평가일: <span id="evalDate"></span> | mollis SCA 커피 관능 평가</div>
    </section>
  </form>
</div>

<!-- 분할 화면 비교 모달 -->
<div id="splitViewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="font-bold text-lg">분할 화면 비교</h3>
      <button id="closeSplitViewBtn" class="text-gray-500 hover:text-gray-700 mobile-touch-friendly">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="flex gap-2 mb-4 flex-wrap">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">왼쪽 샘플</label>
          <select id="leftSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">오른쪽 샘플</label>
          <select id="rightSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
      </div>
      <div class="split-view" id="splitViewContainer">
        <div class="split-view-container" id="leftSampleView">
          <div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>
        </div>
        <div class="split-view-container" id="rightSampleView">
          <div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="sampleToast" class="sample-toast"></div>

<script>
/* === 1단계: 기본 데이터 구조 및 상수 정의 === */

// 확장된 향미 데이터 - 첨부된 커피 플레이버 휠 참고하여 대폭 확장
const FLAVOR_DATA = [
  // Fruity - Citrus Fruit (감귤류 확장)
  ["Fruity","Citrus Fruit","Lemon","#FFEB88","과일류","감귤류","레몬"],
  ["Fruity","Citrus Fruit","Orange","#FFC300","과일류","감귤류","오렌지"],
  ["Fruity","Citrus Fruit","Grapefruit","#FF9970","과일류","감귤류","자몽"],
  ["Fruity","Citrus Fruit","Lime","#C0E57B","과일류","감귤류","라임"],  
  ["Fruity","Citrus Fruit","Tangerine","#FFA54F","과일류","감귤류","귤"],
  ["Fruity","Citrus Fruit","Yuzu","#EFDF48","과일류","감귤류","유자"],
  ["Fruity","Citrus Fruit","Kumquat","#FFA07A","과일류","감귤류","금귤"],
  ["Fruity","Citrus Fruit","Citron","#F0E68C","과일류","감귤류","시트론"],
  ["Fruity","Citrus Fruit","Blood Orange","#FF4500","과일류","감귤류","블러드 오렌지"],
  ["Fruity","Citrus Fruit","Mandarin","#FFAE42","과일류","감귤류","만다린"],
  ["Fruity","Citrus Fruit","Pomelo","#FDDA0D","과일류","감귤류","폼멜로"],
  ["Fruity","Citrus Fruit","Key Lime","#B6E2A1","과일류","감귤류","키라임"],
  ["Fruity","Citrus Fruit","Bergamot","#F9D949","과일류","감귤류","베르가못"],
  
  // Fruity - Other Fruit (기타 과일 확장)
  ["Fruity","Other Fruit","Apple","#C4E8A2","과일류","기타 과일류","사과"],
  ["Fruity","Other Fruit","Green Apple","#8DB600","과일류","기타 과일류","청사과"],
  ["Fruity","Other Fruit","Red Apple","#FF6347","과일류","기타 과일류","빨간사과"],
  ["Fruity","Other Fruit","Pear","#D6ECC2","과일류","기타 과일류","배"],
  ["Fruity","Other Fruit","Asian Pear","#E8DACC","과일류","기타 과일류","배(동양배)"],
  ["Fruity","Other Fruit","Grape","#A288E3","과일류","기타 과일류","포도"],
  ["Fruity","Other Fruit","White Grape","#E6E8FA","과일류","기타 과일류","청포도"],
  ["Fruity","Other Fruit","Red Grape","#B19CD9","과일류","기타 과일류","적포도"],
  ["Fruity","Other Fruit","Kiwi","#8FBC8F","과일류","기타 과일류","키위"],
  ["Fruity","Other Fruit","Watermelon","#E8B4B8","과일류","기타 과일류","수박"],
  ["Fruity","Other Fruit","Melon","#D1E9B0","과일류","기타 과일류","멜론"],
  ["Fruity","Other Fruit","Cantaloupe","#FDAC53","과일류","기타 과일류","캔털롭 멜론"],
  ["Fruity","Other Fruit","Honeydew","#CCEBC5","과일류","기타 과일류","허니듀 멜론"],
  ["Fruity","Other Fruit","Persimmon","#FF8C00","과일류","기타 과일류","감"],
  ["Fruity","Other Fruit","Pomegranate","#C71585","과일류","기타 과일류","석류"],
  ["Fruity","Other Fruit","Quince","#E3B14E","과일류","기타 과일류","마르멜로"],
  
  // Fruity - Berry (베리류 확장)
  ["Fruity","Berry","Raspberry","#FF8BA0","과일류","베리류","라즈베리"],
  ["Fruity","Berry","Strawberry","#FF97A1","과일류","베리류","딸기"],
  ["Fruity","Berry","Wild Strawberry","#FF6B8A","과일류","베리류","야생 딸기"],
  ["Fruity","Berry","Blackberry","#D7263D","과일류","베리류","블랙베리"],
  ["Fruity","Berry","Blueberry","#7099DA","과일류","베리류","블루베리"],  
  ["Fruity","Berry","Cranberry","#E30B5C","과일류","베리류","크랜베리"],
  ["Fruity","Berry","Acai","#71466F","과일류","베리류","아사이베리"],
  ["Fruity","Berry","Goji Berry","#B22222","과일류","베리류","구기자"],
  ["Fruity","Berry","Elderberry","#654321","과일류","베리류","엘더베리"],
  ["Fruity","Berry","Boysenberry","#873260","과일류","베리류","보이젠베리"],
  ["Fruity","Berry","Currant","#B31B1B","과일류","베리류","커런트"],
  ["Fruity","Berry","Black Currant","#2C1608","과일류","베리류","블랙커런트"],
  ["Fruity","Berry","Red Currant","#DC143C","과일류","베리류","빨간커런트"],
  ["Fruity","Berry","Loganberry","#7A2945","과일류","베리류","로건베리"],
  ["Fruity","Berry","Mulberry","#843B62","과일류","베리류","오디"],
  ["Fruity","Berry","Sea Buckthorn","#F5822B","과일류","베리류","비타민나무 열매"],
  ["Fruity","Berry","Cloudberry","#FFB347","과일류","베리류","클라우드베리"],
  ["Fruity","Berry","Gooseberry","#9ACD32","과일류","베리류","구스베리"],
  
  // Fruity - Stone Fruit (핵과류 확장)
  ["Fruity","Stone Fruit","Peach","#FFA07A","과일류","핵과류","복숭아"],
  ["Fruity","Stone Fruit","White Peach","#FFDAB9","과일류","핵과류","백도"],
  ["Fruity","Stone Fruit","Yellow Peach","#FFCC5C","과일류","핵과류","황도"],
  ["Fruity","Stone Fruit","Donut Peach","#FFE4B5","과일류","핵과류","도넛 복숭아"],
  ["Fruity","Stone Fruit","Apricot","#FBCEB1","과일류","핵과류","살구"],
  ["Fruity","Stone Fruit","Cherry","#DE3163","과일류","핵과류","체리"],  
  ["Fruity","Stone Fruit","Sweet Cherry","#FF1493","과일류","핵과류","단체리"],
  ["Fruity","Stone Fruit","Sour Cherry","#DC143C","과일류","핵과류","신체리"],
  ["Fruity","Stone Fruit","Black Cherry","#4E0F0F","과일류","핵과류","블랙체리"],
  ["Fruity","Stone Fruit","Maraschino Cherry","#FF69B4","과일류","핵과류","마라스키노 체리"],
  ["Fruity","Stone Fruit","Plum","#B27AA4","과일류","핵과류","자두"],
  ["Fruity","Stone Fruit","Red Plum","#8B008B","과일류","핵과류","빨간자두"],
  ["Fruity","Stone Fruit","Yellow Plum","#DDA0DD","과일류","핵과류","노란자두"],
  ["Fruity","Stone Fruit","Damson Plum","#6F2DA8","과일류","핵과류","담슨 자두"],
  ["Fruity","Stone Fruit","Nectarine","#FFB8A0","과일류","핵과류","넥타린"],
  ["Fruity","Stone Fruit","White Nectarine","#FFEFD5","과일류","핵과류","백넥타린"],
  ["Fruity","Stone Fruit","Loquat","#F6AD49","과일류","핵과류","비파"],
  
  // Fruity - Tropical Fruit (열대과일 확장)
  ["Fruity","Tropical Fruit","Pineapple","#FEDF00","과일류","열대과일","파인애플"],
  ["Fruity","Tropical Fruit","Fresh Pineapple","#FFD700","과일류","열대과일","신선한 파인애플"],
  ["Fruity","Tropical Fruit","Grilled Pineapple","#DAA520","과일류","열대과일","구운 파인애플"],
  ["Fruity","Tropical Fruit","Coconut","#F2E8D7","과일류","열대과일","코코넛"],
  ["Fruity","Tropical Fruit","Young Coconut","#FFFAF0","과일류","열대과일","어린 코코넛"],
  ["Fruity","Tropical Fruit","Passion Fruit","#DDA0DD","과일류","열대과일","패션프룻"],
  ["Fruity","Tropical Fruit","Guava","#F88379","과일류","열대과일","구아바"],
  ["Fruity","Tropical Fruit","Pink Guava","#FFB6C1","과일류","열대과일","핑크 구아바"],
  ["Fruity","Tropical Fruit","White Guava","#F5F5F5","과일류","열대과일","화이트 구아바"],
  ["Fruity","Tropical Fruit","Banana","#FFEB99","과일류","열대과일","바나나"],
  ["Fruity","Tropical Fruit","Ripe Banana","#FFE135","과일류","열대과일","익은 바나나"],
  ["Fruity","Tropical Fruit","Green Banana","#9ACD32","과일류","열대과일","덜 익은 바나나"],
  ["Fruity","Tropical Fruit","Mango","#FDBE34","과일류","열대과일","망고"],
  ["Fruity","Tropical Fruit","Ripe Mango","#FF8C00","과일류","열대과일","익은 망고"],
  ["Fruity","Tropical Fruit","Green Mango","#32CD32","과일류","열대과일","풋망고"],
  ["Fruity","Tropical Fruit","Lychee","#FFE4E1","과일류","열대과일","리치"],
  ["Fruity","Tropical Fruit","Star Fruit","#FADA5E","과일류","열대과일","스타프룻"],
  ["Fruity","Tropical Fruit","Papaya","#FFDAB9","과일류","열대과일","파파야"],
  ["Fruity","Tropical Fruit","Dragon Fruit","#FFC0CB","과일류","열대과일","용과"],
  ["Fruity","Tropical Fruit","Jackfruit","#FFEFD5","과일류","열대과일","잭프룻"],
  ["Fruity","Tropical Fruit","Kiwano","#C3D825","과일류","열대과일","키와노"],
  ["Fruity","Tropical Fruit","Durian","#CDB380","과일류","열대과일","두리안"],
  ["Fruity","Tropical Fruit","Longan","#D2B48C","과일류","열대과일","용안"],
  ["Fruity","Tropical Fruit","Mangosteen","#5D1F1E","과일류","열대과일","망고스틴"],
  ["Fruity","Tropical Fruit","Rambutan","#EC2D01","과일류","열대과일","람부탄"],
  ["Fruity","Tropical Fruit","Soursop","#C3E88D","과일류","열대과일","사워삽"],
  ["Fruity","Tropical Fruit","Breadfruit","#E8D499","과일류","열대과일","브레드프룻"],
  
  // Fruity - Dried Fruit (건조과일 확장)
  ["Fruity","Dried Fruit","Raisin","#BB9055","과일류","건조과일","건포도"],
  ["Fruity","Dried Fruit","Golden Raisin","#DAA520","과일류","건조과일","골든 건포도"],
  ["Fruity","Dried Fruit","Sultana","#CD853F","과일류","건조과일","술타나"],
  ["Fruity","Dried Fruit","Prune","#925E3A","과일류","건조과일","자두말린것"],
  ["Fruity","Dried Fruit","Fig","#8A4117","과일류","건조과일","무화과"],
  ["Fruity","Dried Fruit","Date","#A57164","과일류","건조과일","대추야자"],
  ["Fruity","Dried Fruit","Medjool Date","#8B4513","과일류","건조과일","메드줄 대추"],
  ["Fruity","Dried Fruit","Dried Apple","#D5BA98","과일류","건조과일","말린사과"],
  ["Fruity","Dried Fruit","Dried Cherry","#A85751","과일류","건조과일","말린체리"],
  ["Fruity","Dried Fruit","Dried Apricot","#E9967A","과일류","건조과일","말린살구"],
  ["Fruity","Dried Fruit","Dried Mango","#FFD700","과일류","건조과일","말린망고"],
  ["Fruity","Dried Fruit","Dried Cranberry","#C41E3A","과일류","건조과일","말린크랜베리"],
  ["Fruity","Dried Fruit","Dried Blueberry","#4682B4","과일류","건조과일","말린블루베리"],
  ["Fruity","Dried Fruit","Dried Banana","#F3E5AB","과일류","건조과일","바나나칩"],
  ["Fruity","Dried Fruit","Dried Pineapple","#FFCC33","과일류","건조과일","말린파인애플"],
  
  // Sweet (단맛 확장)
  ["Sweet","Brown Sugar","Raw Sugar","#DFC5A4","단맛","흑설탕","원당"],
  ["Sweet","Brown Sugar","Muscovado","#5C4033","단맛","흑설탕","무스코바도"],
  ["Sweet","Brown Sugar","Demerara","#8B7355","단맛","흑설탕","데메라라"],
  ["Sweet","Brown Sugar","Turbinado","#D2B48C","단맛","흑설탕","터비나도"],
  ["Sweet","Brown Sugar","Brown Sugar","#B38B57","단맛","흑설탕","흑설탕"],
  ["Sweet","Caramelized","Caramel","#FFB15E","단맛","카라멜화","캐러멜"],
  ["Sweet","Caramelized","Toffee","#D2691E","단맛","카라멜화","토피"],
  ["Sweet","Caramelized","Butterscotch","#E09540","단맛","카라멜화","버터스카치"],
  ["Sweet","Caramelized","Burnt Sugar","#8B4513","단맛","카라멜화","탄설탕"],
  ["Sweet","Vanilla","Honey","#FDE994","단맛","바닐라","꿀"],
  ["Sweet","Vanilla","Wildflower Honey","#F0E68C","단맛","바닐라","야생화꿀"],
  ["Sweet","Vanilla","Acacia Honey","#FFEFD5","단맛","바닐라","아카시아꿀"],
  ["Sweet","Vanilla","Vanilla","#F0D7BC","단맛","바닐라","바닐라"],
  ["Sweet","Vanilla","Vanilla Bean","#F3E5AB","단맛","바닐라","바닐라빈"],
  ["Sweet","Vanilla","Custard","#F0E68C","단맛","바닐라","커스터드"],
  ["Sweet","Vanilla","Cream","#FFFDD0","단맛","바닐라","크림"],
  ["Sweet","Molasses","Maple Syrup","#C97C5D","단맛","당밀","메이플시럽"],
  ["Sweet","Molasses","Molasses","#774936","단맛","당밀","당밀"],
  ["Sweet","Molasses","Black Treacle","#2C1901","단맛","당밀","블랙트리클"],
  ["Sweet","Molasses","Golden Syrup","#F5BD1F","단맛","당밀","골든시럽"],
  ["Sweet","Molasses","Palm Sugar","#C19A6B","단맛","당밀","야자설탕"],
  ["Sweet","Confectionery","Rock Sugar","#E8E6D9","단맛","과자류","돌설탕"],
  ["Sweet","Confectionery","Condensed Milk","#FFF8DC","단맛","과자류","연유"],
  ["Sweet","Confectionery","White Chocolate","#FFFFF0","단맛","과자류","화이트초콜릿"],
  ["Sweet","Confectionery","Marshmallow","#F8F8FF","단맛","과자류","마시멜로"],
  ["Sweet","Confectionery","Cotton Candy","#FFB6C1","단맛","과자류","솜사탕"],
  
  // Floral (꽃향 확장)
  ["Floral","White Flowers","White Flower","#FFFFFF","꽃향","흰꽃","흰꽃"],
  ["Floral","White Flowers","Jasmine","#DEC2CB","꽃향","흰꽃","자스민"],
  ["Floral","White Flowers","Orange Blossom","#FFCC99","꽃향","흰꽃","오렌지꽃"],
  ["Floral","White Flowers","Elderflower","#F0FFF0","꽃향","흰꽃","엘더플라워"],
  ["Floral","White Flowers","Magnolia","#F8F4FF","꽃향","흰꽃","목련"],
  ["Floral","White Flowers","Lily","#FFFFFF","꽃향","흰꽃","백합"],
  ["Floral","White Flowers","Gardenia","#F1FFF7","꽃향","흰꽃","치자꽃"],
  ["Floral","White Flowers","Coffee Blossom","#F5F5F5","꽃향","흰꽃","커피꽃"],
  ["Floral","Colored Flowers","Rose","#FD5D8B","꽃향","유색꽃","장미"],
  ["Floral","Colored Flowers","Red Rose","#DC143C","꽃향","유색꽃","빨간장미"],
  ["Floral","Colored Flowers","Pink Rose","#FFB6C1","꽃향","유색꽃","핑크장미"],
  ["Floral","Colored Flowers","Hibiscus","#F53E6A","꽃향","유색꽃","히비스커스"],
  ["Floral","Colored Flowers","Lavender","#B57EDC","꽃향","유색꽃","라벤더"],
  ["Floral","Colored Flowers","Violet","#C9A0DC","꽃향","유색꽃","제비꽃"],
  ["Floral","Colored Flowers","Cherry Blossom","#FFB7C5","꽃향","유색꽃","벚꽃"],
  ["Floral","Colored Flowers","Orchid","#DA70D6","꽃향","유색꽃","난꽃"],
  ["Floral","Colored Flowers","Geranium","#FF577F","꽃향","유색꽃","제라늄"],
  ["Floral","Colored Flowers","Freesia","#FFBF00","꽃향","유색꽃","프리지아"],
  ["Floral","Colored Flowers","Peony","#FAAFBE","꽃향","유색꽃","모란"],
  ["Floral","Colored Flowers","Lotus","#E8F1D4","꽃향","유색꽃","연꽃"],
  ["Floral","Colored Flowers","Lilac","#C8A2C8","꽃향","유색꽃","라일락"],
  ["Floral","Colored Flowers","Iris","#5A4FCF","꽃향","유색꽃","아이리스"],
  ["Floral","Colored Flowers","Wisteria","#C9A0DC","꽃향","유색꽃","등나무꽃"],
  ["Floral","Herbal Flowers","Chamomile","#F5E5C0","꽃향","허브꽃","카모마일"],
  ["Floral","Herbal Flowers","Honeysuckle","#FFF0DB","꽃향","허브꽃","인동덩굴"],
  ["Floral","Herbal Flowers","Osmanthus","#FFDB58","꽃향","허브꽃","계수나무"],
  
  // Nutty/Cocoa (견과/코코아 확장)
  ["Nutty/Cocoa","Tree Nuts","Almond","#DBD3C9","견과/코코아","견과류","아몬드"],
  ["Nutty/Cocoa","Tree Nuts","Sweet Almond","#F5DEB3","견과/코코아","견과류","단아몬드"],
  ["Nutty/Cocoa","Tree Nuts","Bitter Almond","#D2B48C","견과/코코아","견과류","쓴아몬드"],
  ["Nutty/Cocoa","Tree Nuts","Hazelnut","#D7C2A8","견과/코코아","견과류","헤이즐넛"],
  ["Nutty/Cocoa","Tree Nuts","Roasted Hazelnut","#CD853F","견과/코코아","견과류","구운 헤이즐넛"],
  ["Nutty/Cocoa","Tree Nuts","Walnut","#C19A6B","견과/코코아","견과류","호두"],
  ["Nutty/Cocoa","Tree Nuts","Black Walnut","#654321","견과/코코아","견과류","검은호두"],
  ["Nutty/Cocoa","Tree Nuts","Pecan","#7E675E","견과/코코아","견과류","피칸"],
  ["Nutty/Cocoa","Tree Nuts","Macadamia","#F5F5DC","견과/코코아","견과류","마카다미아"],
  ["Nutty/Cocoa","Tree Nuts","Cashew","#F5DEB3","견과/코코아","견과류","캐슈넛"],
  ["Nutty/Cocoa","Tree Nuts","Pistachio","#93C572","견과/코코아","견과류","피스타치오"],
  ["Nutty/Cocoa","Tree Nuts","Brazilian Nut","#8D6E63","견과/코코아","견과류","브라질너트"],
  ["Nutty/Cocoa","Tree Nuts","Chestnut","#954535","견과/코코아","견과류","밤"],
  ["Nutty/Cocoa","Tree Nuts","Pine Nut","#D6C9A0","견과/코코아","견과류","잣"],
  ["Nutty/Cocoa","Other Nuts","Peanut","#D28C78","견과/코코아","기타견과류","땅콩"],
  ["Nutty/Cocoa","Other Nuts","Roasted Peanut","#A0522D","견과/코코아","기타견과류","구운땅콩"],
  ["Nutty/Cocoa","Other Nuts","Coconut","#F2EFE9","견과/코코아","기타견과류","코코넛"],
  ["Nutty/Cocoa","Cocoa","Dark Chocolate","#6C4F3D","견과/코코아","코코아","다크초콜릿"],
  ["Nutty/Cocoa","Cocoa","70% Dark Chocolate","#5D4037","견과/코코아","코코아","70% 다크초콜릿"],
  ["Nutty/Cocoa","Cocoa","85% Dark Chocolate","#3E2723","견과/코코아","코코아","85% 다크초콜릿"],
  ["Nutty/Cocoa","Cocoa","Cocoa","#926F34","견과/코코아","코코아","코코아"],
  ["Nutty/Cocoa","Cocoa","Raw Cocoa","#8B4513","견과/코코아","코코아","로우 코코아"],
  ["Nutty/Cocoa","Cocoa","Milk Chocolate","#7B3F00","견과/코코아","코코아","밀크초콜릿"],
  ["Nutty/Cocoa","Cocoa","Bittersweet Chocolate","#332421","견과/코코아","코코아","쌉싸름한 초콜릿"],
  ["Nutty/Cocoa","Cocoa","White Chocolate","#F5F5F5","견과/코코아","코코아","화이트 초콜릿"],
  ["Nutty/Cocoa","Cocoa","Mocha","#785135","견과/코코아","코코아","모카"],
  ["Nutty/Cocoa","Cocoa","Cacao Nibs","#654321","견과/코코아","코코아","카카오닙스"],
  ["Nutty/Cocoa","Cocoa","Cocoa Butter","#FEF5CA","견과/코코아","코코아","코코아 버터"],
  ["Nutty/Cocoa","Cocoa","Chocolate Liquor","#3D1E0F","견과/코코아","코코아","초콜릿 리쿼"],
  
  // Spices (향신료 확장)
  ["Spices","Warm Spices","Cinnamon","#E5B39B","향신료","따뜻한향신료","시나몬"],
  ["Spices","Warm Spices","Ceylon Cinnamon","#D2B48C","향신료","따뜻한향신료","실론 시나몬"],
  ["Spices","Warm Spices","Cassia","#A0522D","향신료","따뜻한향신료","카시아"],
  ["Spices","Warm Spices","Clove","#C17855","향신료","따뜻한향신료","정향"],
  ["Spices","Warm Spices","Cardamom","#BDA55D","향신료","따뜻한향신료","카다몬"],
  ["Spices","Warm Spices","Green Cardamom","#9ACD32","향신료","따뜻한향신료","그린 카다몬"],
  ["Spices","Warm Spices","Black Cardamom","#654321","향신료","따뜻한향신료","블랙 카다몬"],
  ["Spices","Warm Spices","Allspice","#9C5903","향신료","따뜻한향신료","올스파이스"],
  ["Spices","Warm Spices","Nutmeg","#BD9C7F","향신료","따뜻한향신료","육두구"],
  ["Spices","Warm Spices","Mace","#C19A6B","향신료","따뜻한향신료","메이스"],
  ["Spices","Hot Spices","Black Pepper","#393939","향신료","매운향신료","흑후추"],
  ["Spices","Hot Spices","White Pepper","#F5F5DC","향신료","매운향신료","백후추"],
  ["Spices","Hot Spices","Pink Pepper","#DDA0DD","향신료","매운향신료","핑크페퍼"],
  ["Spices","Hot Spices","Cayenne","#CC333F","향신료","매운향신료","카이엔 페퍼"],
  ["Spices","Hot Spices","Chili","#FF6347","향신료","매운향신료","칠리"],
  ["Spices","Aromatic Spices","Ginger","#EFCC9C","향신료","방향성향신료","생강"],
  ["Spices","Aromatic Spices","Fresh Ginger","#F4E4BC","향신료","방향성향신료","신선한 생강"],
  ["Spices","Aromatic Spices","Dried Ginger","#CD853F","향신료","방향성향신료","말린 생강"],
  ["Spices","Aromatic Spices","Star Anise","#483C32","향신료","방향성향신료","팔각"],
  ["Spices","Aromatic Spices","Anise","#50404D","향신료","방향성향신료","아니스"],
  ["Spices","Aromatic Spices","Fennel","#C1E1C1","향신료","방향성향신료","회향"],
  ["Spices","Aromatic Spices","Licorice","#2A2926","향신료","방향성향신료","감초"],
  ["Spices","Aromatic Spices","Cumin","#8B4513","향신료","방향성향신료","쿠민"],
  ["Spices","Aromatic Spices","Coriander","#AEC6A5","향신료","방향성향신료","고수"],
  ["Spices","Aromatic Spices","Coriander Seed","#C9A66B","향신료","방향성향신료","코리앤더 씨앗"],
  ["Spices","Aromatic Spices","Turmeric","#FFC300","향신료","방향성향신료","강황"],
  ["Spices","Aromatic Spices","Saffron","#F4C430","향신료","방향성향신료","사프란"],
  ["Spices","Aromatic Spices","Juniper Berries","#6D80AB","향신료","방향성향신료","주니퍼베리"],
  ["Spices","Aromatic Spices","Fenugreek","#C19A6B","향신료","방향성향신료","페뉴그릭"],
  
  // Tea (차 확장)
  ["Tea","Black Tea","Earl Grey","#3A2E39","차","홍차","얼그레이"],
  ["Tea","Black Tea","English Breakfast","#654321","차","홍차","잉글리시 브렉퍼스트"],
  ["Tea","Black Tea","Darjeeling","#856D4D","차","홍차","다즐링"],
  ["Tea","Black Tea","Assam","#4E362F","차","홍차","아삼"],
  ["Tea","Black Tea","Ceylon","#5F4842","차","홍차","실론"],
  ["Tea","Black Tea","Keemun","#6B4226","차","홍차","기문"],
  ["Tea","Black Tea","Lapsang Souchong","#2F1B14","차","홍차","라프상 소우총"],
  ["Tea","Green Tea","Matcha","#D0F0C0","차","녹차","말차"],
  ["Tea","Green Tea","Sencha","#90EE90","차","녹차","센차"],
  ["Tea","Green Tea","Gyokuro","#799E65","차","녹차","교쿠로"],
  ["Tea","Green Tea","Longjing","#C7E4C0","차","녹차","룽징"],
  ["Tea","Green Tea","Jasmine Green Tea","#E6FFE6","차","녹차","자스민 녹차"],
  ["Tea","Oolong","Oolong","#A0522D","차","우롱차","우롱"],
  ["Tea","Oolong","Ti Kuan Yin","#8B4513","차","우롱차","철관음"],
  ["Tea","Oolong","Da Hong Pao","#654321","차","우롱차","대홍포"],
  ["Tea","White Tea","Silver Needle","#E6E8FA","차","백차","은침차"],
  ["Tea","White Tea","White Peony","#F5F5F5","차","백차","백모단"],
  ["Tea","Herbal Tea","Chamomile","#FADA5E","차","허브차","카모마일"],
  ["Tea","Herbal Tea","Peppermint","#98FB98","차","허브차","페퍼민트"],
  ["Tea","Herbal Tea","Rooibos","#D2691E","차","허브차","루이보스"],
  ["Tea","Herbal Tea","Hibiscus Tea","#CA3433","차","허브차","히비스커스차"],
  ["Tea","Herbal Tea","Lemongrass","#9DC183","차","허브차","레몬그라스"],
  ["Tea","Herbal Tea","Chrysanthemum","#FFD700","차","허브차","국화차"],
  ["Tea","Herbal Tea","Mint Tea","#98FB98","차","허브차","민트차"],
  ["Tea","Puer","Aged Puer","#70593E","차","푸얼차","숙성 보이차"],
  ["Tea","Puer","Raw Puer","#B5AA89","차","푸얼차","생 보이차"],
  ["Tea","Puer","Ripe Puer","#5D4037","차","푸얼차","숙 보이차"],
  
  // Cereal/Grain (곡물류 확장)
  ["Cereal/Grain","Malted","Malt","#F0E68C","곡물류","맥아","맥아"],
  ["Cereal/Grain","Malted","Barley Malt","#D2B48C","곡물류","맥아","보리맥아"],
  ["Cereal/Grain","Malted","Wheat Malt","#EAD9A7","곡물류","맥아","밀맥아"],
  ["Cereal/Grain","Baked","Toast","#D2B48C","곡물류","구운것","토스트"],
  ["Cereal/Grain","Baked","Whole Wheat Toast","#8B7355","곡물류","구운것","통밀토스트"],
  ["Cereal/Grain","Baked","Sourdough","#E1D7C6","곡물류","구운것","사워도우"],
  ["Cereal/Grain","Baked","Brioche","#EED7A1","곡물류","구운것","브리오슈"],
  ["Cereal/Grain","Baked","Biscuit","#E2DFD2","곡물류","구운것","비스킷"],
  ["Cereal/Grain","Baked","Graham Cracker","#C9AD86","곡물류","구운것","그레이엄 크래커"],
  ["Cereal/Grain","Raw Grains","Barley","#DBD0AE","곡물류","생곡물","보리"],
  ["Cereal/Grain","Raw Grains","Oats","#E4CBB1","곡물류","생곡물","귀리"],
  ["Cereal/Grain","Raw Grains","Steel Cut Oats","#D4B896","곡물류","생곡물","스틸컷 오트"],
  ["Cereal/Grain","Raw Grains","Rice","#F9FBE7","곡물류","생곡물","쌀"],
  ["Cereal/Grain","Raw Grains","Brown Rice","#DEB887","곡물류","생곡물","현미"],
  ["Cereal/Grain","Raw Grains","Wheat","#EAD9A7","곡물류","생곡물","밀"],
  ["Cereal/Grain","Raw Grains","Whole Wheat","#BC9A6A","곡물류","생곡물","통밀"],
  ["Cereal/Grain","Raw Grains","Corn","#FFF380","곡물류","생곡물","옥수수"],
  ["Cereal/Grain","Raw Grains","Rye","#8B7355","곡물류","생곡물","호밀"],
  ["Cereal/Grain","Raw Grains","Buckwheat","#C19A6B","곡물류","생곡물","메밀"],
  ["Cereal/Grain","Raw Grains","Quinoa","#DEC19E","곡물류","생곡물","퀴노아"],
  ["Cereal/Grain","Raw Grains","Millet","#E9E4A7","곡물류","생곡물","기장"],
  ["Cereal/Grain","Processed","Granola","#C8A951","곡물류","가공품","그래놀라"],
  ["Cereal/Grain","Processed","Cheerios","#E8C99B","곡물류","가공품","시리오스"],
  ["Cereal/Grain","Processed","Cornflakes","#FFBF00","곡물류","가공품","콘플레이크"],
  
  // Roasted (로스팅 향 확장)
  ["Roasted","Light Roast","Cinnamon Roast","#AD8150","로스팅","라이트 로스트","시나몬 로스트"],
  ["Roasted","Light Roast","New England Roast","#967969","로스팅","라이트 로스트","뉴잉글랜드 로스트"],
  ["Roasted","Light Roast","Tea-like","#967969","로스팅","라이트 로스트","차와 유사한"],
  ["Roasted","Light Roast","Herbal","#BDCB96","로스팅","라이트 로스트","허브향"],
  ["Roasted","Medium Roast","American Roast","#8B4513","로스팅","미디엄 로스트","아메리칸 로스트"],
  ["Roasted","Medium Roast","City Roast","#7B3F00","로스팅","미디엄 로스트","시티 로스트"],
  ["Roasted","Medium Roast","Full City","#654321","로스팅","미디엄 로스트","풀 시티"],
  ["Roasted","Medium Roast","Vienna Roast","#4E3524","로스팅","미디엄 로스트","비엔나 로스트"],
  ["Roasted","Medium Roast","Toasty","#C19A6B","로스팅","미디엄 로스트","토스티"],
  ["Roasted","Medium Roast","Caramelized","#C68E17","로스팅","미디엄 로스트","캐러멜화"],
  ["Roasted","Medium Roast","Nutty","#D2B48C","로스팅","미디엄 로스트","견과류"],
  ["Roasted","Dark Roast","French Roast","#23180D","로스팅","다크 로스트","프렌치 로스트"],
  ["Roasted","Dark Roast","Italian Roast","#281811","로스팅","다크 로스트","이탈리안 로스트"],
  ["Roasted","Dark Roast","Spanish Roast","#1C1208","로스팅","다크 로스트","스패니시 로스트"],
  ["Roasted","Dark Roast","Continental Roast","#0F0A05","로스팅","다크 로스트","컨티넨탈 로스트"],
  ["Roasted","Dark Roast","Burnt","#373536","로스팅","다크 로스트","탄 맛"],
  ["Roasted","Dark Roast","Charred","#2C1608","로스팅","다크 로스트","숯불향"],
  ["Roasted","Dark Roast","Ashy","#5D5D5D","로스팅","다크 로스트","재 맛"],
  ["Roasted","Dark Roast","Tobacco","#715F3F","로스팅","다크 로스트","담배향"],
  ["Roasted","Dark Roast","Dark Chocolate","#3D2314","로스팅","다크 로스트","다크 초콜릿"],
  ["Roasted","Smoky","Smoky","#463F3A","로스팅","훈연","훈연향"],
  ["Roasted","Smoky","Wood Smoke","#696969","로스팅","훈연","나무연기"],
  ["Roasted","Smoky","Barbecue","#8B4513","로스팅","훈연","바비큐"],
  
  // Green/Vegetative (풀/채소류 확장)
  ["Green/Vegetative","Fresh Green","Under-ripe","#A4C09C","풀/채소류","신선한풀","덜 익은 맛"],
  ["Green/Vegetative","Fresh Green","Grass","#7EC850","풀/채소류","신선한풀","풀"],
  ["Green/Vegetative","Fresh Green","Fresh Cut Grass","#66BB6A","풀/채소류","신선한풀","갓 깎은 풀"],
  ["Green/Vegetative","Fresh Green","Green Bell Pepper","#4F7942","풀/채소류","신선한풀","피망"],
  ["Green/Vegetative","Fresh Green","Cucumber","#8FBC8F","풀/채소류","신선한풀","오이"],
  ["Green/Vegetative","Fresh Green","Green Apple","#8DB600","풀/채소류","신선한풀","청사과"],
  ["Green/Vegetative","Fresh Green","Green Beans","#7BAA1D","풀/채소류","신선한풀","껍질콩"],
  ["Green/Vegetative","Fresh Green","Peapod","#B2DAC0","풀/채소류","신선한풀","완두콩 꼬투리"],
  ["Green/Vegetative","Fresh Green","Fresh","#C2E99E","풀/채소류","신선한풀","신선한"],
  ["Green/Vegetative","Herbaceous","Mint","#98FB98","풀/채소류","허브류","민트"],
  ["Green/Vegetative","Herbaceous","Spearmint","#00FF7F","풀/채소류","허브류","스피어민트"],
  ["Green/Vegetative","Herbaceous","Peppermint","#90EE90","풀/채소류","허브류","페퍼민트"],
  ["Green/Vegetative","Herbaceous","Basil","#579229","풀/채소류","허브류","바질"],
  ["Green/Vegetative","Herbaceous","Sweet Basil","#6B8E23","풀/채소류","허브류","스위트 바질"],
  ["Green/Vegetative","Herbaceous","Thai Basil","#4B5320","풀/채소류","허브류","타이 바질"],
  ["Green/Vegetative","Herbaceous","Sage","#BCB88A","풀/채소류","허브류","세이지"],
  ["Green/Vegetative","Herbaceous","Rosemary","#77815C","풀/채소류","허브류","로즈마리"],
  ["Green/Vegetative","Herbaceous","Thyme","#4E5144","풀/채소류","허브류","타임"],  
  ["Green/Vegetative","Herbaceous","Oregano","#50C878","풀/채소류","허브류","오레가노"],
  ["Green/Vegetative","Herbaceous","Dill","#718F58","풀/채소류","허브류","딜"],
  ["Green/Vegetative","Herbaceous","Cilantro","#BDFFA8","풀/채소류","허브류","실란트로"],
  ["Green/Vegetative","Herbaceous","Parsley","#7FFFD4","풀/채소류","허브류","파슬리"],
  ["Green/Vegetative","Herbaceous","Tarragon","#A3B86C","풀/채소류","허브류","타라곤"],
  ["Green/Vegetative","Herbaceous","Bay Leaf","#87A96B","풀/채소류","허브류","월계수잎"],
  ["Green/Vegetative","Vegetal","Olive","#708238","풀/채소류","채소류","올리브"],
  ["Green/Vegetative","Vegetal","Green Olive","#9CAF88","풀/채소류","채소류","그린 올리브"],
  ["Green/Vegetative","Vegetal","Black Olive","#36454F","풀/채소류","채소류","블랙 올리브"],
  ["Green/Vegetative","Vegetal","Spinach","#175732","풀/채소류","채소류","시금치"],
  ["Green/Vegetative","Vegetal","Artichoke","#8F9779","풀/채소류","채소류","아티초크"],
  ["Green/Vegetative","Vegetal","Celery","#C1FD95","풀/채소류","채소류","셀러리"],
  ["Green/Vegetative","Vegetal","Brussels Sprout","#7C9C53","풀/채소류","채소류","방울양배추"],
  ["Green/Vegetative","Vegetal","Kale","#5F7F50","풀/채소류","채소류","케일"],
  ["Green/Vegetative","Vegetal","Wheatgrass","#98FB98","풀/채소류","채소류","밀싹"],
  ["Green/Vegetative","Vegetal","Asparagus","#87A96B","풀/채소류","채소류","아스파라거스"],
  ["Green/Vegetative","Vegetal","Broccoli","#6B8E23","풀/채소류","채소류","브로콜리"],
  
  // Sour/Fermented (산미/발효 확장)
  ["Sour/Fermented","Clean Acidity","Citric Acid","#CEE6CB","산미/발효","깨끗한산미","시트르산"],
  ["Sour/Fermented","Clean Acidity","Malic Acid","#C9E265","산미/발효","깨끗한산미","말산"],
  ["Sour/Fermented","Clean Acidity","Tartaric Acid","#D7E8CB","산미/발효","깨끗한산미","타르타르산"],
  ["Sour/Fermented","Clean Acidity","Phosphoric Acid","#E8F3D9","산미/발효","깨끗한산미","인산"],
  ["Sour/Fermented","Clean Acidity","Lactic Acid","#F5F5F5","산미/발효","깨끗한산미","젖산"],
  ["Sour/Fermented","Sour","Acetic Acid","#D9C1B4","산미/발효","산미","아세트산"],
  ["Sour/Fermented","Sour","Vinegar","#ECEDE6","산미/발효","산미","식초"],
  ["Sour/Fermented","Sour","Apple Cider Vinegar","#F4A460","산미/발효","산미","사과식초"],
  ["Sour/Fermented","Sour","Balsamic Vinegar","#654321","산미/발효","산미","발사믹 식초"],
  ["Sour/Fermented","Fermented","Winey","#AC436E","산미/발효","발효","와인 맛"],
  ["Sour/Fermented","Fermented","Red Wine","#722F37","산미/발효","발효","적포도주"],
  ["Sour/Fermented","Fermented","White Wine","#F7E7CE","산미/발효","발효","백포도주"],
  ["Sour/Fermented","Fermented","Champagne","#F7E7CE","산미/발효","발효","샴페인"],
  ["Sour/Fermented","Fermented","Overripe","#625958","산미/발효","발효","과숙한"],
  ["Sour/Fermented","Fermented","Yogurt","#F5F5F5","산미/발효","발효","요거트"],
  ["Sour/Fermented","Fermented","Greek Yogurt","#FFF8DC","산미/발효","발효","그릭 요거트"],
  ["Sour/Fermented","Fermented","Kefir","#F0EAD6","산미/발효","발효","케피어"],
  ["Sour/Fermented","Fermented","Sourdough","#E8D0A7","산미/발효","발효","사워도우"],
  ["Sour/Fermented","Fermented","Kombucha","#DEC19B","산미/발효","발효","콤부차"],
  ["Sour/Fermented","Fermented","Kimchi","#E80000","산미/발효","발효","김치"],
  ["Sour/Fermented","Fermented","Sauerkraut","#E8E4C9","산미/발효","발효","사우어크라우트"],
  ["Sour/Fermented","Fermented","Miso","#E9CEAA","산미/발효","발효","미소"],
  ["Sour/Fermented","Fermented","Sake","#EDEADE","산미/발효","발효","사케"],
  ["Sour/Fermented","Fermented","Beer","#F5DEB3","산미/발효","발효","맥주"],
  ["Sour/Fermented","Aged/Funky","Musty","#8B7D6B","산미/발효","숙성/펑키","곰팡이 냄새"],  
  ["Sour/Fermented","Aged/Funky","Earthy","#79553D","산미/발효","숙성/펑키","흙냄새"],
  ["Sour/Fermented","Aged/Funky","Blue Cheese","#7CB9E8","산미/발효","숙성/펑키","블루치즈"],
  ["Sour/Fermented","Aged/Funky","Mildew","#7D7D65","산미/발효","숙성/펑키","곰팡이"],
  ["Sour/Fermented","Aged/Funky","Barnyard","#8B7355","산미/발효","숙성/펑키","축사냄새"],
  
  // Other (기타 확장)
  ["Other","Defect","Baggy","#C8B094","기타","결함","포대냄새"],
  ["Other","Defect","Ferment","#614E1A","기타","결함","과발효"],
  ["Other","Defect","Phenol","#3B0000","기타","결함","페놀릭"],
  ["Other","Defect","Quaker","#D1BEA8","기타","결함","퀘이커"],
  ["Other","Defect","Potato","#D2B48C","기타","결함","감자냄새"],
  ["Other","Defect","Rio","#8B4513","기타","결함","리오"],
  ["Other","Chemical","Chemical","#FCF6B1","기타","화학적","화학적"],
  ["Other","Chemical","Medicinal","#E2D784","기타","화학적","약품향"],
  ["Other","Chemical","Rubber","#454545","기타","화학적","고무"],
  ["Other","Chemical","Petroleum","#2E2E2E","기타","화학적","석유"],
  ["Other","Chemical","Plastic","#BEBEBE","기타","화학적","플라스틱"],
  ["Other","Chemical","Tar","#1C1C1C","기타","화학적","타르"],
  ["Other","Chemical","Solvent","#696969","기타","화학적","용제"],
  ["Other","Earthy","Soil","#6F4E37","기타","흙내음","흙"],
  ["Other","Earthy","Wet Earth","#622F22","기타","흙내음","젖은 흙"],
  ["Other","Earthy","Dry Earth","#8B7355","기타","흙내음","마른 흙"],
  ["Other","Earthy","Mushroom","#D7CEC7","기타","흙내음","버섯"],
  ["Other","Earthy","Shiitake","#8B7355","기타","흙내음","표고버섯"],
  ["Other","Earthy","Porcini","#A0522D","기타","흙내음","포르치니"],
  ["Other","Earthy","Forest Floor","#5E4B3B","기타","흙내음","숲바닥"],
  ["Other","Earthy","Moss","#617744","기타","흙내음","이끼"],
  ["Other","Earthy","Truffle","#523A28","기타","흙내음","트러플"],
  ["Other","Woody","Oak","#A46B2B","기타","나무향","오크"],
  ["Other","Woody","French Oak","#8B4513","기타","나무향","프렌치 오크"],
  ["Other","Woody","American Oak","#CD853F","기타","나무향","아메리칸 오크"],
  ["Other","Woody","Cedar","#A67B5B","기타","나무향","삼나무"],
  ["Other","Woody","Pine","#8A9A5B","기타","나무향","소나무"],
  ["Other","Woody","Sandalwood","#B87333","기타","나무향","백단향"],
  ["Other","Woody","Maple","#C04000","기타","나무향","단풍나무"],
  ["Other","Woody","Bamboo","#78866B","기타","나무향","대나무"],
  ["Other","Woody","Cypress","#2F4F4F","기타","나무향","사이프러스"],
  ["Other","Woody","Eucalyptus","#44C173","기타","나무향","유칼립투스"],
  ["Other","Woody","Teak","#9A7B4F","기타","나무향","티크"],
  ["Other","Woody","Mahogany","#7C1C05","기타","나무향","마호가니"],
  ["Other","Woody","Birch","#F5DEB3","기타","나무향","자작나무"],
  ["Other","Animal","Leather","#8B4513","기타","동물향","가죽"],
  ["Other","Animal","Suede","#C0C0C0","기타","동물향","스웨이드"],
  ["Other","Animal","Musk","#4E4B51","기타","동물향","사향"],
  ["Other","Animal","Honey Comb","#ECB176","기타","동물향","벌집"],
  ["Other","Animal","Beeswax","#F0DC82","기타","동물향","밀랍"],
  ["Other","Mineral","Mineral","#A8A8A8","기타","미네랄","미네랄"],
  ["Other","Mineral","Wet Stone","#708090","기타","미네랄","젖은 돌"],
  ["Other","Mineral","Chalk","#F5F5F5","기타","미네랄","분필"],
  ["Other","Mineral","Limestone","#E5E4E2","기타","미네랄","석회암"],
  ["Other","Mineral","Salt","#FFFFFF","기타","미네랄","소금"],
  ["Other","Mineral","Sea Salt","#F0F8FF","기타","미네랄","바다소금"]
];

// 바디감 디스크립터 데이터 개선 - 더 많은 항목과 한글/영문 지원 강화
const BODY_DESCRIPTORS = [
  // 질감 계열
  { id: 'silky', label: 'Silky', korean: '실키한', category: 'texture', color: '#E6E6FA' },
  { id: 'smooth', label: 'Smooth', korean: '부드러운', category: 'texture', color: '#F5F5DC' },
  { id: 'creamy', label: 'Creamy', korean: '크리미한', category: 'texture', color: '#FFFDD0' },
  { id: 'velvety', label: 'Velvety', korean: '벨벳같은', category: 'texture', color: '#DDA0DD' },
  { id: 'buttery', label: 'Buttery', korean: '버터같은', category: 'texture', color: '#FFFACD' },
  { id: 'oily', label: 'Oily', korean: '오일리한', category: 'texture', color: '#F0E68C' },
  { id: 'watery', label: 'Watery', korean: '물같은', category: 'texture', color: '#E0F6FF' },
  { id: 'thin', label: 'Thin', korean: '얇은', category: 'texture', color: '#F0F8FF' },
  { id: 'syrupy', label: 'Syrupy', korean: '시럽같은', category: 'texture', color: '#DAA520' },
  { id: 'viscous', label: 'Viscous', korean: '점성있는', category: 'texture', color: '#CD853F' },
  { id: 'juicy', label: 'Juicy', korean: '과즙이 풍부한', category: 'texture', color: '#FFB6C1' },
  { id: 'slick', label: 'Slick', korean: '매끄러운', category: 'texture', color: '#E0E0E0' },
  
  // 무게감 계열
  { id: 'light', label: 'Light', korean: '가벼운', category: 'weight', color: '#F0F8FF' },
  { id: 'medium_light', label: 'Medium-Light', korean: '중간-가벼운', category: 'weight', color: '#F5F5F5' },
  { id: 'medium', label: 'Medium', korean: '중간', category: 'weight', color: '#DCDCDC' },
  { id: 'medium_heavy', label: 'Medium-Heavy', korean: '중간-무거운', category: 'weight', color: '#C0C0C0' },
  { id: 'heavy', label: 'Heavy', korean: '무거운', category: 'weight', color: '#A9A9A9' },
  { id: 'full', label: 'Full', korean: '풀 바디', category: 'weight', color: '#808080' },
  { id: 'robust', label: 'Robust', korean: '견고한', category: 'weight', color: '#696969' },
  { id: 'substantial', label: 'Substantial', korean: '실질적인', category: 'weight', color: '#778899' },
  { id: 'massive', label: 'Massive', korean: '거대한', category: 'weight', color: '#555555' },
  { id: 'weightless', label: 'Weightless', korean: '무중력의', category: 'weight', color: '#F8F8FF' },
  
  // 밀도감 계열
  { id: 'dense', label: 'Dense', korean: '밀도있는', category: 'density', color: '#556B2F' },
  { id: 'concentrated', label: 'Concentrated', korean: '농축된', category: 'density', color: '#8B4513' },
  { id: 'rich', label: 'Rich', korean: '풍부한', category: 'density', color: '#A0522D' },
  { id: 'deep', label: 'Deep', korean: '깊은', category: 'density', color: '#8B0000' },
  { id: 'intense', label: 'Intense', korean: '강렬한', category: 'density', color: '#4B0082' },
  { id: 'weak', label: 'Weak', korean: '약한', category: 'density', color: '#F5F5F5' },
  { id: 'diluted', label: 'Diluted', korean: '희석된', category: 'density', color: '#F0F8FF' },
  { id: 'thin_sparse', label: 'Sparse', korean: '드문드문한', category: 'density', color: '#E6E6FA' },
  { id: 'compact', label: 'Compact', korean: '촘촘한', category: 'density', color: '#8B7D6B' },
  
  // 입안감촉 계열
  { id: 'round', label: 'Round', korean: '둥근', category: 'mouthfeel', color: '#DEB887' },
  { id: 'coating', label: 'Coating', korean: '코팅감', category: 'mouthfeel', color: '#F4A460' },
  { id: 'lingering', label: 'Lingering', korean: '지속되는', category: 'mouthfeel', color: '#CD853F' },
  { id: 'clean', label: 'Clean', korean: '깔끔한', category: 'mouthfeel', color: '#F0FFFF' },
  { id: 'crisp', label: 'Crisp', korean: '상쾌한', category: 'mouthfeel', color: '#E0FFFF' },
  { id: 'refreshing', label: 'Refreshing', korean: '상큼한', category: 'mouthfeel', color: '#AFEEEE' },
  { id: 'astringent', label: 'Astringent', korean: '떫은', category: 'mouthfeel', color: '#8FBC8F' },
  { id: 'drying', label: 'Drying', korean: '건조한', category: 'mouthfeel', color: '#D2B48C' },
  { id: 'chalky', label: 'Chalky', korean: '분필같은', category: 'mouthfeel', color: '#F5F5F5' },
  { id: 'gritty', label: 'Gritty', korean: '거친', category: 'mouthfeel', color: '#BC8F8F' },
  { id: 'powdery', label: 'Powdery', korean: '가루같은', category: 'mouthfeel', color: '#FFE4E1' },
  { id: 'metallic', label: 'Metallic', korean: '금속성의', category: 'mouthfeel', color: '#C0C0C0' },
  { id: 'tannic', label: 'Tannic', korean: '타닌감', category: 'mouthfeel', color: '#8B4513' },
  { id: 'velvety_smooth', label: 'Velvety Smooth', korean: '벨벳처럼 부드러운', category: 'mouthfeel', color: '#DA70D6' },
  
  // 온도감 계열
  { id: 'warming', label: 'Warming', korean: '따뜻한', category: 'temperature', color: '#FF7F50' },
  { id: 'cooling', label: 'Cooling', korean: '시원한', category: 'temperature', color: '#87CEEB' },
  { id: 'neutral', label: 'Neutral', korean: '중성적인', category: 'temperature', color: '#F5F5F5' },
  { id: 'hot', label: 'Hot', korean: '뜨거운', category: 'temperature', color: '#FF4500' },
  { id: 'cold', label: 'Cold', korean: '차가운', category: 'temperature', color: '#4169E1' }
];

// 향미 선택 관련 상수들
const FLAVOR_PHASES = [
  {id:"fragrance", label:"프래그런스", labelEn:"Fragrance"}, 
  {id:"aroma", label:"아로마", labelEn:"Aroma"}, 
  {id:"flavor", label:"플레이버", labelEn:"Flavor"}, 
  {id:"aftertaste", label:"에프터테이스트", labelEn:"Aftertaste"}
];

const ATTR_TO_BADGE = {
  acidityLevel: {label:"산미", labelEn:"Acidity", color:"#FF6B6B"},
  sweetnessLevel: {label:"단맛", labelEn:"Sweetness", color:"#51CF66"},
  bodyLevel: {label:"바디감", labelEn:"Body", color:"#339AF0"}
};

const ATTR_VALUE_LABELS = {
  "Low": {kr:"낮음", en:"Low"}, 
  "Med-Low": {kr:"낮음-중간", en:"Med-Low"}, 
  "Medium": {kr:"중간", en:"Medium"}, 
  "Med-High": {kr:"중간-높음", en:"Med-High"}, 
  "High": {kr:"높음", en:"High"}
};

const DEFECT_LABELS = {
  none: {label:"미선택", labelEn:"None", color:"#bbb"},
  very_weak: {label:"매우 약함", labelEn:"Very Weak", color:"#9ad0c2"},
  weak: {label:"약함", labelEn:"Weak", color:"#95a7f2"},
  moderate: {label:"보통", labelEn:"Moderate", color:"#f6c177"},
  strong: {label:"강함", labelEn:"Strong", color:"#f59f4c"},
  very_strong: {label:"매우 강함", labelEn:"Very Strong", color:"#fc4747"}
};

const DEFECT_PROPS = [
  {key:"defectUnderdevelopment", label:"언더디벨롭먼트", labelEn:"Underdevelopment", desc:"로스팅 불충분, 강한 산미, 피니시/애프터 부족", wheel:"Green/Vegetative"},
  {key:"defectOverdevelopment", label:"오버디벨롭먼트", labelEn:"Overdevelopment", desc:"과도한 로스팅으로 산미, 플레이버 소멸", wheel:"Roasted"},
  {key:"defectBaked", label:"베이킹(베이크드)", labelEn:"Baked", desc:"팝콘/귀리/시리얼류 결점, 캐러멜화 과잉", wheel:"곡물(Cereal/Grain)"},
  {key:"defectScorching", label:"스코칭", labelEn:"Scorching", desc:"탄맛, 과다열 노출, 재/탄 노트", wheel:"Roasted"}
];

// 향미 카테고리별 그룹핑 (확장)
const FLAVOR_CATEGORIES = [
  { name: "과일류", nameEn: "Fruity", categories: ["Fruity"], color: "#FFB8A0" },
  { name: "달콤함", nameEn: "Sweet", categories: ["Sweet"], color: "#FDE994" },
  { name: "꽃향", nameEn: "Floral", categories: ["Floral"], color: "#F5E5C0" },
  { name: "견과/초콜릿", nameEn: "Nutty/Cocoa", categories: ["Nutty/Cocoa"], color: "#D7C2A8" },
  { name: "향신료", nameEn: "Spices", categories: ["Spices"], color: "#BDA55D" },
  { name: "차", nameEn: "Tea", categories: ["Tea"], color: "#8B4513" },
  { name: "곡물/시리얼", nameEn: "Cereal/Grain", categories: ["Cereal/Grain"], color: "#E4CBB1" },
  { name: "로스팅", nameEn: "Roasted", categories: ["Roasted"], color: "#967969" },
  { name: "풀/채소류", nameEn: "Green/Vegetative", categories: ["Green/Vegetative"], color: "#A4C09C" },
  { name: "산미/발효", nameEn: "Sour/Fermented", categories: ["Sour/Fermented"], color: "#CEE6CB" },
  { name: "기타", nameEn: "Other", categories: ["Other"], color: "#D7CEC7" }
];

// 자주 사용하는 향미 리스트 (확장)
const FREQUENT_FLAVORS = [
  // 베리류
  "Fruity|Berry|Strawberry",
  "Fruity|Berry|Blueberry", 
  "Fruity|Berry|Raspberry",
  "Fruity|Berry|Cranberry",
  "Fruity|Berry|Black Currant",
  
  // 감귤류
  "Fruity|Citrus Fruit|Lemon",
  "Fruity|Citrus Fruit|Orange",
  "Fruity|Citrus Fruit|Grapefruit",
  "Fruity|Citrus Fruit|Bergamot",
  
  // 핵과류
  "Fruity|Stone Fruit|Peach",
  "Fruity|Stone Fruit|Apricot",
  "Fruity|Stone Fruit|Cherry",
  "Fruity|Stone Fruit|Plum",
  
  // 꽃향
  "Floral|White Flowers|Coffee Blossom",
  "Floral|White Flowers|Jasmine",
  "Floral|Colored Flowers|Rose",
  "Floral|Colored Flowers|Lavender",
  
  // 열대과일
  "Fruity|Tropical Fruit|Passion Fruit",
  "Fruity|Tropical Fruit|Mango",
  "Fruity|Tropical Fruit|Papaya",
  "Fruity|Tropical Fruit|Guava",
  "Fruity|Tropical Fruit|Pineapple",
  
  // 견과류
  "Nutty/Cocoa|Tree Nuts|Almond",
  "Nutty/Cocoa|Tree Nuts|Walnut",
  "Nutty/Cocoa|Tree Nuts|Macadamia",
  "Nutty/Cocoa|Tree Nuts|Hazelnut",
  
  // 초콜릿
  "Nutty/Cocoa|Cocoa|Dark Chocolate",
  "Nutty/Cocoa|Cocoa|Milk Chocolate",
  "Nutty/Cocoa|Cocoa|Cocoa",
  
  // 단맛
  "Sweet|Caramelized|Caramel",
  "Sweet|Vanilla|Honey",
  "Sweet|Brown Sugar|Brown Sugar"
];

// 바디감 디스크립터 카테고리별 그룹핑 (다국어 지원)
const BODY_DESCRIPTOR_CATEGORIES = [
  { name: "질감", nameEn: "Texture", key: "texture", color: "#E6E6FA" },
  { name: "무게감", nameEn: "Weight", key: "weight", color: "#DCDCDC" },
  { name: "밀도감", nameEn: "Density", key: "density", color: "#A0522D" },
  { name: "입안감촉", nameEn: "Mouthfeel", key: "mouthfeel", color: "#DEB887" },
  { name: "온도감", nameEn: "Temperature", key: "temperature", color: "#87CEEB" }
];

// 언어 지원을 위한 번역 객체
const I18N_TEXTS = {
  ko: {
    'body-descriptor-title': '바디감 디스크립터',
    'body-descriptor-desc': '커피의 질감, 밀도, 무게감을 표현하는 세부 특성을 선택하세요 (복수 선택 가능)',
    'body-descriptor-help': '선택된 항목은 하이라이트 표시됩니다. 클릭하여 선택/해제할 수 있습니다.'
  },
  en: {
    'body-descriptor-title': 'Body Descriptors',
    'body-descriptor-desc': 'Select detailed characteristics that express the texture, density, and weight of coffee (multiple selections possible)',
    'body-descriptor-help': 'Selected items are highlighted. Click to select/deselect.'
  }
};

/* === 2단계: 핵심 변수 및 유틸리티 함수 === */

// 전역 변수들
let samples = [];
let currentSampleId = null;
let sampleSaveTimeout = null;
let flavorProfileChart = null;
let sortableInstance = null;
let currentLanguage = 'ko'; // 언어 기본값을 한국어로 설정
let chartObjects = {};
let currentFlavorCategory = null;
let currentFlavorPhase = "fragrance";
let lastErrorCount = 0;

// 향미 휠 아코디언 토글 함수
function toggleAccordion(header) {
  if (!header) return;
  
  const content = header.nextElementSibling;
  if (!content) return;
  
  const isOpen = content.classList.toggle('show');
  
  // 아이콘 변경
  const icon = header.querySelector('.accordion-icon');
  if (icon) {
    icon.innerHTML = isOpen ? '<i class="fas fa-chevron-up"></i>' : '<i class="fas fa-chevron-down"></i>';
  }
}

// 한국어 초성 추출 함수
function getKoreanInitials(text) {
  if (!text) return '';
  
  const initials = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
  
  return text.split('').map(char => {
    const code = char.charCodeAt(0);
    if (code >= 0xAC00 && code <= 0xD7A3) {
      // 한글 유니코드 범위
      const index = Math.floor((code - 0xAC00) / 588);
      return initials[index];
    }
    return char;
  }).join('');
}

// 한국어 초성 매칭 함수
function matchKoreanInitials(text, searchTerm) {
  if (!text || !searchTerm) return false;
  
  const textInitials = getKoreanInitials(text.toLowerCase());
  const searchInitials = getKoreanInitials(searchTerm.toLowerCase());
  
  // 일반 텍스트 매칭도 함께 확인
  return text.toLowerCase().includes(searchTerm.toLowerCase()) || 
         textInitials.includes(searchInitials) ||
         textInitials.includes(searchTerm.toLowerCase());
}

// 배경색에 따른 텍스트 색상 최적화 함수
function getContrastColor(hexColor) {
  if (!hexColor || typeof hexColor !== 'string') return '#000000';
  
  let r, g, b;
  if (hexColor.startsWith('#')) {
    hexColor = hexColor.substring(1);
  }
  
  if (hexColor.length === 3) {
    r = parseInt(hexColor.charAt(0) + hexColor.charAt(0), 16);
    g = parseInt(hexColor.charAt(1) + hexColor.charAt(1), 16);
    b = parseInt(hexColor.charAt(2) + hexColor.charAt(2), 16);
  } 
  else if (hexColor.length === 6) {
    r = parseInt(hexColor.substring(0, 2), 16);
    g = parseInt(hexColor.substring(2, 4), 16);
    b = parseInt(hexColor.substring(4, 6), 16);
  } else {
    return '#000000';
  }
  
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 128 ? '#000000' : '#FFFFFF';
}

// 다국어 텍스트 가져오기 함수
function getI18nText(key, lang = currentLanguage) {
  return I18N_TEXTS[lang] && I18N_TEXTS[lang][key] ? I18N_TEXTS[lang][key] : key;
}

// 언어에 따른 레이블 가져오기 함수
function getLocalizedLabel(item, lang = currentLanguage) {
  if (lang === 'ko') {
    return item.label || item.labelEn || item.name || item.nameEn || '';
  } else {
    return item.labelEn || item.label || item.nameEn || item.name || '';
  }
}

// 빈 샘플 데이터 생성
function getEmptySampleData() {
  let flavorSelections = {}; 
  FLAVOR_PHASES.forEach(phase => flavorSelections[phase.id] = []);
  return {
    title: "", coffeeName: "", origin: "", variety: "", process: "", roastDate: "", roastLevel: "",
    flavorSelections, acidityLevel: "", sweetnessLevel: "", bodyLevel: "",
    bodyDescriptors: [], // 바디감 디스크립터 추가
    defectUnderdevelopment: "none", defectOverdevelopment: "none", defectBaked: "none", defectScorching: "none",
    scoreFragrance: 7, scoreAroma: 7, scoreFlavor: 7, scoreAftertaste: 7, scoreAcidity: 7, scoreBody: 7, scoreBalance: 7, scoreOverall: 7,
    tastingNotes: "", lastEdit: +(new Date())
  };
}

// 새 샘플 객체 생성
function createNewSampleObj(title) {
  let id = "sample_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
  return {id, title: title || "새 샘플", sampleData: getEmptySampleData(), lastEdit: +(new Date())};
}

// 샘플 이동 시 토스트 메시지 표시
function showSampleToast(sampleName) {
  const toast = document.getElementById('sampleToast');
  if (toast) {
    toast.textContent = sampleName;
    toast.classList.add('show');
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 1500);
  }
}

// 토스트 메시지 표시
function showToast(msg) {
  try {
    let toast = document.getElementById('toast');
    if (toast) {
      toast.innerHTML = msg;
      toast.classList.add('show');
      setTimeout(() => {toast.classList.remove('show');}, 1800);
    }
  } catch(e) {
    console.error("토스트 메시지 표시 중 오류:", e);
  }
}

// 현재 샘플 표시 업데이트
function updateCurrentSampleIndicator() {
  const indicator = document.getElementById('currentSampleIndicator');
  if (!indicator) return;
  
  const currentSample = getCurrentSampleObj();
  if (currentSample) {
    indicator.querySelector('span').textContent = currentSample.title || "샘플";
    
    const currentIndex = samples.findIndex(s => s.id === currentSampleId);
    if (currentIndex > -1) {
      indicator.querySelector('span').textContent += ` (${currentIndex + 1}/${samples.length})`;
    }
  } else {
    indicator.querySelector('span').textContent = "샘플 없음";
  }
}

// 네비게이션 버튼 상태 업데이트
function updateNavigationButtons() {
  const prevBtn = document.getElementById('prevSampleBtn');
  const nextBtn = document.getElementById('nextSampleBtn');
  
  if (!prevBtn || !nextBtn || !samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  
  prevBtn.disabled = currentIndex <= 0;
  prevBtn.classList.toggle('opacity-50', currentIndex <= 0);
  prevBtn.classList.toggle('cursor-not-allowed', currentIndex <= 0);
  
  nextBtn.disabled = currentIndex >= samples.length - 1;
  nextBtn.classList.toggle('opacity-50', currentIndex >= samples.length - 1);
  nextBtn.classList.toggle('cursor-not-allowed', currentIndex >= samples.length - 1);
}

// 이전/다음 샘플로 이동
function goToPrevSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex > 0) {
    loadSample(samples[currentIndex - 1].id);
    showSampleToast(samples[currentIndex - 1].title || "샘플");
  }
}

function goToNextSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex < samples.length - 1) {
    loadSample(samples[currentIndex + 1].id);
    showSampleToast(samples[currentIndex + 1].title || "샘플");
  }
}

// 체크된 라디오 버튼의 값 가져오기
function getCheckedRadio(name) {
  let radio = document.querySelector(`input[name="${name}"]:checked`);
  return radio ? radio.value : "";
}

// 향미 카테고리 필터링
function filterByCategory(category) {
  currentFlavorCategory = currentFlavorCategory === category ? null : category;
  
  document.querySelectorAll('.flavor-category-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.category === currentFlavorCategory);
  });
  
  const allCategories = document.querySelectorAll('.flavor-category-accordion');
  
  if (currentFlavorCategory) {
    allCategories.forEach(cat => {
      if (cat.dataset.category === currentFlavorCategory) {
        cat.classList.remove('flavor-fix-hidden');
        const content = cat.querySelector('.flavor-category-content');
        if (content) {
          content.classList.add('show');
          const icon = content.previousElementSibling.querySelector('.accordion-icon');
          if (icon) icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
      } else {
        cat.classList.add('flavor-fix-hidden');
      }
    });
  } else {
    allCategories.forEach(cat => {
      cat.classList.remove('flavor-fix-hidden');
    });
  }
}

// 언어 전환 함수 개선
function switchLanguage(lang) {
  if (currentLanguage === lang) return; // 동일한 언어면 무시
  
  currentLanguage = lang;
  
  // 언어 토글 버튼 상태 업데이트
  const langEn = document.getElementById('langEn');
  const langKo = document.getElementById('langKo');
  
  if (langEn && langKo) {
    langEn.classList.toggle('active', lang === 'en');
    langKo.classList.toggle('active', lang === 'ko');
  }
  
  // 언어 변경 애니메이션 효과
  const flavorArea = document.getElementById('flavorWheelMultiSelectArea');
  const bodyArea = document.getElementById('bodyDescriptorArea');
  
  if (flavorArea) {
    flavorArea.classList.add('language-transition', 'fade-out');
  }
  if (bodyArea) {
    bodyArea.classList.add('language-transition', 'fade-out');
  }
  
  // 지연 후 UI 업데이트
  setTimeout(() => {
    // 향미 관련 UI 업데이트
    renderFlavorTabs();
    renderFlavorPhase();
    
    // 바디감 디스크립터 UI 업데이트
    renderBodyDescriptors();
    
    // 선택된 향미 영역 업데이트
    renderSelectedFlavorsArea();
    
    // 다국어 텍스트 업데이트
    updateI18nTexts();
    
    // 페이드 인 효과
    setTimeout(() => {
      if (flavorArea) {
        flavorArea.classList.remove('language-transition', 'fade-out');
      }
      if (bodyArea) {
        bodyArea.classList.remove('language-transition', 'fade-out');
      }
    }, 100);
    
  }, 200);
  
  console.log(`언어가 ${lang === 'ko' ? '한국어' : '영어'}로 변경되었습니다.`);
}

// 다국어 텍스트 업데이트 함수
function updateI18nTexts() {
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    const text = getI18nText(key);
    if (text !== key) {
      element.textContent = text;
    }
  });
}

// 바디감 디스크립터 렌더링 개선
function renderBodyDescriptors() {
  const container = document.getElementById('bodyDescriptorArea');
  if (!container) return;
  
  const currentSample = getCurrentSampleObj();
  const selectedDescriptors = currentSample ? (currentSample.sampleData.bodyDescriptors || []) : [];
  
  let html = '';
  
  // 카테고리별로 그룹화하여 렌더링
  BODY_DESCRIPTOR_CATEGORIES.forEach(category => {
    const categoryDescriptors = BODY_DESCRIPTORS.filter(d => d.category === category.key);
    
    if (categoryDescriptors.length > 0) {
      const categoryName = currentLanguage === 'ko' ? category.name : category.nameEn;
      html += `<div class="col-span-full body-category-header">${categoryName}</div>`;
      
      categoryDescriptors.forEach(descriptor => {
        const isSelected = selectedDescriptors.includes(descriptor.id);
        const displayText = currentLanguage === 'ko' ? descriptor.korean : descriptor.label;
        const selectedClass = isSelected ? 'selected' : '';
        
        html += `
          <div class="body-descriptor-item ${selectedClass}" 
               data-descriptor="${descriptor.id}"
               style="border-color: ${descriptor.color};"
               onclick="toggleBodyDescriptor('${descriptor.id}')">
            <input type="checkbox" ${isSelected ? 'checked' : ''}>
            <span class="checkbox-custom"></span>
            <span>${displayText}</span>
          </div>
        `;
      });
    }
  });
  
  container.innerHTML = html;
  
  console.log(`바디감 디스크립터 렌더링 완료 (언어: ${currentLanguage})`);
}

// 바디감 디스크립터 토글 함수 개선
function toggleBodyDescriptor(descriptorId) {
  const currentSample = getCurrentSampleObj();
  if (!currentSample) return;
  
  const descriptors = currentSample.sampleData.bodyDescriptors || [];
  const index = descriptors.indexOf(descriptorId);
  
  if (index > -1) {
    descriptors.splice(index, 1);
  } else {
    descriptors.push(descriptorId);
  }
  
  currentSample.sampleData.bodyDescriptors = descriptors;
  
  // UI 즉시 업데이트 (향미 선택과 동일한 방식)
  const itemElement = document.querySelector(`[data-descriptor="${descriptorId}"]`);
  if (itemElement) {
    const checkbox = itemElement.querySelector('input[type="checkbox"]');
    const isSelected = descriptors.includes(descriptorId);
    
    if (checkbox) {
      checkbox.checked = isSelected;
    }
    
    if (isSelected) {
      itemElement.classList.add('selected');
    } else {
      itemElement.classList.remove('selected');
    }
  }
  
  renderSelectedFlavorsArea();
  scheduleAutoSave();
  
  console.log(`바디감 디스크립터 '${descriptorId}' 토글됨:`, descriptors.includes(descriptorId));
}

/* === 3단계: UI 렌더링 및 상호작용 함수 === */

// Flavor Tabs 렌더링 개선
function renderFlavorTabs() {
  const tabs = document.getElementById('flavorTabs');
  if (!tabs) return;
  
  tabs.innerHTML = '';
  FLAVOR_PHASES.forEach(phase => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'flavor-phase-btn font-bold rounded px-4 py-1 mr-1 mb-1 mobile-touch-friendly ' + 
      (currentFlavorPhase === phase.id ? 'tab-btn-active' : 'tab-btn-inactive');
    
    // 언어에 따른 레이블 표시
    btn.textContent = currentLanguage === 'ko' ? phase.label : phase.labelEn;
    btn.dataset.flavorphase = phase.id;
    btn.onclick = () => {
      currentFlavorPhase = phase.id;
      renderFlavorTabs();
      renderFlavorPhase();
    };
    tabs.appendChild(btn);
  });
  
  console.log(`향미 탭 렌더링 완료 (언어: ${currentLanguage})`);
}

// 향미 선택 영역 렌더링 개선
function renderFlavorPhase() {
  const currentSample = getCurrentSampleObj();
  if (!currentSample) return;
  
  let curSel = currentSample.sampleData.flavorSelections[currentFlavorPhase] || [];
  let outer = document.getElementById('flavorWheelMultiSelectArea');
  
  if (!outer) return;
  
  outer.innerHTML = `
    <div class="flex justify-center items-center p-4">
      <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-amber-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="text-amber-700">향미 선택기 로딩 중...</span>
    </div>
  `;
  
  const categoryMapping = {};
  FLAVOR_CATEGORIES.forEach(cat => {
    cat.categories.forEach(engCat => {
      categoryMapping[engCat] = currentLanguage === 'ko' ? cat.name : cat.nameEn;
    });
  });
  
  let html = `
    <div class="search-box mb-3">
      <input type="text" id="flavorSearchInput" class="search-input" 
        placeholder="${currentLanguage === 'ko' ? '향미 검색 (베리, 초콜릿, 꽃향, 초성: ㅂㄹ, ㅊㅋㄹ 등...)' : 'Search flavors (berry, chocolate, floral, etc...)'}">
      <div class="text-xs text-gray-500 mt-1 px-2">
        ${currentLanguage === 'ko' ? '💡 팁: 한국어 초성으로도 검색 가능 (예: "ㅂㄹ" → 베리류, "ㅊㅋㄹ" → 초콜릿)' : '💡 Tip: Search with Korean initials (e.g., "ㅂㄹ" → Berry)'}
      </div>
   </div>
    
    <div class="flavor-category-tabs">
  `;
  
  // 카테고리 탭 추가 (언어별)
  FLAVOR_CATEGORIES.forEach(category => {
    const categoryName = currentLanguage === 'ko' ? category.name : category.nameEn;
    html += `
      <button type="button" class="flavor-category-tab ${currentFlavorCategory === categoryName ? 'active' : ''}" 
              data-category="${categoryName}" onclick="filterByCategory('${categoryName}')">
        ${categoryName}
      </button>
    `;
  });
  
  html += `</div>
    
    <div class="frequently-used-flavors">
      <h4><i class="fas fa-star mr-1"></i> ${currentLanguage === 'ko' ? '자주 사용하는 향미' : 'Frequently Used Flavors'}</h4>
      <div class="flex flex-wrap">
  `;
  
  // 자주 사용하는 향미 목록 렌더링
  FREQUENT_FLAVORS.forEach(key => {
    const [cat, sub, desc] = key.split('|');
    const rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
    if (rec) {
      const color = rec[3] || '#B8B2A5';
      const textColor = getContrastColor(color);
      const displayName = currentLanguage === 'ko' && rec.length > 6 ? rec[6] : desc;
      const checked = curSel.includes(key) ? ' checked ' : '';
      const selectedClass = checked ? 'selected-flavor' : '';
      
      html += `
        <label class="flavor-checkbox-label ${selectedClass}" style="background:${color};color:${textColor};">
          <input type="checkbox" class="flavorSelectBox" data-key="${key}" ${checked}>
          <span class="checkbox-custom"></span>
          ${displayName}
        </label>
      `;
    }
  });
  
  html += `
      </div>
    </div>
  `;
  
  // 카테고리별로 향미를 그룹화
  const flavorsByCategory = {};
  
  FLAVOR_CATEGORIES.forEach(category => {
    const categoryName = currentLanguage === 'ko' ? category.name : category.nameEn;
    flavorsByCategory[categoryName] = [];
    
    category.categories.forEach(engCategory => {
      FLAVOR_DATA.forEach(flavor => {
        if (flavor[0] === engCategory) {
          flavorsByCategory[categoryName].push(flavor);
        }
      });
    });
  });
  
  // 각 카테고리별 아코디언 생성
  Object.keys(flavorsByCategory).forEach(categoryName => {
    const flavors = flavorsByCategory[categoryName];
    if (!flavors || flavors.length === 0) return;
    
    const isHidden = currentFlavorCategory && currentFlavorCategory !== categoryName;
    
    html += `
      <div class="flavor-category-accordion mb-3 ${isHidden ? 'flavor-fix-hidden' : ''}" data-category="${categoryName}">
        <div class="flavor-category-header" onclick="toggleAccordion(this)">
          <h4>${categoryName}</h4>
          <span class="accordion-icon"><i class="fas fa-chevron-${isHidden ? 'down' : 'up'}"></i></span>
        </div>
        <div class="flavor-category-content ${isHidden ? '' : 'show'}">
    `;
    
    // 서브카테고리별로 그룹화
    const flavorsBySubCategory = {};
    
    flavors.forEach(flavor => {
      const subCategory = flavor[1] || '일반';
      let displaySubCategory;
      
      if (currentLanguage === 'ko') {
        displaySubCategory = flavor[5] || subCategory;
      } else {
        displaySubCategory = subCategory;
      }
      
      if (!flavorsBySubCategory[displaySubCategory]) {
        flavorsBySubCategory[displaySubCategory] = [];
      }
      
      flavorsBySubCategory[displaySubCategory].push(flavor);
    });
    
    // 각 서브카테고리 렌더링
    Object.keys(flavorsBySubCategory).sort().forEach(subCategory => {
      const subFlavors = flavorsBySubCategory[subCategory];
      
      if (subCategory !== '일반' && subCategory !== 'General') {
        html += `<div class="flavor-subcategory-title">${subCategory}</div>`;
      }
      
      html += `<div class="flavor-items flex flex-wrap">`;
      
      subFlavors.forEach(flavor => {
        const [cat, sub, desc, color, catKr, subKr, descKr] = flavor;
        const id = cat+'|'+sub+'|'+desc;
        const checked = curSel.includes(id) ? ' checked ' : '';
        const textColor = getContrastColor(color);
        const displayName = currentLanguage === 'ko' && descKr ? descKr : desc;
        const selectedClass = checked ? 'selected-flavor' : '';
        
        html += `
          <label class="flavor-checkbox-label ${selectedClass}" style="background:${color};color:${textColor};" 
                data-category="${cat}" data-subcategory="${sub}" data-flavor-en="${desc.toLowerCase()}" data-flavor-kr="${(descKr||'').toLowerCase()}">
            <input type="checkbox" class="flavorSelectBox" data-key="${id}" ${checked}>
            <span class="checkbox-custom"></span>
            ${displayName}
          </label>
        `;
      });
      
      html += `</div>`;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  outer.innerHTML = html;
  
  // 향미 검색 기능
  const searchInput = document.getElementById('flavorSearchInput');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const searchTerm = this.value.trim().toLowerCase();
        
        if (searchTerm === '') {
          document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
            label.style.display = '';
            label.classList.remove('search-highlight');
          });
          
          document.querySelectorAll('.flavor-category-accordion').forEach(cat => {
            const categoryName = currentLanguage === 'ko' ? 
              FLAVOR_CATEGORIES.find(c => c.nameEn === cat.dataset.category)?.name || cat.dataset.category :
              cat.dataset.category;
            cat.classList.toggle('flavor-fix-hidden', currentFlavorCategory && categoryName !== currentFlavorCategory);
          });
          
          document.querySelectorAll('.flavor-subcategory-title').forEach(title => {
            title.style.display = '';
          });
          return;
        }
        
        document.querySelectorAll('.flavor-category-content').forEach(content => {
          content.classList.add('show');
          const icon = content.previousElementSibling.querySelector('.accordion-icon');
          if (icon) icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
        });
        
        document.querySelectorAll('.flavor-category-accordion').forEach(cat => {
          cat.classList.remove('flavor-fix-hidden');
        });
        
        let visibleCategories = new Set();
        
        document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
          const flavorEn = label.dataset.flavorEn?.toLowerCase() || '';
          const flavorKr = label.dataset.flavorKr?.toLowerCase() || '';
          const category = label.dataset.category?.toLowerCase() || '';
          const subcategory = label.dataset.subcategory?.toLowerCase() || '';
          
// 기본 텍스트 매칭
const basicMatch = flavorEn.includes(searchTerm) || 
                 flavorKr.includes(searchTerm) || 
                 category.includes(searchTerm) || 
                 subcategory.includes(searchTerm);

// 한국어 초성 매칭
const initialMatch = matchKoreanInitials(flavorKr, searchTerm) ||
                    matchKoreanInitials(category, searchTerm) ||
                    matchKoreanInitials(subcategory, searchTerm);

if (basicMatch || initialMatch) {
            label.style.display = '';
            label.classList.add('search-highlight');
            
            const categoryAccordion = label.closest('.flavor-category-accordion');
            if (categoryAccordion) {
              visibleCategories.add(categoryAccordion);
            }
          } else {
            label.style.display = 'none';
            label.classList.remove('search-highlight');
          }
        });
        
        document.querySelectorAll('.flavor-category-accordion').forEach(accordion => {
          accordion.classList.toggle('flavor-fix-hidden', !visibleCategories.has(accordion));
        });
        
        document.querySelectorAll('.flavor-subcategory-title').forEach(title => {
          let hasVisibleFlavor = false;
          let current = title.nextElementSibling;
          
          while (current && !current.classList.contains('flavor-subcategory-title')) {
            if (current.classList.contains('flavor-items')) {
              const visibleLabels = Array.from(current.querySelectorAll('.flavor-checkbox-label'))
                .filter(label => label.style.display !== 'none');
                
              if (visibleLabels.length > 0) {
                hasVisibleFlavor = true;
                break;
              }
            }
            current = current.nextElementSibling;
          }
          
          title.style.display = hasVisibleFlavor ? '' : 'none';
        });
      }, 250);
    });
  }
  
  // 향미 선택 체크박스 이벤트 처리 개선
  outer.querySelectorAll('.flavorSelectBox').forEach(cb => {
    cb.onchange = function() {
      if (!currentSampleId) return;
      
      const currentSample = getCurrentSampleObj();
      if (!currentSample) return;
      
      let sel = currentSample.sampleData.flavorSelections[currentFlavorPhase];
      let key = this.getAttribute('data-key');
      
      if (this.checked) {
        if (sel.indexOf(key) === -1) {
          if (sel.length < 10) {
            sel.push(key);
            this.closest('label').classList.add('selected-flavor');
          } else {
            this.checked = false;
            showToast("각 항목당 최대 10개까지만 선택 가능합니다.");
            return;
          }
        }
      } else {
        let idx = sel.indexOf(key);
        if (idx > -1) {
          sel.splice(idx, 1);
          this.closest('label').classList.remove('selected-flavor');
        }
      }
      
      renderSelectedFlavorsArea();
      scheduleAutoSave();
    };
  });
  
  console.log(`향미 선택 영역 렌더링 완료 (언어: ${currentLanguage})`);
}

// 향미 특성/속성 실시간 반영 개선 (바디감 디스크립터 포함)
function buildFlavorSummaryHtml(sampleData) {
  let html = '';

  // 각 단계별 향미 표시
  FLAVOR_PHASES.forEach(phase => {
    const phaseLabel = currentLanguage === 'ko' ? phase.label : phase.labelEn;
    let phaseSel = (sampleData.flavorSelections[phase.id] || []).map(key => {
      let [cat, sub, desc] = key.split('|');
      let rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
      if (!rec) return '';

      let color = rec[3] || '#B8B2A5';
      let displayName = currentLanguage === 'ko' && rec.length > 6 ? rec[6] : desc;

      let textColor = getContrastColor(color);
      return `<span class="flavor-badge" style="background:${color};color:${textColor};">${displayName}</span>`;
    }).filter(badge => badge !== '');

    html += `<div class="mb-1">
      <span class="font-bold">${phaseLabel}:</span>
      ${phaseSel.join(' ') || '<span class="text-xs text-gray-400">없음</span>'}
    </div>`;
  });

  // 속성 표시
  html += `<div class="mt-2 mb-1 flex flex-wrap items-center">`;
  Object.keys(ATTR_TO_BADGE).forEach(attrKey => {
    let attrMeta = ATTR_TO_BADGE[attrKey];
    let val = sampleData[attrKey];
    const attrLabel = currentLanguage === 'ko' ? attrMeta.label : attrMeta.labelEn;
    const valLabel = val && ATTR_VALUE_LABELS[val] ?
      (currentLanguage === 'ko' ? ATTR_VALUE_LABELS[val].kr : ATTR_VALUE_LABELS[val].en) :
      '미선택';

    if (val) {
      html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;">
        ${attrLabel}: ${valLabel}
      </span>`;
    } else {
      html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;opacity:0.5;">
        ${attrLabel}: ${valLabel}
      </span>`;
    }
  });
  html += `</div>`;

  // 바디감 디스크립터 표시 개선
  if (sampleData.bodyDescriptors && sampleData.bodyDescriptors.length > 0) {
    const bodyLabel = currentLanguage === 'ko' ? '바디감 디스크립터' : 'Body Descriptors';
    html += `<div class="mt-2 mb-1">
      <span class="font-bold">${bodyLabel}:</span>
      <div class="flex flex-wrap gap-1 mt-1">`;

    sampleData.bodyDescriptors.forEach(descriptorId => {
      const descriptor = BODY_DESCRIPTORS.find(d => d.id === descriptorId);
      if (descriptor) {
        const displayText = currentLanguage === 'ko' ? descriptor.korean : descriptor.label;
        const textColor = getContrastColor(descriptor.color);
        html += `<span class="flavor-badge" style="background:${descriptor.color};color:${textColor};">
          ${displayText}
        </span>`;
      }
    });

    html += `</div></div>`;
  } else {
    const bodyLabel = currentLanguage === 'ko' ? '바디감 디스크립터' : 'Body Descriptors';
    const noneLabel = currentLanguage === 'ko' ? '선택된 항목 없음' : 'No items selected';
    html += `<div class="mt-2 mb-1">
      <span class="font-bold">${bodyLabel}:</span>
      <span class="text-xs text-gray-400 ml-2">${noneLabel}</span>
    </div>`;
  }

  // 로스팅 디펙트 표시
  const defectLabel = currentLanguage === 'ko' ? '로스팅 디펙트' : 'Roasting Defects';
  html += `<div class="mt-2">
    <span class="font-bold">${defectLabel}:</span>
    <div class="flex flex-wrap gap-1 mt-1">`;

  let hasDefect = false;
  DEFECT_PROPS.forEach(d => {
    const val = sampleData[d.key] || "none";
    if (val !== "none") {
      const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
      const defectNameLabel = currentLanguage === 'ko' ? d.label : d.labelEn;
      const defectValueLabel = currentLanguage === 'ko' ? DEFECT_LABELS[val].label : DEFECT_LABELS[val].labelEn;
      html += `<span class="flavor-badge" style="background:${dColor};color:#fff;">
        ${defectNameLabel}: ${defectValueLabel}
      </span>`;
      hasDefect = true;
    }
  });

  if (!hasDefect) {
    const noDefectLabel = currentLanguage === 'ko' ? '선택된 디펙트 없음' : 'No defects selected';
    html += `<span class="text-xs text-gray-400">${noDefectLabel}</span>`;
  }

  html += `</div></div>`;
  return html;
}

function renderSelectedFlavorsArea(_data) {
  let sampleData;
  
  if (_data) {
    sampleData = _data;
  } else {
    const currentSample = getCurrentSampleObj();
    if (!currentSample) return;
    sampleData = currentSample.sampleData;
  }

  const html = buildFlavorSummaryHtml(sampleData);
  const flavorArea = document.getElementById('selectedFlavorsArea');
  if (flavorArea) {
    flavorArea.innerHTML = html;
  }

  console.log(`선택된 향미 영역 업데이트 완료 (언어: ${currentLanguage})`);
}

// 레이더 차트 업데이트
function updateRadar(data) {
  const ctx = document.getElementById('cuppingRadar');
  if (!ctx) return;
  
  if (flavorProfileChart) {
    flavorProfileChart.destroy();
    flavorProfileChart = null;
  }
  
  let sampleData = data || getCurrentSampleObj()?.sampleData;
  if (!sampleData) return;

  const chartData = {
    labels: ['프래그런스', '아로마', '플레이버', '에프터테이스트', '액시디티', '바디', '밸런스', '오버럴'],
    datasets: [{
      label: '점수',
      data: [
        sampleData.scoreFragrance || 0,
        sampleData.scoreAroma || 0,
        sampleData.scoreFlavor || 0,
        sampleData.scoreAftertaste || 0,
        sampleData.scoreAcidity || 0,
        sampleData.scoreBody || 0,
        sampleData.scoreBalance || 0,
        sampleData.scoreOverall || 0
      ],
      backgroundColor: 'rgba(139, 90, 43, 0.2)',
      borderColor: 'rgba(139, 90, 43, 0.8)',
      borderWidth: 2,
      pointBackgroundColor: 'rgba(139, 90, 43, 1)',
      pointRadius: 4
    }]
  };

  const options = {
    scales: {
      r: {
        angleLines: {
          display: true
        },
        min: 0,
        max: 10,
        ticks: {
          stepSize: 2,
          backdropColor: 'rgba(255, 255, 255, 0)'
        }
      }
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return `점수: ${context.raw}`;
          }
        }
      }
    }
  };

  flavorProfileChart = new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: options
  });
  
  chartObjects['cuppingRadar'] = flavorProfileChart;
}

// 총점 계산
function updateTotalScore(data) {
  let sampleData = data;
  
  if (!data) {
    const currentSample = getCurrentSampleObj();
    if (!currentSample) return;
    sampleData = currentSample.sampleData;
  }
  
  const scoreFields = [
    'scoreFragrance', 'scoreAroma', 'scoreFlavor', 'scoreAftertaste', 
    'scoreAcidity', 'scoreBody', 'scoreBalance', 'scoreOverall'
  ];
  
  let total = 30;
  scoreFields.forEach(field => {
    total += parseFloat(sampleData[field] || 0);
  });
  
  let totalScoreEl = document.getElementById('totalScore');
  if (totalScoreEl) {
    totalScoreEl.textContent = total.toFixed(2);
  }
  
  document.getElementById('evalDate').textContent = new Date().toLocaleDateString();
}

// 자동 저장
function scheduleAutoSave() {
  if (sampleSaveTimeout) {
    clearTimeout(sampleSaveTimeout);
  }
  
  sampleSaveTimeout = setTimeout(() => {
    try {
      saveCurrentSample();
      
      const saveState = document.getElementById('sampleSavedState');
      if (saveState) {
        saveState.classList.remove("hidden");
        setTimeout(() => saveState.classList.add("hidden"), 1500);
      }
    } catch(e) {
      console.error("자동 저장 중 오류:", e);
      showToast("자동 저장 중 오류가 발생했습니다.");
    }
  }, 2000);
}

// 현재 샘플 가져오기
function getCurrentSampleObj() { 
  const sample = samples.find(s => s.id === currentSampleId);
  return sample || null;
}

// UI에서 샘플 데이터 로드
function setUIFromSample(sampleData) {
  document.getElementById('sampleTitleInput').value = sampleData.title || '';
  document.getElementById('coffeeName').value = sampleData.coffeeName || '';
  document.getElementById('origin').value = sampleData.origin || '';
  document.getElementById('variety').value = sampleData.variety || '';
  document.getElementById('process').value = sampleData.process || '';
  document.getElementById('roastDate').value = sampleData.roastDate || '';
  document.getElementById('roastLevel').value = sampleData.roastLevel || '';
  
  // 라디오 버튼 상태 설정
  ["acidity", "sweetness", "body"].forEach(group => {
    let v = sampleData[group + "Level"] || "";
    let groupRadio = 'input[name="' + group + 'Level"]';
    if (v) {
      let radio = document.querySelector(groupRadio + '[value="' + v + '"]');
      if (radio) radio.checked = true;
    } else {
      let radios = document.querySelectorAll(groupRadio); 
      radios.forEach(r => r.checked = false);
    }
  });
  
  // 디펙트 라디오 버튼 설정
  DEFECT_PROPS.forEach(d => {
    const val = sampleData[d.key] || "none";
    let radioNode = document.querySelector('input[name="' + d.key + '"][value="' + val + '"]');
    if (radioNode) radioNode.checked = true;
  });
  
  // SCA 점수 설정
  [
    ["scoreFragrance", "scoreFragrance"], ["scoreAroma", "scoreAroma"], 
    ["scoreFlavor", "scoreFlavor"], ["scoreAftertaste", "scoreAftertaste"],
    ["scoreAcidity", "scoreAcidity"], ["scoreBody", "scoreBody"], 
    ["scoreBalance", "scoreBalance"], ["scoreOverall", "scoreOverall"]
  ].forEach(([key, id]) => {
    document.getElementById(id).value = sampleData[key] || 7;
    document.getElementById(id + "_slider").value = sampleData[key] || 7;
  });
  
  document.getElementById('tastingNotes').value = sampleData.tastingNotes || '';
  
  // 바디감 디스크립터 렌더링
  renderBodyDescriptors();
  
  renderSelectedFlavorsArea(sampleData);
  updateRadar(sampleData);
  updateTotalScore(sampleData);
  renderFlavorTabs();
  renderFlavorPhase();
}

// UI에서 샘플 데이터 저장
function saveUIToSample(targetDataObj) {
  let sampleData = targetDataObj || getCurrentSampleObj().sampleData;
  if (!sampleData) return;
  
  sampleData.title = document.getElementById('sampleTitleInput').value || "";
  sampleData.coffeeName = document.getElementById('coffeeName').value;
  sampleData.origin = document.getElementById('origin').value;
  sampleData.variety = document.getElementById('variety').value;
  sampleData.process = document.getElementById('process').value;
  sampleData.roastDate = document.getElementById('roastDate').value;
  sampleData.roastLevel = document.getElementById('roastLevel').value;
  sampleData.acidityLevel = getCheckedRadio('acidityLevel');
  sampleData.sweetnessLevel = getCheckedRadio('sweetnessLevel');
  sampleData.bodyLevel = getCheckedRadio('bodyLevel');
  
  DEFECT_PROPS.forEach(d => {
    sampleData[d.key] = getCheckedRadio(d.key) || "none";
  });
  
  sampleData.scoreFragrance = parseFloat(document.getElementById('scoreFragrance').value) || 0;
  sampleData.scoreAroma = parseFloat(document.getElementById('scoreAroma').value) || 0;
  sampleData.scoreFlavor = parseFloat(document.getElementById('scoreFlavor').value) || 0;
  sampleData.scoreAftertaste = parseFloat(document.getElementById('scoreAftertaste').value) || 0;
  sampleData.scoreAcidity = parseFloat(document.getElementById('scoreAcidity').value) || 0;
  sampleData.scoreBody = parseFloat(document.getElementById('scoreBody').value) || 0;
  sampleData.scoreBalance = parseFloat(document.getElementById('scoreBalance').value) || 0;
  sampleData.scoreOverall = parseFloat(document.getElementById('scoreOverall').value) || 0;
  sampleData.tastingNotes = document.getElementById('tastingNotes').value;
  sampleData.lastEdit = +(new Date());
}

// 샘플 목록 렌더링 (드래그 앤 드롭 지원)
function renderSampleList() {
  let listDiv = document.getElementById('sampleList');
  if (!samples.length) {
    listDiv.innerHTML = `<div class="text-gray-500 text-xs my-3 text-center">샘플 없음<br>새로 추가하세요.</div>`;
    updateNavigationButtons();
    updateCurrentSampleIndicator();
    return;
  }
  
  let html = '';
  samples.forEach(sm => {
    html += `
      <div class="flex justify-between items-center border rounded-lg px-2 py-1 mb-1 sample-item ${sm.id === currentSampleId ? "bg-yellow-100 border-yellow-700" : "bg-white border-gray-200"}" data-id="${sm.id}">
        <div class="sample-drag-handle"><i class="fas fa-grip-lines"></i></div>
        <span class="truncate text-sm flex-1 ${sm.id === currentSampleId ? "font-bold" : ""}">${sm.title || "샘플"}</span>
        <span class="text-xs ml-2 text-gray-400">${sm.sampleData && sm.sampleData.roastDate ? sm.sampleData.roastDate : ""}</span>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
  
  // 샘플 클릭 이벤트
  Array.from(listDiv.querySelectorAll('.sample-item')).forEach(el => {
    el.addEventListener('click', (e) => {
      if (!e.target.closest('.sample-drag-handle')) {
        let id = el.getAttribute('data-id');
        if (id !== currentSampleId) {
          loadSample(id);
          const sample = samples.find(s => s.id === id);
          if (sample) {
            showSampleToast(sample.title || "샘플");
          }
        }
      }
    });
    
    // 모바일 길게 누르기로 복제
    el.addEventListener('touchstart', function(e) {
      if (e.target.closest('.sample-drag-handle')) return;
      
      const longPressTimer = setTimeout(() => {
        const sampleId = el.getAttribute('data-id');
        if (confirm("이 샘플을 복제하시겠습니까?")) {
          cloneSample(sampleId);
        }
      }, 800);
      
      const clearTimer = () => clearTimeout(longPressTimer);
      el.addEventListener('touchend', clearTimer, { once: true });
      el.addEventListener('touchcancel', clearTimer, { once: true });
    });
  });
  
  // Sortable.js 초기화
  if (sortableInstance) {
    sortableInstance.destroy();
  }
  
  if (samples.length > 1) {
    sortableInstance = new Sortable(listDiv, {
      animation: 150,
      handle: '.sample-drag-handle',
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      onEnd: function (evt) {
        const oldIndex = evt.oldIndex;
        const newIndex = evt.newIndex;
        
        if (oldIndex !== newIndex) {
          const item = samples[oldIndex];
          samples.splice(oldIndex, 1);
          samples.splice(newIndex, 0, item);
          saveSamplesToStorage();
          updateNavigationButtons();
          updateCurrentSampleIndicator();
        }
      }
    });
  }
  
  updateNavigationButtons();
  updateCurrentSampleIndicator();
  renderCompareList();
}

// 비교 목록 렌더링
function renderCompareList() {
  const compareListBox = document.getElementById('compareListBox');
  if (!compareListBox) return;
  
  if (samples.length < 2) {
    compareListBox.innerHTML = `<div class="text-xs text-gray-400 my-2">비교를 위해 샘플을 2개 이상 추가하세요.</div>`;
    return;
  }
  
  let html = `<div class="text-xs mb-2 text-gray-500">비교할 샘플 선택:</div>`;
  
  html += `<div class="flex flex-wrap gap-2 mb-3">`;
  samples.forEach(sm => {
    html += `
      <label class="flex items-center bg-gray-100 hover:bg-gray-200 rounded px-3 py-1 text-sm mobile-touch-friendly">
        <input type="checkbox" class="compare-checkbox mr-1.5" value="${sm.id}">
        ${sm.title || "샘플"}
      </label>
    `;
  });
  html += `</div>`;
  
  compareListBox.innerHTML = html;
}

// 현재 샘플 저장
function saveCurrentSample(applyInput=true) {
  let sampleIdx = samples.findIndex(s => s.id === currentSampleId);
  if (sampleIdx === -1) return false;
  
  if (applyInput) {
    saveUIToSample(samples[sampleIdx].sampleData);
  }
  let titleVal = document.getElementById('sampleTitleInput').value.trim();
  samples[sampleIdx].title = titleVal || "샘플";
  samples[sampleIdx].sampleData.title = samples[sampleIdx].title;
  samples[sampleIdx].lastEdit = +(new Date());
  renderSampleList();
  saveSamplesToStorage();
  return true;
}

// 샘플 로드
function loadSample(sampleId) {
  if (currentSampleId) {
    saveCurrentSample();
  }
  
  let sampleObj = samples.find(s => s.id === sampleId);
  if (sampleObj) {
    currentSampleId = sampleId;
    setUIFromSample(sampleObj.sampleData);
    renderSampleList();
  }
}

// 스토리지에서 샘플 로드
function loadSamplesFromStorage() {
  try {
    let raw = localStorage.getItem("mollis_sca_samples2");
    if (raw) { 
      samples = JSON.parse(raw); 
      if (!Array.isArray(samples)) {
        samples = [];
      }
    }
  } catch(e) {
    console.error("저장된 샘플 로딩 중 오류:", e);
    samples = [];
  }
  
  if (samples.length === 0) {
    let defaultSample = createNewSampleObj("샘플 #1");
    samples.push(defaultSample);
    currentSampleId = defaultSample.id;
    saveSamplesToStorage();
  }
  
  if (!currentSampleId || !samples.find(s => s.id === currentSampleId)) { 
    currentSampleId = samples[0].id; 
  }
  
  renderSampleList();
}

// 스토리지에 샘플 저장
function saveSamplesToStorage() {
  try {
    localStorage.setItem("mollis_sca_samples2", JSON.stringify(samples));
    const saveState = document.getElementById('sampleSavedState');
    if (saveState) {
      saveState.classList.remove("hidden");
      setTimeout(() => saveState.classList.add("hidden"), 900);
    }
  } catch(e) {
    console.error("샘플 저장 중 오류:", e);
    showToast("저장 중 오류가 발생했습니다. 데이터를 백업해 주세요.");
  }
}

// 샘플 복제
function cloneSample(sampleId) {
  const originalSample = samples.find(s => s.id === sampleId);
  if (!originalSample) return;
  
  const clonedData = JSON.parse(JSON.stringify(originalSample.sampleData));
  const newId = "sample_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
  const clonedSample = {
    id: newId,
    title: originalSample.title + " (복사본)",
    sampleData: clonedData,
    lastEdit: +(new Date())
  };
  
  samples.unshift(clonedSample);
  currentSampleId = newId;
  renderSampleList();
  setUIFromSample(clonedSample.sampleData);
  saveSamplesToStorage();
  showToast("샘플을 복제했습니다.");
}

// 스와이프로 이전/다음 샘플 이동 (모바일 최적화)
function setupSwipeNavigation() {
  try {
    const form = document.getElementById('cuppingForm');
    if (!form || typeof Hammer === 'undefined') return;
    
    const hammer = new Hammer(form);
    hammer.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });
    
    hammer.on('swipeleft', function(e) {
      goToNextSample();
    });
    
    hammer.on('swiperight', function(e) {
      goToPrevSample();
    });
    
    console.log("스와이프 내비게이션이 설정되었습니다.");
  } catch (e) {
    console.error("스와이프 내비게이션 설정 중 오류:", e);
  }
}

/* === 4단계: 고급 기능 및 마무리 === */

// 자동 백업 기능
function setupAutoBackup() {
  const lastBackup = localStorage.getItem('mollis_sca_last_backup');
  const now = Date.now();
  
  if (!lastBackup || (now - parseInt(lastBackup)) > 86400000) {
    try {
      const backupData = JSON.stringify(samples);
      const backupKey = `mollis_sca_backup_${new Date().toISOString().slice(0, 10)}`;
      
      localStorage.setItem(backupKey, backupData);
      localStorage.setItem('mollis_sca_last_backup', now.toString());
      
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('mollis_sca_backup_')) {
          keys.push(key);
        }
      }
      
      if (keys.length > 7) {
        keys.sort();
        while (keys.length > 7) {
          localStorage.removeItem(keys.shift());
        }
      }
      
      console.log('자동 백업 완료:', backupKey);
    } catch (e) {
      console.error('자동 백업 중 오류:', e);
    }
  }
}

// 백업 목록 표시 및 복원
function showBackupList() {
  const backups = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('mollis_sca_backup_')) {
      const date = key.replace('mollis_sca_backup_', '');
      backups.push({ key, date });
    }
  }
  
  if (backups.length === 0) {
    showToast("저장된 백업이 없습니다.");
    return;
  }
  
  backups.sort((a, b) => b.date.localeCompare(a.date));
  
  let message = "백업 목록: (최근 날짜순)\n\n";
  backups.forEach((backup, i) => {
    message += `${i + 1}. ${backup.date}\n`;
  });
  
  message += "\n복원할 백업 번호를 입력하세요 (취소는 0):";
  
  const choice = prompt(message, "");
  if (!choice) return;
  
  const num = parseInt(choice, 10);
  if (isNaN(num) || num === 0) return;
  
  if (num > 0 && num <= backups.length) {
    const selectedBackup = backups[num - 1];
    
    if (confirm(`${selectedBackup.date} 백업을 복원하시겠습니까? 현재 데이터는 덮어씌워집니다.`)) {
      try {
        const backupData = localStorage.getItem(selectedBackup.key);
        const parsedData = JSON.parse(backupData);
        
        if (Array.isArray(parsedData) && parsedData.length > 0) {
          samples = parsedData;
          currentSampleId = samples[0].id;
          setUIFromSample(samples[0].sampleData);
          renderSampleList();
          saveSamplesToStorage();
          showToast(`${selectedBackup.date} 백업을 성공적으로 복원했습니다.`);
        } else {
          showToast("백업 데이터 형식이 올바르지 않습니다.");
        }
      } catch (e) {
        console.error("백업 복원 중 오류:", e);
        showToast("백업 복원 중 오류가 발생했습니다.");
      }
    }
  } else {
    showToast("올바른 백업 번호를 입력하세요.");
  }
}

// 차트 메모리 정리
function cleanupCharts() {
  Object.keys(chartObjects).forEach(key => {
    const chart = chartObjects[key];
    if (chart) {
      try {
        chart.destroy();
        chartObjects[key] = null;
      } catch (e) {
        console.warn(`차트(${key}) 정리 중 오류:`, e);
      }
    }
  });
}

// 비교 차트 생성
function createComparisonChart(selectedSamples) {
  const compareArea = document.getElementById('compareArea');
  if (!compareArea) return;
  
  if (chartObjects.comparisonRadar) {
    chartObjects.comparisonRadar.destroy();
    chartObjects.comparisonRadar = null;
  }
  
  let html = `
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">SCA 점수 비교 차트</h4>
      <div class="chart-container">
        <canvas id="comparisonRadar"></canvas>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">점수 비교 테이블</h4>
      <div class="overflow-x-auto">
        <table class="compare-table w-full">
          <thead>
            <tr>
              <th>항목</th>
  `;
  
  selectedSamples.forEach(sample => {
    html += `<th>${sample.title || '샘플'}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  const scoreFields = [
    { key: 'scoreFragrance', label: '프래그런스' },
    { key: 'scoreAroma', label: '아로마' },
    { key: 'scoreFlavor', label: '플레이버' },
    { key: 'scoreAftertaste', label: '에프터테이스트' },
    { key: 'scoreAcidity', label: '액시디티' },
    { key: 'scoreBody', label: '바디' },
    { key: 'scoreBalance', label: '밸런스' },
    { key: 'scoreOverall', label: '오버럴' }
  ];
  
  scoreFields.forEach(field => {
    html += `<tr><td>${field.label}</td>`;
    selectedSamples.forEach(sample => {
      html += `<td>${parseFloat(sample.sampleData[field.key] || 0).toFixed(2)}</td>`;
    });
    html += `</tr>`;
  });
  
  html += `<tr class="font-bold"><td>총점 (30+합계)</td>`;
  selectedSamples.forEach(sample => {
    let total = 30;
    scoreFields.forEach(field => {
      total += parseFloat(sample.sampleData[field.key] || 0);
    });
    html += `<td>${total.toFixed(2)}</td>`;
  });
  html += `</tr>`;
  
  html += `</tbody></table></div></div>`;

  html += `<div class="bg-white rounded-lg p-4 shadow-md mt-4">`;
  html += `<h4 class="font-semibold mb-4">선택 향미</h4>`;
  html += `<div class="grid md:grid-cols-${selectedSamples.length} gap-4">`;
  selectedSamples.forEach(sample => {
    html += `<div>`;
    html += `<h5 class="font-semibold mb-2">${sample.title || '샘플'}</h5>`;
    html += buildFlavorSummaryHtml(sample.sampleData);
    html += `</div>`;
  });
  html += `</div></div>`;
  
  compareArea.innerHTML = html;
  
  // 차트 생성
  const ctx = document.getElementById('comparisonRadar');
  if (!ctx) return;
  
  const chartData = {
    labels: ['프래그런스', '아로마', '플레이버', '에프터테이스트', '액시디티', '바디', '밸런스', '오버럴'],
    datasets: []
  };
  
  const colors = [
    { bg: 'rgba(139, 90, 43, 0.2)', border: 'rgba(139, 90, 43, 0.8)' },
    { bg: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 0.8)' },
    { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 0.8)' },
    { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 0.8)' },
    { bg: 'rgba(153, 102, 255, 0.2)', border: 'rgba(153, 102, 255, 0.8)' },
    { bg: 'rgba(255, 159, 64, 0.2)', border: 'rgba(255, 159, 64, 0.8)' }
  ];
  
  selectedSamples.forEach((sample, index) => {
    const color = colors[index % colors.length];
    
    chartData.datasets.push({
      label: sample.title || '샘플',
      data: [
        parseFloat(sample.sampleData.scoreFragrance || 0),
        parseFloat(sample.sampleData.scoreAroma || 0),
        parseFloat(sample.sampleData.scoreFlavor || 0),
        parseFloat(sample.sampleData.scoreAftertaste || 0),
        parseFloat(sample.sampleData.scoreAcidity || 0),
        parseFloat(sample.sampleData.scoreBody || 0),
        parseFloat(sample.sampleData.scoreBalance || 0),
        parseFloat(sample.sampleData.scoreOverall || 0)
      ],
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 2,
      pointRadius: 4
    });
  });
  
  const options = {
    scales: {
      r: {
        angleLines: { display: true },
        min: 0,
        max: 10,
        ticks: {
          stepSize: 2,
          backdropColor: 'rgba(255, 255, 255, 0)'
        }
      }
    }
  };
  
  chartObjects.comparisonRadar = new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: options
  });
  
  compareArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 고급 비교 테이블 생성

// 분할 화면 셀렉트 박스 업데이트
function updateSplitViewSelects() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  
  if (!leftSelect || !rightSelect) return;
  
  leftSelect.innerHTML = '';
  rightSelect.innerHTML = '';
  
  leftSelect.add(new Option('선택하세요', ''));
  rightSelect.add(new Option('선택하세요', ''));
  
  samples.forEach(sample => {
    leftSelect.add(new Option(sample.title || '샘플', sample.id));
    rightSelect.add(new Option(sample.title || '샘플', sample.id));
  });
  
  if (samples.length >= 2) {
    leftSelect.value = samples[0].id;
    rightSelect.value = samples[1].id;
    updateSplitView();
  }
}

// 분할 화면 업데이트
function updateSplitView() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  const leftView = document.getElementById('leftSampleView');
  const rightView = document.getElementById('rightSampleView');
  
  if (!leftSelect || !rightSelect || !leftView || !rightView) return;
  
  const leftSample = samples.find(s => s.id === leftSelect.value);
  const rightSample = samples.find(s => s.id === rightSelect.value);
  
  if (leftSample) {
    leftView.innerHTML = createSampleSummary(leftSample);
  } else {
    leftView.innerHTML = '<div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>';
  }
  
  if (rightSample) {
    rightView.innerHTML = createSampleSummary(rightSample);
  } else {
    rightView.innerHTML = '<div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>';
  }
}

// 샘플 요약 HTML 생성
function createSampleSummary(sample) {
  if (!sample) return '';
  
  const sampleData = sample.sampleData;
  let html = `
    <h3 class="font-bold text-lg mb-3">${sample.title || '샘플'}</h3>
    <div class="mb-3">
      <div><span class="font-semibold">커피명:</span> ${sampleData.coffeeName || '-'}</div>
      <div><span class="font-semibold">원산지:</span> ${sampleData.origin || '-'}</div>
      <div><span class="font-semibold">품종:</span> ${sampleData.variety || '-'}</div>
      <div><span class="font-semibold">가공법:</span> ${sampleData.process || '-'}</div>
      <div><span class="font-semibold">로스팅 날짜:</span> ${sampleData.roastDate || '-'}</div>
    </div>
    
    <h4 class="font-bold mt-4 mb-2">SCA 점수</h4>
    <div class="grid grid-cols-2 gap-2">
      <div><span class="font-semibold">프래그런스:</span> ${parseFloat(sampleData.scoreFragrance || 0).toFixed(2)}</div>
      <div><span class="font-semibold">아로마:</span> ${parseFloat(sampleData.scoreAroma || 0).toFixed(2)}</div>
      <div><span class="font-semibold">플레이버:</span> ${parseFloat(sampleData.scoreFlavor || 0).toFixed(2)}</div>
      <div><span class="font-semibold">에프터테이스트:</span> ${parseFloat(sampleData.scoreAftertaste || 0).toFixed(2)}</div>
      <div><span class="font-semibold">액시디티:</span> ${parseFloat(sampleData.scoreAcidity || 0).toFixed(2)}</div>
      <div><span class="font-semibold">바디:</span> ${parseFloat(sampleData.scoreBody || 0).toFixed(2)}</div>
      <div><span class="font-semibold">밸런스:</span> ${parseFloat(sampleData.scoreBalance || 0).toFixed(2)}</div>
      <div><span class="font-semibold">오버럴:</span> ${parseFloat(sampleData.scoreOverall || 0).toFixed(2)}</div>
    </div>
    
  <div class="mt-2">
      <span class="font-bold">총점: </span>
      ${(30 + parseFloat(sampleData.scoreFragrance || 0) + 
          parseFloat(sampleData.scoreAroma || 0) + 
          parseFloat(sampleData.scoreFlavor || 0) + 
          parseFloat(sampleData.scoreAftertaste || 0) + 
          parseFloat(sampleData.scoreAcidity || 0) + 
          parseFloat(sampleData.scoreBody || 0) + 
          parseFloat(sampleData.scoreBalance || 0) + 
          parseFloat(sampleData.scoreOverall || 0)).toFixed(2)}
    </div>
  `;

  html += buildFlavorSummaryHtml(sampleData);
  
  // 바디감 디스크립터 표시
  if (sampleData.bodyDescriptors && sampleData.bodyDescriptors.length > 0) {
    html += `<h4 class="font-bold mt-4 mb-2">바디감 디스크립터</h4>`;
    
    sampleData.bodyDescriptors.forEach(descriptorId => {
      const descriptor = BODY_DESCRIPTORS.find(d => d.id === descriptorId);
      if (descriptor) {
        const displayText = currentLanguage === 'ko' ? descriptor.korean : descriptor.label;
        const textColor = getContrastColor(descriptor.color);
        html += `<span class="flavor-badge" style="background:${descriptor.color};color:${textColor};">${displayText}</span> `;
      }
    });
  }
  
  if (sampleData.tastingNotes) {
    html += `
      <h4 class="font-bold mt-4 mb-2">테이스팅 노트</h4>
      <div class="bg-gray-50 p-3 rounded text-sm">${sampleData.tastingNotes.replace(/\n/g, '<br>')}</div>
    `;
  }
  
  return html;
}

// SNS형 이미지 내보내기 함수
function exportSnsImage() {
  saveCurrentSample();
  
  const currentSample = getCurrentSampleObj();
  if (!currentSample) {
    showToast("내보낼 샘플이 없습니다.");
    return;
  }
  
  const s = currentSample.sampleData;
  
  // SNS용 임시 DOM 요소 생성 (심플한 흰색 배경)
  const tempRoot = document.createElement('div');
  tempRoot.style.cssText = `
    background: white;
    padding: 40px;
    max-width: 500px;
    font-family: 'Noto Sans KR', sans-serif;
    position: absolute;
    left: -9999px;
    top: 0;
    border-radius: 12px;
    color: #333;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border: 2px solid #f0f0f0;
  `;
  
  // SNS용 간결한 HTML 구성 (커피명 + 향미특성/속성만)
  tempRoot.innerHTML = `
  <div style="text-align: center; margin-bottom: 30px;">
    <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #8B5A2B;">${s.title || s.coffeeName || '커피 테이스팅'}</h2>
    ${s.coffeeName && s.title !== s.coffeeName ? `<div style="font-size: 16px; color: #666; margin-top: 5px;">${s.coffeeName}</div>` : ''}
  </div>
  
  <div style="border: 1px solid #e5e5e5; border-radius: 8px; padding: 25px;">
    <h3 style="font-weight: 700; font-size: 18px; margin: 0 0 20px 0; text-align: center; color: #8B5A2B; border-bottom: 1px solid #e5e5e5; padding-bottom: 10px;">향미 프로필</h3>
    
    <div style="display: grid; gap: 15px;">
      ${FLAVOR_PHASES.map(phase => {
        const phaseLabel = currentLanguage === 'ko' ? phase.label : phase.labelEn;
        const phaseSel = (s.flavorSelections[phase.id] || []).map(key => {
          const [cat, sub, desc] = key.split('|');
          const rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
          const displayName = currentLanguage === 'ko' && rec && rec.length > 6 ? rec[6] : desc;
          const color = rec ? rec[3] : '#B8B2A5';
          const textColor = getContrastColor(color);
          return `<span style="display: inline-block; padding: 4px 10px; border-radius: 12px; margin: 2px; font-size: 12px; color: ${textColor}; background: ${color}; font-weight: 500;">${displayName}</span>`;
        }).join('');
        
        return `<div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; font-size: 14px; color: #555;">${phaseLabel}</div>
          <div style="line-height: 1.5; min-height: 24px;">
            ${phaseSel || '<span style="color: #999; font-style: italic; font-size: 12px;">선택된 향미 없음</span>'}
          </div>
        </div>`;
      }).join('')}
    </div>
    
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e5e5;">
      <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #555;">맛 속성</div>
      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
        ${Object.keys(ATTR_TO_BADGE).map(attrKey => {
          const attrMeta = ATTR_TO_BADGE[attrKey];
          const val = s[attrKey];
          const attrLabel = currentLanguage === 'ko' ? attrMeta.label : attrMeta.labelEn;
          const valLabel = val && ATTR_VALUE_LABELS[val] ? 
            (currentLanguage === 'ko' ? ATTR_VALUE_LABELS[val].kr : ATTR_VALUE_LABELS[val].en) : 
            '미선택';
          
          if (val) {
            return `<span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: white; background: ${attrMeta.color}; font-weight: 500;">${attrLabel}: ${valLabel}</span>`;
          } else {
            return `<span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: white; background: ${attrMeta.color}; opacity: 0.5; font-weight: 500;">${attrLabel}: ${valLabel}</span>`;
          }
        }).join('')}
      </div>
    </div>
    
    ${(s.bodyDescriptors && s.bodyDescriptors.length > 0) ? `
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e5e5;">
      <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #555;">바디감</div>
      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
        ${s.bodyDescriptors.map(descriptorId => {
          const descriptor = BODY_DESCRIPTORS.find(d => d.id === descriptorId);
          if (descriptor) {
            const displayText = currentLanguage === 'ko' ? descriptor.korean : descriptor.label;
            const textColor = getContrastColor(descriptor.color);
            return `<span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: ${textColor}; background: ${descriptor.color}; font-weight: 500;">${displayText}</span>`;
          }
          return '';
        }).join('')}
      </div>
    </div>
    ` : ''}
    
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e5e5; text-align: center;">
      <div style="font-size: 12px; color: #888;">
        ${new Date().toLocaleDateString()} | mollis Coffee Cupping
      </div>
    </div>
  </div>
  `;
  
  document.body.appendChild(tempRoot);
  
  // SNS용 이미지 생성
  html2canvas(tempRoot, {
    backgroundColor: "white",
    scale: 2,
    logging: false,
    useCORS: true
  }).then(canvas => {
    try {
      const a = document.createElement('a');
      a.href = canvas.toDataURL("image/png");
      const fname = (s.title || s.coffeeName || 'coffee_sns') + '_sns.png';
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      
      document.body.removeChild(a);
      document.body.removeChild(tempRoot);
      showToast("SNS용 이미지가 저장되었습니다!");
    } catch (e) {
      console.error("SNS 이미지 생성 중 오류:", e);
      showToast("SNS 이미지 생성 중 오류가 발생했습니다.");
    }
  }).catch(e => {
    console.error("Canvas 생성 중 오류:", e);
    showToast("이미지 변환 중 오류가 발생했습니다.");
    if (document.body.contains(tempRoot)) {
      document.body.removeChild(tempRoot);
    }
  });
}

// 결과 이미지 내보내기 (향미/속성 + 레이더 차트)
function exportResultImage() {
  saveCurrentSample();
  const currentSample = getCurrentSampleObj();
  if (!currentSample) {
    showToast("내보낼 샘플이 없습니다.");
    return;
  }

  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'background:white;padding:20px;position:absolute;left:-9999px;top:0;font-family:\'Noto Sans KR\',sans-serif;';
  wrapper.innerHTML = `<h2 style="text-align:center;font-weight:bold;color:#8B5A2B;margin-bottom:16px;">${currentSample.title || currentSample.sampleData.coffeeName || '커핑 샘플'}</h2>`;
  const visual = document.querySelector('.visual-section-flex');
  if (visual) {
    const clone = visual.cloneNode(true);
    const origCanvas = visual.querySelector('#cuppingRadar');
    const cloneCanvas = clone.querySelector('#cuppingRadar');
    if (origCanvas && cloneCanvas) {
      const img = document.createElement('img');
      img.src = origCanvas.toDataURL('image/png');
      img.style.maxWidth = '100%';
      img.width = origCanvas.width;
      img.height = origCanvas.height;
      cloneCanvas.parentNode.replaceChild(img, cloneCanvas);
    }
    wrapper.appendChild(clone);
  }

  document.body.appendChild(wrapper);
  html2canvas(wrapper, {backgroundColor: 'white', scale: 2, useCORS: true}).then(canvas => {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = (currentSample.title || 'cupping') + '.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    document.body.removeChild(wrapper);
    showToast('이미지가 저장되었습니다!');
  }).catch(e => {
    console.error('이미지 저장 오류:', e);
    showToast('이미지 저장 중 오류가 발생했습니다.');
    if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
  });
}

// Excel 내보내기
function exportToExcel() {
  saveCurrentSample();
  if (samples.length === 0) {
    showToast('내보낼 데이터가 없습니다.');
    return;
  }

  const header = ['샘플명','커피명','원산지','품종','가공방식','로스팅 날짜','로스팅 레벨','산미','단맛','바디','바디 디스크립터','프래그런스','아로마','플레이버','에프터테이스트','테이스팅 노트'];
  const rows = [header];

  samples.forEach(sample => {
    const d = sample.sampleData;
    const flavors = FLAVOR_PHASES.map(ph => (d.flavorSelections[ph.id] || []).map(key => {
      const parts = key.split('|');
      const rec = FLAVOR_DATA.find(f => f[0] === parts[0] && f[1] === parts[1] && f[2] === parts[2]);
      return rec ? (currentLanguage === 'ko' && rec.length > 6 ? rec[6] : rec[2]) : parts[2];
    }).join(', '));

    const bodyDesc = (d.bodyDescriptors || []).map(id => {
      const descriptor = BODY_DESCRIPTORS.find(b => b.id === id);
      return descriptor ? descriptor.korean : id;
    }).join(', ');

    rows.push([
      sample.title || '',
      d.coffeeName || '',
      d.origin || '',
      d.variety || '',
      d.process || '',
      d.roastDate || '',
      d.roastLevel || '',
      d.acidityLevel || '',
      d.sweetnessLevel || '',
      d.bodyLevel || '',
      bodyDesc,
      flavors[0] || '',
      flavors[1] || '',
      flavors[2] || '',
      flavors[3] || '',
      d.tastingNotes || ''
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Cupping');
  XLSX.writeFile(wb, 'cupping_data.xlsx');
  showToast('엑셀 파일이 저장되었습니다.');
}

// 데이터 무결성 검증 함수
function validateSampleData(sampleData) {
  try {
    // 필수 필드 검증
    if (!sampleData.flavorSelections) {
      sampleData.flavorSelections = {};
      FLAVOR_PHASES.forEach(phase => sampleData.flavorSelections[phase.id] = []);
    }
    
    // 바디감 디스크립터 필드 추가 (기존 데이터 호환성)
    if (!sampleData.bodyDescriptors) {
      sampleData.bodyDescriptors = [];
    }
    
    // 점수 필드 검증
    const scoreFields = ['scoreFragrance', 'scoreAroma', 'scoreFlavor', 'scoreAftertaste', 
                        'scoreAcidity', 'scoreBody', 'scoreBalance', 'scoreOverall'];
    scoreFields.forEach(field => {
      if (typeof sampleData[field] !== 'number' || isNaN(sampleData[field])) {
        sampleData[field] = 7; // 기본값
      }
    });
    
    // 디펙트 필드 검증
    DEFECT_PROPS.forEach(defect => {
      if (!sampleData[defect.key] || !DEFECT_LABELS[sampleData[defect.key]]) {
        sampleData[defect.key] = "none";
      }
    });
    
    return true;
  } catch (e) {
    console.error("샘플 데이터 검증 중 오류:", e);
    return false;
  }
}

// 오류 모니터링 및 자동 복구 기능
function setupErrorMonitoring() {
  window.addEventListener('error', function(e) {
    console.error('오류 감지됨:', e.error);
    
    lastErrorCount++;
    
    if (lastErrorCount > 5) {
      try {
        let lastBackupKey = null;
        let lastBackupDate = '';
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('mollis_sca_backup_')) {
            const date = key.replace('mollis_sca_backup_', '');
            if (!lastBackupKey || date > lastBackupDate) {
              lastBackupKey = key;
              lastBackupDate = date;
            }
          }
        }
        
        if (lastBackupKey) {
          const emergency_copy = JSON.parse(JSON.stringify(samples));
          const backupData = JSON.parse(localStorage.getItem(lastBackupKey));
          
          if (Array.isArray(backupData) && backupData.length > 0) {
            localStorage.setItem('mollis_sca_emergency_backup', JSON.stringify(emergency_copy));
            showToast("오류로 인해 마지막 백업 상태로 복원합니다...");
            
            samples = backupData;
            if (samples.length > 0) {
              currentSampleId = samples[0].id;
              setUIFromSample(samples[0].sampleData);
              renderSampleList();
              saveSamplesToStorage();
            }
          }
        }
        
        lastErrorCount = 0;
      } catch (err) {
        console.error("자동 복구 중 오류:", err);
      }
    }
    
    setTimeout(() => { lastErrorCount = 0; }, 10000);
  });
}

// 모바일 터치 최적화 추가 기능
function enhanceMobileExperience() {
  // 모바일 브라우저 감지
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    // 모바일 전용 스타일 동적 적용
    const style = document.createElement('style');
    style.textContent = `
      .mobile-optimized {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      input, textarea, select {
        font-size: 16px !important; /* iOS 줌 방지 */
      }
      
      .flavor-checkbox-label {
        min-height: 44px;
        min-width: 44px;
      }
      
      .sample-item {
        min-height: 50px;
      }
      
      .tab-btn-active, .tab-btn-inactive {
        min-height: 48px;
      }
    `;
    document.head.appendChild(style);
    
    // 모바일 전용 터치 이벤트 추가
    document.body.classList.add('mobile-optimized');
    
    // 더블 탭 줌 방지
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    console.log("모바일 최적화 기능이 활성화되었습니다.");
  }
}

// 키보드 단축키 지원
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    // Ctrl+S: 현재 샘플 저장
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      if (currentSampleId) {
        saveCurrentSample();
        showToast("샘플이 저장되었습니다.");
      }
    }
    
    // Ctrl+N: 새 샘플 추가
    if (e.ctrlKey && e.key === 'n') {
      e.preventDefault();
      document.getElementById('addSampleBtn').click();
    }
    
    // 화살표 키: 샘플 네비게이션
    if (e.key === 'ArrowLeft' && e.altKey) {
      e.preventDefault();
      goToPrevSample();
    }
    
    if (e.key === 'ArrowRight' && e.altKey) {
      e.preventDefault();
      goToNextSample();
    }
    
    // Ctrl+D: 샘플 복제
    if (e.ctrlKey && e.key === 'd') {
      e.preventDefault();
      if (currentSampleId) {
        cloneSample(currentSampleId);
      }
    }
    
    // ESC: 모달 닫기
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => {
        modal.classList.remove('show');
      });
    }
    
    // Ctrl+1~4: 향미 탭 전환
    if (e.ctrlKey && e.key >= '1' && e.key <= '4') {
      e.preventDefault();
      const phaseIndex = parseInt(e.key) - 1;
      if (phaseIndex < FLAVOR_PHASES.length) {
        currentFlavorPhase = FLAVOR_PHASES[phaseIndex].id;
        renderFlavorTabs();
        renderFlavorPhase();
      }
    }
    
    // Ctrl+L: 언어 전환
    if (e.ctrlKey && e.key === 'l') {
      e.preventDefault();
      switchLanguage(currentLanguage === 'ko' ? 'en' : 'ko');
    }
  });
  
  console.log("키보드 단축키가 설정되었습니다.");
}

// 성능 최적화 함수
function optimizePerformance() {
  // 디바운싱된 리사이즈 이벤트
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      // 차트 리사이즈
      if (flavorProfileChart) {
        flavorProfileChart.resize();
      }
      
      Object.values(chartObjects).forEach(chart => {
        if (chart && typeof chart.resize === 'function') {
          chart.resize();
        }
      });
    }, 250);
  });
  
  // 메모리 사용량 모니터링 (개발자 도구용)
  if (typeof performance !== 'undefined' && performance.memory) {
    setInterval(() => {
      const memory = performance.memory;
      if (memory.usedJSHeapSize > 50 * 1024 * 1024) { // 50MB 이상
        console.warn("메모리 사용량이 높습니다:", memory.usedJSHeapSize / 1024 / 1024, "MB");
        cleanupCharts();
      }
    }, 30000); // 30초마다 체크
  }
}

// 초기화 함수
function initApp() {
  try {
    console.log("🚀 Mollis SCA 커피 관능 평가 도구 (개선버전) 시작");
    
    renderFlavorTabs();
    loadSamplesFromStorage();
    
    // 모든 샘플 데이터 검증 및 수정
    samples.forEach(sample => {
      validateSampleData(sample.sampleData);
    });
    
    setupSwipeNavigation();
    setupKeyboardShortcuts();
    enhanceMobileExperience();
    setupErrorMonitoring();
    
    document.getElementById('evalDate').textContent = new Date().toLocaleDateString();
    
    // 바디감 디스크립터 렌더링
    renderBodyDescriptors();
    
    // 다국어 텍스트 초기화
    updateI18nTexts();
    
    // 현재 샘플이 있으면 UI 업데이트
    if (currentSampleId) {
      const currentSample = getCurrentSampleObj();
      if (currentSample) {
        setUIFromSample(currentSample.sampleData);
      }
    }
    
    console.log("✅ 애플리케이션 초기화 완료");
    console.log(`📊 향미 항목: ${FLAVOR_DATA.length}개`);
    console.log(`🖐 바디감 디스크립터: ${BODY_DESCRIPTORS.length}개`);
    console.log(`🌐 현재 언어: ${currentLanguage === 'ko' ? '한국어' : '영어'}`);
    
    // 사용자에게 환영 메시지 표시
    setTimeout(() => {
      showToast("Mollis SCA 커피 관능 평가 도구 (개선버전)에 오신 것을 환영합니다!");
    }, 1000);
    
  } catch (e) {
    console.error("애플리케이션 초기화 중 오류:", e);
    showToast("초기화 중 오류가 발생했습니다. 페이지를 새로고침해 주세요.");
  }
}

// 이벤트 핸들러 설정
function setupEventHandlers() {
  // 샘플 관리 버튼들
  const addSampleBtn = document.getElementById('addSampleBtn');
  if (addSampleBtn) addSampleBtn.addEventListener('click', function() {
    if (currentSampleId) {
      saveCurrentSample();
    }
    
    const newSample = createNewSampleObj(`샘플 #${samples.length + 1}`);
    samples.unshift(newSample);
    currentSampleId = newSample.id;
    renderSampleList();
    setUIFromSample(newSample.sampleData);
    saveSamplesToStorage();
    showToast("새 샘플이 추가되었습니다.");
  });
  
  const removeSampleBtn = document.getElementById('removeSampleBtn');
  if (removeSampleBtn) removeSampleBtn.addEventListener('click', function() {
    if (!currentSampleId) return;
    
    if (confirm("현재 샘플을 삭제하시겠습니까?")) {
      const currentIdx = samples.findIndex(s => s.id === currentSampleId);
      if (currentIdx === -1) return;
      
      samples.splice(currentIdx, 1);
      
      if (samples.length > 0) {
        currentSampleId = samples[Math.min(currentIdx, samples.length - 1)].id;
        setUIFromSample(samples.find(s => s.id === currentSampleId).sampleData);
      } else {
        const newSample = createNewSampleObj("샘플 #1");
        samples.push(newSample);
        currentSampleId = newSample.id;
        setUIFromSample(newSample.sampleData);
      }
      
      renderSampleList();
      saveSamplesToStorage();
      showToast("샘플이 삭제되었습니다.");
    }
  });
  
  const cloneSampleBtn = document.getElementById('cloneSampleBtn');
          <button class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs flex items-center mobile-touch-friendly" id="undoBtn"><i class="fa fa-undo mr-2"></i>실행취소</button>
  if (cloneSampleBtn) cloneSampleBtn.addEventListener('click', function() {
          <button class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-xs flex items-center mobile-touch-friendly" id="undoBtn"><i class="fa fa-undo mr-2"></i>실행취소</button>
    if (!currentSampleId) return;
    cloneSample(currentSampleId);
  });
  
  // 데이터 관리 버튼들
  const saveSamplesBtn = document.getElementById('saveSamplesBtn');
  if (saveSamplesBtn) saveSamplesBtn.addEventListener('click', function() {
    if (currentSampleId) {
      saveCurrentSample();
    }
    saveSamplesToStorage();
    showToast("모든 샘플이 웹 스토리지에 저장되었습니다.");
  });
  
  const loadSamplesWebBtn = document.getElementById('loadSamplesWebBtn');
  if (loadSamplesWebBtn) loadSamplesWebBtn.addEventListener('click', function() {
    if (confirm("웹 스토리지에서 샘플을 불러오시겠습니까? 저장되지 않은 변경사항은 사라집니다.")) {
      loadSamplesFromStorage();
      if (samples.length > 0) {
        currentSampleId = samples[0].id;
        setUIFromSample(samples[0].sampleData);
      }
      showToast("웹 스토리지에서 샘플을 불러왔습니다.");
    }
  });
  
  const backupManageBtn = document.getElementById('backupManageBtn');
  if (backupManageBtn) backupManageBtn.addEventListener('click', function() {
    showBackupList();
  });
  
  // JSON 내보내기
  const exportSamplesBtn = document.getElementById('exportSamplesBtn');
  if (exportSamplesBtn) exportSamplesBtn.addEventListener('click', function() {
    if (currentSampleId) {
      saveCurrentSample();
    }
    
    try {
      const dataStr = JSON.stringify(samples, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      
      const exportFileName = `mollis_coffee_samples_${new Date().toISOString().slice(0, 10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.style.display = 'none';
      document.body.appendChild(linkElement);
      linkElement.click();
      document.body.removeChild(linkElement);
      
      showToast("샘플 데이터를 JSON 파일로 내보냈습니다.");
    } catch (e) {
      console.error("JSON 내보내기 중 오류:", e);
      showToast("내보내기 중 오류가 발생했습니다.");
    }
  });
  
  // JSON 불러오기
  const importSamplesInput = document.getElementById('importSamplesInput');
  if (importSamplesInput) importSamplesInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const importedData = JSON.parse(event.target.result);
        
        if (Array.isArray(importedData) && importedData.length > 0) {
          if (confirm("불러온 데이터로 기존 데이터를 대체하시겠습니까?")) {
            samples = importedData;
            // 데이터 검증
            samples.forEach(sample => {
              validateSampleData(sample.sampleData);
            });
            
            currentSampleId = samples[0].id;
            setUIFromSample(samples[0].sampleData);
            renderSampleList();
            saveSamplesToStorage();
            showToast("샘플 데이터를 성공적으로 불러왔습니다.");
          }
        } else {
          showToast("유효한 샘플 데이터가 아닙니다.");
        }
      } catch (e) {
        console.error("JSON 파싱 오류:", e);
        showToast("JSON 파일 형식이 올바르지 않습니다.");
      }
    };
    
    reader.readAsText(file);
    e.target.value = '';
  });
  
  // 슬라이더/입력 동기화
  document.querySelectorAll('.score-slider').forEach(slider => {
    const inputId = slider.id.replace('_slider', '');
    const input = document.getElementById(inputId);
    
    slider.addEventListener('input', function() {
      input.value = this.value;
      updateTotalScore();
      scheduleAutoSave();
    });
    
    input.addEventListener('input', function() {
      slider.value = this.value;
      updateTotalScore();
      scheduleAutoSave();
    });
  });
  
  // 계산 버튼
  const calcScoreBtn = document.getElementById('calcScoreBtn');
  if (calcScoreBtn) calcScoreBtn.addEventListener('click', function() {
    updateTotalScore();
  });
  
  // 변경 감지 이벤트들
  const sampleTitleInput = document.getElementById('sampleTitleInput');
  if (sampleTitleInput) sampleTitleInput.addEventListener('input', scheduleAutoSave);
  
  document.querySelectorAll('.coffee-input').forEach(input => {
    input.addEventListener('input', scheduleAutoSave);
    input.addEventListener('change', scheduleAutoSave);
  });
  
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      scheduleAutoSave();
      renderSelectedFlavorsArea();
    });
  });
  
  const tastingNotes = document.getElementById('tastingNotes');
  if (tastingNotes) tastingNotes.addEventListener('input', scheduleAutoSave);
  
  // 네비게이션 버튼
  const prevSampleBtn = document.getElementById('prevSampleBtn');
  if (prevSampleBtn) prevSampleBtn.addEventListener('click', goToPrevSample);
  const nextSampleBtn = document.getElementById('nextSampleBtn');
  if (nextSampleBtn) nextSampleBtn.addEventListener('click', goToNextSample);
  
  // 언어 전환 버튼 개선
  const langEn = document.getElementById('langEn');
  if (langEn) langEn.addEventListener('click', () => switchLanguage('en'));
  const langKo = document.getElementById('langKo');
  if (langKo) langKo.addEventListener('click', () => switchLanguage('ko'));
  
  // 비교 버튼들
  const compareBtn = document.getElementById('compareBtn');
  if (compareBtn) compareBtn.addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.compare-checkbox:checked'))
      .map(cb => cb.value);
    
    if (selectedIds.length < 2) {
      showToast("비교를 위해 2개 이상의 샘플을 선택해 주세요.");
      return;
    }
    
    const selectedSamples = samples.filter(s => selectedIds.includes(s.id));
    createComparisonChart(selectedSamples);
  });
    
  const splitViewBtn = document.getElementById('splitViewBtn');
  if (splitViewBtn) splitViewBtn.addEventListener('click', function() {
    if (samples.length < 2) {
      showToast("비교를 위해 샘플이 2개 이상 필요합니다.");
      return;
    }
    
    const modal = document.getElementById('splitViewModal');
    modal.classList.add('show');
    updateSplitViewSelects();
  });
  
  // 모달 관련
  const closeSplitViewBtn = document.getElementById('closeSplitViewBtn');
  if (closeSplitViewBtn) closeSplitViewBtn.addEventListener('click', function() {
    document.getElementById('splitViewModal').classList.remove('show');
  });

  const leftSampleSelect = document.getElementById('leftSampleSelect');
  if (leftSampleSelect) leftSampleSelect.addEventListener('change', updateSplitView);
  const rightSampleSelect = document.getElementById('rightSampleSelect');
  if (rightSampleSelect) rightSampleSelect.addEventListener('change', updateSplitView);
  
  // 모달 배경 클릭으로 닫기
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
      e.target.classList.remove('show');
    }
  });
  
  // 내보내기 버튼들 (기존 코드 유지 - 생략하여 길이 단축)
  const exportImgBtn = document.getElementById('exportImgBtn');
  if (exportImgBtn) exportImgBtn.addEventListener('click', exportResultImage);

  const exportSnsImgBtn = document.getElementById('exportSnsImgBtn');
  if (exportSnsImgBtn) exportSnsImgBtn.addEventListener('click', exportSnsImage);

  const exportXlsxBtn = document.getElementById('exportXlsxBtn');
  if (exportXlsxBtn) exportXlsxBtn.addEventListener('click', exportToExcel);
  
  console.log("모든 이벤트 핸들러 설정 완료");
}

// DOM 준비 상태 확인 후 앱 초기화
function runInit() {
  initApp();
  setupEventHandlers();
  setupAutoBackup();
  optimizePerformance();
}

if (document.readyState !== 'loading') {
  runInit();
} else {
  document.addEventListener('DOMContentLoaded', runInit);
    if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js').catch(e => console.error('SW registration failed:', e));
    });
  }
}

// 페이지 종료 시 정리 작업 
window.addEventListener('beforeunload', function(e) {
  try {
    saveCurrentSample();
    cleanupCharts();
  } catch (err) {
    console.error("페이지 종료 시 정리 작업 중 오류:", err);
  }
});

</script>
  <script src="extras.js"></script>
</body>
</html>
