<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mollis SCA 커피 관능 평가</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    html,body { font-family: 'Noto Sans KR', sans-serif; background: #fcfaf7;}
    .flavor-badge { font-size: 13px; border-radius: 9999px; padding: 2px 10px; margin: 2px; display:inline-block;}
    .export-btn { background:#8B5A2B; color:white;} .export-btn:hover { background: #654321;}
    .tab-btn-active { background: #8B5A2B!important; color:#fff !important;}
    .tab-btn-inactive { background: #f3efe8!important; color: #675444;}
    .visual-section-flex { display: flex; flex-direction: row; gap: 18px; flex-wrap: wrap; }
    @media (max-width:900px){ .visual-section-flex{ flex-direction:column; } }
    @media (max-width:640px){
      .visual-section-flex { flex-direction: column; gap: 12px;}
      .grid-cols-sample { grid-template-columns:1fr!important;}
      .md\:grid-cols-2 { grid-template-columns: 1fr !important;}
      .score-input-wrap input[type=number], .score-slider { width: 90px; }
      .defect-block { min-width:110px!important;}
    }
    
    /* 향미 선택 영역 스크롤 제거 및 전체 표시 */
    .flavor-section {
      max-height: none !important; 
      overflow: visible !important;
      padding: 15px;
      background: #f9f7f5;
      border-radius: 12px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    
    /* 샘플 알림 토스트 */
    .sample-toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .sample-toast.show {
      opacity: 1;
      visibility: visible;
    }
    
    .no-scrollbar::-webkit-scrollbar {display: none;} 
    .no-scrollbar {-ms-overflow-style: none; scrollbar-width: none;}
    .html2canvas-container { box-shadow: 0 0 0 3px #eee; }
    .score-slider { width: 100%; }
    .sample-list-scroll {max-height: 190px; overflow-y: auto;}
    .compare-table th, .compare-table td {border:1px solid #e2e2e2; padding:6px 8px; font-size:14px;}
    .compare-table th {background: #f9f3ea;}
    .compare-table tr:nth-child(even) td {background: #f8f6f4;}
    .tooltip { position: relative; cursor: help;}
    .tooltip .tooltip-text { visibility: hidden; background: #333; color: #fff; position: absolute; z-index: 10; padding: 7px 15px; border-radius: 8px; left: 50%; top:110%; min-width:160px; font-size:13px; opacity:0; transform:translateX(-50%); pointer-events: none; transition: opacity 0.2s; box-shadow: 0 1px 6px rgba(0,0,0,0.13); word-break: keep-all; }
    .tooltip:hover .tooltip-text {opacity:1;visibility:visible;}
    .toast { position: fixed; bottom: 28px; right: 28px; min-width: 240px; background: #8B5A2B; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 3px 20px rgba(0,0,0,.18); z-index: 9999; font-size: 15px; opacity: 0; pointer-events:none; transition: opacity 0.3s; text-align: center; }
    .toast.show{opacity:1;pointer-events:auto;}
    .defect-badge { border-radius:9999px; font-size:12px!important; padding:2px 11px;margin: 0 4px 4px 0; display:inline-block; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .defect-headline { font-size: 15px; font-weight:600; margin-bottom:.5rem }
    .defect-desc { font-size: 11px; color: #666; margin-bottom: .2rem; }
    .defect-block { display:flex; flex-direction: column; min-width:120px; margin-right:9px; margin-bottom:7px;}
    @media print { .flavor-section { max-height: none !important; overflow: visible !important; } body { background: #fff; } .toast, .sample-toast { display:none; } }
    @media (max-width:400px) {
      .defect-block { min-width:70px!important;font-size:11px;}
      .defect-badge { font-size:11px!important;padding:1px 6px;}
      .defect-headline { font-size:12.5px;}
    }
    
    /* 향미 선택 개선 */
    .flavor-checkbox-label {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 4px 12px 4px 30px;
      border-radius: 20px;
      margin: 3px;
      font-size: 13px;
      cursor: pointer;
      line-height: 1.3;
      transition: all 0.2s;
    }
    .flavor-checkbox-label:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .flavor-checkbox-label input {
      position: absolute;
      opacity: 0;
      left: 8px;
    }
    .flavor-checkbox-label .checkbox-custom {
      position: absolute;
      left: 8px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .flavor-checkbox-label input:checked + .checkbox-custom:after {
      content: "\f00c";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      font-size: 10px;
      color: #fff;
    }
    .flavor-checkbox-label input:checked + .checkbox-custom {
      background: #8B5A2B;
      border-color: #8B5A2B;
    }
    .flavor-checkbox-label .flavor-kr {
      font-size: 12px;
      opacity: 0.85;
      display: block;
    }
    
    .flavor-category-title {
      background: #8B5A2B;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      margin: 12px 0 8px 0;
      font-weight: 600;
    }
    
    .flavor-subcategory-title {
      font-weight: 600;
      background: #f1e7db;
      padding: 4px 10px;
      border-radius: 4px;
      margin: 8px 0 6px 0;
      display: inline-block;
    }
    
    /* 샘플 리스트 드래그 앤 드롭 */
    .sample-item {
      cursor: grab;
      transition: background-color 0.2s;
      user-select: none;
      touch-action: none; /* 모바일에서 드래그 사용 가능 */
    }
    .sample-item:active {
      cursor: grabbing;
    }
    .sample-item.sortable-ghost {
      opacity: 0.4;
      background-color: #f0ebdd !important;
    }
    .sample-item.sortable-chosen {
      background-color: #fef9c3 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .sample-drag-handle {
      cursor: grab;
      color: #9ca3af;
      padding: 0 6px;
    }
    
    /* 향미 프로필 레이더 차트 */
    .flavor-profile-chart-container {
      width: 100%;
      height: 300px;
      margin-top: 20px;
    }
    
    /* 분할 화면 비교 */
    .split-view {
      display: flex;
      flex-direction: row;
      width: 100%;
      gap: 10px;
      margin-top: 20px;
      overflow: auto;
    }
    .split-view-container {
      flex: 1;
      min-width: 200px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
      .split-view {
        flex-direction: column;
      }
    }
    
    /* 터치 최적화 - 모바일 */
    @media (max-width: 768px) {
      .flavor-checkbox-label {
        padding: 8px 14px 8px 34px; /* 더 큰 터치 영역 */
        margin: 4px;
        font-size: 14px;
      }
      .flavor-checkbox-label .checkbox-custom {
        width: 20px;
        height: 20px;
        left: 8px;
      }
      .flavor-checkbox-label input:checked + .checkbox-custom:after {
        font-size: 12px;
      }
      .mobile-touch-friendly {
        min-height: 44px; /* 최소 터치 영역 크기 */
      }
      .tab-btn-inactive, .tab-btn-active {
        padding: 8px 16px;
        margin-bottom: 8px;
      }
      input[type="radio"] + span {
        padding: 4px 0;
        margin-left: 4px;
        display: inline-block;
      }
      .score-slider {
        height: 20px; /* 슬라이더 높이 증가 */
      }
      .flavor-badge {
        padding: 4px 12px;
        margin: 3px;
      }
    }
    
    /* 고급 비교 테이블 */
    .advanced-compare-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    .advanced-compare-table th {
      background: #8B5A2B;
      color: white;
      font-weight: 600;
      text-align: left;
      padding: 10px 12px;
      font-size: 13px;
    }
    .advanced-compare-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .advanced-compare-table tr:nth-child(even) {
      background-color: #f9f7f5;
    }
    .advanced-compare-table tr:last-child td {
      border-bottom: none;
    }
    .advanced-compare-table .category-row {
      background-color: #f4eee6;
      font-weight: bold;
    }
    .advanced-compare-category {
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: bold;
      padding: 6px 8px;
      background-color: #f4eee6;
      border-radius: 4px;
    }
    
    /* 모달 스타일 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      display: none; /* 모달은 처음에 보이지 않음 */
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.show {
      display: flex; /* 모달이 보이도록 함 */
    }
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      max-width: 90%;
      max-height: 90vh;
      overflow: auto;
      width: 1200px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-body {
      padding: 1rem;
    }
    
    /* 검색 기능 추가 */
    .search-box {
      position: sticky;
      top: 0;
      background: #f8f8f8;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    /* 차트 컨테이너 높이 지정 */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* 네비게이션 버튼 스타일 */
    .nav-btn {
      padding: 6px 12px;
      background-color: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .nav-btn:hover:not(:disabled) {
      background-color: #e5e7eb;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* 언어 토글 버튼 */
    .lang-toggle {
      position: absolute;
      right: 10px;
      top: 8px;
      z-index: 5;
      display: inline-flex;
      background: #f4eee6;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lang-toggle button {
      padding: 4px 8px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
    }
    .lang-toggle button.active {
      background: #8B5A2B;
      color: white;
    }
    
    /* 향미 카테고리 탭 네비게이션 - 추가된 스타일 */
    .flavor-category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .flavor-category-tab {
      padding: 6px 12px;
      background: #f1e7db;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .flavor-category-tab:hover {
      background: #e5d9c7;
    }
    
    .flavor-category-tab.active {
      background: #8B5A2B;
      color: white;
    }
    
    /* 향미 아코디언 패널 */
    .flavor-category-wrapper {
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .flavor-category-header {
      padding: 10px 15px;
      background: #f1e7db;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .flavor-category-header h4 {
      margin: 0;
      font-weight: 600;
    }
    
    .flavor-category-content {
      padding: 15px;
      display: none;
      background: white;
    }
    
    .flavor-category-content.show {
      display: block;
    }
    
    /* 자주 사용하는 향미 섹션 */
    .frequently-used-flavors {
      background: #f9f4ea;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
    }
    
    .frequently-used-flavors h4 {
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    /* 검색 결과 강조 */
    .flavor-checkbox-label.search-highlight {
      box-shadow: 0 0 0 2px #8B5A2B;
    }
    
    /* 향미 카테고리 필터 버튼 */
    .flavor-filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .flavor-filter-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 15px;
      background-color: #f3efe8;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .flavor-filter-btn.active {
      background-color: #8B5A2B;
      color: white;
      border-color: #8B5A2B;
    }
    
    /* 향미 데이터 그리드 레이아웃 */
    .flavor-items {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    /* 향미 휠 패치 스타일 */
    .flavor-fix-hidden {
      display: none !important;
    }
    
    /* 선택된 향미 스타일 강화 */
    .flavor-checkbox-label.selected-flavor {
      box-shadow: 0 0 0 2px rgba(139, 90, 43, 0.8);
      transform: translateY(-1px);
    }
    
    /* 자동 백업 알림 */
    .backup-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(25, 135, 84, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .backup-notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="min-h-screen bg-[#fcfaf7]">
<div class="max-w-5xl mx-auto p-1 md:p-4 bg-[#fcfaf7]">
  <!-- Header -->
  <header class="flex flex-col md:flex-row items-center justify-between py-4 mb-2 border-b border-tan-300 bg-white rounded-lg shadow-sm">
    <div class="flex items-center">
      <svg width="48" height="48" viewBox="0 0 200 200" class="mr-2"><rect width="200" height="200" fill="black"/><path d="M100,40 L120,60 L110,60 L110,80 L115,90 L105,100 C105,100 120,110 130,120 C140,130 120,150 120,150 L80,150 C80,150 60,130 70,120 C80,110 95,100 95,100 L85,90 L90,80 L90,60 L80,60 Z" fill="#D2B48C"/><circle cx="95" cy="60" r="2" fill="#D2B48C"/><circle cx="105" cy="70" r="2" fill="#D2B48C"/><circle cx="115" cy="65" r="2" fill="#D2B48C"/></svg>
      <span class="text-2xl md:text-3xl font-bold text-tan-900 select-none">mollis</span>
    </div>
    <div class="mt-3 md:mt-0 text-center md:text-right">
      <h2 class="text-lg md:text-2xl font-semibold">SCA 커피 관능 평가</h2>
      <div class="text-xs text-gray-500 mt-1">PC/모바일 대응 · PDF 저장 최적</div>
    </div>
  </header>
  <!-- Sample/Data/Compare Section -->
  <section class="bg-white shadow rounded-lg p-3 md:p-6 mb-3 flex flex-col md:flex-row gap-3">
    <!-- 샘플 관리 -->
    <div class="flex-1 min-w-[260px] mb-3 md:mb-0">
      <div class="mb-3 bg-yellow-50 border border-yellow-200 rounded px-2 py-2 flex items-center text-xs text-yellow-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">샘플 관리 방법 안내:</span><br>
          - <b>샘플 추가</b>로 새로운 커피 평가를 기록/관리할 수 있습니다.<br>
          - <b>샘플 선택</b>시 해당 샘플 내용을 상세 편집/저장하며, 자동저장이 지원됩니다.<br>
          - <b>웹에 전체 저장</b> 또는 <b>웹에서 불러오기</b> 버튼을 통해 LocalStorage에 전체 평가 내역을 관리할 수 있습니다.<br>
          - <b>JSON 내보내기</b> 및 <b>불러오기</b> 기능을 통해 데이터를 파일로 보관/복원할 수 있습니다.
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-database mr-2"></i>샘플 관리/불러오기</h3>
      <div class="flex items-center gap-1 mb-2 flex-wrap">
        <button class="px-2 py-1 export-btn rounded text-xs flex items-center mobile-touch-friendly" id="addSampleBtn"><i class="fa fa-plus mr-2"></i>샘플 추가</button>
        <button class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs flex items-center mobile-touch-friendly" id="removeSampleBtn"><i class="fa fa-trash mr-2"></i>샘플 삭제</button>
        <button class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs flex items-center mobile-touch-friendly" id="cloneSampleBtn"><i class="fa fa-copy mr-2"></i>복제</button>
      </div>
      <div class="sample-list-scroll bg-gray-50 rounded-lg border p-1.5 no-scrollbar">
        <div id="sampleList" class="sample-sortable-list"></div>
        <div class="text-xs text-gray-500 mt-2 px-2">
          <i class="fas fa-arrows-alt"></i> 샘플 순서를 드래그하여 변경할 수 있습니다.
        </div>
      </div>
      <div class="flex flex-wrap gap-1 mt-2">
        <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-xs flex items-center mobile-touch-friendly" id="saveSamplesBtn"><i class="fa fa-save mr-1"></i>웹에 전체 저장</button>
        <button class="px-3 py-1 bg-blue-200 hover:bg-blue-300 text-blue-900 rounded text-xs flex items-center mobile-touch-friendly" id="loadSamplesWebBtn"><i class="fa fa-cloud-download-alt mr-1"></i>웹에서 불러오기</button>
        <button class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-xs flex items-center mobile-touch-friendly" id="exportSamplesBtn"><i class="fa fa-download mr-1"></i>JSON 내보내기</button>
        <label class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-xs flex items-center cursor-pointer mb-0 mobile-touch-friendly"><i class="fa fa-upload mr-1"></i>불러오기<input type="file" id="importSamplesInput" accept=".json" class="hidden"></label>
        <button class="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded text-xs flex items-center mobile-touch-friendly" id="backupManageBtn"><i class="fa fa-history mr-1"></i>백업 복원</button>
      </div>
    </div>
    <!-- 커핑 비교 -->
    <div class="flex-1 min-w-[260px]">
      <div class="mb-3 bg-blue-50 border border-blue-200 rounded px-2 py-2 flex items-center text-xs text-blue-800 leading-5">
        <i class="fa fa-info-circle mr-2"></i>
        <div>
          <span class="font-semibold">커핑 기록 비교 안내:</span><br>
          - <b>아래 평가 목록에서 2개 이상 선택</b> 후 <b>비교차트 표시</b>를 클릭하면 SCA 점수/향미/결점 비교차트와 표가 생성됩니다.<br>
          - 다양한 샘플을 추가한 후, 손쉽게 차트로 비교・분석이 가능합니다.<br>
          - 샘플을 새로고침하거나 불러온 후에도 비교기능 사용 가능.<br>
          <span class="text-gray-400">※ 비교 표와 차트는 PDF, 이미지 등으로 저장시 함께 출력됨.</span>
        </div>
      </div>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-code-compare mr-2"></i>커핑 기록 비교</h3>
      <div id="compareListBox" class="mb-2"></div>
      <div class="flex gap-2 flex-wrap"> 
        <button class="export-btn text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="compareBtn">
          <i class="fa fa-chart-radar mr-1"></i>기본 비교
        </button>
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="advancedCompareBtn">
          <i class="fa fa-chart-line mr-1"></i>고급 비교
        </button>
        <button class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded flex items-center mb-2 mobile-touch-friendly" id="splitViewBtn">
          <i class="fa fa-columns mr-1"></i>분할 화면
        </button>
      </div>
      <div id="compareArea"><div class="text-xs text-gray-400 my-2">2개 이상 샘플을 선택 후 비교 버튼을 눌러주세요.</div></div>
    </div>
  </section>
  
  <!-- 샘플 네비게이션 -->
  <div class="mb-3 bg-white shadow rounded-lg p-3 flex items-center justify-between">
    <button id="prevSampleBtn" class="nav-btn mobile-touch-friendly">
      <i class="fas fa-chevron-left mr-1"></i>이전
    </button>
    <div id="currentSampleIndicator" class="font-bold text-center flex-1 truncate mx-2">현재 샘플: <span class="text-amber-700"></span></div>
    <button id="nextSampleBtn" class="nav-btn mobile-touch-friendly">
      다음<i class="fas fa-chevron-right ml-1"></i>
    </button>
  </div>
  
  <!-- 평가 폼 -->
  <form id="cuppingForm" class="bg-white shadow rounded-lg p-3 md:p-6 mb-4 sample-info">
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <div class="font-bold text-lg mr-2 mb-1">현재 샘플명:</div>
      <input id="sampleTitleInput" type="text" maxlength="60" class="p-1.5 border rounded min-w-[140px] text-base font-semibold" placeholder="샘플명">
      <span id="sampleSavedState" class="ml-2 text-green-700 font-bold text-xs hidden">저장됨</span>
    </div>
    <!-- 커피 정보 -->
    <section>
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-mug-hot mr-2"></i>커피 정보</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 grid-cols-sample">
        <div>
          <label class="block text-sm font-semibold mb-1">커피명</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="coffeeName" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">원산지</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="origin" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">품종(Variety)</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="variety" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">가공방식(Process)</label>
          <input class="coffee-input w-full border border-tan-300 rounded p-2" id="process" autocomplete="off">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 날짜</label>
          <input type="date" class="coffee-input w-full border border-tan-300 rounded p-2" id="roastDate">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">로스팅 레벨</label>
          <select class="coffee-input w-full border border-tan-300 rounded p-2" id="roastLevel">
            <option value="">선택</option>
            <option value="light">Light</option>
            <option value="medium-light">Medium-Light</option>
            <option value="medium">Medium</option>
            <option value="medium-dark">Medium-Dark</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>
    </section>
    <!-- SCA 향미 선택 -->
    <section class="mt-8">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-circle-half-stroke mr-2"></i>SCA 향미 선택</h3>
      <div class="text-xs mb-3 text-gray-600">[프래그런스] [아로마] [플레이버] [에프터테이스트] 각 그룹별 향미 선택</div>
      <div class="mb-4 flex flex-wrap items-center">
        <button type="button" class="px-2 py-1 rounded bg-gray-100 text-xs mobile-touch-friendly mr-2" onclick="window.open('https://sca.coffee/research/coffee-tasters-flavor-wheel', '_blank');">
          플레이버 휠 공식자료 <i class="fas fa-external-link-alt ml-1 text-xs"></i>
        </button>
        <div class="lang-toggle">
          <button type="button" id="langEn" class="active">영어</button>
          <button type="button" id="langKo">한글</button>
        </div>
      </div>
      <div id="flavorTabs" class="flex flex-wrap gap-2 mb-2"></div>
      <div id="flavorWheelMultiSelectArea" class="flavor-section border border-gray-50 rounded-lg p-2 bg-gray-50 mb-1"></div>
    </section>
    <!-- 단계 속성 -->
    <section class="mt-8">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block mb-1 font-medium tooltip">
            Acidity <span class="text-xs text-gray-500">(산미)</span>
            <span class="tooltip-text">커피의 밝고 상쾌한 특성으로 입에서 느껴지는 신맛의 정도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="acidity_level">
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="acidityLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Sweetness <span class="text-xs text-gray-500">(단맛)</span>
            <span class="tooltip-text">커피에서 느껴지는 달콤함의 정도와 깊이</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="sweetness_level">
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="sweetnessLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
        <div>
          <label class="block mb-1 font-medium tooltip">
            Body <span class="text-xs text-gray-500">(바디감)</span>
            <span class="tooltip-text">커피의 질감과 무게감, 입안에서 느껴지는 밀도</span>
          </label>
          <div class="flex gap-2 flex-wrap" id="body_level">
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Low"><span class="ml-1">Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Medium"><span class="ml-1">Medium</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="bodyLevel" value="High"><span class="ml-1">High</span></label>
          </div>
        </div>
      </div>
    </section>
    <!-- 로스팅 디펙트 -->
    <section class="mt-10" id="section-defect">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-fire mr-2"></i>로스팅 디펙트(결점) 선택</h3>
      <div class="text-xs mb-2 text-gray-600"> 각 항목별로 결점의 정도(매우 약함, 약함, 보통, 강함, 매우 강함)를 선택하세요. <span class="text-gray-400 ml-1">* 왜곡되지 않은 평가를 위해 결점이 없으면 "미선택"으로 둡니다.</span> </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div>
          <label class="font-semibold mb-1 flex items-center"> 언더디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                로스팅을 통해 산미, 단맛, 플레이버가 불충분하게 발현.<br>
                공격적인 산미, 피니시/애프터테이스트 부족,<br>
                구개 앞쪽에서 플레이버가 느껴짐.<br>
                <span class="font-semibold">SCA 플레이버휠 'Green/Vegetative'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_underdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectUnderdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 오버디벨롭먼트
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과도한 로스팅으로 플레이버가 파괴.<br>모든 산미와 플레이버가 사라진 맛.<br>
                <span class="font-semibold">SCA 플레이버휠 'Roasted'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_overdevelopment">
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectOverdevelopment" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 베이킹(베이크드)
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                캐러멜 반응 지속시 생기는 결점.<br>팝콘, 딱딱한 시리얼, 귀리맛 등.<br>
                <span class="font-semibold">SCA 플레이버휠 '곡물류'와 관련.</span>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_baked">
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectBaked" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
        <div>
          <label class="font-semibold mb-1 flex items-center"> 스코칭
            <span class="tooltip text-xs ml-2 text-gray-500"><i class="fa fa-info-circle"></i> 
              <span class="tooltip-text">
                과하게 높은 열에 노출된 결점.<br>SCA 플레이버휠의 '재' 또는 '탄 맛' 노트.<br>
              </span>
            </span>
          </label>
          <div class="flex gap-2 flex-wrap mt-1" id="defect_scorching">
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="none"><span class="ml-1">미선택</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_weak"><span class="ml-1">매우 약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="weak"><span class="ml-1">약함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="moderate"><span class="ml-1">보통</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="strong"><span class="ml-1">강함</span></label>
            <label class="mobile-touch-friendly"><input type="radio" name="defectScorching" value="very_strong"><span class="ml-1">매우 강함</span></label>
          </div>
        </div>
      </div>
    </section>
    <!-- SCA 점수 (슬라이더별 점수입력) -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-star mr-2"></i>SCA 점수 (0~10점, 0.25단위)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 score-input-wrap">
        <div>
          <label class="block text-sm mb-1 tooltip">프래그런스<span class="tooltip-text">분쇄한 분말 시 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFragrance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFragrance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">아로마<span class="tooltip-text">물 부은 후 느껴지는 향</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAroma_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAroma" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">플레이버<span class="tooltip-text">혀로 느껴지는 커피의 전반적 맛 특성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreFlavor_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreFlavor" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">에프터테이스트<span class="tooltip-text">삼킨 후 입안에 남는 좋은 맛의 지속성</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAftertaste_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAftertaste" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">액시디티<span class="tooltip-text">밝은 산미, 긍정적이면 높게</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreAcidity_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreAcidity" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">바디<span class="tooltip-text">입안에서 느껴지는 무게감, 질감</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBody_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBody" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">밸런스<span class="tooltip-text">각 항목의 조화</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreBalance_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreBalance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
        <div>
          <label class="block text-sm mb-1 tooltip">오버럴<span class="tooltip-text">총평, 인상</span></label>
          <input type="range" min="0" max="10" step="0.25" value="7" id="scoreOverall_slider" class="score-slider mb-1">
          <input type="number" step="0.25" min="0" max="10" id="scoreOverall" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-end gap-3">
        <div>
          <label class="text-sm block mb-1">총점 (기본 30점+합계)</label>
          <span id="totalScore" class="font-bold inline-block text-lg bg-gray-100 px-4 py-2 rounded border">86.00</span>
        </div>
        <button type="button" id="calcScoreBtn" class="ml-1 mt-2 px-4 py-2 rounded export-btn flex items-center mobile-touch-friendly"><i class="fas fa-equals mr-2"></i>점수 계산</button>
      </div>
    </section>
    <!-- 테이스팅 노트 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-1 border-b pb-1 border-tan-200 flex items-center"><i class="fas fa-pen-nib mr-2"></i>테이스팅 노트/비고</h3>
      <textarea id="tastingNotes" class="coffee-input w-full min-h-[80px] p-2 border rounded" placeholder="특이사항, 시간, 온도, 커핑 총평 등 메모"></textarea>
    </section>
    <!-- 결과 시각화 및 내보내기 -->
    <section class="mt-10">
      <h3 class="text-base font-bold mb-2 border-b pb-1 border-tan-200 flex items-center"><i class="fa fa-chart-radar mr-2"></i>결과 시각화 및 내보내기</h3>
      <div class="visual-section-flex w-full mt-2">
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0 mb-2">
          <h4 class="font-semibold mb-2">향미 특성/속성</h4>
          <div id="selectedFlavorsArea"></div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-md flex-1 min-w-0">
          <h4 class="font-semibold mb-2">SCA 평가 레이더 차트</h4>
          <canvas id="cuppingRadar" class="w-full max-w-full" height="200"></canvas>
        </div>
      </div>
      <div id="selectedDefectsArea" class="w-full mt-6"></div>
      <div class="flex flex-wrap mt-6 gap-2">
        <button id="exportImgBtn" type="button" class="export-btn px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-image mr-2"></i>이미지로 내보내기</button>
        <button id="exportCsvBtn" type="button" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-file-csv mr-2"></i>CSV로 내보내기</button>
        <button id="exportXlsxBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded flex items-center mobile-touch-friendly"><i class="fas fa-file-excel mr-2"></i>엑셀로 내보내기</button>
      </div>
      <div class="text-xs text-gray-400 mt-8 md:mt-12 text-center"> 평가일: <span id="evalDate"></span> | mollis SCA 커피 관능 평가</div>
    </section>
  </form>
</div>

<!-- 분할 화면 비교 모달 -->
<div id="splitViewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="font-bold text-lg">분할 화면 비교</h3>
      <button id="closeSplitViewBtn" class="text-gray-500 hover:text-gray-700 mobile-touch-friendly">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="flex gap-2 mb-4 flex-wrap">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">왼쪽 샘플</label>
          <select id="leftSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium mb-1">오른쪽 샘플</label>
          <select id="rightSampleSelect" class="w-full border rounded p-2 mobile-touch-friendly"></select>
        </div>
      </div>
      <div class="split-view" id="splitViewContainer">
        <div class="split-view-container" id="leftSampleView">
          <div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>
        </div>
        <div class="split-view-container" id="rightSampleView">
          <div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="sampleToast" class="sample-toast"></div>

<script>
/* --- 원본 데이터 및 각종 전역변수 --- */
// 향미 데이터 확장 및 조정 - 세분화된 항목 및 한글 추가
const FLAVOR_DATA = [
  // Fruity - Citrus Fruit
  ["Fruity","Citrus Fruit","Lemon","#FFEB88","과일류","감귤류","레몬"],
  ["Fruity","Citrus Fruit","Orange","#FFC300","과일류","감귤류","오렌지"],
  ["Fruity","Citrus Fruit","Grapefruit","#FF9970","과일류","감귤류","자몽"],
  ["Fruity","Citrus Fruit","Lime","#C0E57B","과일류","감귤류","라임"],  ["Fruity","Citrus Fruit","Tangerine","#FFA54F","과일류","감귤류","귤"],
  ["Fruity","Citrus Fruit","Bergamot","#F9D949","과일류","감귤류","베르가못"],
  ["Fruity","Citrus Fruit","Yuzu","#EFDF48","과일류","감귤류","유자"],
  ["Fruity","Citrus Fruit","Kumquat","#FFA07A","과일류","감귤류","금귤"],
  ["Fruity","Citrus Fruit","Citron","#F0E68C","과일류","감귤류","시트론"],
  ["Fruity","Citrus Fruit","Blood Orange","#FF4500","과일류","감귤류","블러드 오렌지"],
  ["Fruity","Citrus Fruit","Mandarin","#FFAE42","과일류","감귤류","만다린"],
  ["Fruity","Citrus Fruit","Pomelo","#FDDA0D","과일류","감귤류","폼멜로"],
  ["Fruity","Citrus Fruit","Key Lime","#B6E2A1","과일류","감귤류","키라임"],
  
  // Fruity - Other Fruit
  ["Fruity","Other Fruit","Apple","#C4E8A2","과일류","기타 과일류","사과"],
  ["Fruity","Other Fruit","Pear","#D6ECC2","과일류","기타 과일류","배"],
  ["Fruity","Other Fruit","Grape","#A288E3","과일류","기타 과일류","포도"],
  ["Fruity","Other Fruit","Kiwi","#8FBC8F","과일류","기타 과일류","키위"],
  ["Fruity","Other Fruit","Watermelon","#E8B4B8","과일류","기타 과일류","수박"],
  ["Fruity","Other Fruit","Melon","#D1E9B0","과일류","기타 과일류","멜론"],
  ["Fruity","Other Fruit","Persimmon","#FF8C00","과일류","기타 과일류","감"],
  ["Fruity","Other Fruit","Pomegranate","#C71585","과일류","기타 과일류","석류"],
  ["Fruity","Other Fruit","Honeydew","#CCEBC5","과일류","기타 과일류","허니듀 멜론"],
  ["Fruity","Other Fruit","Asian Pear","#E8DACC","과일류","기타 과일류","배(동양배)"],
  ["Fruity","Other Fruit","Quince","#E3B14E","과일류","기타 과일류","마르멜로"],
  ["Fruity","Other Fruit","Cantaloupe","#FDAC53","과일류","기타 과일류","캔털롭 멜론"],
  
  // Fruity - Berry
  ["Fruity","Berry","Raspberry","#FF8BA0","과일류","베리류","라즈베리"],
  ["Fruity","Berry","Strawberry","#FF97A1","과일류","베리류","딸기"],
  ["Fruity","Berry","Blackberry","#D7263D","과일류","베리류","블랙베리"],
  ["Fruity","Berry","Blueberry","#7099DA","과일류","베리류","블루베리"],  
  ["Fruity","Berry","Cranberry","#E30B5C","과일류","베리류","크랜베리"],
  ["Fruity","Berry","Acai","#71466F","과일류","베리류","아사이베리"],
  ["Fruity","Berry","Goji Berry","#B22222","과일류","베리류","구기자"],
  ["Fruity","Berry","Elderberry","#654321","과일류","베리류","엘더베리"],
  ["Fruity","Berry","Boysenberry","#873260","과일류","베리류","보이젠베리"],
  ["Fruity","Berry","Currant","#B31B1B","과일류","베리류","커런트"],
  ["Fruity","Berry","Loganberry","#7A2945","과일류","베리류","로건베리"],
  ["Fruity","Berry","Mulberry","#843B62","과일류","베리류","오디"],
  ["Fruity","Berry","Sea Buckthorn","#F5822B","과일류","베리류","비타민나무 열매"],
  ["Fruity","Berry","Cloudberry","#FFB347","과일류","베리류","클라우드베리"],
  
  // Fruity - Stone Fruit
  ["Fruity","Stone Fruit","Peach","#FFCBA4","과일류","핵과류","복숭아"],
  ["Fruity","Stone Fruit","Apricot","#FBCEB1","과일류","핵과류","살구"],
  ["Fruity","Stone Fruit","Cherry","#DE3163","과일류","핵과류","체리"],  
  ["Fruity","Stone Fruit","Plum","#B27AA4","과일류","핵과류","자두"],
  ["Fruity","Stone Fruit","Nectarine","#FFB8A0","과일류","핵과류","넥타린"],
  ["Fruity","Stone Fruit","Loquat","#F6AD49","과일류","핵과류","비파"],
  ["Fruity","Stone Fruit","Black Cherry","#4E0F0F","과일류","핵과류","블랙체리"],
  ["Fruity","Stone Fruit","Damson Plum","#6F2DA8","과일류","핵과류","담슨 자두"],
  
  // Fruity - Tropical Fruit  
  ["Fruity","Tropical Fruit","Pineapple","#FEDF00","과일류","열대과일","파인애플"],
  ["Fruity","Tropical Fruit","Coconut","#F2E8D7","과일류","열대과일","코코넛"],
  ["Fruity","Tropical Fruit","Passion Fruit","#DDA0DD","과일류","열대과일","패션프룻"],
  ["Fruity","Tropical Fruit","Guava","#F88379","과일류","열대과일","구아바"],
  ["Fruity","Tropical Fruit","Banana","#FFEB99","과일류","열대과일","바나나"],
  ["Fruity","Tropical Fruit","Lychee","#FFE4E1","과일류","열대과일","리치"],
  ["Fruity","Tropical Fruit","Star Fruit","#FADA5E","과일류","열대과일","스타프룻"],
  ["Fruity","Tropical Fruit","Papaya","#FFDAB9","과일류","열대과일","파파야"],
  ["Fruity","Tropical Fruit","Dragon Fruit","#FFC0CB","과일류","열대과일","용과"],
  ["Fruity","Tropical Fruit","Jackfruit","#FFEFD5","과일류","열대과일","잭프룻"],
  ["Fruity","Tropical Fruit","Kiwano","#C3D825","과일류","열대과일","키와노"],
  ["Fruity","Tropical Fruit","Durian","#CDB380","과일류","열대과일","두리안"],
  ["Fruity","Tropical Fruit","Longan","#D2B48C","과일류","열대과일","용안"],
  ["Fruity","Tropical Fruit","Mangosteen","#5D1F1E","과일류","열대과일","망고스틴"],
  ["Fruity","Tropical Fruit","Rambutan","#EC2D01","과일류","열대과일","람부탄"],
  ["Fruity","Tropical Fruit","Soursop","#C3E88D","과일류","열대과일","사워삽"],
  ["Fruity","Tropical Fruit","Breadfruit","#E8D499","과일류","열대과일","브레드프룻"],
  ["Fruity","Tropical Fruit","Mango","#FDBE34","과일류","열대과일","망고"],
  
  // Fruity - Dried Fruit
  ["Fruity","Dried Fruit","Raisin","#BB9055","과일류","건조과일","건포도"],
  ["Fruity","Dried Fruit","Prune","#925E3A","과일류","건조과일","자두말린것"],
  ["Fruity","Dried Fruit","Fig","#8A4117","과일류","건조과일","무화과"],
  ["Fruity","Dried Fruit","Date","#A57164","과일류","건조과일","대추야자"],
  ["Fruity","Dried Fruit","Dried Apple","#D5BA98","과일류","건조과일","말린사과"],
  ["Fruity","Dried Fruit","Dried Cherry","#A85751","과일류","건조과일","말린체리"],
  ["Fruity","Dried Fruit","Dried Apricot","#E9967A","과일류","건조과일","말린살구"],
  ["Fruity","Dried Fruit","Dried Mango","#FFD700","과일류","건조과일","말린망고"],
  ["Fruity","Dried Fruit","Dried Cranberry","#C41E3A","과일류","건조과일","말린크랜베리"],
  ["Fruity","Dried Fruit","Dried Blueberry","#4682B4","과일류","건조과일","말린블루베리"],
  ["Fruity","Dried Fruit","Dried Banana","#F3E5AB","과일류","건조과일","바나나칩"],
  ["Fruity","Dried Fruit","Dried Pineapple","#FFCC33","과일류","건조과일","말린파인애플"],
  
  // Sweet
  ["Sweet","","Brown Sugar","#B38B57","단맛","","흑설탕"],
  ["Sweet","","Caramel","#FFB15E","단맛","","캐러멜"],
  ["Sweet","","Honey","#FDE994","단맛","","꿀"],
  ["Sweet","","Vanilla","#F0D7BC","단맛","","바닐라"],
  ["Sweet","Caramelized","Toffee","#D2691E","단맛","카라멜화","토피"],
  ["Sweet","Caramelized","Butterscotch","#E09540","단맛","카라멜화","버터스카치"],
  ["Sweet","Vanilla","Custard","#F0E68C","단맛","바닐라","커스터드"],
  ["Sweet","Vanilla","Cream","#FFFDD0","단맛","바닐라","크림"],
  ["Sweet","","Maple Syrup","#C97C5D","단맛","","메이플시럽"],
  ["Sweet","","Molasses","#774936","단맛","","당밀"],
  ["Sweet","","Palm Sugar","#C19A6B","단맛","","야자설탕"],
  ["Sweet","","Condensed Milk","#FFF8DC","단맛","","연유"],
  ["Sweet","","Raw Sugar","#DFC5A4","단맛","","원당"],
  ["Sweet","","Rock Sugar","#E8E6D9","단맛","","돌설탕"],
  ["Sweet","","Muscovado","#5C4033","단맛","","무스코바도"],
  ["Sweet","","Black Treacle","#2C1901","단맛","","블랙트리클"],
  ["Sweet","","Golden Syrup","#F5BD1F","단맛","","골든시럽"],
  ["Sweet","","White Chocolate","#FFFFF0","단맛","","화이트초콜릿"],
  
  // Floral
  ["Floral","","Jasmine","#DEC2CB","꽃향","","자스민"],
  ["Floral","","Rose","#FD5D8B","꽃향","","장미"],
  ["Floral","","Chamomile","#F5E5C0","꽃향","","카모마일"],
  ["Floral","","Hibiscus","#F53E6A","꽃향","","히비스커스"],
  ["Floral","","Lavender","#B57EDC","꽃향","","라벤더"],
  ["Floral","","Orange Blossom","#FFCC99","꽃향","","오렌지꽃"],
  ["Floral","","Elderflower","#F0FFF0","꽃향","","엘더플라워"],
  ["Floral","","Honeysuckle","#FFF0DB","꽃향","","인동덩굴"],
  ["Floral","","Violet","#C9A0DC","꽃향","","제비꽃"],
  ["Floral","","Cherry Blossom","#FFB7C5","꽃향","","벚꽃"],
  ["Floral","","Magnolia","#F8F4FF","꽃향","","목련"],
  ["Floral","","Lily","#FFFFFF","꽃향","","백합"],
  ["Floral","","Orchid","#DA70D6","꽃향","","난꽃"],
  ["Floral","","Geranium","#FF577F","꽃향","","제라늄"],
  ["Floral","","Freesia","#FFBF00","꽃향","","프리지아"],
  ["Floral","","Osmanthus","#FFDB58","꽃향","","계수나무"],
  ["Floral","","Peony","#FAAFBE","꽃향","","모란"],
  ["Floral","","Lotus","#E8F1D4","꽃향","","연꽃"],
  ["Floral","","Gardenia","#F1FFF7","꽃향","","치자꽃"],
  ["Floral","","Lilac","#C8A2C8","꽃향","","라일락"],
  ["Floral","","Iris","#5A4FCF","꽃향","","아이리스"],
  ["Floral","","Wisteria","#C9A0DC","꽃향","","등나무꽃"],
  
  // Nutty/Cocoa
  ["Nutty/Cocoa","Nutty","Hazelnut","#D7C2A8","견과/코코아","견과류","헤이즐넛"],
  ["Nutty/Cocoa","Nutty","Almond","#DBD3C9","견과/코코아","견과류","아몬드"],
  ["Nutty/Cocoa","Nutty","Peanut","#D28C78","견과/코코아","견과류","땅콩"],
  ["Nutty/Cocoa","Nutty","Walnut","#C19A6B","견과/코코아","견과류","호두"],
  ["Nutty/Cocoa","Nutty","Cashew","#F5DEB3","견과/코코아","견과류","캐슈넛"],
  ["Nutty/Cocoa","Cocoa","Dark Chocolate","#6C4F3D","견과/코코아","코코아","다크초콜릿"],
  ["Nutty/Cocoa","Cocoa","Cocoa","#926F34","견과/코코아","코코아","코코아"],
  ["Nutty/Cocoa","Cocoa","Milk Chocolate","#7B3F00","견과/코코아","코코아","밀크초콜릿"],
  ["Nutty/Cocoa","Cocoa","Bittersweet Chocolate","#332421","견과/코코아","코코아","쌉싸름한 초콜릿"],
  ["Nutty/Cocoa","Cocoa","Mocha","#785135","견과/코코아","코코아","모카"],
  ["Nutty/Cocoa","Nutty","Pistachio","#93C572","견과/코코아","견과류","피스타치오"],
  ["Nutty/Cocoa","Nutty","Macadamia","#F5F5DC","견과/코코아","견과류","마카다미아"],
  ["Nutty/Cocoa","Cocoa","Cacao Nibs","#654321","견과/코코아","코코아","카카오닙스"],
  ["Nutty/Cocoa","Nutty","Brazilian Nut","#8D6E63","견과/코코아","견과류","브라질너트"],
  ["Nutty/Cocoa","Nutty","Pecan","#7E675E","견과/코코아","견과류","피칸"],
  ["Nutty/Cocoa","Cocoa","White Chocolate","#F5F5F5","견과/코코아","코코아","화이트 초콜릿"],
  ["Nutty/Cocoa","Nutty","Chestnut","#954535","견과/코코아","견과류","밤"],
  ["Nutty/Cocoa","Nutty","Pine Nut","#D6C9A0","견과/코코아","견과류","잣"],
  ["Nutty/Cocoa","Nutty","Coconut","#F2EFE9","견과/코코아","견과류","코코넛"],
  ["Nutty/Cocoa","Cocoa","Cocoa Butter","#FEF5CA","견과/코코아","코코아","코코아 버터"],
  ["Nutty/Cocoa","Cocoa","Chocolate Liquor","#3D1E0F","견과/코코아","코코아","초콜릿 리쿼"],
  
  // Spices
  ["Spices","","Cinnamon","#E5B39B","향신료","","시나몬"],
  ["Spices","","Clove","#C17855","향신료","","정향"],
  ["Spices","","Pepper","#818286","향신료","","후추"],
  ["Spices","","Nutmeg","#BD9C7F","향신료","","육두구"],
  ["Spices","Warming Spices","Cardamom","#BDA55D","향신료","따뜻한 향신료","카다몬"],
  ["Spices","Warming Spices","Allspice","#9C5903","향신료","따뜻한 향신료","올스파이스"],
  ["Spices","Pungent Spices","Licorice","#2A2926","향신료","강한 향신료","감초"],
  ["Spices","Pungent Spices","Anise","#50404D","향신료","강한 향신료","아니스"],
  ["Spices","","Ginger","#EFCC9C","향신료","","생강"],
  ["Spices","","Vanilla Bean","#F3E5AB","향신료","","바닐라빈"],
  ["Spices","","Star Anise","#483C32","향신료","","팔각"],
  ["Spices","","Cumin","#8B4513","향신료","","쿠민"],
  ["Spices","","Coriander","#AEC6A5","향신료","","고수"],
  ["Spices","","Turmeric","#FFC300","향신료","","강황"],
  ["Spices","","Saffron","#F4C430","향신료","","사프란"],
  ["Spices","","Black Pepper","#393939","향신료","","흑후추"],
  ["Spices","","Coriander Seed","#C9A66B","향신료","","코리앤더 씨앗"],
  ["Spices","","Tarragon","#A3B86C","향신료","","타라곤"],
  ["Spices","","Bay Leaf","#87A96B","향신료","","월계수잎"],
  ["Spices","","Fennel","#C1E1C1","향신료","","회향"],
  ["Spices","","Juniper Berries","#6D80AB","향신료","","주니퍼베리"],
  ["Spices","","Cayenne","#CC333F","향신료","","카이엔 페퍼"],
  ["Spices","","Mace","#C19A6B","향신료","","메이스"],
  ["Spices","","Fenugreek","#C19A6B","향신료","","페뉴그릭"],
  
  // Tea
  ["Tea","Black Tea","Earl Grey","#3A2E39","차","홍차","얼그레이"],
  ["Tea","Black Tea","English Breakfast","#654321","차","홍차","잉글리시 브렉퍼스트"],
  ["Tea","Black Tea","Darjeeling","#856D4D","차","홍차","다즐링"],
  ["Tea","Green Tea","Matcha","#D0F0C0","차","녹차","말차"],
  ["Tea","Green Tea","Sencha","#90EE90","차","녹차","센차"],
  ["Tea","Herbal Tea","Chamomile","#FADA5E","차","허브차","카모마일"],
  ["Tea","Herbal Tea","Peppermint","#98FB98","차","허브차","페퍼민트"],
  ["Tea","Herbal Tea","Rooibos","#D2691E","차","허브차","루이보스"],
  ["Tea","Oolong","Oolong","#A0522D","차","우롱차","우롱"],
  ["Tea","White Tea","Silver Needle","#E6E8FA","차","백차","은침차"],
  ["Tea","Black Tea","Assam","#4E362F","차","홍차","아삼"],
  ["Tea","Black Tea","Ceylon","#5F4842","차","홍차","실론"],
  ["Tea","Green Tea","Gyokuro","#799E65","차","녹차","교쿠로"],
  ["Tea","Herbal Tea","Hibiscus Tea","#CA3433","차","허브차","히비스커스차"],
  ["Tea","Herbal Tea","Lemongrass","#9DC183","차","허브차","레몬그라스"],
  ["Tea","Black Tea","Keemun","#6B4226","차","홍차","기문"],
  ["Tea","Green Tea","Longjing","#C7E4C0","차","녹차","룽징"],
  ["Tea","Herbal Tea","Chrysanthemum","#FFD700","차","허브차","국화차"],
  ["Tea","Herbal Tea","Mint Tea","#98FB98","차","허브차","민트차"],
  ["Tea","Puer","Aged Puer","#70593E","차","푸얼차","숙성 보이차"],
  ["Tea","Puer","Raw Puer","#B5AA89","차","푸얼차","생 보이차"],
  
  // Cereal/Grain
  ["Cereal/Grain","Cereal","Malt","#F0E68C","곡물류","시리얼","맥아"],
  ["Cereal/Grain","Cereal","Toast","#D2B48C","곡물류","시리얼","토스트"],
  ["Cereal/Grain","Cereal","Barley","#DBD0AE","곡물류","시리얼","보리"],
  ["Cereal/Grain","Grain-like","Granola","#C8A951","곡물류","곡물류","그래놀라"],
  ["Cereal/Grain","Grain-like","Oats","#E4CBB1","곡물류","곡물류","귀리"],
  ["Cereal/Grain","Grain-like","Rice","#F9FBE7","곡물류","곡물류","쌀"],
  ["Cereal/Grain","Grain-like","Wheat","#EAD9A7","곡물류","곡물류","밀"],
  ["Cereal/Grain","Grain-like","Corn","#FFF380","곡물류","곡물류","옥수수"],
  ["Cereal/Grain","Grain-like","Rye","#8B7355","곡물류","곡물류","호밀"],
  ["Cereal/Grain","Grain-like","Buckwheat","#C19A6B","곡물류","곡물류","메밀"],
  ["Cereal/Grain","Cereal","Biscuit","#E2DFD2","곡물류","시리얼","비스킷"],
  ["Cereal/Grain","Cereal","Cheerios","#E8C99B","곡물류","시리얼","시리오스"],
  ["Cereal/Grain","Cereal","Cornflakes","#FFBF00","곡물류","시리얼","콘플레이크"],
  ["Cereal/Grain","Grain-like","Quinoa","#DEC19E","곡물류","곡물류","퀴노아"],
  ["Cereal/Grain","Grain-like","Millet","#E9E4A7","곡물류","곡물류","기장"],
  ["Cereal/Grain","Cereal","Graham Cracker","#C9AD86","곡물류","시리얼","그레이엄 크래커"],
  ["Cereal/Grain","Cereal","Sourdough","#E1D7C6","곡물류","시리얼","사워도우"],
  ["Cereal/Grain","Cereal","Brioche","#EED7A1","곡물류","시리얼","브리오슈"],
  
  // Roasted
  ["Roasted","","Brown Roast","#5C4033","로스팅","","갈색 로스팅"],
  ["Roasted","","Smoky","#463F3A","로스팅","","훈연향"],
  ["Roasted","Light Roast","Tea-like","#967969","로스팅","라이트 로스트","차와 유사한"],
  ["Roasted","Light Roast","Herbal","#BDCB96","로스팅","라이트 로스트","허브향"],
  ["Roasted","Medium Roast","Toasty","#C19A6B","로스팅","미디엄 로스트","토스티"],
  ["Roasted","Medium Roast","Caramelized","#C68E17","로스팅","미디엄 로스트","캐러멜화"],
  ["Roasted","Dark Roast","Burnt","#373536","로스팅","다크 로스트","탄 맛"],
  ["Roasted","Dark Roast","Charred","#2C1608","로스팅","다크 로스트","숯불향"],
  ["Roasted","Dark Roast","Ashy","#5D5D5D","로스팅","다크 로스트","재 맛"],
  ["Roasted","Medium Roast","Nutty","#D2B48C","로스팅","미디엄 로스트","견과류"],
  ["Roasted","Dark Roast","Tobacco","#715F3F","로스팅","다크 로스트","담배향"],
  ["Roasted","Dark Roast","Dark Chocolate","#3D2314","로스팅","다크 로스트","다크 초콜릿"],
  ["Roasted","Dark Roast","French Roast","#23180D","로스팅","다크 로스트","프렌치 로스트"],
  ["Roasted","Medium Roast","Full City","#654321","로스팅","미디엄 로스트","풀 시티"],
  ["Roasted","Light Roast","Cinnamon Roast","#AD8150","로스팅","라이트 로스트","시나몬 로스트"],
  ["Roasted","Medium Roast","Vienna Roast","#4E3524","로스팅","미디엄 로스트","비엔나 로스트"],
  ["Roasted","Dark Roast","Italian Roast","#281811","로스팅","다크 로스트","이탈리안 로스트"],
  
  // Green/Vegetative
  ["Green/Vegetative","","Under-ripe","#A4C09C","풀/채소류","","덜 익은 맛"],
  ["Green/Vegetative","","Peapod","#B2DAC0","풀/채소류","","완두콩 꼬투리"],
  ["Green/Vegetative","","Fresh","#C2E99E","풀/채소류","","신선한"],
  ["Green/Vegetative","Fresh Green","Grass","#7EC850","풀/채소류","신선한 풀","풀"],
  ["Green/Vegetative","Fresh Green","Cucumber","#8FBC8F","풀/채소류","신선한 풀","오이"],
  ["Green/Vegetative","Fresh Green","Green Bell Pepper","#4F7942","풀/채소류","신선한 풀","피망"],  ["Green/Vegetative","Herbaceous","Mint","#98FB98","풀/채소류","허브류","민트"],
  ["Green/Vegetative","Herbaceous","Sage","#BCB88A","풀/채소류","허브류","세이지"],
  ["Green/Vegetative","Herbaceous","Basil","#579229","풀/채소류","허브류","바질"],
  ["Green/Vegetative","Vegetal","Olive","#708238","풀/채소류","채소류","올리브"],
  ["Green/Vegetative","Vegetal","Spinach","#175732","풀/채소류","채소류","시금치"],
  ["Green/Vegetative","Herbaceous","Rosemary","#77815C","풀/채소류","허브류","로즈마리"],
  ["Green/Vegetative","Herbaceous","Thyme","#4E5144","풀/채소류","허브류","타임"],  
  ["Green/Vegetative","Vegetal","Artichoke","#8F9779","풀/채소류","채소류","아티초크"],
  ["Green/Vegetative","Fresh Green","Green Apple","#8DB600","풀/채소류","신선한 풀","청사과"],
  ["Green/Vegetative","Vegetal","Celery","#C1FD95","풀/채소류","채소류","셀러리"],
  ["Green/Vegetative","Vegetal","Brussels Sprout","#7C9C53","풀/채소류","채소류","방울양배추"],
  ["Green/Vegetative","Herbaceous","Dill","#718F58","풀/채소류","허브류","딜"],
  ["Green/Vegetative","Vegetal","Kale","#5F7F50","풀/채소류","채소류","케일"],
  ["Green/Vegetative","Vegetal","Wheatgrass","#98FB98","풀/채소류","채소류","밀싹"],
  ["Green/Vegetative","Herbaceous","Cilantro","#BDFFA8","풀/채소류","허브류","실란트로"],
  ["Green/Vegetative","Fresh Green","Green Beans","#7BAA1D","풀/채소류","신선한 풀","껍질콩"],
  
  // Sour/Fermented
  ["Sour/Fermented","Sour","Citric Acid","#CEE6CB","산미/발효","산미","시트르산"],
  ["Sour/Fermented","Sour","Malic Acid","#C9E265","산미/발효","산미","말산"],
  ["Sour/Fermented","Sour","Acetic Acid","#D9C1B4","산미/발효","산미","아세트산"],  
  ["Sour/Fermented","Clean Acidity","Tartaric Acid","#D7E8CB","산미/발효","깨끗한 산미","타르타르산"],
  ["Sour/Fermented","Clean Acidity","Phosphoric Acid","#E8F3D9","산미/발효","깨끗한 산미","인산"],
  ["Sour/Fermented","Fermented","Winey","#AC436E","산미/발효","발효","와인 맛"],
  ["Sour/Fermented","Fermented","Overripe","#625958","산미/발효","발효","과숙한"],
  ["Sour/Fermented","Fermented","Yogurt","#F5F5F5","산미/발효","발효","요거트"],
  ["Sour/Fermented","Fermented","Sourdough","#E8D0A7","산미/발효","발효","사워도우"],
  ["Sour/Fermented","Fermented","Vinegar","#ECEDE6","산미/발효","발효","식초"],
  ["Sour/Fermented","Fermented","Kombucha","#DEC19B","산미/발효","발효","콤부차"],
  ["Sour/Fermented","Aged/Funky","Musty","#8B7D6B","산미/발효","숙성/펑키","곰팡이 냄새"],  
  ["Sour/Fermented","Aged/Funky","Earthy","#79553D","산미/발효","숙성/펑키","흙냄새"],
  ["Sour/Fermented","Fermented","Kimchi","#E80000","산미/발효","발효","김치"],
  ["Sour/Fermented","Fermented","Kefir","#F0EAD6","산미/발효","발효","케피어"],
  ["Sour/Fermented","Fermented","Sake","#EDEADE","산미/발효","발효","사케"],
  ["Sour/Fermented","Fermented","Sauerkraut","#E8E4C9","산미/발효","발효","사우어크라우트"],
  ["Sour/Fermented","Fermented","Miso","#E9CEAA","산미/발효","발효","미소"],
  ["Sour/Fermented","Fermented","Beer","#F5DEB3","산미/발효","발효","맥주"],
  ["Sour/Fermented","Fermented","Champagne","#F7E7CE","산미/발효","발효","샴페인"],
  ["Sour/Fermented","Clean Acidity","Lactic Acid","#F5F5F5","산미/발효","깨끗한 산미","젖산"],
  ["Sour/Fermented","Aged/Funky","Blue Cheese","#7CB9E8","산미/발효","숙성/펑키","블루치즈"],
  ["Sour/Fermented","Aged/Funky","Mildew","#7D7D65","산미/발효","숙성/펑키","곰팡이"],
  
  // Other
  ["Other","","Chemical","#FCF6B1","기타","","화학적"],
  ["Other","","Medicinal","#E2D784","기타","","약품향"],
  ["Other","Chemical","Rubber","#454545","기타","화학적","고무"],
  ["Other","Chemical","Petroleum","#2E2E2E","기타","화학적","석유"],
  ["Other","Chemical","Plastic","#BEBEBE","기타","화학적","플라스틱"],
  ["Other","Chemical","Tar","#1C1C1C","기타","화학적","타르"],
  ["Other","Earthy","Soil","#6F4E37","기타","흙내음","흙"],
  ["Other","Earthy","Mushroom","#D7CEC7","기타","흙내음","버섯"],
  ["Other","Earthy","Forest Floor","#5E4B3B","기타","흙내음","숲바닥"],
  ["Other","Earthy","Wet Earth","#622F22","기타","흙내음","젖은 흙"],
  ["Other","Woody","Oak","#A46B2B","기타","나무향","오크"],
  ["Other","Woody","Cedar","#A67B5B","기타","나무향","삼나무"],
  ["Other","Woody","Pine","#8A9A5B","기타","나무향","소나무"],
  ["Other","Woody","Sandalwood","#B87333","기타","나무향","백단향"],
  ["Other","Woody","Maple","#C04000","기타","나무향","단풍나무"],
  ["Other","Animal","Leather","#8B4513","기타","동물향","가죽"],
  ["Other","Woody","Bamboo","#78866B","기타","나무향","대나무"],
  ["Other","Animal","Musk","#4E4B51","기타","동물향","사향"],
  ["Other","Animal","Honey Comb","#ECB176","기타","동물향","벌집"],
  ["Other","Woody","Cypress","#2F4F4F","기타","나무향","사이프러스"],
  ["Other","Woody","Eucalyptus","#44C173","기타","나무향","유칼립투스"],
  ["Other","Earthy","Moss","#617744","기타","흙내음","이끼"],
  ["Other","Earthy","Truffle","#523A28","기타","흙내음","트러플"],
  ["Other","Woody","Teak","#9A7B4F","기타","나무향","티크"],
  ["Other","Woody","Mahogany","#7C1C05","기타","나무향","마호가니"]
];

const FLAVOR_PHASES=[{id:"fragrance",label:"프래그런스"},{id:"aroma",label:"아로마"},{id:"flavor",label:"플레이버"},{id:"aftertaste",label:"에프터테이스트"}];
const ATTR_TO_BADGE={acidityLevel:{label:"산미",color:"#FF6B6B"},sweetnessLevel:{label:"단맛",color:"#51CF66"},bodyLevel:{label:"바디감",color:"#339AF0"}};
const ATTR_VALUE_LABELS={"Low":"낮음","Med-Low":"낮음-중간","Medium":"중간","Med-High":"중간-높음","High":"높음"};
const DEFECT_LABELS={none:{label:"미선택",color:"#bbb" },very_weak:{label:"매우 약함",color:"#9ad0c2"},weak:{label:"약함",color:"#95a7f2"},moderate:{label:"보통",color:"#f6c177"},strong:{label:"강함",color:"#f59f4c"},very_strong:{label:"매우 강함",color:"#fc4747"} };
const DEFECT_PROPS=[{key:"defectUnderdevelopment",label:"언더디벨롭먼트",desc:"로스팅 불충분, 강한 산미, 피니시/애프터 부족",wheel:"Green/Vegetative"},{key:"defectOverdevelopment",label:"오버디벨롭먼트",desc:"과도한 로스팅으로 산미, 플레이버 소멸",wheel:"Roasted"},{key:"defectBaked",label:"베이킹(베이크드)",desc:"팝콘/귀리/시리얼류 결점, 캐러멜화 과잉",wheel:"곡물(Cereal/Grain)"},{key:"defectScorching",label:"스코칭",desc:"탄맛, 과다열 노출, 재/탄 노트",wheel:"Roasted"}];

// 향미 카테고리별 그룹핑
const FLAVOR_CATEGORIES = [
  { name: "과일류", categories: ["Fruity"], color: "#FFB8A0" },
  { name: "달콤함", categories: ["Sweet"], color: "#FDE994" },
  { name: "꽃향", categories: ["Floral"], color: "#F5E5C0" },
  { name: "견과/초콜릿", categories: ["Nutty/Cocoa"], color: "#D7C2A8" },
  { name: "향신료", categories: ["Spices"], color: "#BDA55D" },
  { name: "차", categories: ["Tea"], color: "#8B4513" },
  { name: "곡물/시리얼", categories: ["Cereal/Grain"], color: "#E4CBB1" },
  { name: "로스팅", categories: ["Roasted"], color: "#967969" },
  { name: "풀/채소류", categories: ["Green/Vegetative"], color: "#A4C09C" },
  { name: "산미/발효", categories: ["Sour/Fermented"], color: "#CEE6CB" },
  { name: "기타", categories: ["Other"], color: "#D7CEC7" }
];

// 자주 사용하는 향미 리스트 추가
const FREQUENT_FLAVORS = [
  "Fruity|Citrus Fruit|Lemon",
  "Fruity|Berry|Blueberry", 
  "Sweet||Caramel",
  "Sweet||Honey",
  "Floral||Jasmine",
  "Nutty/Cocoa|Cocoa|Dark Chocolate",
  "Spices||Cinnamon",
  "Cereal/Grain|Cereal|Toast",
  "Green/Vegetative|Fresh Green|Grass"
];

let samples = [];
let currentSampleId = null;
let sampleSaveTimeout = null;
let flavorProfileChart = null; // 향미 프로필 차트 객체
let sortableInstance = null; // Sortable 인스턴스를 저장할 변수
let currentLanguage = 'en'; // 기본 언어 설정 (en 또는 ko)
let chartObjects = {}; // 차트 객체 저장 관리 (메모리 누수 방지)
let currentFlavorCategory = null; // 현재 선택된 향미 카테고리
let currentFlavorPhase = "fragrance"; // 현재 선택된 향미 단계

// 향미 휠 아코디언 토글 함수
function toggleAccordion(header) {
  if (!header) return;
  
  const content = header.nextElementSibling;
  if (!content) return;
  
  const isOpen = content.classList.toggle('show');
  
  // 아이콘 변경
  const icon = header.querySelector('.accordion-icon');
  if (icon) {
    icon.innerHTML = isOpen ? '<i class="fas fa-chevron-up"></i>' : '<i class="fas fa-chevron-down"></i>';
  }
}

// 배경색에 따른 텍스트 색상 최적화 함수
function getContrastColor(hexColor) {
  // 색상이 유효하지 않으면 기본 검정 반환
  if (!hexColor || typeof hexColor !== 'string') return '#000000';
  
  // 16진수 색상값 파싱
  let r, g, b;
  if (hexColor.startsWith('#')) {
    hexColor = hexColor.substring(1);
  }
  
  // 3자리 헥스코드 처리 (#RGB)
  if (hexColor.length === 3) {
    r = parseInt(hexColor.charAt(0) + hexColor.charAt(0), 16);
    g = parseInt(hexColor.charAt(1) + hexColor.charAt(1), 16);
    b = parseInt(hexColor.charAt(2) + hexColor.charAt(2), 16);
  } 
  // 6자리 헥스코드 처리 (#RRGGBB)
  else if (hexColor.length === 6) {
    r = parseInt(hexColor.substring(0, 2), 16);
    g = parseInt(hexColor.substring(2, 4), 16);
    b = parseInt(hexColor.substring(4, 6), 16);
  } else {
    return '#000000'; // 기본값
  }
  
  // 밝기 계산 (YIQ 공식) - 가독성 향상
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  
  // 밝은 색상이면 검정, 어두운 색상이면 흰색 반환
  return brightness > 128 ? '#000000' : '#FFFFFF';
}

function getEmptySampleData() {
  let flavorSelections = {}; 
  FLAVOR_PHASES.forEach(phase => flavorSelections[phase.id] = []);
  return {
    title: "", coffeeName: "", origin: "", variety: "", process: "", roastDate: "", roastLevel: "",
    flavorSelections, acidityLevel: "", sweetnessLevel: "", bodyLevel: "",
    defectUnderdevelopment: "none", defectOverdevelopment: "none", defectBaked: "none", defectScorching: "none",
    scoreFragrance: 7, scoreAroma: 7, scoreFlavor: 7, scoreAftertaste: 7, scoreAcidity: 7, scoreBody: 7, scoreBalance: 7, scoreOverall: 7,
    tastingNotes: "", lastEdit: +(new Date())
  };
}

function createNewSampleObj(title) {
  let id = "sample_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
  return {id, title: title || "새 샘플", sampleData: getEmptySampleData(), lastEdit: +(new Date())};
}

// 샘플 이동 시 토스트 메시지 표시 함수
function showSampleToast(sampleName) {
  const toast = document.getElementById('sampleToast');
  toast.textContent = sampleName;
  toast.classList.add('show');
  
  // 일정 시간 후 토스트 메시지 숨기기
  setTimeout(() => {
    toast.classList.remove('show');
  }, 1500);
}

// 토스트 메시지 표시 함수
function showToast(msg) {
  try {
    let toast = document.getElementById('toast');
    toast.innerHTML = msg;
    toast.classList.add('show');
    setTimeout(() => {toast.classList.remove('show');}, 1800);
  } catch(e) {
    console.error("토스트 메시지 표시 중 오류:", e);
  }
}

// 현재 샘플 표시 업데이트 함수
function updateCurrentSampleIndicator() {
  const indicator = document.getElementById('currentSampleIndicator');
  if (!indicator) return;
  
  const currentSample = getCurrentSampleObj();
  if (currentSample) {
    indicator.querySelector('span').textContent = currentSample.title || "샘플";
    
    // 현재 위치 표시 (예: 2/5)
    const currentIndex = samples.findIndex(s => s.id === currentSampleId);
    if (currentIndex > -1) {
      indicator.querySelector('span').textContent += ` (${currentIndex + 1}/${samples.length})`;
    }
  } else {
    indicator.querySelector('span').textContent = "샘플 없음";
  }
}

// 네비게이션 버튼 상태 업데이트
function updateNavigationButtons() {
  const prevBtn = document.getElementById('prevSampleBtn');
  const nextBtn = document.getElementById('nextSampleBtn');
  
  if (!prevBtn || !nextBtn || !samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  
  prevBtn.disabled = currentIndex <= 0;
  prevBtn.classList.toggle('opacity-50', currentIndex <= 0);
  prevBtn.classList.toggle('cursor-not-allowed', currentIndex <= 0);
  
  nextBtn.disabled = currentIndex >= samples.length - 1;
  nextBtn.classList.toggle('opacity-50', currentIndex >= samples.length - 1);
  nextBtn.classList.toggle('cursor-not-allowed', currentIndex >= samples.length - 1);
}

// 이전 샘플로 이동
function goToPrevSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex > 0) {
    loadSample(samples[currentIndex - 1].id);
    // 샘플 토스트 메시지 표시
    showSampleToast(samples[currentIndex - 1].title || "샘플");
  }
}

// 다음 샘플로 이동
function goToNextSample() {
  if (!samples.length) return;
  
  const currentIndex = samples.findIndex(s => s.id === currentSampleId);
  if (currentIndex < samples.length - 1) {
    loadSample(samples[currentIndex + 1].id);
    // 샘플 토스트 메시지 표시
    showSampleToast(samples[currentIndex + 1].title || "샘플");
  }
}

// 체크된 라디오 버튼의 값 가져오기
function getCheckedRadio(name) {
  let radio = document.querySelector(`input[name="${name}"]:checked`);
  return radio ? radio.value : "";
}

// 향미 카테고리 필터링 함수
function filterByCategory(category) {
  // 현재 카테고리 업데이트
  currentFlavorCategory = currentFlavorCategory === category ? null : category;
  
  // 카테고리 탭 업데이트
  document.querySelectorAll('.flavor-category-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.category === currentFlavorCategory);
  });
  
  // 각 향미 카테고리 영역 표시/숨김
  const allCategories = document.querySelectorAll('.flavor-category-accordion');
  
  if (currentFlavorCategory) {
    // 특정 카테고리만 표시 - 클래스 기반으로 전환
    allCategories.forEach(cat => {
      if (cat.dataset.category === currentFlavorCategory) {
        cat.classList.remove('flavor-fix-hidden');
        // 선택된 카테고리는 자동으로 펼침
        const content = cat.querySelector('.flavor-category-content');
        if (content) {
          content.classList.add('show');
          const icon = content.previousElementSibling.querySelector('.accordion-icon');
          if (icon) icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
      } else {
        cat.classList.add('flavor-fix-hidden');
      }
    });
  } else {
    // 모든 카테고리 표시 (필터링 해제)
    allCategories.forEach(cat => {
      cat.classList.remove('flavor-fix-hidden');
    });
  }
}

// 언어 전환 함수
function switchLanguage(lang) {
  currentLanguage = lang;
  
  // 언어 버튼 스타일 업데이트
  document.getElementById('langEn').classList.toggle('active', lang === 'en');
  document.getElementById('langKo').classList.toggle('active', lang === 'ko');
  
  // 향미 데이터 다시 렌더링 - 카테고리 필터링 상태 유지
  renderFlavorPhase(); 
  
  // 선택된 향미 영역 업데이트
  renderSelectedFlavorsArea();
}

// Flavor Tabs 렌더링 함수
function renderFlavorTabs() {
  const tabs = document.getElementById('flavorTabs');
  if (!tabs) return;
  
  tabs.innerHTML = '';
  FLAVOR_PHASES.forEach(phase => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'flavor-phase-btn font-bold rounded px-4 py-1 mr-1 mb-1 mobile-touch-friendly ' + 
      (currentFlavorPhase === phase.id ? 'tab-btn-active' : 'tab-btn-inactive');
    btn.textContent = phase.label;
    btn.dataset.flavorphase = phase.id;
    btn.onclick = () => {
      currentFlavorPhase = phase.id;
      renderFlavorTabs();
      renderFlavorPhase();
    };
    tabs.appendChild(btn);
  });
}

// 향미 선택 영역 렌더링 함수
function renderFlavorPhase() {
  const currentSample = getCurrentSampleObj();
  if (!currentSample) return;
  
  let curSel = currentSample.sampleData.flavorSelections[currentFlavorPhase] || [];
  let outer = document.getElementById('flavorWheelMultiSelectArea');
  
  // 로딩 상태 표시
  outer.innerHTML = `
    <div class="flex justify-center items-center p-4">
      <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-amber-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="text-amber-700">향미 선택기 로딩 중...</span>
    </div>
  `;
  
  // 카테고리-향미 매핑 준비
  // 영어 카테고리 이름을 키로, 한글 카테고리 이름을 값으로 하는 매핑 생성
  const categoryMapping = {};
  FLAVOR_CATEGORIES.forEach(cat => {
    cat.categories.forEach(engCat => {
      categoryMapping[engCat] = cat.name;
    });
  });
  
  let html = `
    <div class="search-box mb-3">
      <input type="text" id="flavorSearchInput" class="search-input" 
        placeholder="향미 검색 (베리, 초콜릿, 꽃향 등...)">
    </div>
    
    <div class="flavor-category-tabs">
  `;
  
  // 카테고리 탭 추가
  FLAVOR_CATEGORIES.forEach(category => {
    html += `
      <button type="button" class="flavor-category-tab ${currentFlavorCategory === category.name ? 'active' : ''}" 
              data-category="${category.name}" onclick="filterByCategory('${category.name}')">
        ${category.name}
      </button>
    `;
  });
  
  html += `</div>
    
    <div class="frequently-used-flavors">
      <h4><i class="fas fa-star mr-1"></i> 자주 사용하는 향미</h4>
      <div class="flex flex-wrap">
  `;
  
  // 자주 사용하는 향미 목록 렌더링
  FREQUENT_FLAVORS.forEach(key => {
    const [cat, sub, desc] = key.split('|');
    const rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
    if (rec) {
      const color = rec[3] || '#B8B2A5';
      const textColor = getContrastColor(color);
      const koreanName = rec.length > 6 ? rec[6] : desc;
      const checked = curSel.includes(key) ? ' checked ' : '';
      
      html += `
        <label class="flavor-checkbox-label" style="background:${color};color:${textColor};">
          <input type="checkbox" class="flavorSelectBox" data-key="${key}" ${checked}>
          <span class="checkbox-custom"></span>
          ${currentLanguage === 'en' ? desc : koreanName}
        </label>
      `;
    }
  });
  
  html += `
      </div>
    </div>
  `;
  
  // 카테고리별로 향미를 그룹화
  const flavorsByCategory = {};
  
  // 각 FLAVOR_CATEGORIES의 카테고리에 대해 해당하는 FLAVOR_DATA 항목들을 그룹화
  FLAVOR_CATEGORIES.forEach(category => {
    flavorsByCategory[category.name] = [];
    
    // 영어 카테고리명을 사용하여 매칭되는 향미들을 찾기
    category.categories.forEach(engCategory => {
      FLAVOR_DATA.forEach(flavor => {
        if (flavor[0] === engCategory) {
          flavorsByCategory[category.name].push(flavor);
        }
      });
    });
  });
  
  // 각 카테고리별 아코디언 생성
  Object.keys(flavorsByCategory).forEach(categoryName => {
    const flavors = flavorsByCategory[categoryName];
    if (!flavors || flavors.length === 0) return;
    
    // 필터링 적용: 현재 선택된 카테고리가 있고, 이 카테고리가 아니면 숨김 클래스 추가
    const isHidden = currentFlavorCategory && currentFlavorCategory !== categoryName;
    
    html += `
      <div class="flavor-category-accordion mb-3 ${isHidden ? 'flavor-fix-hidden' : ''}" data-category="${categoryName}">
        <div class="flavor-category-header" onclick="toggleAccordion(this)">
          <h4>${categoryName}</h4>
          <span class="accordion-icon"><i class="fas fa-chevron-${isHidden ? 'down' : 'up'}"></i></span>
        </div>
        <div class="flavor-category-content ${isHidden ? '' : 'show'}">
    `;
    
    // 서브카테고리별로 그룹화
    const flavorsBySubCategory = {};
    
    flavors.forEach(flavor => {
      const subCategory = flavor[1] || '일반';
      const subCategoryKR = flavor[5] || '일반';
      const displaySubCategory = currentLanguage === 'en' ? subCategory : subCategoryKR;
      
      if (!flavorsBySubCategory[displaySubCategory]) {
        flavorsBySubCategory[displaySubCategory] = [];
      }
      
      flavorsBySubCategory[displaySubCategory].push(flavor);
    });
    
    // 각 서브카테고리 렌더링
    Object.keys(flavorsBySubCategory).sort().forEach(subCategory => {
      const subFlavors = flavorsBySubCategory[subCategory];
      
        if (subCategory !== '일반') {
          html += `<div class="flavor-subcategory-title">${subCategory}</div>`;
        }
        
        html += `<div class="flavor-items flex flex-wrap">`;
        
        // 서브카테고리 내 향미들 렌더링
        subFlavors.forEach(flavor => {
          const [cat, sub, desc, color, catKr, subKr, descKr] = flavor;
          const id = cat+'|'+sub+'|'+desc;
          const checked = curSel.includes(id) ? ' checked ' : '';
          const textColor = getContrastColor(color);
          const displayName = currentLanguage === 'en' ? desc : (descKr || desc);
          
          html += `
            <label class="flavor-checkbox-label ${checked ? 'selected-flavor' : ''}" style="background:${color};color:${textColor};" 
                  data-category="${cat}" data-subcategory="${sub}" data-flavor-en="${desc.toLowerCase()}" data-flavor-kr="${(descKr||'').toLowerCase()}">
              <input type="checkbox" class="flavorSelectBox" data-key="${id}" ${checked}>
              <span class="checkbox-custom"></span>
              ${displayName}
            </label>
          `;
        });
        
        html += `</div>`;
      });
      
      html += `
          </div>
        </div>
      `;
    });
    
    outer.innerHTML = html;
    
    // 향미 검색 기능 (디바운싱 적용)
    const searchInput = document.getElementById('flavorSearchInput');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const searchTerm = this.value.trim().toLowerCase();
          
          // 검색어가 비어있으면 원래 상태로 복원
          if (searchTerm === '') {
            document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
              label.style.display = '';
              label.classList.remove('search-highlight');
            });
            
            // 카테고리 필터링 상태 복원
            document.querySelectorAll('.flavor-category-accordion').forEach(cat => {
              cat.classList.toggle('flavor-fix-hidden', currentFlavorCategory && cat.dataset.category !== currentFlavorCategory);
            });
            
            document.querySelectorAll('.flavor-subcategory-title').forEach(title => {
              title.style.display = '';
            });
            return;
          }
          
          // 검색 중에는 모든 아코디언 펼치기
          document.querySelectorAll('.flavor-category-content').forEach(content => {
            content.classList.add('show');
            const icon = content.previousElementSibling.querySelector('.accordion-icon');
            if (icon) icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
          });
          
          // 모든 카테고리 표시 (필터링 초기화)
          document.querySelectorAll('.flavor-category-accordion').forEach(cat => {
            cat.classList.remove('flavor-fix-hidden');
          });
          
          // 검색어에 맞는 항목만 표시
          let visibleCategories = new Set(); // 보여줄 카테고리 추적
          
          document.querySelectorAll('.flavor-checkbox-label').forEach(label => {
            const flavorEn = label.dataset.flavorEn?.toLowerCase() || '';
            const flavorKr = label.dataset.flavorKr?.toLowerCase() || '';
            const category = label.dataset.category?.toLowerCase() || '';
            const subcategory = label.dataset.subcategory?.toLowerCase() || '';
            
            if (
              flavorEn.includes(searchTerm) || 
              flavorKr.includes(searchTerm) || 
              category.includes(searchTerm) || 
              subcategory.includes(searchTerm)
            ) {
              label.style.display = '';
              label.classList.add('search-highlight');
              
              // 해당 레이블이 속한 카테고리 표시
              const categoryAccordion = label.closest('.flavor-category-accordion');
              if (categoryAccordion) {
                visibleCategories.add(categoryAccordion);
              }
            } else {
              label.style.display = 'none';
              label.classList.remove('search-highlight');
            }
          });
          
          // 매칭된 향미가 없는 카테고리 숨기기
          document.querySelectorAll('.flavor-category-accordion').forEach(accordion => {
            accordion.classList.toggle('flavor-fix-hidden', !visibleCategories.has(accordion));
          });
          
          // 매칭된 향미가 없는 서브카테고리 숨기기
          document.querySelectorAll('.flavor-subcategory-title').forEach(title => {
            // 이 서브카테고리 이후, 다음 서브카테고리 전까지의 모든 레이블 확인
            let hasVisibleFlavor = false;
            let current = title.nextElementSibling;
            
            while (current && !current.classList.contains('flavor-subcategory-title')) {
              if (current.classList.contains('flavor-items')) {
                const visibleLabels = Array.from(current.querySelectorAll('.flavor-checkbox-label'))
                  .filter(label => label.style.display !== 'none');
                  
                if (visibleLabels.length > 0) {
                  hasVisibleFlavor = true;
                  break;
                }
              }
              current = current.nextElementSibling;
            }
            
            title.style.display = hasVisibleFlavor ? '' : 'none';
          });
        }, 250); // 250ms 디바운싱
      });
    }
    
    // 향미 선택 체크박스 이벤트 처리
    outer.querySelectorAll('.flavorSelectBox').forEach(cb => {
      cb.onchange = function() {
        if (!currentSampleId) return;
        
        const currentSample = getCurrentSampleObj();
        if (!currentSample) return;
        
        let sel = currentSample.sampleData.flavorSelections[currentFlavorPhase];
        let key = this.getAttribute('data-key');
        
        if (this.checked) {
          if (sel.indexOf(key) === -1) {
            if (sel.length < 10) {
              sel.push(key);
              this.closest('label').classList.add('selected-flavor'); // 시각적 피드백
            } else {
              this.checked = false;
              showToast("각 항목당 최대 10개까지만 선택 가능합니다.");
              return;
            }
          }
        } else {
          let idx = sel.indexOf(key);
          if (idx > -1) {
            sel.splice(idx, 1);
            this.closest('label').classList.remove('selected-flavor');
          }
        }
        
        renderSelectedFlavorsArea();
        scheduleAutoSave();
      };
    });
}

// 디펙트 영역 렌더링 함수
function renderSelectedDefectsArea(data) {
  let sampleData = data;
  if (!data) {
    const currentSample = getCurrentSampleObj();
    if (!currentSample) return;
    sampleData = currentSample.sampleData;
  }
  
  let hasDefect = false;
  let html = `<div class="bg-white rounded-lg p-4 shadow-md">
    <h4 class="font-semibold mb-3">로스팅 디펙트 평가 결과</h4>
    <div class="flex flex-wrap gap-3">`;
  
  DEFECT_PROPS.forEach(d => {
    const val = sampleData[d.key] || "none";
    if (val !== "none") {
      hasDefect = true;
      const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
      const textColor = getContrastColor(dColor);
      html += `
        <div class="defect-block">
          <div class="defect-headline">${d.label}</div>
          <div class="defect-desc">${d.desc}</div>
          <div class="defect-badge" style="background:${dColor};color:${textColor};">${DEFECT_LABELS[val].label}</div>
        </div>`;
    }
  });
  
  if (!hasDefect) {
    html += `<div class="text-center w-full text-gray-400 py-3">선택된 디펙트 없음</div>`;
  }
  
  html += `</div></div>`;
  
  let area = document.getElementById('selectedDefectsArea');
  if (area) area.innerHTML = html;
}

// 향미 특성/속성 실시간 반영 함수
function renderSelectedFlavorsArea(_data) {
  let sampleData;
  
  // 데이터 소스 결정
  if (_data) {
    sampleData = _data;
  } else {
    const currentSample = getCurrentSampleObj();
    if (!currentSample) return;
    sampleData = currentSample.sampleData;
  }
  
  let html = '';
  
  // 각 단계별 향미 표시
  FLAVOR_PHASES.forEach(phase => {
    let phaseSel = (sampleData.flavorSelections[phase.id] || []).map(key => {
      let [cat, sub, desc] = key.split('|');
      let rec = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
      if (!rec) return ''; // 존재하지 않는 항목 방지
      
      let color = rec[3] || '#B8B2A5';
      let koreanName = rec.length > 6 ? rec[6] : desc;
      
      // 색상 대비 계산하여 텍스트 색상 결정
      let textColor = getContrastColor(color);
      return `<span class="flavor-badge" style="background:${color};color:${textColor};">${currentLanguage === 'en' ? desc : koreanName}</span>`;
    }).filter(badge => badge !== ''); // 빈 항목 제거
    
    html += `<div class="mb-1">
      <span class="font-bold">${phase.label}:</span> 
      ${phaseSel.join(' ') || '<span class="text-xs text-gray-400">없음</span>'}
    </div>`;
  });
  
  // 속성 표시
  html += `<div class="mt-2 mb-1 flex flex-wrap items-center">`;
  Object.keys(ATTR_TO_BADGE).forEach(attrKey => {
    let attrMeta = ATTR_TO_BADGE[attrKey];
    let val = sampleData[attrKey];
    if (val) {
      html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;">
        ${attrMeta.label}: ${ATTR_VALUE_LABELS[val]}
      </span>`;
    } else {
      html += `<span class="flavor-badge" style="background:${attrMeta.color};color:#fff;opacity:0.5;">
        ${attrMeta.label}: 미선택
      </span>`;
    }
  });
  html += `</div>`;
  
  // 로스팅 디펙트 표시
  html += `<div class="mt-2">
    <span class="font-bold">로스팅 디펙트:</span>
    <div class="flex flex-wrap gap-1 mt-1">`;
    
  let hasDefect = false;
  DEFECT_PROPS.forEach(d => {
    const val = sampleData[d.key] || "none";
    if (val !== "none") {
      const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
      html += `<span class="flavor-badge" style="background:${dColor};color:#fff;">
        ${d.label}: ${DEFECT_LABELS[val].label}
      </span>`;
      hasDefect = true;
    }
  });
  
  // 선택된 디펙트가 없는 경우
  if (!hasDefect) {
    html += `<span class="text-xs text-gray-400">선택된 디펙트 없음</span>`;
  }
  
  html += `</div></div>`;
  
  // 결과 표시
  const flavorArea = document.getElementById('selectedFlavorsArea');
  if (flavorArea) {
    flavorArea.innerHTML = html;
  }
}

// 레이더 차트 업데이트
function updateRadar(data) {
  const ctx = document.getElementById('cuppingRadar');
  if (!ctx) return;
  
  // 기존 차트 정리
  if (flavorProfileChart) {
    flavorProfileChart.destroy();
    flavorProfileChart = null;
  }
  
  // 샘플 데이터 확인
  let sampleData = data || getCurrentSampleObj()?.sampleData;
  if (!sampleData) return;

  // 차트 데이터
  const chartData = {
    labels: ['프래그런스', '아로마', '플레이버', '에프터테이스트', '액시디티', '바디', '밸런스', '오버럴'],
    datasets: [{
      label: '점수',
      data: [
        sampleData.scoreFragrance || 0,
        sampleData.scoreAroma || 0,
        sampleData.scoreFlavor || 0,
        sampleData.scoreAftertaste || 0,
        sampleData.scoreAcidity || 0,
        sampleData.scoreBody || 0,
        sampleData.scoreBalance || 0,
        sampleData.scoreOverall || 0
      ],
      backgroundColor: 'rgba(139, 90, 43, 0.2)',
      borderColor: 'rgba(139, 90, 43, 0.8)',
      borderWidth: 2,
      pointBackgroundColor: 'rgba(139, 90, 43, 1)',
      pointRadius: 4
    }]
  };

  // 차트 옵션
  const options = {
    scales: {
      r: {
        angleLines: {
          display: true
        },
        min: 0,
        max: 10,
        ticks: {
          stepSize: 2,
          backdropColor: 'rgba(255, 255, 255, 0)'
        }
      }
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return `점수: ${context.raw}`;
          }
        }
      }
    }
  };

  // 차트 생성
  flavorProfileChart = new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: options
  });
  
  // 차트 객체 저장 (메모리 관리)
  chartObjects['cuppingRadar'] = flavorProfileChart;
}

// 총점 계산
function updateTotalScore(data) {
  let sampleData = data;
  
  if (!data) {
    const currentSample = getCurrentSampleObj();
    if (!currentSample) return;
    sampleData = currentSample.sampleData;
  }
  
  const scoreFields = [
    'scoreFragrance', 'scoreAroma', 'scoreFlavor', 'scoreAftertaste', 
    'scoreAcidity', 'scoreBody', 'scoreBalance', 'scoreOverall'
  ];
  
  let total = 30; // 기본 30점
  scoreFields.forEach(field => {
    total += parseFloat(sampleData[field] || 0);
  });
  
  let totalScoreEl = document.getElementById('totalScore');
  if (totalScoreEl) {
    totalScoreEl.textContent = total.toFixed(2);
  }
  
  // 평가일 업데이트
  document.getElementById('evalDate').textContent = new Date().toLocaleDateString();
}

// 자동 저장
function scheduleAutoSave() {
  if (sampleSaveTimeout) {
    clearTimeout(sampleSaveTimeout);
  }
  
  sampleSaveTimeout = setTimeout(() => {
    try {
      saveCurrentSample();
      
      // 저장 표시를 잠시 보여주기
      const saveState = document.getElementById('sampleSavedState');
      if (saveState) {
        saveState.classList.remove("hidden");
        setTimeout(() => saveState.classList.add("hidden"), 1500);
      }
    } catch(e) {
      console.error("자동 저장 중 오류:", e);
      showToast("자동 저장 중 오류가 발생했습니다.");
    }
  }, 2000); // 2초 후 저장
}

// 현재 샘플 가져오기
function getCurrentSampleObj() { 
  const sample = samples.find(s => s.id === currentSampleId);
  return sample || null;
}

// UI에서 샘플 데이터 로드
function setUIFromSample(sampleData) {
  document.getElementById('sampleTitleInput').value = sampleData.title || '';
  document.getElementById('coffeeName').value = sampleData.coffeeName || '';
  document.getElementById('origin').value = sampleData.origin || '';
  document.getElementById('variety').value = sampleData.variety || '';
  document.getElementById('process').value = sampleData.process || '';
  document.getElementById('roastDate').value = sampleData.roastDate || '';
  document.getElementById('roastLevel').value = sampleData.roastLevel || '';
  
  // 라디오 버튼 상태 설정
  ["acidity", "sweetness", "body"].forEach(group => {
    let v = sampleData[group + "Level"] || "";
    let groupRadio = 'input[name="' + group + 'Level"]';
    if (v) {
      let radio = document.querySelector(groupRadio + '[value="' + v + '"]');
      if (radio) radio.checked = true;
    } else {
      let radios = document.querySelectorAll(groupRadio); 
      radios.forEach(r => r.checked = false);
    }
  });
  
  // 디펙트 라디오 버튼 설정
  DEFECT_PROPS.forEach(d => {
    const val = sampleData[d.key] || "none";
    let radioNode = document.querySelector('input[name="' + d.key + '"][value="' + val + '"]');
    if (radioNode) radioNode.checked = true;
  });
  
  // SCA 점수 설정
  [
    ["scoreFragrance", "scoreFragrance"], ["scoreAroma", "scoreAroma"], 
    ["scoreFlavor", "scoreFlavor"], ["scoreAftertaste", "scoreAftertaste"],
    ["scoreAcidity", "scoreAcidity"], ["scoreBody", "scoreBody"], 
    ["scoreBalance", "scoreBalance"], ["scoreOverall", "scoreOverall"]
  ].forEach(([key, id]) => {
    document.getElementById(id).value = sampleData[key] || 7;
    document.getElementById(id + "_slider").value = sampleData[key] || 7;
  });
  
  document.getElementById('tastingNotes').value = sampleData.tastingNotes || '';
  renderSelectedFlavorsArea(sampleData);
  renderSelectedDefectsArea(sampleData);
  updateRadar(sampleData);
  updateTotalScore(sampleData);
  renderFlavorTabs();
  renderFlavorPhase(); // 향미 선택 UI 업데이트
}

// UI에서 샘플 데이터 저장
function saveUIToSample(targetDataObj) {
  let sampleData = targetDataObj || getCurrentSampleObj().sampleData;
  if (!sampleData) return; // 유효한 샘플 데이터가 없으면 중단
  
  sampleData.title = document.getElementById('sampleTitleInput').value || "";
  sampleData.coffeeName = document.getElementById('coffeeName').value;
  sampleData.origin = document.getElementById('origin').value;
  sampleData.variety = document.getElementById('variety').value;
  sampleData.process = document.getElementById('process').value;
  sampleData.roastDate = document.getElementById('roastDate').value;
  sampleData.roastLevel = document.getElementById('roastLevel').value;
  sampleData.acidityLevel = getCheckedRadio('acidityLevel');
  sampleData.sweetnessLevel = getCheckedRadio('sweetnessLevel');
  sampleData.bodyLevel = getCheckedRadio('bodyLevel');
  DEFECT_PROPS.forEach(d => {
    sampleData[d.key] = getCheckedRadio(d.key) || "none";
  });
  sampleData.scoreFragrance = parseFloat(document.getElementById('scoreFragrance').value) || 0;
  sampleData.scoreAroma = parseFloat(document.getElementById('scoreAroma').value) || 0;
  sampleData.scoreFlavor = parseFloat(document.getElementById('scoreFlavor').value) || 0;
  sampleData.scoreAftertaste = parseFloat(document.getElementById('scoreAftertaste').value) || 0;
  sampleData.scoreAcidity = parseFloat(document.getElementById('scoreAcidity').value) || 0;
  sampleData.scoreBody = parseFloat(document.getElementById('scoreBody').value) || 0;
  sampleData.scoreBalance = parseFloat(document.getElementById('scoreBalance').value) || 0;
  sampleData.scoreOverall = parseFloat(document.getElementById('scoreOverall').value) || 0;
  sampleData.tastingNotes = document.getElementById('tastingNotes').value;
  sampleData.lastEdit = +(new Date());
}

// 샘플 목록 렌더링
function renderSampleList() {
  let listDiv = document.getElementById('sampleList');
  if (!samples.length) {
    listDiv.innerHTML = `<div class="text-gray-500 text-xs my-3 text-center">샘플 없음<br>새로 추가하세요.</div>`;
    updateNavigationButtons();
    updateCurrentSampleIndicator();
    return;
  }
  
  // 드래그 앤 드롭 가능한 샘플 리스트로 변경
  let html = '';
  samples.forEach(sm => {
    html += `
      <div class="flex justify-between items-center border rounded-lg px-2 py-1 mb-1 sample-item ${sm.id === currentSampleId ? "bg-yellow-100 border-yellow-700" : "bg-white border-gray-200"}" data-id="${sm.id}">
        <div class="sample-drag-handle"><i class="fas fa-grip-lines"></i></div>
        <span class="truncate text-sm flex-1 ${sm.id === currentSampleId ? "font-bold" : ""}">${sm.title || "샘플"}</span>
        <span class="text-xs ml-2 text-gray-400">${sm.sampleData && sm.sampleData.roastDate ? sm.sampleData.roastDate : ""}</span>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
  
  // 샘플 클릭 이벤트
  Array.from(listDiv.querySelectorAll('.sample-item')).forEach(el => {
    el.addEventListener('click', (e) => {
      // 드래그 핸들을 클릭했을 때는 로드하지 않음
      if (!e.target.closest('.sample-drag-handle')) {
        let id = el.getAttribute('data-id');
        if (id !== currentSampleId) {
          loadSample(id);
          // 샘플 토스트 메시지 표시
          const sample = samples.find(s => s.id === id);
          if (sample) {
            showSampleToast(sample.title || "샘플");
          }
        }
      }
    });
    
    // 샘플 복제를 위한 컨텍스트 메뉴(우클릭) 이벤트
    el.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const sampleId = el.getAttribute('data-id');
      if (confirm("이 샘플을 복제하시겠습니까?")) {
        cloneSample(sampleId);
      }
    });
    
    // 모바일에서 길게 누르기로 샘플 복제
    el.addEventListener('touchstart', function(e) {
      if (e.target.closest('.sample-drag-handle')) return; // 드래그 핸들 터치 시 무시
      
      const longPressTimer = setTimeout(() => {
        const sampleId = el.getAttribute('data-id');
        if (confirm("이 샘플을 복제하시겠습니까?")) {
          cloneSample(sampleId);
        }
      }, 800); // 800ms 이상 누르면 복제 다이얼로그 표시
      
      // 터치 종료 시 타이머 제거
      const clearTimer = () => clearTimeout(longPressTimer);
      el.addEventListener('touchend', clearTimer, { once: true });
      el.addEventListener('touchcancel', clearTimer, { once: true });
    });
  });
  
  // Sortable.js 초기화 - 드래그 앤 드롭
  // 기존 인스턴스가 있으면 파괴
  if (sortableInstance) {
    sortableInstance.destroy();
  }
  
  if (samples.length > 1) {
    sortableInstance = new Sortable(listDiv, {
      animation: 150,
      handle: '.sample-drag-handle',
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      onEnd: function (evt) {
        // 드래그 앤 드롭 후 배열 재정렬
        const oldIndex = evt.oldIndex;
        const newIndex = evt.newIndex;
        
        if (oldIndex !== newIndex) {
          const item = samples[oldIndex];
          samples.splice(oldIndex, 1);
          samples.splice(newIndex, 0, item);
          saveSamplesToStorage();
          updateNavigationButtons();
          updateCurrentSampleIndicator();
        }
      }
    });
  }
  
  updateNavigationButtons();
  updateCurrentSampleIndicator();
  renderCompareList(); // 샘플 변경시 항상 compare UI 새로 그리기
}

// 비교 목록 렌더링
function renderCompareList() {
  const compareListBox = document.getElementById('compareListBox');
  if (!compareListBox) return;
  
  if (samples.length < 2) {
    compareListBox.innerHTML = `<div class="text-xs text-gray-400 my-2">비교를 위해 샘플을 2개 이상 추가하세요.</div>`;
    return;
  }
  
  let html = `<div class="text-xs mb-2 text-gray-500">비교할 샘플 선택:</div>`;
  
  html += `<div class="flex flex-wrap gap-2 mb-3">`;
  samples.forEach(sm => {
    html += `
      <label class="flex items-center bg-gray-100 hover:bg-gray-200 rounded px-3 py-1 text-sm mobile-touch-friendly">
        <input type="checkbox" class="compare-checkbox mr-1.5" value="${sm.id}">
        ${sm.title || "샘플"}
      </label>
    `;
  });
  html += `</div>`;
  
  compareListBox.innerHTML = html;
}

// 현재 샘플 저장
function saveCurrentSample(applyInput=true) {
  let sampleIdx = samples.findIndex(s => s.id === currentSampleId);
  if (sampleIdx === -1) return false; // 유효한 샘플이 없으면 중단
  
  if (applyInput) {
    saveUIToSample(samples[sampleIdx].sampleData);
  }
  let titleVal = document.getElementById('sampleTitleInput').value.trim();
  samples[sampleIdx].title = titleVal || "샘플";
  samples[sampleIdx].sampleData.title = samples[sampleIdx].title;
  samples[sampleIdx].lastEdit = +(new Date());
  renderSampleList();
  saveSamplesToStorage();
  return true;
}

// 샘플 로드
function loadSample(sampleId) {
  // 현재 샘플 저장
  if (currentSampleId) {
    saveCurrentSample();
  }
  
  let sampleObj = samples.find(s => s.id === sampleId);
  if (sampleObj) {
    currentSampleId = sampleId;
    setUIFromSample(sampleObj.sampleData);
    renderSampleList();
  }
}

// 스토리지에서 샘플 로드
function loadSamplesFromStorage() {
  try {
    let raw = localStorage.getItem("mollis_sca_samples2");
    if (raw) { 
      samples = JSON.parse(raw); 
      if (!Array.isArray(samples)) {
        samples = [];
      }
    }
  } catch(e) {
    console.error("저장된 샘플 로딩 중 오류:", e);
    samples = [];
  }
  
  if (samples.length === 0) {
    let defaultSample = createNewSampleObj("샘플 #1");
    samples.push(defaultSample);
    currentSampleId = defaultSample.id;
    saveSamplesToStorage();
  }
  
  if (!currentSampleId || !samples.find(s => s.id === currentSampleId)) { 
    currentSampleId = samples[0].id; 
  }
  
  renderSampleList();
}

// 스토리지에 샘플 저장
function saveSamplesToStorage() {
  try {
    localStorage.setItem("mollis_sca_samples2", JSON.stringify(samples));
    const saveState = document.getElementById('sampleSavedState');
    if (saveState) {
      saveState.classList.remove("hidden");
      setTimeout(() => saveState.classList.add("hidden"), 900);
    }
  } catch(e) {
    console.error("샘플 저장 중 오류:", e);
    showToast("저장 중 오류가 발생했습니다. 데이터를 백업해 주세요.");
  }
}

// 샘플 복제 기능
function cloneSample(sampleId) {
  const originalSample = samples.find(s => s.id === sampleId);
  if (!originalSample) return;
  
  // 깊은 복사를 통해 완전한 복제본 생성
  const clonedData = JSON.parse(JSON.stringify(originalSample.sampleData));
  const newId = "sample_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
  const clonedSample = {
    id: newId,
    title: originalSample.title + " (복사본)",
    sampleData: clonedData,
    lastEdit: +(new Date())
  };
  
  samples.unshift(clonedSample); // 배열 맨 앞에 추가
  currentSampleId = newId;
  renderSampleList();
  setUIFromSample(clonedSample.sampleData);
  saveSamplesToStorage();
  showToast("샘플을 복제했습니다.");
}

// 샘플 백업 복원 기능
function showBackupList() {
  // 백업 목록 수집
  const backups = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('mollis_sca_backup_')) {
      const date = key.replace('mollis_sca_backup_', '');
      backups.push({ key, date });
    }
  }
  
  if (backups.length === 0) {
    showToast("저장된 백업이 없습니다.");
    return;
  }
  
  // 날짜 최신순 정렬
  backups.sort((a, b) => b.date.localeCompare(a.date));
  
  // 목록 표시
  let message = "백업 목록: (최근 날짜순)\n\n";
  backups.forEach((backup, i) => {
    message += `${i + 1}. ${backup.date}\n`;
  });
  
  message += "\n복원할 백업 번호를 입력하세요 (취소는 0):";
  
  const choice = prompt(message, "");
  if (!choice) return;
  
  const num = parseInt(choice, 10);
  if (isNaN(num) || num === 0) return;
  
  if (num > 0 && num <= backups.length) {
    const selectedBackup = backups[num - 1];
    
    if (confirm(`${selectedBackup.date} 백업을 복원하시겠습니까? 현재 데이터는 덮어씌워집니다.`)) {
      try {
        const backupData = localStorage.getItem(selectedBackup.key);
        const parsedData = JSON.parse(backupData);
        
        if (Array.isArray(parsedData) && parsedData.length > 0) {
          samples = parsedData;
          currentSampleId = samples[0].id;
          setUIFromSample(samples[0].sampleData);
          renderSampleList();
          saveSamplesToStorage();
          showToast(`${selectedBackup.date} 백업을 성공적으로 복원했습니다.`);
        } else {
          showToast("백업 데이터 형식이 올바르지 않습니다.");
        }
      } catch (e) {
        console.error("백업 복원 중 오류:", e);
        showToast("백업 복원 중 오류가 발생했습니다.");
      }
    }
  } else {
    showToast("올바른 백업 번호를 입력하세요.");
  }
}

// 자동 백업 기능
function setupAutoBackup() {
  // 마지막 백업 시간 확인
  const lastBackup = localStorage.getItem('mollis_sca_last_backup');
  const now = Date.now();
  
  // 24시간마다 자동 백업 (86400000ms)
  if (!lastBackup || (now - parseInt(lastBackup)) > 86400000) {
    try {
      // 백업 데이터 생성
      const backupData = JSON.stringify(samples);
      const backupKey = `mollis_sca_backup_${new Date().toISOString().slice(0, 10)}`;
      
      // 로컬 스토리지에 저장
      localStorage.setItem(backupKey, backupData);
      localStorage.setItem('mollis_sca_last_backup', now.toString());
      
      // 최대 7개 백업 유지
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('mollis_sca_backup_')) {
          keys.push(key);
        }
      }
      
      // 오래된 백업 삭제
      if (keys.length > 7) {
        keys.sort();
        while (keys.length > 7) {
          localStorage.removeItem(keys.shift());
        }
      }
      
      console.log('자동 백업 완료:', backupKey);
    } catch (e) {
      console.error('자동 백업 중 오류:', e);
    }
  }
}

// 오류 모니터링 및 자동 복구 기능
let lastErrorCount = 0;
function setupErrorMonitoring() {
  // 오류 모니터링 및 자동 복구
  window.addEventListener('error', function(e) {
    console.error('오류 감지됨:', e.error);
    
    // 오류 카운트 증가
    lastErrorCount++;
    
    // 짧은 시간 내에 오류가 과도하게 발생하는 경우 자동 백업 복원 시도
    if (lastErrorCount > 5) {
      try {
        // 마지막 백업 찾기
        let lastBackupKey = null;
        let lastBackupDate = '';
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('mollis_sca_backup_')) {
            const date = key.replace('mollis_sca_backup_', '');
            if (!lastBackupKey || date > lastBackupDate) {
              lastBackupKey = key;
              lastBackupDate = date;
            }
          }
        }
        
        if (lastBackupKey) {
          // 자동 복구 시도 (안전하게 복사본 만들기)
          const emergency_copy = JSON.parse(JSON.stringify(samples));
          const backupData = JSON.parse(localStorage.getItem(lastBackupKey));
          
          if (Array.isArray(backupData) && backupData.length > 0) {
            // 현재 데이터 백업
            localStorage.setItem('mollis_sca_emergency_backup', JSON.stringify(emergency_copy));
            showToast("오류로 인해 마지막 백업 상태로 복원합니다...");
            
            // 백업 데이터 복원
            samples = backupData;
            if (samples.length > 0) {
              currentSampleId = samples[0].id;
              setUIFromSample(samples[0].sampleData);
              renderSampleList();
              saveSamplesToStorage();
            }
          }
        }
        
        lastErrorCount = 0; // 리셋
      } catch (err) {
        console.error("자동 복구 중 오류:", err);
      }
    }
    
    // 10초 후 오류 카운트 리셋
    setTimeout(() => { lastErrorCount = 0; }, 10000);
  });
}

// 서비스 워커 등록
function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      window.addEventListener('load', async () => {
        try {
          // 상대 경로 사용
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('ServiceWorker 등록 성공:', registration.scope);
        } catch (e) {
          console.log('ServiceWorker 등록 실패, 다른 경로 시도:', e);
          try {
            // 현재 경로 기반으로 시도
            const path = window.location.pathname;
            const basePath = path.substr(0, path.lastIndexOf('/'));
            const swPath = basePath + '/sw.js';
            const registration = await navigator.serviceWorker.register(swPath);
            console.log('ServiceWorker 등록 성공(상대 경로):', registration.scope);
          } catch (err) {
            console.warn('ServiceWorker 등록 최종 실패:', err);
          }
        }
      });
    } catch (e) {
      console.warn("ServiceWorker 초기화 중 오류:", e);
    }
  }
}

// 차트 메모리 정리 함수
function cleanupCharts() {
  Object.keys(chartObjects).forEach(key => {
    const chart = chartObjects[key];
    if (chart) {
      try {
        chart.destroy();
        chartObjects[key] = null;
      } catch (e) {
        console.warn(`차트(${key}) 정리 중 오류:`, e);
      }
    }
  });
}

// 초기화 함수
function initFlavorWheelApp() {
  // 향미 선택 UI 초기화
  renderFlavorTabs();
  
  // 스크롤 개선 스타일 추가
  const styleEl = document.createElement('style');
  styleEl.id = 'flavor-fix-styles';
  styleEl.textContent = `
    .flavor-fix-hidden {
      display: none !important;
    }
    
    .flavor-checkbox-label.selected-flavor {
      box-shadow: 0 0 0 2px rgba(139, 90, 43, 0.8);
      transform: translateY(-1px);
    }
    
    .flavor-checkbox-label.search-highlight {
      transform: translateY(-2px);
      box-shadow: 0 0 0 2px #8B5A2B, 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1;
      position: relative;
    }
  `;
  document.head.appendChild(styleEl);
  
  // 서비스 워커 등록
  registerServiceWorker();
  
  // 자동 백업 설정
  setupAutoBackup();
  
  // 오류 모니터링 설정
  setupErrorMonitoring();
  
  // 샘플 불러오기
  loadSamplesFromStorage();
  
  // 현재 날짜 표시
  document.getElementById('evalDate').textContent = new Date().toLocaleDateString();
}

// 이벤트 핸들러 등록
function setupEventHandlers() {
  // 샘플 추가 버튼
  document.getElementById('addSampleBtn').addEventListener('click', function() {
    // 현재 샘플 저장
    if (currentSampleId) {
      saveCurrentSample();
    }
    
    // 새 샘플 생성 및 추가
    const newSample = createNewSampleObj(`샘플 #${samples.length + 1}`);
    samples.unshift(newSample); // 배열 맨 앞에 추가
    currentSampleId = newSample.id;
    renderSampleList();
    setUIFromSample(newSample.sampleData);
    saveSamplesToStorage();
    showToast("새 샘플이 추가되었습니다.");
  });
  
  // 샘플 삭제 버튼
  document.getElementById('removeSampleBtn').addEventListener('click', function() {
    if (!currentSampleId) return;
    
    if (confirm("현재 샘플을 삭제하시겠습니까?")) {
      const currentIdx = samples.findIndex(s => s.id === currentSampleId);
      if (currentIdx === -1) return;
      
      // 샘플 삭제
      samples.splice(currentIdx, 1);
      
      // 다음에 표시할 샘플 결정
      if (samples.length > 0) {
        currentSampleId = samples[Math.min(currentIdx, samples.length - 1)].id;
        setUIFromSample(samples.find(s => s.id === currentSampleId).sampleData);
      } else {
        // 샘플이 없는 경우 빈 샘플 추가
        const newSample = createNewSampleObj("샘플 #1");
        samples.push(newSample);
        currentSampleId = newSample.id;
        setUIFromSample(newSample.sampleData);
      }
      
      renderSampleList();
      saveSamplesToStorage();
      showToast("샘플이 삭제되었습니다.");
    }
  });
  
  // 샘플 복제 버튼
  document.getElementById('cloneSampleBtn').addEventListener('click', function() {
    if (!currentSampleId) return;
    cloneSample(currentSampleId);
  });
  
  // 웹에 저장 버튼
  document.getElementById('saveSamplesBtn').addEventListener('click', function() {
    if (currentSampleId) {
      saveCurrentSample();
    }
    saveSamplesToStorage();
    showToast("모든 샘플이 웹 스토리지에 저장되었습니다.");
  });
  
  // 웹에서 불러오기 버튼
  document.getElementById('loadSamplesWebBtn').addEventListener('click', function() {
    if (confirm("웹 스토리지에서 샘플을 불러오시겠습니까? 저장되지 않은 변경사항은 사라집니다.")) {
      loadSamplesFromStorage();
      if (samples.length > 0) {
        currentSampleId = samples[0].id;
        setUIFromSample(samples[0].sampleData);
      }
      showToast("웹 스토리지에서 샘플을 불러왔습니다.");
    }
  });
  
  // 백업 관리 버튼
  document.getElementById('backupManageBtn').addEventListener('click', function() {
    showBackupList();
  });
  
  // JSON 내보내기 버튼
  document.getElementById('exportSamplesBtn').addEventListener('click', function() {
    if (currentSampleId) {
      saveCurrentSample();
    }
    
    try {
      const dataStr = JSON.stringify(samples, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      
      const exportFileName = `mollis_coffee_samples_${new Date().toISOString().slice(0, 10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.style.display = 'none';
      document.body.appendChild(linkElement);
      linkElement.click();
      document.body.removeChild(linkElement);
      
      showToast("샘플 데이터를 JSON 파일로 내보냈습니다.");
    } catch (e) {
      console.error("JSON 내보내기 중 오류:", e);
      showToast("내보내기 중 오류가 발생했습니다.");
    }
  });
  
  // JSON 불러오기
  document.getElementById('importSamplesInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const importedData = JSON.parse(event.target.result);
        
        if (Array.isArray(importedData) && importedData.length > 0) {
          if (confirm("불러온 데이터로 기존 데이터를 대체하시겠습니까?")) {
            samples = importedData;
            currentSampleId = samples[0].id;
            setUIFromSample(samples[0].sampleData);
            renderSampleList();
            saveSamplesToStorage();
            showToast("샘플 데이터를 성공적으로 불러왔습니다.");
          }
        } else {
          showToast("유효한 샘플 데이터가 아닙니다.");
        }
      } catch (e) {
        console.error("JSON 파싱 오류:", e);
        showToast("JSON 파일 형식이 올바르지 않습니다.");
      }
    };
    
    reader.readAsText(file);
    // 파일 선택 초기화 (다시 같은 파일 선택 가능하도록)
    e.target.value = '';
  });
  
  // 슬라이더/입력 동기화
  document.querySelectorAll('.score-slider').forEach(slider => {
    const inputId = slider.id.replace('_slider', '');
    const input = document.getElementById(inputId);
    
    slider.addEventListener('input', function() {
      input.value = this.value;
      updateTotalScore();
      scheduleAutoSave();
    });
    
    input.addEventListener('input', function() {
      slider.value = this.value;
      updateTotalScore();
      scheduleAutoSave();
    });
  });
  
  // 계산 버튼
  document.getElementById('calcScoreBtn').addEventListener('click', function() {
    updateTotalScore();
  });
  
  // 샘플명 입력 변경 감지
  document.getElementById('sampleTitleInput').addEventListener('input', function() {
    scheduleAutoSave();
  });
  
  // 커피 정보 입력 변경 감지
  document.querySelectorAll('.coffee-input').forEach(input => {
    input.addEventListener('input', function() {
      scheduleAutoSave();
    });
    
    input.addEventListener('change', function() {
      scheduleAutoSave();
    });
  });
  
  // 라디오 버튼 변경 감지
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      scheduleAutoSave();
      renderSelectedFlavorsArea(); // 속성이 변경되면 향미 영역 업데이트
    });
  });
  
  // 테이스팅 노트 변경 감지
  document.getElementById('tastingNotes').addEventListener('input', function() {
    scheduleAutoSave();
  });
  
  // 이미지로 내보내기 버튼
  document.getElementById('exportImgBtn').addEventListener('click', function() {
    try {
      const form = document.getElementById('cuppingForm');
      
      html2canvas(form, {
        backgroundColor: '#ffffff',
        scale: 1.5,
        useCORS: true,
        allowTaint: true,
        className: 'html2canvas-container'
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        
        // 다운로드 링크 생성
        const link = document.createElement('a');
        link.download = `${document.getElementById('sampleTitleInput').value || 'coffee'}_평가_${new Date().toISOString().slice(0, 10)}.png`;
        link.href = imgData;
        link.click();
        
        showToast("이미지가 저장되었습니다.");
      });
    } catch (e) {
      console.error("이미지 내보내기 중 오류:", e);
      showToast("이미지 생성 중 오류가 발생했습니다.");
    }
  });
  
  // CSV로 내보내기 버튼
  document.getElementById('exportCsvBtn').addEventListener('click', function() {
    try {
      const currentSample = getCurrentSampleObj();
      if (!currentSample) return;
      
      const sampleData = currentSample.sampleData;
      
      // CSV 헤더
      let csvContent = "항목,값\n";
      
      // 기본 정보
      csvContent += `샘플명,${sampleData.title || ""}\n`;
      csvContent += `커피명,${sampleData.coffeeName || ""}\n`;
      csvContent += `원산지,${sampleData.origin || ""}\n`;
      csvContent += `품종,${sampleData.variety || ""}\n`;
      csvContent += `가공방식,${sampleData.process || ""}\n`;
      csvContent += `로스팅날짜,${sampleData.roastDate || ""}\n`;
      csvContent += `로스팅레벨,${sampleData.roastLevel || ""}\n\n`;
      
      // 속성
      csvContent += `산미,${sampleData.acidityLevel || "미선택"}\n`;
      csvContent += `단맛,${sampleData.sweetnessLevel || "미선택"}\n`;
      csvContent += `바디감,${sampleData.bodyLevel || "미선택"}\n\n`;
      
      // 로스팅 디펙트
      DEFECT_PROPS.forEach(d => {
        const val = sampleData[d.key] || "none";
        csvContent += `${d.label},${val === "none" ? "미선택" : DEFECT_LABELS[val].label}\n`;
      });
      csvContent += "\n";
      
      // SCA 점수
      csvContent += `프래그런스,${sampleData.scoreFragrance || 0}\n`;
      csvContent += `아로마,${sampleData.scoreAroma || 0}\n`;
      csvContent += `플레이버,${sampleData.scoreFlavor || 0}\n`;
      csvContent += `에프터테이스트,${sampleData.scoreAftertaste || 0}\n`;
      csvContent += `액시디티,${sampleData.scoreAcidity || 0}\n`;
      csvContent += `바디,${sampleData.scoreBody || 0}\n`;
      csvContent += `밸런스,${sampleData.scoreBalance || 0}\n`;
      csvContent += `오버럴,${sampleData.scoreOverall || 0}\n`;
      
      // 총점 계산
      let totalScore = 30;
      totalScore += parseFloat(sampleData.scoreFragrance || 0);
      totalScore += parseFloat(sampleData.scoreAroma || 0);
      totalScore += parseFloat(sampleData.scoreFlavor || 0);
      totalScore += parseFloat(sampleData.scoreAftertaste || 0);
      totalScore += parseFloat(sampleData.scoreAcidity || 0);
      totalScore += parseFloat(sampleData.scoreBody || 0);
      totalScore += parseFloat(sampleData.scoreBalance || 0);
      totalScore += parseFloat(sampleData.scoreOverall || 0);
      
      csvContent += `총점,${totalScore.toFixed(2)}\n\n`;
      
      // 향미 선택
      FLAVOR_PHASES.forEach(phase => {
        csvContent += `${phase.label},`;
        const flavors = sampleData.flavorSelections[phase.id] || [];
        if (flavors.length > 0) {
          const flavorNames = flavors.map(key => {
            const [cat, sub, desc] = key.split('|');
            const flavor = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
            return flavor ? flavor[2] : '';
          }).filter(name => name);
          csvContent += flavorNames.join('; ');
        }
        csvContent += '\n';
      });
      csvContent += "\n";
      
      // 테이스팅 노트
      csvContent += `테이스팅노트,${(sampleData.tastingNotes || "").replace(/[\r\n]+/g, ' ')}\n`;
      
      // 다운로드
      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `${sampleData.title || 'coffee'}_평가_${new Date().toISOString().slice(0, 10)}.csv`);
      link.click();
      
      showToast("CSV 파일이 다운로드되었습니다.");
    } catch (e) {
      console.error("CSV 내보내기 중 오류:", e);
      showToast("CSV 파일 생성 중 오류가 발생했습니다.");
    }
  });
  
  // 엑셀로 내보내기 버튼
  document.getElementById('exportXlsxBtn').addEventListener('click', function() {
    try {
      const currentSample = getCurrentSampleObj();
      if (!currentSample) return;
      
      const sampleData = currentSample.sampleData;
      
      // 워크시트 데이터 준비
      const ws_data = [
        ["mollis SCA 커피 관능 평가", "", "평가일:", new Date().toLocaleDateString()],
        [""],
        ["기본 정보", ""],
        ["샘플명", sampleData.title || ""],
        ["커피명", sampleData.coffeeName || ""],
        ["원산지", sampleData.origin || ""],
        ["품종", sampleData.variety || ""],
        ["가공방식", sampleData.process || ""],
        ["로스팅날짜", sampleData.roastDate || ""],
        ["로스팅레벨", sampleData.roastLevel || ""],
        [""],
        ["속성", ""],
        ["산미", sampleData.acidityLevel || "미선택"],
        ["단맛", sampleData.sweetnessLevel || "미선택"],
        ["바디감", sampleData.bodyLevel || "미선택"],
        [""],
        ["로스팅 디펙트", ""]
      ];
      
      // 디펙트 추가
      DEFECT_PROPS.forEach(d => {
        const val = sampleData[d.key] || "none";
        ws_data.push([d.label, val === "none" ? "미선택" : DEFECT_LABELS[val].label]);
      });
      
      ws_data.push([""]);
      ws_data.push(["SCA 점수", ""]);
      
      // SCA 점수
      const scoreData = [
        ["프래그런스", sampleData.scoreFragrance || 0],
        ["아로마", sampleData.scoreAroma || 0],
        ["플레이버", sampleData.scoreFlavor || 0],
        ["에프터테이스트", sampleData.scoreAftertaste || 0],
        ["액시디티", sampleData.scoreAcidity || 0],
        ["바디", sampleData.scoreBody || 0],
        ["밸런스", sampleData.scoreBalance || 0],
        ["오버럴", sampleData.scoreOverall || 0]
      ];
      
      // 점수 추가
      ws_data.push(...scoreData);
      
      // 총점 계산
      let totalScore = 30;
      scoreData.forEach(item => totalScore += parseFloat(item[1]));
      
      ws_data.push(["총점", totalScore.toFixed(2)]);
      ws_data.push([""]);
      
      // 향미 선택
      ws_data.push(["향미 선택", ""]);
      
      FLAVOR_PHASES.forEach(phase => {
        const flavors = sampleData.flavorSelections[phase.id] || [];
        let flavorStr = "";
        
        if (flavors.length > 0) {
          const flavorNames = flavors.map(key => {
            const [cat, sub, desc] = key.split('|');
            const flavor = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
            return flavor ? flavor[2] : '';
          }).filter(name => name);
          flavorStr = flavorNames.join('; ');
        }
        
        ws_data.push([phase.label, flavorStr]);
      });
      
      ws_data.push([""]);
      ws_data.push(["테이스팅 노트", ""]);
      ws_data.push(["", sampleData.tastingNotes || ""]);
      
      // 워크북 생성
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      
      // 워크시트를 워크북에 추가
      XLSX.utils.book_append_sheet(wb, ws, "커피 평가");
      
      // 엑셀 파일로 내보내기
      XLSX.writeFile(wb, `${sampleData.title || 'coffee'}_평가_${new Date().toISOString().slice(0, 10)}.xlsx`);
      
      showToast("엑셀 파일이 다운로드되었습니다.");
    } catch (e) {
      console.error("엑셀 내보내기 중 오류:", e);
      showToast("엑셀 파일 생성 중 오류가 발생했습니다.");
    }
  });
  
  // 네비게이션 버튼
  document.getElementById('prevSampleBtn').addEventListener('click', goToPrevSample);
  document.getElementById('nextSampleBtn').addEventListener('click', goToNextSample);
  
  // 언어 전환 버튼
  document.getElementById('langEn').addEventListener('click', () => switchLanguage('en'));
  document.getElementById('langKo').addEventListener('click', () => switchLanguage('ko'));
  
  // 비교 버튼
  document.getElementById('compareBtn').addEventListener('click', function() {
    // 현재 선택된 샘플 ID 수집
    const selectedIds = Array.from(document.querySelectorAll('.compare-checkbox:checked'))
      .map(cb => cb.value);
    
    if (selectedIds.length < 2) {
      showToast("비교를 위해 2개 이상의 샘플을 선택해 주세요.");
      return;
    }
    
    // 선택된 샘플들 가져오기
    const selectedSamples = samples.filter(s => selectedIds.includes(s.id));
    
    // 비교 차트 생성
    createComparisonChart(selectedSamples);
  });
  
  // 고급 비교 버튼
  document.getElementById('advancedCompareBtn').addEventListener('click', function() {
    // 현재 선택된 샘플 ID 수집
    const selectedIds = Array.from(document.querySelectorAll('.compare-checkbox:checked'))
      .map(cb => cb.value);
    
    if (selectedIds.length < 2) {
      showToast("비교를 위해 2개 이상의 샘플을 선택해 주세요.");
      return;
    }
    
    // 선택된 샘플들 가져오기
    const selectedSamples = samples.filter(s => selectedIds.includes(s.id));
    
    // 고급 비교 테이블 생성
    createAdvancedComparisonTable(selectedSamples);
  });
  
  // 분할 화면 버튼
  document.getElementById('splitViewBtn').addEventListener('click', function() {
    if (samples.length < 2) {
      showToast("비교를 위해 샘플이 2개 이상 필요합니다.");
      return;
    }
    
    // 모달 열기
    const modal = document.getElementById('splitViewModal');
    modal.classList.add('show');
    
    // 셀렉트 박스 업데이트
    updateSplitViewSelects();
  });
  
  // 모달 닫기 버튼
  document.getElementById('closeSplitViewBtn').addEventListener('click', function() {
    document.getElementById('splitViewModal').classList.remove('show');
  });
  
  // 분할 화면 셀렉트 박스 변경 이벤트
  document.getElementById('leftSampleSelect').addEventListener('change', updateSplitView);
  document.getElementById('rightSampleSelect').addEventListener('change', updateSplitView);
}

// 비교 차트 생성 함수
function createComparisonChart(selectedSamples) {
  const compareArea = document.getElementById('compareArea');
  if (!compareArea) return;
  
  // 기존 차트 정리
  if (chartObjects.comparisonRadar) {
    chartObjects.comparisonRadar.destroy();
    chartObjects.comparisonRadar = null;
  }
  
  // 컨테이너 생성
  let html = `
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">SCA 점수 비교 차트</h4>
      <div class="chart-container">
        <canvas id="comparisonRadar"></canvas>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">점수 비교 테이블</h4>
      <div class="overflow-x-auto">
        <table class="compare-table w-full">
          <thead>
            <tr>
              <th>항목</th>
  `;
  
  // 샘플 이름 헤더
  selectedSamples.forEach(sample => {
    html += `<th>${sample.title || '샘플'}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // 점수 행
  const scoreFields = [
    { key: 'scoreFragrance', label: '프래그런스' },
    { key: 'scoreAroma', label: '아로마' },
    { key: 'scoreFlavor', label: '플레이버' },
    { key: 'scoreAftertaste', label: '에프터테이스트' },
    { key: 'scoreAcidity', label: '액시디티' },
    { key: 'scoreBody', label: '바디' },
    { key: 'scoreBalance', label: '밸런스' },
    { key: 'scoreOverall', label: '오버럴' }
  ];
  
  scoreFields.forEach(field => {
    html += `<tr><td>${field.label}</td>`;
    selectedSamples.forEach(sample => {
      html += `<td>${parseFloat(sample.sampleData[field.key] || 0).toFixed(2)}</td>`;
    });
    html += `</tr>`;
  });
  
  // 총점 계산
  html += `<tr class="font-bold"><td>총점 (30+합계)</td>`;
  selectedSamples.forEach(sample => {
    let total = 30;
    scoreFields.forEach(field => {
      total += parseFloat(sample.sampleData[field.key] || 0);
    });
    html += `<td>${total.toFixed(2)}</td>`;
  });
  html += `</tr>`;
  
  html += `</tbody></table></div></div>`;
  
  // 향미 비교 섹션
  html += `
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">향미 비교</h4>
      <div class="overflow-x-auto">
        <table class="compare-table w-full">
          <thead>
            <tr>
              <th>단계</th>
  `;
  
  // 샘플 이름 헤더
  selectedSamples.forEach(sample => {
    html += `<th>${sample.title || '샘플'}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // 향미 행
  FLAVOR_PHASES.forEach(phase => {
    html += `<tr><td>${phase.label}</td>`;
    selectedSamples.forEach(sample => {
      const flavors = sample.sampleData.flavorSelections[phase.id] || [];
      html += `<td>`;
      
      if (flavors.length > 0) {
        flavors.forEach(key => {
          const [cat, sub, desc] = key.split('|');
          const flavor = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
          if (flavor) {
            const color = flavor[3] || '#B8B2A5';
            const textColor = getContrastColor(color);
            const displayName = currentLanguage === 'en' ? flavor[2] : (flavor[6] || flavor[2]);
            html += `<span class="flavor-badge" style="background:${color};color:${textColor};">${displayName}</span> `;
          }
        });
      } else {
        html += `<span class="text-xs text-gray-400">없음</span>`;
      }
      
      html += `</td>`;
    });
    html += `</tr>`;
  });
  
  html += `</tbody></table></div></div>`;
  
  // 디펙트 비교 섹션
  html += `
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">로스팅 디펙트 비교</h4>
      <div class="overflow-x-auto">
        <table class="compare-table w-full">
          <thead>
            <tr>
              <th>디펙트</th>
  `;
  
  // 샘플 이름 헤더
  selectedSamples.forEach(sample => {
    html += `<th>${sample.title || '샘플'}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // 디펙트 행
  DEFECT_PROPS.forEach(defect => {
    html += `<tr><td>${defect.label}</td>`;
    selectedSamples.forEach(sample => {
      const val = sample.sampleData[defect.key] || "none";
      if (val === "none") {
        html += `<td><span class="text-xs text-gray-400">미선택</span></td>`;
      } else {
        const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
        const textColor = getContrastColor(dColor);
        html += `<td><span class="defect-badge" style="background:${dColor};color:${textColor};">${DEFECT_LABELS[val].label}</span></td>`;
      }
    });
    html += `</tr>`;
  });
  
  html += `</tbody></table></div></div>`;
  
  compareArea.innerHTML = html;
  
  // 차트 생성
  const ctx = document.getElementById('comparisonRadar');
  if (!ctx) return;
  
  const chartData = {
    labels: ['프래그런스', '아로마', '플레이버', '에프터테이스트', '액시디티', '바디', '밸런스', '오버럴'],
    datasets: []
  };
  
  // 색상 팔레트
  const colors = [
    { bg: 'rgba(139, 90, 43, 0.2)', border: 'rgba(139, 90, 43, 0.8)' },
    { bg: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 0.8)' },
    { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 0.8)' },
    { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 0.8)' },
    { bg: 'rgba(153, 102, 255, 0.2)', border: 'rgba(153, 102, 255, 0.8)' },
    { bg: 'rgba(255, 159, 64, 0.2)', border: 'rgba(255, 159, 64, 0.8)' },
    { bg: 'rgba(205, 92, 92, 0.2)', border: 'rgba(205, 92, 92, 0.8)' },
    { bg: 'rgba(50, 205, 50, 0.2)', border: 'rgba(50, 205, 50, 0.8)' }
  ];
  
  // 데이터셋 생성
  selectedSamples.forEach((sample, index) => {
    const color = colors[index % colors.length];
    
    chartData.datasets.push({
      label: sample.title || '샘플',
      data: [
        parseFloat(sample.sampleData.scoreFragrance || 0),
        parseFloat(sample.sampleData.scoreAroma || 0),
        parseFloat(sample.sampleData.scoreFlavor || 0),
        parseFloat(sample.sampleData.scoreAftertaste || 0),
        parseFloat(sample.sampleData.scoreAcidity || 0),
        parseFloat(sample.sampleData.scoreBody || 0),
        parseFloat(sample.sampleData.scoreBalance || 0),
        parseFloat(sample.sampleData.scoreOverall || 0)
      ],
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 2,
      pointRadius: 4
    });
  });
  
  // 차트 옵션
  const options = {
    scales: {
      r: {
        angleLines: {
          display: true
        },
        min: 0,
        max: 10,
        ticks: {
          stepSize: 2,
          backdropColor: 'rgba(255, 255, 255, 0)'
        }
      }
    }
  };
  
  // 차트 생성 및 저장
  chartObjects.comparisonRadar = new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: options
  });
  
  // 스크롤 이동
  compareArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 고급 비교 테이블 생성 함수
function createAdvancedComparisonTable(selectedSamples) {
  const compareArea = document.getElementById('compareArea');
  if (!compareArea) return;
  
  let html = `
    <div class="bg-white rounded-lg p-4 shadow-md mt-4">
      <h4 class="font-semibold mb-4">고급 분석 비교</h4>
      <div class="overflow-x-auto">
        <table class="advanced-compare-table w-full">
          <thead>
            <tr>
              <th>구분</th>
              <th>항목</th>
  `;
  
  // 샘플 이름 헤더
  selectedSamples.forEach(sample => {
    html += `<th>${sample.title || '샘플'}</th>`;
  });
  
  html += `</tr></thead><tbody>`;
  
  // 기본 정보 섹션
  html += `<tr class="category-row"><td colspan="${2 + selectedSamples.length}">기본 정보</td></tr>`;
  
  const basicFields = [
    { key: 'coffeeName', label: '커피명' },
    { key: 'origin', label: '원산지' },
    { key: 'variety', label: '품종' },
    { key: 'process', label: '가공방식' },
    { key: 'roastDate', label: '로스팅 날짜' },
    { key: 'roastLevel', label: '로스팅 레벨' }
  ];
  
  basicFields.forEach(field => {
    html += `<tr><td>기본정보</td><td>${field.label}</td>`;
    selectedSamples.forEach(sample => {
      html += `<td>${sample.sampleData[field.key] || '-'}</td>`;
    });
    html += `</tr>`;
  });
  
  // 속성 섹션
  html += `<tr class="category-row"><td colspan="${2 + selectedSamples.length}">맛 속성</td></tr>`;
  
  const attrFields = [
    { key: 'acidityLevel', label: '산미' },
    { key: 'sweetnessLevel', label: '단맛' },
    { key: 'bodyLevel', label: '바디감' }
  ];
  
  attrFields.forEach(field => {
    html += `<tr><td>맛 속성</td><td>${field.label}</td>`;
    selectedSamples.forEach(sample => {
      const val = sample.sampleData[field.key];
      html += `<td>${val ? ATTR_VALUE_LABELS[val] : '미선택'}</td>`;
    });
    html += `</tr>`;
  });
  
  // SCA 점수 섹션
  html += `<tr class="category-row"><td colspan="${2 + selectedSamples.length}">SCA 점수</td></tr>`;
  
  const scoreFields = [
    { key: 'scoreFragrance', label: '프래그런스' },
    { key: 'scoreAroma', label: '아로마' },
    { key: 'scoreFlavor', label: '플레이버' },
    { key: 'scoreAftertaste', label: '에프터테이스트' },
    { key: 'scoreAcidity', label: '액시디티' },
    { key: 'scoreBody', label: '바디' },
    { key: 'scoreBalance', label: '밸런스' },
    { key: 'scoreOverall', label: '오버럴' }
  ];
  
  scoreFields.forEach(field => {
    html += `<tr><td>SCA 점수</td><td>${field.label}</td>`;
    selectedSamples.forEach(sample => {
      html += `<td>${parseFloat(sample.sampleData[field.key] || 0).toFixed(2)}</td>`;
    });
    html += `</tr>`;
  });
  
  // 총점 계산
  html += `<tr><td>SCA 점수</td><td class="font-bold">총점 (30+합계)</td>`;
  selectedSamples.forEach(sample => {
    let total = 30;
    scoreFields.forEach(field => {
      total += parseFloat(sample.sampleData[field.key] || 0);
    });
    html += `<td class="font-bold">${total.toFixed(2)}</td>`;
  });
  html += `</tr>`;
  
  // 로스팅 디펙트 섹션
  html += `<tr class="category-row"><td colspan="${2 + selectedSamples.length}">로스팅 디펙트</td></tr>`;
  
  DEFECT_PROPS.forEach(defect => {
    html += `<tr><td>디펙트</td><td>${defect.label}</td>`;
    selectedSamples.forEach(sample => {
      const val = sample.sampleData[defect.key] || "none";
      if (val === "none") {
        html += `<td><span class="text-xs text-gray-400">미선택</span></td>`;
      } else {
        const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
        const textColor = getContrastColor(dColor);
        html += `<td><span class="defect-badge" style="background:${dColor};color:${textColor};">${DEFECT_LABELS[val].label}</span></td>`;
      }
    });
    html += `</tr>`;
  });
  
  html += `</tbody></table></div></div>`;
  
  compareArea.innerHTML = html;
  
  // 스크롤 이동
  compareArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 분할 화면 셀렉트 박스 업데이트
function updateSplitViewSelects() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  
  if (!leftSelect || !rightSelect) return;
  
  // 기존 옵션 제거
  leftSelect.innerHTML = '';
  rightSelect.innerHTML = '';
  
  // 기본 옵션 추가
  leftSelect.add(new Option('선택하세요', ''));
  rightSelect.add(new Option('선택하세요', ''));
  
  // 샘플 옵션 추가
  samples.forEach(sample => {
    leftSelect.add(new Option(sample.title || '샘플', sample.id));
    rightSelect.add(new Option(sample.title || '샘플', sample.id));
  });
  
  // 기본값 설정 (다른 샘플 선택)
  if (samples.length >= 2) {
    leftSelect.value = samples[0].id;
    rightSelect.value = samples[1].id;
    updateSplitView();
  }
}

// 분할 화면 업데이트
function updateSplitView() {
  const leftSelect = document.getElementById('leftSampleSelect');
  const rightSelect = document.getElementById('rightSampleSelect');
  const leftView = document.getElementById('leftSampleView');
  const rightView = document.getElementById('rightSampleView');
  
  if (!leftSelect || !rightSelect || !leftView || !rightView) return;
  
  // 선택된 샘플 가져오기
  const leftSample = samples.find(s => s.id === leftSelect.value);
  const rightSample = samples.find(s => s.id === rightSelect.value);
  
  // 왼쪽 샘플 표시
  if (leftSample) {
    leftView.innerHTML = createSampleSummary(leftSample);
  } else {
    leftView.innerHTML = '<div class="text-center text-gray-500">왼쪽 샘플을 선택하세요</div>';
  }
  
  // 오른쪽 샘플 표시
  if (rightSample) {
    rightView.innerHTML = createSampleSummary(rightSample);
  } else {
    rightView.innerHTML = '<div class="text-center text-gray-500">오른쪽 샘플을 선택하세요</div>';
  }
}

// 샘플 요약 HTML 생성
function createSampleSummary(sample) {
  if (!sample) return '';
  
  const sampleData = sample.sampleData;
  let html = `
    <h3 class="font-bold text-lg mb-3">${sample.title || '샘플'}</h3>
    <div class="mb-3">
      <div><span class="font-semibold">커피명:</span> ${sampleData.coffeeName || '-'}</div>
      <div><span class="font-semibold">원산지:</span> ${sampleData.origin || '-'}</div>
      <div><span class="font-semibold">품종:</span> ${sampleData.variety || '-'}</div>
      <div><span class="font-semibold">가공법:</span> ${sampleData.process || '-'}</div>
      <div><span class="font-semibold">로스팅 날짜:</span> ${sampleData.roastDate || '-'}</div>
    </div>
    
    <h4 class="font-bold mt-4 mb-2">SCA 점수</h4>
    <div class="grid grid-cols-2 gap-2">
      <div><span class="font-semibold">프래그런스:</span> ${parseFloat(sampleData.scoreFragrance || 0).toFixed(2)}</div>
      <div><span class="font-semibold">아로마:</span> ${parseFloat(sampleData.scoreAroma || 0).toFixed(2)}</div>
      <div><span class="font-semibold">플레이버:</span> ${parseFloat(sampleData.scoreFlavor || 0).toFixed(2)}</div>
      <div><span class="font-semibold">에프터테이스트:</span> ${parseFloat(sampleData.scoreAftertaste || 0).toFixed(2)}</div>
      <div><span class="font-semibold">액시디티:</span> ${parseFloat(sampleData.scoreAcidity || 0).toFixed(2)}</div>
      <div><span class="font-semibold">바디:</span> ${parseFloat(sampleData.scoreBody || 0).toFixed(2)}</div>
      <div><span class="font-semibold">밸런스:</span> ${parseFloat(sampleData.scoreBalance || 0).toFixed(2)}</div>
      <div><span class="font-semibold">오버럴:</span> ${parseFloat(sampleData.scoreOverall || 0).toFixed(2)}</div>
    </div>
    
    <div class="mt-2">
      <span class="font-bold">총점: </span>
      ${(30 + parseFloat(sampleData.scoreFragrance || 0) + 
          parseFloat(sampleData.scoreAroma || 0) + 
          parseFloat(sampleData.scoreFlavor || 0) + 
          parseFloat(sampleData.scoreAftertaste || 0) + 
          parseFloat(sampleData.scoreAcidity || 0) + 
          parseFloat(sampleData.scoreBody || 0) + 
          parseFloat(sampleData.scoreBalance || 0) + 
          parseFloat(sampleData.scoreOverall || 0)).toFixed(2)}
    </div>
    
    <h4 class="font-bold mt-4 mb-2">향미 프로필</h4>
  `;
  
  // 향미 표시
  FLAVOR_PHASES.forEach(phase => {
    const flavors = sampleData.flavorSelections[phase.id] || [];
    html += `<div class="mb-2"><span class="font-semibold">${phase.label}:</span> `;
    
    if (flavors.length > 0) {
      flavors.forEach(key => {
        const [cat, sub, desc] = key.split('|');
        const flavor = FLAVOR_DATA.find(f => f[0] === cat && f[1] === sub && f[2] === desc);
        if (flavor) {
          const color = flavor[3] || '#B8B2A5';
          const textColor = getContrastColor(color);
          const displayName = currentLanguage === 'en' ? flavor[2] : (flavor[6] || flavor[2]);
          html += `<span class="flavor-badge" style="background:${color};color:${textColor};">${displayName}</span> `;
        }
      });
    } else {
      html += `<span class="text-xs text-gray-400">없음</span>`;
    }
    
    html += `</div>`;
  });
  
  // 속성 표시
  html += `
    <h4 class="font-bold mt-4 mb-2">맛 속성</h4>
    <div class="grid grid-cols-3 gap-2">
      <div><span class="font-semibold">산미:</span> ${sampleData.acidityLevel ? ATTR_VALUE_LABELS[sampleData.acidityLevel] : '미선택'}</div>
      <div><span class="font-semibold">단맛:</span> ${sampleData.sweetnessLevel ? ATTR_VALUE_LABELS[sampleData.sweetnessLevel] : '미선택'}</div>
      <div><span class="font-semibold">바디:</span> ${sampleData.bodyLevel ? ATTR_VALUE_LABELS[sampleData.bodyLevel] : '미선택'}</div>
    </div>
  `;
  
  // 디펙트 표시
  html += `<h4 class="font-bold mt-4 mb-2">로스팅 디펙트</h4>`;
  
  let hasDefect = false;
  DEFECT_PROPS.forEach(defect => {
    const val = sampleData[defect.key] || "none";
    if (val !== "none") {
      hasDefect = true;
      const dColor = DEFECT_LABELS[val] ? DEFECT_LABELS[val].color : "#bbb";
      const textColor = getContrastColor(dColor);
      html += `
        <div class="mb-1">
          <span class="font-semibold">${defect.label}:</span>
          <span class="defect-badge" style="background:${dColor};color:${textColor};">${DEFECT_LABELS[val].label}</span>
        </div>
      `;
    }
  });
  
  if (!hasDefect) {
    html += `<div class="text-sm text-gray-400">선택된 디펙트 없음</div>`;
  }
  
  // 테이스팅 노트 표시
  if (sampleData.tastingNotes) {
    html += `
      <h4 class="font-bold mt-4 mb-2">테이스팅 노트</h4>
      <div class="bg-gray-50 p-3 rounded text-sm">${sampleData.tastingNotes.replace(/\n/g, '<br>')}</div>
    `;
  }
  
  return html;
}

// DOM이 준비되면 앱 초기화
document.addEventListener('DOMContentLoaded', function() {
  // 앱 기본 초기화
  initFlavorWheelApp();
  
  // 이벤트 리스너 설정
  setupEventHandlers();
  
  // 평가일 표시
  document.getElementById('evalDate').textContent = new Date().toLocaleDateString();
});

// 페이지 종료 시 정리 작업 
window.addEventListener('beforeunload', function(e) {
  try {
    // 현재 샘플 저장
    saveCurrentSample();
    
    // 차트 메모리 정리
    cleanupCharts();
  } catch (err) {
    console.error("페이지 종료 시 정리 작업 중 오류:", err);
  }
});
</script>
</body>
</html>
