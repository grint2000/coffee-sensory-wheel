<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Mollis SCA 커피 관능 평가</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TailwindCSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js 4.4.3 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- SheetJS for excel/csv export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #fcfaf7; }
        .tab-btn-active { background-color: #8B5A2B !important; color: #fff !important; }
        .tab-btn-inactive { background-color: #f3efe8 !important; color: #675444; }
        .flavor-badge { font-size: 13px; border-radius: 9999px; padding: 2px 10px; margin: 2px; display:inline-block;}
        .export-btn { background-color:#8B5A2B;color:white;}
        .export-btn:hover { background-color: #654321;}
        .modal-bg {background: rgba(0,0,0,0.2);}
        @media (max-width: 640px) {
          .grid-cols-sample { grid-template-columns: 1fr!important;}
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-6xl mx-auto p-2 md:p-6">
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row items-center justify-between py-6 mb-2 border-b border-tan-300 bg-white rounded-lg shadow-sm">
        <div class="flex items-center">
            <svg width="60" height="60" viewBox="0 0 200 200" class="mr-3"><rect width="200" height="200" fill="black"/><path d="M100,40 L120,60 L110,60 L110,80 L115,90 L105,100 C105,100 120,110 130,120 C140,130 120,150 120,150 L80,150 C80,150 60,130 70,120 C80,110 95,100 95,100 L85,90 L90,80 L90,60 L80,60 Z" fill="#D2B48C"/><circle cx="95" cy="60" r="2" fill="#D2B48C"/><circle cx="105" cy="70" r="2" fill="#D2B48C"/><circle cx="115" cy="65" r="2" fill="#D2B48C"/></svg>
            <span class="text-2xl md:text-3xl font-bold text-tan-900 select-none">mollis</span>
        </div>
        <div class="mt-3 md:mt-0 text-center md:text-right">
          <h2 class="text-lg md:text-2xl font-semibold">SCAA 커피 관능 평가</h2>
          <div class="text-xs text-gray-500 mt-1">최대 20개 샘플 다중 비교 | SCAA Flavor Wheel 기반</div>
        </div>
    </header>

    <!-- SAMPLE TABS -->
    <nav id="sampleTabs" class="flex flex-wrap items-center mb-4 gap-2"></nav>
    <div class="flex flex-wrap gap-2 mb-6">
        <button id="addSampleBtn" class="rounded px-4 py-2 export-btn flex items-center text-sm"><i class="fas fa-plus mr-2"></i>샘플 추가</button>
        <button id="duplicateSampleBtn" class="rounded px-4 py-2 bg-gray-200 flex items-center text-sm"><i class="fas fa-copy mr-2"></i>현재 복제</button>
        <button id="removeSampleBtn" class="rounded px-4 py-2 bg-red-200 text-red-900 flex items-center text-sm"><i class="fas fa-trash mr-2"></i>샘플 삭제</button>
        <button id="compareViewBtn" class="rounded px-4 py-2 bg-blue-200 text-blue-900 flex items-center text-sm"><i class="fas fa-bars mr-2"></i>비교 뷰</button>
    </div>

    <!-- EVALUATION FORM -->
    <form id="cuppingForm" class="bg-white shadow rounded-lg p-4 md:p-8">
        <!-- 샘플 정보 -->
        <section class="mb-8">
            <h3 class="text-xl font-bold mb-4 border-b-2 pb-1 border-tan-200 flex items-center"><i class="fas fa-mug-hot mr-2"></i>커피 정보</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 grid-cols-sample">
                <div>
                    <label class="block text-sm font-semibold mb-1">커피명</label>
                    <input class="coffee-input w-full border border-tan-300 rounded p-2" id="coffeeName">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">원산지</label>
                    <input class="coffee-input w-full border border-tan-300 rounded p-2" id="origin">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">품종(Variety)</label>
                    <input class="coffee-input w-full border border-tan-300 rounded p-2" id="variety">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">가공방식(Process)</label>
                    <input class="coffee-input w-full border border-tan-300 rounded p-2" id="process">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">로스팅 날짜</label>
                    <input type="date" class="coffee-input w-full border border-tan-300 rounded p-2" id="roastDate">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">로스팅 레벨</label>
                    <select class="coffee-input w-full border border-tan-300 rounded p-2" id="roastLevel">
                        <option value="">선택</option>
                        <option value="light">Light</option>
                        <option value="medium-light">Medium-Light</option>
                        <option value="medium">Medium</option>
                        <option value="medium-dark">Medium-Dark</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- SCAA FLAVOR WHEEL EVALUATION -->
        <section>
            <h3 class="text-xl font-bold mb-1 border-b-2 pb-1 border-tan-200 flex items-center"><i class="fa fa-circle-half-stroke mr-2"></i>SCAA 향미 선택</h3>
            <div class="text-sm mb-4 text-gray-600">[프래그런스] [아로마] [플레이버] [에프터테이스트] 항목별로 SCAA Flavor Wheel의 향미를 각각 선택해 주세요.</div>
            <button type="button" class="mb-4 px-3 py-1 rounded bg-gray-100 text-xs" onclick="window.open('https://sca.coffee/research/coffee-tasters-flavor-wheel', '_blank');">플레이버 휠 공식자료 보기<i class="fas fa-external-link-alt ml-1 text-xs"></i></button>
            <div id="flavorTabs" class="flex flex-wrap gap-2 mb-2">
                <button type="button" data-flavorphase="fragrance" class="flavor-phase-btn tab-btn-active font-bold rounded px-4 py-1">프래그런스</button>
                <button type="button" data-flavorphase="aroma" class="flavor-phase-btn tab-btn-inactive rounded px-4 py-1">아로마</button>
                <button type="button" data-flavorphase="flavor" class="flavor-phase-btn tab-btn-inactive rounded px-4 py-1">플레이버</button>
                <button type="button" data-flavorphase="aftertaste" class="flavor-phase-btn tab-btn-inactive rounded px-4 py-1">에프터테이스트</button>
            </div>
            <div id="flavorWheelMultiSelectArea" class="mb-4"></div>
        </section>

        <!-- STRUCTURED ATTRIBUTES -->
        <section class="mb-8">
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Acidity -->
                <div>
                    <label class="block mb-1 font-medium">Acidity<br><span class="text-xs text-gray-500">산미 단계선택</span></label>
                    <div class="flex gap-2 flex-wrap" id="acidity_level">
                        <label><input type="radio" name="acidityLevel" value="Low"><span class="ml-1">Low</span></label>
                        <label><input type="radio" name="acidityLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
                        <label><input type="radio" name="acidityLevel" value="Medium"><span class="ml-1">Medium</span></label>
                        <label><input type="radio" name="acidityLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
                        <label><input type="radio" name="acidityLevel" value="High"><span class="ml-1">High</span></label>
                    </div>
                </div>
                <!-- Sweetness -->
                <div>
                    <label class="block mb-1 font-medium">Sweetness<br><span class="text-xs text-gray-500">단맛 단계선택</span></label>
                    <div class="flex gap-2 flex-wrap" id="sweetness_level">
                        <label><input type="radio" name="sweetnessLevel" value="Low"><span class="ml-1">Low</span></label>
                        <label><input type="radio" name="sweetnessLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
                        <label><input type="radio" name="sweetnessLevel" value="Medium"><span class="ml-1">Medium</span></label>
                        <label><input type="radio" name="sweetnessLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
                        <label><input type="radio" name="sweetnessLevel" value="High"><span class="ml-1">High</span></label>
                    </div>
                </div>
                <!-- Body -->
                <div>
                    <label class="block mb-1 font-medium">Body<br><span class="text-xs text-gray-500">질감/바디 단계선택</span></label>
                    <div class="flex gap-2 flex-wrap" id="body_level">
                        <label><input type="radio" name="bodyLevel" value="Low"><span class="ml-1">Low</span></label>
                        <label><input type="radio" name="bodyLevel" value="Med-Low"><span class="ml-1">Med-Low</span></label>
                        <label><input type="radio" name="bodyLevel" value="Medium"><span class="ml-1">Medium</span></label>
                        <label><input type="radio" name="bodyLevel" value="Med-High"><span class="ml-1">Med-High</span></label>
                        <label><input type="radio" name="bodyLevel" value="High"><span class="ml-1">High</span></label>
                    </div>
                </div>
            </div>
        </section>

        <!-- SCORING -->
        <section class="mb-8">
            <h3 class="text-xl font-bold mb-2 border-b-2 pb-1 border-tan-200 flex items-center"><i class="fa fa-star mr-2"></i>SCA 점수 (0~10점, 0.25단위)</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <div>
                    <label class="block text-sm mb-1">프래그런스</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreFragrance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">아로마</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreAroma" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">플레이버</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreFlavor" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">에프터테이스트</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreAftertaste" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">액시디티</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreAcidity" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">바디</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreBody" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">밸런스</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreBalance" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
                <div>
                    <label class="block text-sm mb-1">오버럴</label>
                    <input type="number" step="0.25" min="0" max="10" id="scoreOverall" class="coffee-input w-full p-1.5 text-center border rounded" value="7">
                </div>
            </div>
            <div class="mt-4 flex flex-wrap items-end gap-3">
                <div>
                    <label class="text-sm block mb-1">총점 (기본 30점+합계)</label>
                    <span id="totalScore" class="font-bold inline-block text-lg bg-gray-100 px-4 py-2 rounded border">86.00</span>
                </div>
                <button type="button" id="calcScoreBtn" class="ml-1 mt-2 px-4 py-2 rounded export-btn flex items-center text-sm"><i class="fas fa-equals mr-2"></i>점수 계산</button>
            </div>
        </section>

        <!-- TASTING NOTES -->
        <section class="mb-6">
            <h3 class="text-xl font-bold mb-2 border-b-2 pb-1 border-tan-200 flex items-center"><i class="fas fa-pen-nib mr-2"></i>테이스팅 노트/기타</h3>
            <textarea id="tastingNotes" class="coffee-input w-full min-h-[80px] p-2 border rounded" placeholder="특이사항, 시간, 온도, 커핑 총평 등 메모"></textarea>
        </section>

        <!-- VISUALIZATION -->
        <section class="">
            <h3 class="text-xl font-bold mb-2 border-b-2 pb-1 border-tan-200 flex items-center"><i class="fas fa-chart-radar mr-2"></i>결과 시각화 및 내보내기</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <h4 class="font-semibold mb-2">향미 특성/훈련용 워드 클라우드</h4>
                    <div id="selectedFlavorsArea"></div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <h4 class="font-semibold mb-2">SCA 평가 레이더 차트</h4>
                    <canvas id="cuppingRadar" class="" height="200"></canvas>
                </div>
            </div>
            <div class="flex flex-wrap space-x-2 mt-6 gap-2">
                <button id="exportImgBtn" type="button" class="export-btn px-6 py-2 rounded flex items-center"><i class="fas fa-image mr-2"></i>이미지로 내보내기</button>
                <button id="exportCsvBtn" type="button" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded flex items-center"><i class="fas fa-file-csv mr-2"></i>CSV로 내보내기</button>
                <button id="exportXlsxBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded flex items-center"><i class="fas fa-file-excel mr-2"></i>엑셀로 내보내기</button>
            </div>
        </section>
    </form>
</div>

<!-- COMPARE MODAL -->
<div id="compareModal" class="hidden fixed top-0 left-0 w-full h-full flex justify-center items-center z-50 modal-bg">
  <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 w-full max-w-5xl max-h-[92vh] overflow-y-auto relative border">
    <button type="button" id="closeCompareBtn" class="absolute top-2 right-4 text-lg text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
    <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-balance-scale mr-2"></i>샘플 비교</h3>
    <div class="flex flex-col md:flex-row gap-2">
        <div class="md:w-1/2">
            <canvas id="compareRadar"></canvas>
            <div class="text-sm text-gray-400 mt-1">SCA Score Radar: 2~5개까지 선택 가능</div>
        </div>
        <div class="md:w-1/2 overflow-x-auto">
            <table class="min-w-full bg-white border text-sm mt-2">
                <thead><tr id="compareTableHeader" class="bg-gray-50"></tr></thead>
                <tbody id="compareTableBody"></tbody>
            </table>
        </div>
    </div>
  </div>
</div>

<script>
// SCAA FLAVOR DATA (MainCategory/Sub/Descriptors)
const FLAVOR_DATA = [
    // 기존 데이터 유지
    ["Fruity", "Citrus Fruit", "Lemon", "#FFD966"], ["Fruity", "Citrus Fruit", "Orange", "#FFC300"],
    ["Fruity", "Citrus Fruit", "Grapefruit", "#FF7F50"], ["Fruity", "Other Fruit", "Apple", "#ABE188"],
    ["Fruity", "Other Fruit", "Pear", "#B6E4A3"], ["Fruity", "Berry", "Raspberry", "#DD5772"],
    ["Fruity", "Berry", "Strawberry", "#FF6F91"], ["Fruity", "Berry", "Blackberry", "#D7263D"],
    ["Fruity", "Dried Fruit", "Raisin", "#BB9055"], ["Fruity", "Dried Fruit", "Prune", "#925E3A"],
    ["Sweet", "", "Brown Sugar", "#B38B57"], ["Sweet", "", "Caramel", "#FFB15E"],
    ["Sweet", "", "Honey", "#FDE994"], ["Sweet", "", "Vanilla", "#F0D7BC"],
    ["Floral", "", "Jasmine", "#DEC2CB"], ["Floral", "", "Rose", "#FD5D8B"],
    ["Floral", "", "Chamomile", "#F5E5C0"], ["Nutty/Cocoa", "Nutty", "Hazelnut", "#D7C2A8"],
    ["Nutty/Cocoa", "Nutty", "Almond", "#DBD3C9"], ["Nutty/Cocoa", "Cocoa", "Dark Chocolate", "#6C4F3D"],
    ["Nutty/Cocoa", "Cocoa", "Cocoa", "#926F34"], ["Spices", "", "Cinnamon", "#E5B39B"],
    ["Spices", "", "Clove", "#C17855"], ["Spices", "", "Pepper", "#818286"], ["Spices", "", "Nutmeg", "#BD9C7F"],
    ["Brown Sugar", "", "Molasses", "#946A3B"], ["Brown Sugar", "", "Maple Syrup", "#C97C5D"],
    ["Roasted", "", "Brown Roast", "#5C4033"], ["Roasted", "", "Smoky", "#2D231C"],
    ["Green/Vegetative", "", "Under-ripe", "#A4C09C"], ["Green/Vegetative", "", "Peapod", "#B2DAC0"],
    ["Green/Vegetative", "", "Fresh", "#C2E99E"],
    ["Sour/Fermented", "Sour", "Citric Acid", "#CEE6CB"],
    ["Sour/Fermented", "Sour", "Malic Acid", "#C9E265"],
    ["Sour/Fermented", "Sour", "Acetic Acid", "#D9C1B4"],
    ["Sour/Fermented", "Fermented", "Winey", "#AC436E"],
    ["Sour/Fermented", "Fermented", "Overripe", "#625958"],
    ["Other", "", "Chemical", "#FCF6B1"],
    ["Other", "", "Medicinal", "#E2D784"],
    
    // 1. 프래그런스(원두 향기) 추가 항목
    ["Fruity", "Citrus Fruit", "Lime", "#C0E57B"],
    ["Fruity", "Citrus Fruit", "Tangerine", "#FFA54F"],
    ["Fruity", "Berry", "Blueberry", "#4F86F7"],
    ["Fruity", "Berry", "Cranberry", "#E30B5C"],
    ["Fruity", "Stone Fruit", "Peach", "#FFCBA4"],
    ["Fruity", "Stone Fruit", "Apricot", "#FBCEB1"],
    ["Fruity", "Stone Fruit", "Cherry", "#DE3163"],
    ["Fruity", "Stone Fruit", "Plum", "#8E4585"],
    ["Fruity", "Tropical Fruit", "Pineapple", "#FEDF00"],
    ["Fruity", "Tropical Fruit", "Mango", "#FFB300"],
    ["Fruity", "Tropical Fruit", "Coconut", "#F2E8D7"],
    ["Fruity", "Tropical Fruit", "Passion Fruit", "#DDA0DD"],
    ["Fruity", "Dried Fruit", "Fig", "#8A4117"],
    ["Fruity", "Dried Fruit", "Date", "#A57164"],
    
    // 2. 아로마(음료 향기) 추가 항목
    ["Floral", "", "Hibiscus", "#F53E6A"],
    ["Floral", "", "Lavender", "#B57EDC"],
    ["Floral", "", "Orange Blossom", "#FFCC99"],
    ["Spices", "Warming Spices", "Cardamom", "#BDA55D"],
    ["Spices", "Warming Spices", "Allspice", "#9C5903"],
    ["Spices", "Pungent Spices", "Licorice", "#2A2926"],
    ["Spices", "Pungent Spices", "Anise", "#50404D"],
    ["Sweet", "Caramelized", "Toffee", "#D2691E"],
    ["Sweet", "Caramelized", "Butterscotch", "#E09540"],
    ["Sweet", "Vanilla", "Custard", "#F0E68C"],
    ["Sweet", "Vanilla", "Cream", "#FFFDD0"],
    
    // 3. 플레이버(맛) 추가 항목
    ["Nutty/Cocoa", "Nutty", "Peanut", "#D28C78"],
    ["Nutty/Cocoa", "Nutty", "Walnut", "#C19A6B"],
    ["Nutty/Cocoa", "Nutty", "Cashew", "#F5DEB3"],
    ["Nutty/Cocoa", "Cocoa", "Milk Chocolate", "#7B3F00"],
    ["Nutty/Cocoa", "Cocoa", "Bittersweet Chocolate", "#332421"],
    ["Nutty/Cocoa", "Cocoa", "Mocha", "#785135"],
    ["Cereal/Grain", "Cereal", "Malt", "#F0E68C"],
    ["Cereal/Grain", "Cereal", "Toast", "#D2B48C"],
    ["Cereal/Grain", "Cereal", "Barley", "#DBD0AE"],
    ["Cereal/Grain", "Grain-like", "Granola", "#C8A951"],
    ["Cereal/Grain", "Grain-like", "Oats", "#E4CBB1"],
    ["Cereal/Grain", "Grain-like", "Rice", "#F9FBE7"],
    
    // 4. 에프터테이스트(뒷맛) 추가 항목
    ["Sour/Fermented", "Clean Acidity", "Tartaric Acid", "#D7E8CB"],
    ["Sour/Fermented", "Clean Acidity", "Phosphoric Acid", "#E8F3D9"],
    ["Sour/Fermented", "Fermented", "Yogurt", "#F5F5F5"],
    ["Sour/Fermented", "Fermented", "Sourdough", "#E8D0A7"],
    ["Sour/Fermented", "Fermented", "Vinegar", "#ECEDE6"],
    ["Sour/Fermented", "Fermented", "Kombucha", "#DEC19B"],
    ["Sour/Fermented", "Aged/Funky", "Musty", "#8B7D6B"],
    ["Sour/Fermented", "Aged/Funky", "Earthy", "#79553D"],
    ["Roasted", "Light Roast", "Tea-like", "#967969"],
    ["Roasted", "Light Roast", "Herbal", "#BDCB96"],
    ["Roasted", "Medium Roast", "Toasty", "#C19A6B"],
    ["Roasted", "Medium Roast", "Caramelized", "#C68E17"],
    ["Roasted", "Dark Roast", "Burnt", "#373536"],
    ["Roasted", "Dark Roast", "Charred", "#2C1608"],
    ["Roasted", "Dark Roast", "Ashy", "#5D5D5D"],
    
    // 공통 특성 추가 항목
    ["Green/Vegetative", "Fresh Green", "Grass", "#7EC850"],
    ["Green/Vegetative", "Fresh Green", "Cucumber", "#8FBC8F"],
    ["Green/Vegetative", "Fresh Green", "Green Bell Pepper", "#4F7942"],
    ["Green/Vegetative", "Herbaceous", "Mint", "#98FB98"],
    ["Green/Vegetative", "Herbaceous", "Sage", "#BCB88A"],
    ["Green/Vegetative", "Herbaceous", "Basil", "#579229"],
    ["Green/Vegetative", "Vegetal", "Olive", "#708238"],
    ["Green/Vegetative", "Vegetal", "Spinach", "#175732"],
    ["Other", "Chemical", "Rubber", "#454545"],
    ["Other", "Chemical", "Petroleum", "#2E2E2E"],
    ["Other", "Chemical", "Plastic", "#BEBEBE"],
    ["Other", "Chemical", "Tar", "#1C1C1C"],
    ["Other", "Earthy", "Soil", "#6F4E37"],
    ["Other", "Earthy", "Mushroom", "#D7CEC7"],
    ["Other", "Earthy", "Forest Floor", "#5E4B3B"],
    ["Other", "Earthy", "Wet Earth", "#622F22"],
    ["Other", "Woody", "Oak", "#A46B2B"],
    ["Other", "Woody", "Cedar", "#A67B5B"],
    ["Other", "Woody", "Pine", "#8A9A5B"],
    ["Other", "Woody", "Sandalwood", "#B87333"]
];


// PHASES (for fragrance/aroma/flavor/aftertaste)
const FLAVOR_PHASES = [
    {id: "fragrance", label:"프래그런스"},
    {id: "aroma", label:"아로마"},
    {id: "flavor", label:"플레이버"},
    {id: "aftertaste", label:"에프터테이스트"}
];

// RAM: SAMPLE DATA STORE
let samples = []; // [{}, ...] up to 20
let currentSampleIdx = 0;

/* -------- Sample Initialization Helper -------- */
function makeEmptySample(){
    let flavorSelections = {};
    FLAVOR_PHASES.forEach(phase=>{
        flavorSelections[phase.id] = [];
    });
    return {
        name: "샘플" + (samples.length+1),
        coffeeName: "", origin: "", variety: "", process: "",
        roastDate: "", roastLevel: "",
        flavorSelections,
        acidityLevel: "", sweetnessLevel: "", bodyLevel: "",
        scoreFragrance: 7, scoreAroma: 7, scoreFlavor: 7, scoreAftertaste: 7,
        scoreAcidity: 7, scoreBody:7, scoreBalance:7, scoreOverall:7,
        tastingNotes: ""
    }
}

/* -------- UI Rendering Functions -------- */
function updateSampleTabs(){
    let tabArea = document.getElementById('sampleTabs');
    tabArea.innerHTML = '';
    samples.forEach((sample, idx)=>{
        let btn = document.createElement('button');
        btn.type='button';
        btn.className = 'rounded px-3 py-1 mx-1 mb-1 border text-sm '+(idx===currentSampleIdx?'tab-btn-active':'tab-btn-inactive');
        btn.textContent = sample.name || (`샘플${idx+1}`);
        btn.setAttribute('data-idx',idx);
        btn.onclick = ()=>{
            saveUiToSample();
            currentSampleIdx=idx;
            renderSample();
            updateSampleTabs();
        };
        tabArea.appendChild(btn);
    });
}

/* -------- Form <-> Sample Binding -------- */
function renderSample(){
    let data = samples[currentSampleIdx]||{};
    document.getElementById('coffeeName').value = data.coffeeName||'';
    document.getElementById('origin').value = data.origin||'';
    document.getElementById('variety').value = data.variety||'';
    document.getElementById('process').value = data.process||'';
    document.getElementById('roastDate').value = data.roastDate||'';
    document.getElementById('roastLevel').value = data.roastLevel||'';

    // Attribute radios
    for(let group of ["acidity","sweetness","body"]){
      let v = data[group+"Level"]||"";
      if(v){
        let radio = document.querySelector('input[name="'+group+'Level"][value="'+v+'"]');
        if(radio) radio.checked = true;
      }else{
        let radios = document.querySelectorAll('input[name="'+group+'Level"]');
        radios.forEach(r=>r.checked=false);
      }
    }
    // Score
    [
      ["scoreFragrance","scoreFragrance"],
      ["scoreAroma","scoreAroma"],
      ["scoreFlavor","scoreFlavor"],
      ["scoreAftertaste","scoreAftertaste"],
      ["scoreAcidity","scoreAcidity"],
      ["scoreBody","scoreBody"],
      ["scoreBalance","scoreBalance"],
      ["scoreOverall","scoreOverall"]
    ].forEach(([key,id])=>{
      document.getElementById(id).value = data[key]||7;
    });
    document.getElementById('tastingNotes').value = data.tastingNotes||'';
    renderFlavorPhase();
    updateFlavorsArea();
    updateRadar();
    updateTotalScore();
}

function saveUiToSample(){
    let s=samples[currentSampleIdx];
    s.coffeeName = document.getElementById('coffeeName').value;
    s.origin = document.getElementById('origin').value;
    s.variety = document.getElementById('variety').value;
    s.process = document.getElementById('process').value;
    s.roastDate = document.getElementById('roastDate').value;
    s.roastLevel = document.getElementById('roastLevel').value;
    s.acidityLevel = getCheckedRadio('acidityLevel');
    s.sweetnessLevel = getCheckedRadio('sweetnessLevel');
    s.bodyLevel = getCheckedRadio('bodyLevel');
    s.scoreFragrance = parseFloat(document.getElementById('scoreFragrance').value)||0;
    s.scoreAroma = parseFloat(document.getElementById('scoreAroma').value)||0;
    s.scoreFlavor = parseFloat(document.getElementById('scoreFlavor').value)||0;
    s.scoreAftertaste = parseFloat(document.getElementById('scoreAftertaste').value)||0;
    s.scoreAcidity = parseFloat(document.getElementById('scoreAcidity').value)||0;
    s.scoreBody = parseFloat(document.getElementById('scoreBody').value)||0;
    s.scoreBalance = parseFloat(document.getElementById('scoreBalance').value)||0;
    s.scoreOverall = parseFloat(document.getElementById('scoreOverall').value)||0;
    s.tastingNotes = document.getElementById('tastingNotes').value;
    // save phase flavors et al. in respective handlers
}

/* -------- Flavor Phase UI -------- */
let currentFlavorPhase = "fragrance";
function renderFlavorPhase(){
    let curSel = samples[currentSampleIdx].flavorSelections[currentFlavorPhase]||[];
    let outer = document.getElementById('flavorWheelMultiSelectArea');
    // Group data by MainCategory
    let catMap = {};
    FLAVOR_DATA.forEach(([cat, sub, desc, color])=>{
        if(!catMap[cat])catMap[cat] = [];
        catMap[cat].push({sub,desc,color});
    });
    // Build HTML
    let html = '';
    for(let cat in catMap){
        html += `<div class="mb-1 mt-2"><div class="font-bold mb-0.5">${cat}</div>`;
        // SubCat group
        let subMap = {};
        catMap[cat].forEach(f=>{
            let k = f.sub||'특징없음';
            if(!subMap[k])subMap[k]=[];
            subMap[k].push(f);
        });
        for(let sub in subMap){
            html += `<div class="mb-1 ml-2"><span class="font-semibold text-sm">${sub!=='특징없음'?sub:""}</span>&nbsp;`;
            subMap[sub].forEach(f=>{
                // unique key for this desc
                let id = cat+'|'+sub+'|'+f.desc;
                let checked = curSel.includes(id) ? ' checked ':'';
                html+=`<label class="inline-block align-middle mr-2 mb-1 flavor-badge" style="background:${f.color};"><input type="checkbox" class="flavorSelectBox" data-key="${id}" ${checked}><span>${f.desc}</span></label>`;
            });
            html += '</div>';
        }
        html+='</div>';
    }
    outer.innerHTML = html;
    // Checkbox handler
    outer.querySelectorAll('.flavorSelectBox').forEach(cb=>{
        cb.onchange = function(){
            let sel = samples[currentSampleIdx].flavorSelections[currentFlavorPhase];
            let key = this.getAttribute('data-key');
            if(this.checked){
                if(sel.length<10) sel.push(key);
            }else{
                let idx = sel.indexOf(key);
                if(idx>-1) sel.splice(idx,1);
            }
            samples[currentSampleIdx].flavorSelections[currentFlavorPhase] = sel;
            updateFlavorsArea();
        }
    });
}
/* nav phase */
document.querySelectorAll('.flavor-phase-btn').forEach(btn=>{
    btn.onclick = function(){
        document.querySelectorAll('.flavor-phase-btn').forEach(b=>b.classList.remove('tab-btn-active'));
        this.classList.add('tab-btn-active');
        currentFlavorPhase = this.getAttribute('data-flavorphase');
        renderFlavorPhase();
    };
});

/* ------- Update Flavors Word Cloud/Selection ------ */
function updateFlavorsArea(){
    let s = samples[currentSampleIdx];
    let html = '';
    FLAVOR_PHASES.forEach(phase=>{
        let phaseSel = (s.flavorSelections[phase.id]||[]).map(key=>{
            let [cat,sub,desc] = key.split('|');
            let rec = FLAVOR_DATA.find(f=>f[0]===cat&&f[1]===sub&&f[2]===desc);
            let color = rec?rec[3]:'#B8B2A5';
            return `<span class="flavor-badge" style="background:${color};">${desc}</span>`;
        });
        html+=`<div class="mb-1"><span class="font-bold">${phase.label}:</span> ${phaseSel.join(' ')||'<span class="text-xs text-gray-400">없음</span>'}</div>`;
    });
    document.getElementById('selectedFlavorsArea').innerHTML = html;
}

/* ---- Score, Attribute, Radar Chart  ---- */
function updateTotalScore(){
    let s = samples[currentSampleIdx];
    let sum = 30 + s.scoreFragrance + s.scoreAroma + s.scoreFlavor + s.scoreAftertaste + s.scoreAcidity + s.scoreBody + s.scoreBalance + s.scoreOverall;
    document.getElementById('totalScore').textContent = sum.toFixed(2);
}
function updateRadar(){
    if(!window.cuppingRadarChart){
        window.cuppingRadarChart = new Chart(document.getElementById('cuppingRadar').getContext('2d'), {
          type: "radar",
          data: {
            labels:["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"],
            datasets:[{label:"점수",data:[7,7,7,7,7,7,7,7], backgroundColor:"rgba(139,90,43,0.2)",borderColor:"#8B5A2B",pointBgColor:"#8B5A2B"}]
          },
          options: {
            responsive:true,
            plugins:{legend:{display:false}},
            scales:{r:{
              min:0,max:10,ticks:{stepSize:2,
                font:{family:"Noto Sans KR", size:13}},
             pointLabels:{font:{family:"Noto Sans KR", weight:"bold", size:14}}
            }}
          }
        });
    }
    let s = samples[currentSampleIdx];
    let chart = window.cuppingRadarChart;
    chart.data.datasets[0].data = [
      s.scoreFragrance, s.scoreAroma, s.scoreFlavor, s.scoreAftertaste,
      s.scoreAcidity, s.scoreBody, s.scoreBalance, s.scoreOverall
    ];
    chart.update();
}

// -- CSV/XLSX Helper --
function samplesToRows(fields){
    // fields = ["샘플이름",'coffeeName' ...]
    return samples.map(s=>{
        return fields.map(f=>{
            if(f.startsWith('flavorSelections.')){
                let phase = f.split('.')[1];
                return (s.flavorSelections[phase]||[]).map(key=>key.split('|')[2]).join('; ');
            }
            return s[f]!==undefined?s[f]:"";
        });
    });
}

/* ---- COMPARISON ---------- */
function openCompareModal(){
    // By default: select all samples, up to 5
    let selectedIdx = samples.map((s,idx)=>idx).slice(0,Math.min(5,samples.length));
    let tableHeader = document.getElementById('compareTableHeader');
    let tableBody = document.getElementById('compareTableBody');

    // Header
    tableHeader.innerHTML = '<th class="px-1 py-0.5"></th>'+selectedIdx.map(idx=>`<th class="text-sm text-tan-800 px-1 py-0.5">${samples[idx].name||"샘플"+(idx+1)}</th>`).join("");
    // Body/fields
    let rows = [
        ['커피명','coffeeName'],
        ['원산지','origin'],
        ['품종','variety'],
        ['가공','process'],
        ['로스팅','roastLevel'],
        ['프래그런스','scoreFragrance'],
        ['아로마','scoreAroma'],
        ['플레이버','scoreFlavor'],
        ['에프터테이스트','scoreAftertaste'],
        ['액시디티','scoreAcidity'],
        ['바디','scoreBody'],
        ['밸런스','scoreBalance'],
        ['오버럴','scoreOverall'],
        ['총점',null],
        ['Acidity Level','acidityLevel'],
        ['Sweetness Level','sweetnessLevel'],
        ['Body Level','bodyLevel'],
    ];
    tableBody.innerHTML = '';
    rows.forEach(([label,key])=>{
        tableBody.innerHTML += `<tr>
          <td class="border p-1 font-semibold">${label}</td>
          ${selectedIdx.map(idx=>{
              if(key){
                return `<td class="border p-1">${samples[idx][key]??""}</td>`;
              }else if(label==="총점"){
                let s = samples[idx];
                let sum = 30+s.scoreFragrance+s.scoreAroma+s.scoreFlavor+s.scoreAftertaste+s.scoreAcidity+s.scoreBody+s.scoreBalance+s.scoreOverall;
                return `<td class="border p-1 font-bold bg-gray-50">${sum.toFixed(2)}</td>`;
              }else return `<td class="border"></td>`
          }).join('')}
        </tr>`;
    });
    // Radar
    let radar = document.getElementById('compareRadar').getContext('2d');
    if(window.compareRadarChart) window.compareRadarChart.destroy();
    let datasets = selectedIdx.map((idx,j)=>({
        label: samples[idx].name||`샘플${idx+1}`,
        data:[
            samples[idx].scoreFragrance,
            samples[idx].scoreAroma,
            samples[idx].scoreFlavor,
            samples[idx].scoreAftertaste,
            samples[idx].scoreAcidity,
            samples[idx].scoreBody,
            samples[idx].scoreBalance,
            samples[idx].scoreOverall
        ],
        backgroundColor: `rgba(${60+j*35},${130+j*21},${170-j*15},0.13)`,
        borderColor: `rgba(${60+j*35},${120+j*20},${170-j*15},1)`,
        pointBackgroundColor: `rgba(${60+j*35},${120+j*20},${170-j*15},1)`
    }));
    window.compareRadarChart = new Chart(radar, {
      type:'radar',
      data: {
        labels:["프래그런스","아로마","플레이버","에프터테이스트","액시디티","바디","밸런스","오버럴"],
        datasets
      },
      options: {
        responsive:true, plugins:{legend:{position:'top',labels:{font:{family:"Noto Sans KR"}}}},
        scales:{r:{min:0,max:10,ticks:{stepSize:2}}}
      }
    });

    document.getElementById('compareModal').classList.remove('hidden');
}
document.getElementById('compareViewBtn').onclick = openCompareModal;
document.getElementById('closeCompareBtn').onclick = ()=>{
    document.getElementById('compareModal').classList.add('hidden');
};


function getCheckedRadio(name){
    let r = document.querySelector('input[name="'+name+'"]:checked');
    return r?r.value:"";
}

/* ------ Event Handlers ------ */
// score input handler
["scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste",
 "scoreAcidity","scoreBody","scoreBalance","scoreOverall"].forEach(id=>{
    document.getElementById(id).onchange = ()=>{
        saveUiToSample(); updateTotalScore(); updateRadar();
    };
 });
["acidityLevel","sweetnessLevel","bodyLevel"].forEach(gr=>{
    document.querySelectorAll('input[name="'+gr+'"]').forEach(r=>{
        r.onchange = ()=>{ saveUiToSample();}
    });
});
["coffeeName","origin","variety","process","roastDate","roastLevel","tastingNotes"].forEach(id=>{
    document.getElementById(id).onblur = ()=>{saveUiToSample();}
});
document.getElementById('calcScoreBtn').onclick = ()=>{
    saveUiToSample();
    updateTotalScore();
    updateRadar();
};

/* ------- init sample + buttons---------- */
function addSample(copy=null){
    if(samples.length>=20){alert("최대 20개까지 추가 가능합니다.");return;}
    if(copy){
        samples.push(JSON.parse(JSON.stringify(copy)));
    }else{
        samples.push(makeEmptySample());
    }
    currentSampleIdx = samples.length-1;
    renderSample();
    updateSampleTabs();
}
function removeSample(){
    if(samples.length<=1){alert("최소 하나는 필요합니다.");return;}
    samples.splice(currentSampleIdx,1);
    if(currentSampleIdx>0)currentSampleIdx--;
    renderSample();
    updateSampleTabs();
}
function duplicateSample(){
    let copy = JSON.parse(JSON.stringify(samples[currentSampleIdx]));
    addSample(copy);
}
document.getElementById('addSampleBtn').onclick = ()=>{saveUiToSample();addSample();};
document.getElementById('removeSampleBtn').onclick = ()=>{removeSample();};
document.getElementById('duplicateSampleBtn').onclick = ()=>{duplicateSample();};

/* ---- EXPORT: IMAGE, CSV, XLSX ---- */
document.getElementById('exportImgBtn').onclick = ()=>{
    // Only export current visualization(not full page);
    html2canvas(document.querySelector("#cuppingForm"),{
      backgroundColor:"#fcfaf7",scale:2,logging:false,
      onclone:(doc)=>{
        doc.getElementById('cuppingForm').style.boxShadow="none";
      }
    }).then(canvas=>{
        let a = document.createElement('a');
        a.href = canvas.toDataURL("image/png");
        let fname = (samples[currentSampleIdx].coffeeName||samples[currentSampleIdx].name||'sample')+'_cupping.png';
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });
};
document.getElementById('exportCsvBtn').onclick = ()=>{
    saveUiToSample();
    // CSV fields: 샘플명, 주요 정보, 각 phase flavor, 점수, 속성 등
    let fields = [
        "name","coffeeName","origin","variety","process","roastDate","roastLevel",
        "acidityLevel","sweetnessLevel","bodyLevel",
        "flavorSelections.fragrance","flavorSelections.aroma","flavorSelections.flavor","flavorSelections.aftertaste",
        "scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall",
        "tastingNotes"
    ];
    let rows = samplesToRows(fields);
    let header = ["샘플구분","커피명","원산지","품종","가공법","로스팅일","로스팅레벨","산미단계","단맛단계","바디단계","프래그런스","아로마","플레이버","에프터테이스트","Fragrance점수","Aroma점수","Flavor점수","Aftertaste점수","Acidity점수","Body점수","Balance점수","Overall점수","비고/노트"];
    let csv = header.join(',')+'\n'+rows.map(row=>row.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
    let blob = new Blob([csv],{type:"text/csv"});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "cupping_data.csv";
    document.body.appendChild(a);
    a.click(); document.body.removeChild(a);
};
document.getElementById('exportXlsxBtn').onclick = ()=>{
    saveUiToSample();
    let fields = [
        "name","coffeeName","origin","variety","process","roastDate","roastLevel",
        "acidityLevel","sweetnessLevel","bodyLevel",
        "flavorSelections.fragrance","flavorSelections.aroma","flavorSelections.flavor","flavorSelections.aftertaste",
        "scoreFragrance","scoreAroma","scoreFlavor","scoreAftertaste","scoreAcidity","scoreBody","scoreBalance","scoreOverall",
        "tastingNotes"
    ];
    let rows = samplesToRows(fields);
    let header = ["샘플구분","커피명","원산지","품종","가공법","로스팅일","로스팅레벨","산미단계","단맛단계","바디단계","프래그런스","아로마","플레이버","에프터테이스트","Fragrance점수","Aroma점수","Flavor점수","Aftertaste점수","Acidity점수","Body점수","Balance점수","Overall점수","비고/노트"];
    let ws = XLSX.utils.aoa_to_sheet([header,...rows]);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "cupping");
    XLSX.writeFile(wb,"cupping_data.xlsx");
};

/* ---- INIT ----- */
addSample(); // make one sample
renderSample();
updateSampleTabs();
</script>
</body>
</html>

